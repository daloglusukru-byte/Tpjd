<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPJD Üyelik Yönetim Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --tpjd-dark: #2c3e50;
            --tpjd-gray: #34495e;
            --tpjd-gold: #f39c12;
            --tpjd-light-gold: #f1c40f;
            --tpjd-light: #ecf0f1;
            --tpjd-border: #bdc3c7;
            --tpjd-success: #27ae60;
            --tpjd-danger: #e74c3c;
            --tpjd-warning: #e67e22;
            --tpjd-info: #3498db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--tpjd-dark) 0%, var(--tpjd-gray) 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid var(--tpjd-border);
        }

        .header {
            background: linear-gradient(135deg, var(--tpjd-dark) 0%, var(--tpjd-gray) 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
            border-bottom: 4px solid var(--tpjd-gold);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: var(--tpjd-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 24px;
        }
        
        .logo i {
            display: block;
        }

        .header-text h1 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header-text p {
            opacity: 0.9;
            font-size: 14px;
            color: var(--tpjd-light);
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .tabs {
            display: flex;
            background: var(--tpjd-light);
            border-bottom: 1px solid var(--tpjd-border);
            overflow-x: auto;
            padding: 0 10px;
        }

        .tab {
            padding: 18px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--tpjd-gray);
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab:hover {
            background: rgba(52, 73, 94, 0.05);
            color: var(--tpjd-dark);
        }

        .tab.active {
            color: var(--tpjd-dark);
            border-bottom: 3px solid var(--tpjd-gold);
            background: white;
        }

        .tab i {
            margin-right: 8px;
            opacity: 0.8;
        }

        .content {
            padding: 30px;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-left: 5px solid var(--tpjd-gold);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--tpjd-light-gold) 0%, transparent 70%);
            opacity: 0.1;
            border-radius: 0 0 0 100%;
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--tpjd-gray);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--tpjd-dark);
        }

        .stat-card .subtitle {
            font-size: 13px;
            color: #7f8c8d;
            font-weight: 500;
        }

        .stat-card.success {
            border-left-color: var(--tpjd-success);
        }

        .stat-card.warning {
            border-left-color: var(--tpjd-warning);
        }

        .stat-card.info {
            border-left-color: var(--tpjd-info);
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 35px;
        }
        
        .chart-container h3 {
            font-size: 18px;
            color: var(--tpjd-dark);
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }
        
        .chart-wrapper {
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }
        
        @media (max-width: 768px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 50px 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--tpjd-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 32px;
            margin: 0 auto 30px;
        }
        
        .login-logo i {
            display: block;
        }

        .login-box h1 {
            font-size: 28px;
            color: var(--tpjd-dark);
            margin-bottom: 10px;
        }

        .login-box p {
            color: #7f8c8d;
            margin-bottom: 35px;
            font-size: 15px;
        }

        .login-form .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--tpjd-dark);
            font-weight: 600;
            font-size: 14px;
        }

        .login-form input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .login-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--tpjd-danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .main-app {
            display: none;
        }

        .main-app.show {
            display: block;
        }
        
        .logout-btn {
            background: var(--tpjd-danger);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }.toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--tpjd-border);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn i {
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--tpjd-gray), var(--tpjd-dark));
        }

        .btn-success {
            background: var(--tpjd-success);
            color: white;
        }

        .btn-warning {
            background: var(--tpjd-warning);
            color: white;
        }

        .btn-danger {
            background: var(--tpjd-danger);
            color: white;
        }

        .btn-info {
            background: var(--tpjd-info);
            color: white;
        }

        .btn-secondary {
            background: var(--tpjd-border);
            color: var(--tpjd-dark);
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid var(--tpjd-border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
        }

        thead th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid var(--tpjd-border);
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: rgba(243, 156, 18, 0.05);
        }

        tbody td {
            padding: 14px 16px;
            font-size: 14px;
            color: #555;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge.success {
            background: rgba(39, 174, 96, 0.15);
            color: var(--tpjd-success);
        }

        .badge.warning {
            background: rgba(230, 126, 34, 0.15);
            color: var(--tpjd-warning);
        }

        .badge.danger {
            background: rgba(231, 76, 60, 0.15);
            color: var(--tpjd-danger);
        }

        .badge.info {
            background: rgba(52, 152, 219, 0.15);
            color: var(--tpjd-info);
        }

        .action-btn {
            padding: 8px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .action-btn.edit {
            background: var(--tpjd-info);
            color: white;
        }

        .action-btn.delete {
            background: var(--tpjd-danger);
            color: white;
        }

        .action-btn.view {
            background: var(--tpjd-warning);
            color: white;
        }
        
        .action-btn.download {
            background: var(--tpjd-success);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 0;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            position: relative;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--tpjd-gold);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tpjd-dark);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .modal-footer {
            padding: 20px 25px;
            background: var(--tpjd-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--tpjd-border);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            z-index: 2000;
            min-width: 300px;
            border-left: 5px solid var(--tpjd-success);
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left-color: var(--tpjd-success);
        }

        .notification.error {
            border-left-color: var(--tpjd-danger);
        }

        .notification.warning {
            border-left-color: var(--tpjd-warning);
        }

        .notification.info {
            border-left-color: var(--tpjd-info);
        }
        
        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tpjd-gray);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--tpjd-gold);
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            thead th, tbody td {
                padding: 10px 8px;
            }
        }

        .spinner {
            border: 3px solid var(--tpjd-light);
            border-top: 3px solid var(--tpjd-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--tpjd-gray);
        }

        .empty-state p {
            font-size: 14px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .detail-item {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid var(--tpjd-gold);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .detail-item label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .detail-item .value {
            font-size: 16px;
            color: var(--tpjd-dark);
            font-weight: 500;
        }
        
        .accordion {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid var(--tpjd-border);
        }

        .accordion-header {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            padding: 18px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg, var(--tpjd-gray), var(--tpjd-dark));
        }

        .accordion-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accordion-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .accordion-content.active {
            max-height: 2000px;
        }

        .accordion-body {
            padding: 0;
        }

        .accordion-body table {
            margin: 0;
        }
        
        .member-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .member-stat-badge {
            background: var(--tpjd-gold);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .form-group.checkbox-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group.checkbox-inline input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .form-group.checkbox-inline label {
            margin: 0;
            cursor: pointer;
        }
        
        .year-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: var(--tpjd-light);
            border-radius: 8px;
        }

        .year-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid var(--tpjd-border);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .year-checkbox-item:hover {
            border-color: var(--tpjd-gold);
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.2);
        }

        .year-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--tpjd-gold);
        }

        .year-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: var(--tpjd-dark);
        }

        .year-checkbox-item input[type="checkbox"]:checked + label {
            color: var(--tpjd-gold);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-users"></i>
            </div>
            <h1>TPJD Üyelik Yönetim Sistemi</h1>
            <p style="margin-bottom: 35px;">Giriş yaparak sisteme erişebilirsiniz</p>
            
            <div id="loginError" class="login-error">
                Kullanıcı adı veya şifre hatalı!
            </div>
            
            <form class="login-form" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginUsername">Kullanıcı Adı</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Şifre</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Giriş Yap
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="header-text">
                        <h1>TPJD</h1>
                        <p>Türkiye Petrol Jeologları Derneği - Üyelik Yönetim Sistemi</p>
                    </div>
                </div>
                <div class="user-info">
                    <i class="fas fa-user-circle"></i> Yönetici Paneli
                    <button class="logout-btn" onclick="logout()" style="margin-left: 15px;">
                        <i class="fas fa-sign-out-alt"></i> Çıkış
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard', event)">
                <i class="fas fa-home"></i> Ana Sayfa
            </button>
            <button class="tab" onclick="switchTab('members', event)">
                <i class="fas fa-users"></i> Üyeler
            </button>
            <button class="tab" onclick="switchTab('payments', event)">
                <i class="fas fa-money-bill-wave"></i> Ödemeler
            </button>
            <button class="tab" onclick="switchTab('notifications', event)">
                <i class="fas fa-bell"></i> Bildirimler
            </button>
            <button class="tab" onclick="switchTab('editMember', event)">
                <i class="fas fa-user-edit"></i> Üye Düzenle
            </button>
            <button class="tab" onclick="switchTab('settings', event)">
                <i class="fas fa-cog"></i> Ayarlar
            </button>
        </div>
        <!-- Content -->
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Toplam Üye</h3>
                        <div class="value" id="totalMembers">0</div>
                        <div class="subtitle">Kayıtlı üye sayısı</div>
                    </div>
                    <div class="stat-card success">
                        <h3>Aktif Üye</h3>
                        <div class="value" id="activeMembers">0</div>
                        <div class="subtitle">2025 yılı aidat ödemesi yapan</div>
                    </div>
                    <div class="stat-card warning">
                        <h3>Bekleyen Ödeme</h3>
                        <div class="value" id="pendingPayments">0</div>
                        <div class="subtitle">Aidat ödemeyen üye sayısı</div>
                    </div>
                    <div class="stat-card info">
                        <h3>Toplam Gelir</h3>
                        <div class="value" id="totalIncome">₺0</div>
                        <div class="subtitle">2025 yılı toplam aidat geliri</div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="charts-row">
                    <!-- Ödeme Durumu Simit Grafik -->
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-pie"></i> Genel Borç Durumu</h3>
                        <div class="chart-wrapper">
                            <canvas id="paymentDonutChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Üyelik Tipi Dağılımı Simit Grafik -->
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-pie"></i> Üyelik Tipi Dağılımı</h3>
                        <div class="chart-wrapper">
                            <canvas id="membershipDonutChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openModal('memberModal')">
                        <i class="fas fa-user-plus"></i> Yeni Üye Ekle
                    </button>
                    <button class="btn btn-success" onclick="openModal('paymentModal')">
                        <i class="fas fa-plus-circle"></i> Ödeme Ekle
                    </button>
                    <button class="btn btn-warning" onclick="openBulkEmailModal()">
                        <i class="fas fa-envelope"></i> Toplu E-posta
                    </button>
                    <button class="btn btn-secondary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Excel'e Aktar
                    </button>
                    <button class="btn btn-secondary" onclick="exportToJSON()">
                        <i class="fas fa-file-code"></i> JSON İndir
                    </button>
                    <button class="btn btn-danger" onclick="loadSampleData()">
                        <i class="fas fa-database"></i> Örnek Veri Yükle
                    </button>
                </div>

                <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 20px 0; color: var(--tpjd-dark); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--tpjd-danger);"></i> 
                        Borçlu Üyeler Listesi
                        <span id="debtorCount" style="margin-left: auto; font-size: 14px; color: var(--tpjd-warning); background: rgba(230, 126, 34, 0.1); padding: 5px 15px; border-radius: 20px;"></span>
                    </h3>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Üye No</th>
                                <th>Ad Soyad</th>
                                <th>Üyelik Tipi</th>
                                <th>E-posta</th>
                                <th>Telefon</th>
                                <th>Ödeme Durumu</th>
                                <th>Borç Tutarı</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardMembersTable">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>Henüz üye kaydı bulunmamaktadır</h3>
                                    <p>Yeni üye eklemek için "Yeni Üye Ekle" butonuna tıklayın</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>

            <!-- Members Tab -->
            <div id="members" class="tab-content">
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openModal('memberModal')">
                        <i class="fas fa-user-plus"></i> Yeni Üye Ekle
                    </button>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="memberSearch" placeholder="Üye ara..." onkeyup="searchMembers()">
                    </div>
                    <button class="btn btn-secondary" onclick="exportMembersToExcel()">
                        <i class="fas fa-file-excel"></i> Excel'e Aktar
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Üye No</th>
                                <th>Ad Soyad</th>
                                <th>TC No</th>
                                <th>E-posta</th>
                                <th>Telefon</th>
                                <th>Üyelik Tipi</th>
                                <th>Kayıt Tarihi</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="membersTable">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>Henüz üye kaydı bulunmamaktadır</h3>
                                    <p>Yeni üye eklemek için "Yeni Üye Ekle" butonuna tıklayın</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Tab with Accordion -->
            <div id="payments" class="tab-content">
                <div class="toolbar">
                    <button class="btn btn-success" onclick="openModal('paymentModal')">
                        <i class="fas fa-plus-circle"></i> Ödeme Ekle
                    </button>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="paymentSearch" placeholder="Ödeme ara..." onkeyup="searchPayments()">
                    </div>
                    <button class="btn btn-secondary" onclick="exportPaymentsToExcel()">
                        <i class="fas fa-file-excel"></i> Excel'e Aktar
                    </button>
                </div>

                <div id="paymentsAccordion">
                    <!-- Accordion items will be dynamically generated here -->
                </div>
            </div>

            <!-- Transactions Tab -->

            <!-- Notifications Tab -->
            <div id="notifications" class="tab-content">
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openModal('notificationModal')">
                        <i class="fas fa-bell"></i> Yeni Bildirim Gönder
                    </button>
                    <button class="btn btn-warning" onclick="openBulkEmailModal()">
                        <i class="fas fa-envelope"></i> Toplu E-posta Gönder
                    </button>
                </div>

                <div id="notificationsList">
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>Henüz bildirim bulunmamaktadır</h3>
                        <p>Yeni bildirim göndermek için "Yeni Bildirim Gönder" butonuna tıklayın</p>
                    </div>
                </div>
            </div>

            <!-- Edit Member Tab -->
            <div id="editMember" class="tab-content">
                <div class="stat-card" style="margin-bottom: 25px;">
                    <h3><i class="fas fa-search"></i> Üye Ara ve Düzenle</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div class="form-group">
                            <label>Üye No</label>
                            <input type="text" id="filterMemberNo" placeholder="Üye numarası ile ara..." oninput="filterMembersForEdit()">
                        </div>
                        <div class="form-group">
                            <label>Ad</label>
                            <input type="text" id="filterFirstName" placeholder="Ad ile ara..." oninput="filterMembersForEdit()">
                        </div>
                        <div class="form-group">
                            <label>Soyad</label>
                            <input type="text" id="filterLastName" placeholder="Soyad ile ara..." oninput="filterMembersForEdit()">
                        </div>
                        <div class="form-group">
                            <label>TC No</label>
                            <input type="text" id="filterTcNo" placeholder="TC No ile ara..." oninput="filterMembersForEdit()">
                        </div>
                        <div class="form-group">
                            <label>Telefon</label>
                            <input type="text" id="filterPhone" placeholder="Telefon ile ara..." oninput="filterMembersForEdit()">
                        </div>
                        <div class="form-group">
                            <label>Şehir</label>
                            <input type="text" id="filterCity" placeholder="Şehir ile ara..." oninput="filterMembersForEdit()">
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="clearEditFilters()" style="margin-top: 10px;">
                        <i class="fas fa-eraser"></i> Filtreleri Temizle
                    </button>
                </div>

                <div class="stat-card">
                    <h3><i class="fas fa-list"></i> Üye Listesi <span id="filteredMemberCount" style="color: var(--tpjd-gold); font-size: 14px;"></span></h3>
                    
                    <div id="editMembersList" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>Üye aramak için yukarıdaki filtreleri kullanın</h3>
                            <p>Düzenlemek istediğiniz üyeyi bulun ve tıklayın</p>
                        </div>
                    </div>
                </div>

                <div id="editMemberFormContainer" style="display: none; margin-top: 25px;">
                    <div class="stat-card">
                        <h3><i class="fas fa-user-edit"></i> Üye Bilgilerini Düzenle - <span id="editingMemberName"></span></h3>
                        
                        <form id="editMemberForm" style="margin-top: 20px;">
                            <input type="hidden" id="editMemberId">
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <!-- Sol Kolon -->
                                <div>
                                    <h4 style="color: var(--tpjd-dark); margin-bottom: 15px; border-bottom: 2px solid var(--tpjd-gold); padding-bottom: 8px;">
                                        <i class="fas fa-id-card"></i> Temel Bilgiler
                                    </h4>
                                    
                                    <div class="form-group">
                                        <label>Üye No *</label>
                                        <input type="text" id="editMemberNo" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Üyelik Tipi *</label>
                                        <select id="editMembershipType" required>
                                            <option value="">Seçiniz</option>
                                            <option value="Asil Üye">Asil Üye</option>
                                            <option value="Asil Onursal">Asil Onursal</option>
                                            <option value="Öğrenci Üye">Öğrenci Üye</option>
                                            <option value="Fahri Üye">Fahri Üye</option>
                                            <option value="Fahri Onursal">Fahri Onursal</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="editAidatAktif" style="width: auto;">
                                        <label style="margin: 0;">Aidat Aktif</label>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Ad *</label>
                                        <input type="text" id="editFirstName" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Soyad *</label>
                                        <input type="text" id="editLastName" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>TC Kimlik No *</label>
                                        <input type="text" id="editTcNo" maxlength="11" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Cinsiyet *</label>
                                        <select id="editGender" required>
                                            <option value="">Seçiniz</option>
                                            <option value="Erkek">Erkek</option>
                                            <option value="Kadın">Kadın</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Doğum Tarihi *</label>
                                        <input type="date" id="editBirthDate" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Kan Grubu</label>
                                        <select id="editBloodType">
                                            <option value="">Seçiniz</option>
                                            <option value="A Rh+">A Rh+</option>
                                            <option value="A Rh-">A Rh-</option>
                                            <option value="B Rh+">B Rh+</option>
                                            <option value="B Rh-">B Rh-</option>
                                            <option value="AB Rh+">AB Rh+</option>
                                            <option value="AB Rh-">AB Rh-</option>
                                            <option value="0 Rh+">0 Rh+</option>
                                            <option value="0 Rh-">0 Rh-</option>
                                        </select>
                                    </div>
                                    
                                    <h4 style="color: var(--tpjd-dark); margin: 25px 0 15px; border-bottom: 2px solid var(--tpjd-gold); padding-bottom: 8px;">
                                        <i class="fas fa-phone"></i> İletişim Bilgileri
                                    </h4>
                                    
                                    <div class="form-group">
                                        <label>E-posta *</label>
                                        <input type="email" id="editEmail" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Telefon *</label>
                                        <input type="tel" id="editPhone" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Ev Telefonu</label>
                                        <input type="tel" id="editPhoneHome">
                                    </div>
                                </div>
                                
                                <!-- Sağ Kolon -->
                                <div>
                                    <h4 style="color: var(--tpjd-dark); margin-bottom: 15px; border-bottom: 2px solid var(--tpjd-gold); padding-bottom: 8px;">
                                        <i class="fas fa-map-marker-alt"></i> Adres Bilgileri
                                    </h4>
                                    
                                    <div class="form-group">
                                        <label>İl *</label>
                                        <input type="text" id="editCity" required list="cityList">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>İlçe</label>
                                        <input type="text" id="editDistrict">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Mahalle</label>
                                        <input type="text" id="editNeighborhood">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Adres *</label>
                                        <textarea id="editAddress" rows="3" required></textarea>
                                    </div>
                                    
                                    <h4 style="color: var(--tpjd-dark); margin: 25px 0 15px; border-bottom: 2px solid var(--tpjd-gold); padding-bottom: 8px;">
                                        <i class="fas fa-user-friends"></i> Aile Bilgileri
                                    </h4>
                                    
                                    <div class="form-group">
                                        <label>Baba Adı</label>
                                        <input type="text" id="editFatherName">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Anne Adı</label>
                                        <input type="text" id="editMotherName">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Medeni Durum</label>
                                        <select id="editMaritalStatus">
                                            <option value="">Seçiniz</option>
                                            <option value="Bekar">Bekar</option>
                                            <option value="Evli">Evli</option>
                                            <option value="Dul">Dul</option>
                                            <option value="Boşanmış">Boşanmış</option>
                                        </select>
                                    </div>
                                    
                                    <h4 style="color: var(--tpjd-dark); margin: 25px 0 15px; border-bottom: 2px solid var(--tpjd-gold); padding-bottom: 8px;">
                                        <i class="fas fa-briefcase"></i> Eğitim ve Meslek
                                    </h4>
                                    
                                    <div class="form-group">
                                        <label>Mezuniyet</label>
                                        <input type="text" id="editGraduation" placeholder="Üniversite/Fakülte">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Mezuniyet Yılı</label>
                                        <input type="number" id="editGraduationYear" min="1950" max="2030">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Çalışma Durumu</label>
                                        <select id="editEmploymentStatus">
                                            <option value="">Seçiniz</option>
                                            <option value="Çalışıyor">Çalışıyor</option>
                                            <option value="Emekli">Emekli</option>
                                            <option value="Öğrenci">Öğrenci</option>
                                            <option value="İşsiz">İşsiz</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>İş Yeri</label>
                                        <input type="text" id="editWorkplace">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Pozisyon</label>
                                        <input type="text" id="editPosition">
                                    </div>
                                    
                                    <h4 style="color: var(--tpjd-dark); margin: 25px 0 15px; border-bottom: 2px solid var(--tpjd-gold); padding-bottom: 8px;">
                                        <i class="fas fa-book"></i> Nüfus Bilgileri
                                    </h4>
                                    
                                    <div class="form-group">
                                        <label>Doğum Yeri (İl)</label>
                                        <input type="text" id="editBirthCity">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Doğum Yeri (İlçe)</label>
                                        <input type="text" id="editBirthDistrict">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Cilt No</label>
                                        <input type="text" id="editVolumeNo">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Aile Sıra No</label>
                                        <input type="text" id="editFamilyNo">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Sıra No</label>
                                        <input type="text" id="editLineNo">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Notlar</label>
                                        <textarea id="editNotes" rows="3"></textarea>
                                    </div>
                                    
                                    <!-- ÜYELİKTEN AYRILMA BİLGİLERİ -->
                                    <div style="border-top: 2px solid var(--tpjd-light); margin: 25px 0 20px 0; padding-top: 20px;">
                                        <h4 style="color: var(--tpjd-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-user-times" style="color: var(--tpjd-danger);"></i>
                                            Üyelikten Ayrılma Bilgileri
                                        </h4>
                                        
                                        <div class="form-group">
                                            <label>Üyelik Durumu *</label>
                                            <select id="editMembershipStatus" onchange="toggleEditExitFields()">
                                                <option value="aktif">Aktif Üye</option>
                                                <option value="pasif">Pasif Üye (Geçici)</option>
                                                <option value="ayrıldı">Üyelikten Ayrıldı</option>
                                            </select>
                                        </div>
                                        
                                        <div id="editExitFieldsContainer" style="display: none;">
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label>Ayrılış Tarihi</label>
                                                    <input type="date" id="editExitDate">
                                                </div>
                                                <div class="form-group">
                                                    <label>Ayrılış Nedeni</label>
                                                    <select id="editExitReasonType">
                                                        <option value="">Seçiniz</option>
                                                        <option value="Kendi İsteği">Kendi İsteği</option>
                                                        <option value="Ödeme Yapmaması">Ödeme Yapmaması</option>
                                                        <option value="Disiplin Sorunu">Disiplin Sorunu</option>
                                                        <option value="Taşınma">Taşınma / Şehir Değişikliği</option>
                                                        <option value="Sağlık Sorunları">Sağlık Sorunları</option>
                                                        <option value="Diğer">Diğer</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label>Detaylı Açıklama</label>
                                                <textarea id="editExitReason" placeholder="Ayrılış nedeni detayları..." rows="3"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--tpjd-light);">
                                <button type="button" class="btn btn-primary" onclick="saveEditedMember()" style="flex: 1;">
                                    <i class="fas fa-save"></i> Değişiklikleri Kaydet
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelEditMember()" style="flex: 1;">
                                    <i class="fas fa-times"></i> İptal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="stats-grid" style="grid-template-columns: 1fr;">
                    <div class="stat-card">
                        <h3><i class="fas fa-key"></i> Kullanıcı Adı ve Şifre Değiştir</h3>
                        <form id="passwordForm" style="margin-top: 20px;">
                            <div class="form-group">
                                <label>Mevcut Kullanıcı Adı</label>
                                <input type="text" id="currentUsername" readonly style="background: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Mevcut Şifre</label>
                                <input type="password" id="currentPasswordCheck" required placeholder="Mevcut şifrenizi girin">
                            </div>
                            <div class="form-group">
                                <label>Yeni Kullanıcı Adı</label>
                                <input type="text" id="newUsername" required placeholder="Yeni kullanıcı adı">
                            </div>
                            <div class="form-group">
                                <label>Yeni Şifre</label>
                                <input type="password" id="newPassword" required placeholder="Yeni şifre (min. 6 karakter)">
                            </div>
                            <div class="form-group">
                                <label>Yeni Şifre Tekrar</label>
                                <input type="password" id="newPasswordConfirm" required placeholder="Yeni şifre tekrar">
                            </div>
                            <button type="button" class="btn btn-primary" onclick="changePassword()" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-save"></i> Değişiklikleri Kaydet
                            </button>
                        </form>
                    </div>
                    
                    <div class="stat-card info">
                        <h3><i class="fas fa-info-circle"></i> Sistem Bilgileri</h3>
                        <div style="margin-top: 20px;">
                            <div class="detail-item" style="margin-bottom: 15px;">
                                <label>Toplam Üye Sayısı</label>
                                <div class="value" id="settingsTotalMembers">0</div>
                            </div>
                            <div class="detail-item" style="margin-bottom: 15px;">
                                <label>Toplam Ödeme Sayısı</label>
                                <div class="value" id="settingsTotalPayments">0</div>
                            </div>
                            <div class="detail-item">
                                <label>Versiyon</label>
                                <div class="value">v1.0.0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card warning">
                        <h3><i class="fas fa-money-bill-wave"></i> Aidat Tutarları</h3>
                        <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                            Her üyelik tipi için yıllık aidat tutarlarını belirleyin. Bu tutarlar otomatik borçlandırma işleminde kullanılacaktır.
                        </p>
                        <form id="aidatSettingsForm" style="margin-top: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div class="form-group">
                                    <label>Asil Üye Aidatı (₺)</label>
                                    <input type="number" id="aidatAsilUye" min="0" step="0.01" value="100" required>
                                </div>
                                <div class="form-group">
                                    <label>Asil Onursal Aidatı (₺)</label>
                                    <input type="number" id="aidatAsilOnursal" min="0" step="0.01" value="0" required>
                                    <small style="color: #7f8c8d;">0 ise borçlandırılmaz</small>
                                </div>
                                <div class="form-group">
                                    <label>Öğrenci Üye Aidatı (₺)</label>
                                    <input type="number" id="aidatOgrenciUye" min="0" step="0.01" value="50" required>
                                </div>
                                <div class="form-group">
                                    <label>Fahri Üye Aidatı (₺)</label>
                                    <input type="number" id="aidatFahriUye" min="0" step="0.01" value="100" required>
                                </div>
                                <div class="form-group">
                                    <label>Fahri Onursal Aidatı (₺)</label>
                                    <input type="number" id="aidatFahriOnursal" min="0" step="0.01" value="0" required>
                                    <small style="color: #7f8c8d;">0 ise borçlandırılmaz</small>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveAidatSettings()" style="width: 100%; margin-top: 15px;">
                                <i class="fas fa-save"></i> Aidat Tutarlarını Kaydet
                            </button>
                        </form>
                        
                        <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid var(--tpjd-light);">
                            <h4 style="color: var(--tpjd-dark); margin-bottom: 15px;">
                                <i class="fas fa-calendar-check"></i> Otomatik Yıllık Borçlandırma
                            </h4>
                            <p style="margin: 10px 0; color: #7f8c8d; font-size: 14px;">
                                Tüm üyeleri yukarıdaki tutarlar üzerinden seçtiğiniz yıl için otomatik borçlandırın.
                            </p>
                            <div style="display: flex; gap: 15px; align-items: flex-end; margin-top: 15px;">
                                <div class="form-group" style="flex: 1;">
                                    <label>Borçlandırma Yılı</label>
                                    <input type="number" id="borclandirmaYili" min="2020" max="2050" required style="width: 100%;">
                                </div>
                                <button type="button" class="btn btn-warning" onclick="otomatikBorclandir()" style="flex: 2;">
                                    <i class="fas fa-calculator"></i> Otomatik Borçlandır
                                </button>
                            </div>
                            <div style="margin-top: 12px; padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 6px; border-left: 4px solid var(--tpjd-warning);">
                                <small style="color: var(--tpjd-warning); font-weight: 600;">
                                    <i class="fas fa-info-circle"></i> Not: Sadece "Aidat Aktif" üyeler borçlandırılacaktır. Aynı yıl için tekrar borçlandırma yapılamaz.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card success">
                        <h3><i class="fas fa-database"></i> Veri Yedekleme ve Geri Yükleme</h3>
                        <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                            Tüm verilerinizi JSON formatında yedekleyebilir veya daha önce yedeklediğiniz verileri geri yükleyebilirsiniz.
                        </p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="exportToJSON()" style="flex: 1; min-width: 200px;">
                                <i class="fas fa-download"></i> JSON İndir (Yedekle)
                            </button>
                            <button class="btn btn-info" onclick="document.getElementById('jsonFileInput').click()" style="flex: 1; min-width: 200px;">
                                <i class="fas fa-upload"></i> JSON Yükle (Geri Yükle)
                            </button>
                            <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="importFromJSON(event)">
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 6px; border-left: 4px solid var(--tpjd-warning);">
                            <small style="color: var(--tpjd-warning); font-weight: 600;">
                                <i class="fas fa-exclamation-triangle"></i> Uyarı: JSON yükleme işlemi mevcut tüm verilerin yerine geçecektir!
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification"></div>
    <!-- Member Modal -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Üye İşlemleri</h2>
                <span class="close" onclick="closeModal('memberModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="memberForm">
                    <input type="hidden" id="memberId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Üye No *</label>
                            <input type="text" id="memberNo" required placeholder="TPJD001">
                        </div>
                        <div class="form-group">
                            <label>Üyelik Tipi *</label>
                            <select id="membershipType" required onchange="updateMembershipType()">
                                <option value="">Seçiniz</option>
                                <option value="Asil Üye">Asil Üye</option>
                                <option value="Asil Onursal">Asil Onursal</option>
                                <option value="Öğrenci Üye">Öğrenci Üye</option>
                                <option value="Fahri Üye">Fahri Üye</option>
                                <option value="Fahri Onursal">Fahri Onursal</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ad *</label>
                            <input type="text" id="firstName" required placeholder="Ad">
                        </div>
                        <div class="form-group">
                            <label>Soyad *</label>
                            <input type="text" id="lastName" required placeholder="Soyad">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>TC Kimlik No *</label>
                            <input type="text" id="tcNo" required placeholder="12345678901" maxlength="11">
                        </div>
                        <div class="form-group">
                            <label>Cinsiyet *</label>
                            <select id="gender" required>
                                <option value="">Seçiniz</option>
                                <option value="Erkek">Erkek</option>
                                <option value="Kadın">Kadın</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Doğum Tarihi *</label>
                            <input type="date" id="birthDate" required>
                        </div>
                        <div class="form-group">
                            <label>Kan Grubu</label>
                            <select id="bloodType">
                                <option value="">Seçiniz</option>
                                <option value="A Rh+">A Rh+</option>
                                <option value="A Rh-">A Rh-</option>
                                <option value="B Rh+">B Rh+</option>
                                <option value="B Rh-">B Rh-</option>
                                <option value="AB Rh+">AB Rh+</option>
                                <option value="AB Rh-">AB Rh-</option>
                                <option value="0 Rh+">0 Rh+</option>
                                <option value="0 Rh-">0 Rh-</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>E-posta *</label>
                            <input type="email" id="email" required placeholder="ornek@email.com">
                        </div>
                        <div class="form-group">
                            <label>Telefon *</label>
                            <input type="tel" id="phone" required placeholder="+905551234567">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ev Telefonu</label>
                            <input type="tel" id="phoneHome" placeholder="+902121234567">
                        </div>
                        <div class="form-group">
                            <label>Medeni Durum</label>
                            <select id="maritalStatus">
                                <option value="">Seçiniz</option>
                                <option value="Bekar">Bekar</option>
                                <option value="Evli">Evli</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>İl *</label>
                            <input type="text" id="city" required placeholder="İl" list="cityList">
                            <datalist id="cityList">
                                <option value="Adana">
                                <option value="Adıyaman">
                                <option value="Afyonkarahisar">
                                <option value="Ağrı">
                                <option value="Aksaray">
                                <option value="Amasya">
                                <option value="Ankara">
                                <option value="Antalya">
                                <option value="Ardahan">
                                <option value="Artvin">
                                <option value="Aydın">
                                <option value="Balıkesir">
                                <option value="Bartın">
                                <option value="Batman">
                                <option value="Bayburt">
                                <option value="Bilecik">
                                <option value="Bingöl">
                                <option value="Bitlis">
                                <option value="Bolu">
                                <option value="Burdur">
                                <option value="Bursa">
                                <option value="Çanakkale">
                                <option value="Çankırı">
                                <option value="Çorum">
                                <option value="Denizli">
                                <option value="Diyarbakır">
                                <option value="Düzce">
                                <option value="Edirne">
                                <option value="Elazığ">
                                <option value="Erzincan">
                                <option value="Erzurum">
                                <option value="Eskişehir">
                                <option value="Gaziantep">
                                <option value="Giresun">
                                <option value="Gümüşhane">
                                <option value="Hakkari">
                                <option value="Hatay">
                                <option value="Iğdır">
                                <option value="Isparta">
                                <option value="İstanbul">
                                <option value="İzmir">
                                <option value="Kahramanmaraş">
                                <option value="Karabük">
                                <option value="Karaman">
                                <option value="Kars">
                                <option value="Kastamonu">
                                <option value="Kayseri">
                                <option value="Kırıkkale">
                                <option value="Kırklareli">
                                <option value="Kırşehir">
                                <option value="Kilis">
                                <option value="Kocaeli">
                                <option value="Konya">
                                <option value="Kütahya">
                                <option value="Malatya">
                                <option value="Manisa">
                                <option value="Mardin">
                                <option value="Mersin">
                                <option value="Muğla">
                                <option value="Muş">
                                <option value="Nevşehir">
                                <option value="Niğde">
                                <option value="Ordu">
                                <option value="Osmaniye">
                                <option value="Rize">
                                <option value="Sakarya">
                                <option value="Samsun">
                                <option value="Siirt">
                                <option value="Sinop">
                                <option value="Sivas">
                                <option value="Şanlıurfa">
                                <option value="Şırnak">
                                <option value="Tekirdağ">
                                <option value="Tokat">
                                <option value="Trabzon">
                                <option value="Tunceli">
                                <option value="Uşak">
                                <option value="Van">
                                <option value="Yalova">
                                <option value="Yozgat">
                                <option value="Zonguldak">
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label>İlçe</label>
                            <input type="text" id="district" placeholder="İlçe">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Mahalle</label>
                        <input type="text" id="neighborhood" placeholder="Mahalle">
                    </div>

                    <div class="form-group">
                        <label>Adres *</label>
                        <textarea id="address" required placeholder="Tam adres"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Baba Adı</label>
                            <input type="text" id="fatherName" placeholder="Baba adı">
                        </div>
                        <div class="form-group">
                            <label>Anne Adı</label>
                            <input type="text" id="motherName" placeholder="Anne adı">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Mezuniyet</label>
                            <input type="text" id="graduation" placeholder="Üniversite adı">
                        </div>
                        <div class="form-group">
                            <label>Mezuniyet Yılı</label>
                            <input type="text" id="graduationYear" placeholder="2020">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>İş Durumu</label>
                            <select id="employmentStatus">
                                <option value="">Seçiniz</option>
                                <option value="Çalışıyor">Çalışıyor</option>
                                <option value="Öğrenci">Öğrenci</option>
                                <option value="Emekli">Emekli</option>
                                <option value="İşsiz">İşsiz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>İş Yeri</label>
                            <input type="text" id="workplace" placeholder="Şirket adı">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Pozisyon</label>
                        <input type="text" id="position" placeholder="Ünvan">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Doğum Yeri (İl)</label>
                            <input type="text" id="birthCity" placeholder="İl">
                        </div>
                        <div class="form-group">
                            <label>Doğum Yeri (İlçe)</label>
                            <input type="text" id="birthDistrict" placeholder="İlçe">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Cilt No</label>
                            <input type="text" id="volumeNo" placeholder="Cilt No">
                        </div>
                        <div class="form-group">
                            <label>Aile Sıra No</label>
                            <input type="text" id="familyNo" placeholder="Aile Sıra No">
                        </div>
                        <div class="form-group">
                            <label>Sıra No</label>
                            <input type="text" id="lineNo" placeholder="Sıra No">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notlar</label>
                        <textarea id="notes" placeholder="Ek notlar"></textarea>
                    </div>
                    
                    <div class="form-group checkbox-inline">
                        <input type="checkbox" id="aidatAktif" checked>
                        <label for="aidatAktif">Aidat Aktif (Her yıl otomatik aidat borcu oluşturulacak)</label>
                    </div>
                    
                    <div class="form-group checkbox-inline">
                        <input type="checkbox" id="gecmisYillarBorclandir" onchange="toggleYearSelection()">
                        <label for="gecmisYillarBorclandir">Geçmiş Yıllardan Borçlandır</label>
                    </div>
                    
                    <div id="yearSelectionContainer" style="display: none;">
                        <div class="form-group">
                            <label>Borçlandırılacak Yılları Seçin:</label>
                            <div class="year-selection-grid" id="yearSelectionGrid">
                                <!-- Years will be dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('memberModal')">
                    <i class="fas fa-times"></i> İptal
                </button>
                <button type="button" class="btn btn-primary" onclick="saveMember()">
                    <i class="fas fa-save"></i> Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-money-bill-wave"></i> Ödeme İşlemleri</h2>
                <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <input type="hidden" id="paymentId">
                    
                    <div class="form-group">
                        <label>Üye Seçin *</label>
                        <select id="paymentMemberId" required onchange="updatePaymentAmount()">
                            <option value="">Üye seçiniz</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ödeme Tipi *</label>
                            <select id="paymentType" required>
                                <option value="aidat">Aidat</option>
                                <option value="bağış">Bağış</option>
                                <option value="diğer">Diğer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Yıl *</label>
                            <input type="number" id="paymentYear" required value="2025" min="2000" max="2100">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tutar (₺) *</label>
                            <input type="number" id="paymentAmount" required step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Tarih *</label>
                            <input type="date" id="paymentDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Fiş No</label>
                        <input type="text" id="receiptNo" placeholder="FİŞ001">
                    </div>

                    <div class="form-group">
                        <label>Açıklama *</label>
                        <textarea id="paymentDescription" required placeholder="Ödeme açıklaması"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Durum *</label>
                        <select id="paymentStatus" required>
                            <option value="tamamlandı">Tamamlandı</option>
                            <option value="bekliyor">Bekliyor</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">
                    <i class="fas fa-times"></i> İptal
                </button>
                <button type="button" class="btn btn-success" onclick="savePayment()">
                    <i class="fas fa-save"></i> Kaydet
                </button>
            </div>
        </div>
    </div>
    <!-- Notification Modal (UPDATED) -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-bell"></i> Bildirim Gönder</h2>
                <span class="close" onclick="closeModal('notificationModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="notificationForm">
                    <div class="form-group">
                        <label>Gönderim Türü *</label>
                        <select id="notificationType" required onchange="toggleRecipientSelection()">
                            <option value="">Seçiniz</option>
                            <option value="group">Hedef Grup</option>
                            <option value="individual">Bireysel</option>
                        </select>
                    </div>

                    <!-- Hedef Grup Seçimi -->
                    <div id="groupSelectionContainer" style="display: none;">
                        <div class="form-group">
                            <label>Hedef Grup *</label>
                            <select id="targetGroup">
                                <option value="all">Tüm Üyeler</option>
                                <option value="active">Aidat Aktif Üyeler</option>
                                <option value="inactive">Aidat Pasif Üyeler</option>
                                <option value="paid">Bu Yıl Ödeme Yapan Üyeler</option>
                                <option value="unpaid">Bu Yıl Ödeme Yapmayan Üyeler</option>
                                <option value="asil">Asil Üyeler</option>
                                <option value="asil-onursal">Asil Onursal Üyeler</option>
                                <option value="ogrenci">Öğrenci Üyeler</option>
                                <option value="fahri">Fahri Üyeler</option>
                                <option value="fahri-onursal">Fahri Onursal Üyeler</option>
                            </select>
                        </div>
                    </div>

                    <!-- Bireysel Üye Seçimi -->
                    <div id="individualSelectionContainer" style="display: none;">
                        <!-- Seçili üye gösterimi -->
                        <div id="preSelectedMemberInfo" style="display: none;">
                            <div class="form-group" style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid var(--tpjd-success);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-user-check" style="color: var(--tpjd-success);"></i>
                                    <strong>Seçili Üye</strong>
                                </label>
                                <div id="preSelectedMemberName" style="font-size: 16px; color: var(--tpjd-dark); font-weight: 600;"></div>
                                <button type="button" class="btn btn-secondary" onclick="changeNotificationRecipient()" 
                                        style="margin-top: 10px; padding: 5px 15px; font-size: 13px;">
                                    <i class="fas fa-exchange-alt"></i> Farklı Üye Seç
                                </button>
                            </div>
                        </div>
                        
                        <!-- Normal üye seçim alanı -->
                        <div id="normalMemberSelection">
                            <div class="form-group">
                                <label>Üye Ara</label>
                                <input type="text" id="memberSearchInput" placeholder="Üye adı, soyadı veya üye no ile ara..." 
                                       oninput="searchMemberForNotification()">
                            </div>
                            
                            <div class="form-group">
                                <label>Üye Seçin *</label>
                                <select id="individualMemberId" size="5" style="height: 150px;">
                                    <option value="">Üye seçiniz</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Bildirim Başlığı *</label>
                        <input type="text" id="notificationTitle" required placeholder="Bildirim başlığı">
                    </div>

                    <div class="form-group">
                        <label>Bildirim Mesajı *</label>
                        <textarea id="notificationMessage" required placeholder="Bildirim mesajı..." rows="6"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Öncelik</label>
                        <select id="notificationPriority">
                            <option value="normal">Normal</option>
                            <option value="high">Yüksek</option>
                            <option value="urgent">Acil</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 15px;">
                <!-- Bireysel Gönderim İçin Özel Butonlar -->
                <div id="individualSendButtons" style="display: none; width: 100%;">
                    <div style="width: 100%; padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196F3; margin-bottom: 15px;">
                        <strong style="color: #1565C0; font-size: 14px;">
                            <i class="fas fa-info-circle"></i> Bireysel İletişim
                        </strong>
                        <p style="margin: 8px 0 0 0; font-size: 13px; color: #1565C0;">
                            Mesajınız seçtiğiniz platforma yönlendirilecek. WhatsApp veya Telegram uygulamanız otomatik açılacak.
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; width: 100%;">
                        <button type="button" class="btn" onclick="sendViaWhatsAppIndividual()" 
                                style="background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fab fa-whatsapp" style="font-size: 20px;"></i>
                            <span>WhatsApp</span>
                        </button>
                        <button type="button" class="btn" onclick="sendViaTelegramIndividual()" 
                                style="background: #0088cc; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fab fa-telegram" style="font-size: 20px;"></i>
                            <span>Telegram</span>
                        </button>
                        <button type="button" class="btn" onclick="sendViaEmailIndividual()" 
                                style="background: #EA4335; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-envelope" style="font-size: 18px;"></i>
                            <span>E-posta</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')" 
                                style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-times"></i>
                            <span>İptal</span>
                        </button>
                    </div>
                </div>
                
                <!-- Grup Gönderimi İçin Normal Butonlar -->
                <div id="groupSendButtons" style="display: flex; gap: 10px; width: 100%;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')" style="flex: 1;">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendNotification()" style="flex: 2;">
                        <i class="fas fa-paper-plane"></i> Bildirim Gönder (Sistem Kaydı)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Email Modal -->
    <div id="bulkEmailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2><i class="fas fa-envelope"></i> Toplu E-posta Gönder</h2>
                <span class="close" onclick="closeBulkEmailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Hedef Grup *</label>
                    <select id="bulkEmailTarget" onchange="updateEmailPreview()">
                        <option value="">-- Seçiniz --</option>
                        <option value="all">Tüm Üyeler</option>
                        <option value="paid">Aidat Ödeyenler (2025)</option>
                        <option value="unpaid">Aidat Ödemeyenler (Borçlular)</option>
                    </select>
                </div>
                
                <!-- Önizleme Alanı -->
                <div id="emailPreviewSection" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--tpjd-info);">
                    <h4 style="margin: 0 0 10px 0; color: var(--tpjd-dark); font-size: 14px;">
                        <i class="fas fa-users"></i> Alıcılar
                    </h4>
                    <div id="emailRecipientCount" style="font-size: 16px; font-weight: 600; color: var(--tpjd-info); margin-bottom: 10px;"></div>
                    <details style="cursor: pointer;">
                        <summary style="color: var(--tpjd-primary); font-weight: 600; font-size: 13px;">E-posta adreslerini göster</summary>
                        <div id="emailRecipientList" style="max-height: 120px; overflow-y: auto; margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 12px; color: #666;"></div>
                    </details>
                </div>

                <div class="form-group">
                    <label>Konu *</label>
                    <input type="text" id="bulkEmailSubject" placeholder="E-posta konusu (örn: Aidat Hatırlatması)" maxlength="100">
                </div>

                <div class="form-group">
                    <label>Mesaj *</label>
                    <textarea id="bulkEmailMessage" placeholder="E-posta mesajınızı buraya yazın..." rows="6" maxlength="2000"></textarea>
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> Not: Çok uzun mesajlar mail programlarında kesilme yapabilir.
                    </small>
                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 15px;">
                <div style="width: 100%; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <strong style="color: #856404; font-size: 14px;">
                        <i class="fas fa-exclamation-triangle"></i> Nasıl Çalışır?
                    </strong>
                    <p style="margin: 8px 0 0 0; font-size: 13px; color: #856404;">
                        Butona tıkladığınızda mail programınız otomatik açılacak. Alıcılar <strong>BCC</strong> (gizli alıcı) olarak eklenecek böylece kimse birbirinin mailine erişemez.
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; width: 100%; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="closeBulkEmailModal()" style="flex: 1; min-width: 140px;">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="button" class="btn" onclick="sendViaGmail()" style="flex: 1; min-width: 140px; background: #EA4335; color: white;">
                        <i class="fab fa-google"></i> Gmail'den Gönder
                    </button>
                    <button type="button" class="btn" onclick="sendViaOutlook()" style="flex: 1; min-width: 140px; background: #0078D4; color: white;">
                        <i class="fab fa-microsoft"></i> Outlook'tan Gönder
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendViaDefaultMail()" style="flex: 1; min-width: 140px;">
                        <i class="fas fa-envelope"></i> Varsayılan Mail
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Detail Modal (UPDATED WITH NOTIFICATION BUTTON) -->
    <div id="memberDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user"></i> Üye Detayları</h2>
                <span class="close" onclick="closeModal('memberDetailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="memberDetailContent">
                    <!-- Member details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('memberDetailModal')">
                    <i class="fas fa-times"></i> Kapat
                </button>
                <button type="button" class="btn btn-primary" onclick="addPaymentForCurrentMember()" title="Bu üye için ödeme ekle">
                    <i class="fas fa-plus-circle"></i> Ödeme Ekle
                </button>
                <button type="button" class="btn btn-warning" onclick="sendNotificationToCurrentMember()">
                    <i class="fas fa-bell"></i> Bildirim Gönder
                </button>
                <button type="button" class="btn btn-success" onclick="downloadMemberDetail()" id="downloadDetailBtn">
                    <i class="fas fa-download"></i> HTML İndir
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let members = [];
        let payments = [];
        let notifications = [];
        let currentMemberId = null;
        let paymentDonutChart = null;
        let membershipDonutChart = null;
        
        // Aidat tutarları (varsayılan değerler)
        let aidatSettings = {
            'Asil Üye': 100,
            'Asil Onursal': 0,
            'Öğrenci Üye': 50,
            'Fahri Üye': 100,
            'Fahri Onursal': 0
        };

        // Get credentials from localStorage or use defaults
        function getCredentials() {
            const username = localStorage.getItem('tpjd_username') || 'admin';
            const password = localStorage.getItem('tpjd_password') || 'admin123';
            return { username, password };
        }

        // Login function
        function login(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const credentials = getCredentials();
            
            if (username === credentials.username && password === credentials.password) {
                localStorage.setItem('tpjd_logged_in', 'true');
                document.getElementById('loginError').classList.remove('show');
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').classList.add('show');
                
                // Load data after login
                loadMembers();
                loadPayments();
                loadNotifications();
                updateDashboard();
                updateSettingsInfo();
                initializeDonutCharts();
                
                // Otomatik yıllık borçlandırma DEVRE DIŞI
                // checkAndCreateYearlyDebts(); // Manuel borçlandırma için Ayarlar'ı kullanın
            } else {
                document.getElementById('loginError').classList.add('show');
            }
        }

        // Logout function
        function logout() {
            if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                localStorage.removeItem('tpjd_logged_in');
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainApp').classList.remove('show');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').classList.remove('show');
            }
        }

        // Change password function
        function changePassword() {
            const currentPasswordCheck = document.getElementById('currentPasswordCheck').value;
            const newUsername = document.getElementById('newUsername').value;
            const newPassword = document.getElementById('newPassword').value;
            const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;
            
            const credentials = getCredentials();
            
            // Check current password
            if (currentPasswordCheck !== credentials.password) {
                showNotification('Mevcut şifre hatalı!', 'error');
                return;
            }
            
            // Validate new password
            if (newPassword.length < 6) {
                showNotification('Yeni şifre en az 6 karakter olmalıdır!', 'warning');
                return;
            }
            
            // Check password confirmation
            if (newPassword !== newPasswordConfirm) {
                showNotification('Yeni şifreler eşleşmiyor!', 'warning');
                return;
            }
            
            // Validate username
            if (newUsername.length < 3) {
                showNotification('Kullanıcı adı en az 3 karakter olmalıdır!', 'warning');
                return;
            }
            
            // Save new credentials
            localStorage.setItem('tpjd_username', newUsername);
            localStorage.setItem('tpjd_password', newPassword);
            
            // Clear form
            document.getElementById('currentPasswordCheck').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newPasswordConfirm').value = '';
            document.getElementById('currentUsername').value = newUsername;
            document.getElementById('newUsername').value = newUsername;
            
            showNotification('Kullanıcı adı ve şifre başarıyla değiştirildi!', 'success');
        }

        // Update settings info
        function updateSettingsInfo() {
            const credentials = getCredentials();
            document.getElementById('currentUsername').value = credentials.username;
            document.getElementById('newUsername').value = credentials.username;
            
            document.getElementById('settingsTotalMembers').textContent = members.length;
            document.getElementById('settingsTotalPayments').textContent = payments.length;
            
            // Load aidat settings
            loadAidatSettingsToForm();
        }
        
        // Aidat Ayarları Fonksiyonları
        function saveAidatSettings() {
            const settings = {
                'Asil Üye': parseFloat(document.getElementById('aidatAsilUye').value),
                'Asil Onursal': parseFloat(document.getElementById('aidatAsilOnursal').value),
                'Öğrenci Üye': parseFloat(document.getElementById('aidatOgrenciUye').value),
                'Fahri Üye': parseFloat(document.getElementById('aidatFahriUye').value),
                'Fahri Onursal': parseFloat(document.getElementById('aidatFahriOnursal').value)
            };
            
            aidatSettings = settings;
            localStorage.setItem('tpjd_aidat_settings', JSON.stringify(settings));
            
            showNotification('✅ Aidat tutarları başarıyla kaydedildi!', 'success');
        }
        
        function loadAidatSettings() {
            const saved = localStorage.getItem('tpjd_aidat_settings');
            if (saved) {
                aidatSettings = JSON.parse(saved);
            }
        }
        
        function loadAidatSettingsToForm() {
            document.getElementById('aidatAsilUye').value = aidatSettings['Asil Üye'] || 100;
            document.getElementById('aidatAsilOnursal').value = aidatSettings['Asil Onursal'] || 0;
            document.getElementById('aidatOgrenciUye').value = aidatSettings['Öğrenci Üye'] || 50;
            document.getElementById('aidatFahriUye').value = aidatSettings['Fahri Üye'] || 100;
            document.getElementById('aidatFahriOnursal').value = aidatSettings['Fahri Onursal'] || 0;
            
            // Set current year as default
            const currentYear = new Date().getFullYear();
            document.getElementById('borclandirmaYili').value = currentYear;
        }
        
        function otomatikBorclandir() {
            const year = parseInt(document.getElementById('borclandirmaYili').value);
            
            if (!year || year < 2020 || year > 2050) {
                showNotification('Lütfen geçerli bir yıl girin!', 'warning');
                return;
            }
            
            // Check if year already charged
            const existingDebts = payments.filter(p => p.type === 'aidat' && p.year === year);
            if (existingDebts.length > 0) {
                if (!confirm(`${year} yılı için ${existingDebts.length} adet aidat kaydı bulundu. Yine de devam etmek istiyor musunuz?`)) {
                    return;
                }
            }
            
            if (!confirm(`Tüm "Aidat Aktif" üyeleri ${year} yılı için borçlandırmak istediğinizden emin misiniz?`)) {
                return;
            }
            
            let borclandirilanSayisi = 0;
            let atlananSayisi = 0;
            
            members.forEach(member => {
                // Sadece aidat aktif üyeleri borçlandır
                if (!member.aidatAktif) {
                    atlananSayisi++;
                    return;
                }
                
                // Üyelik tipine göre aidat tutarını al
                const aidatTutari = aidatSettings[member.membershipType];
                
                // Eğer aidat tutarı 0 ise borçlandırma
                if (!aidatTutari || aidatTutari === 0) {
                    atlananSayisi++;
                    return;
                }
                
                // Aynı yıl için zaten borç var mı kontrol et
                const existingDebt = payments.find(p => 
                    p.memberId === member.id && 
                    p.type === 'aidat' && 
                    p.year === year
                );
                
                if (existingDebt) {
                    atlananSayisi++;
                    return;
                }
                
                // Yeni ödeme kaydı oluştur
                const newPayment = {
                    id: generateId(),
                    memberId: member.id,
                    amount: aidatTutari,
                    type: 'aidat',
                    date: `${year}-01-01`,
                    year: year,
                    receiptNo: '',
                    description: `${year} yılı ${member.membershipType} aidatı`,
                    status: 'bekliyor',
                    createdAt: new Date().toISOString()
                };
                
                payments.push(newPayment);
                borclandirilanSayisi++;
            });
            
            // Verileri kaydet
            savePayments();
            
            // UI güncellemeleri
            loadPaymentsTable();
            updateDashboard();
            updateDonutCharts();
            
            showNotification(
                `✅ Otomatik borçlandırma tamamlandı!\n${borclandirilanSayisi} üye borçlandırıldı, ${atlananSayisi} üye atlandı.`,
                'success'
            );
        }

        // Check authentication
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('tpjd_logged_in');
            if (isLoggedIn === 'true') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').classList.add('show');
            } else {
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainApp').classList.remove('show');
            }
        }

        // Initialize
        
        // ⭐ Duplikat borç kayıtlarını temizle (Tek seferlik temizlik)
        function cleanDuplicateDebts() {
            let cleanedCount = 0;
            
            // Tüm "tamamlandı" aidat ödemelerini al
            const completedPayments = payments.filter(p => 
                p.type === 'aidat' && 
                p.status === 'tamamlandı'
            );
            
            // Her tamamlanmış ödeme için, aynı yıl için bekleyen borç kaydı var mı kontrol et
            completedPayments.forEach(completedPayment => {
                const duplicateDebts = payments.filter(p => 
                    p.id !== completedPayment.id && // Kendisi değil
                    p.memberId === completedPayment.memberId && 
                    p.year === completedPayment.year && 
                    p.type === 'aidat' && 
                    p.status === 'bekliyor'
                );
                
                if (duplicateDebts.length > 0) {
                    // Duplikat borç kayıtlarını sil
                    payments = payments.filter(p => !duplicateDebts.some(d => d.id === p.id));
                    cleanedCount += duplicateDebts.length;
                }
            });
            
            // Eğer temizlik yapıldıysa kaydet
            if (cleanedCount > 0) {
                savePayments();
                console.log(`✅ ${cleanedCount} adet duplikat borç kaydı temizlendi!`);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadMembers();
            loadPayments();
            loadNotifications();
            loadAidatSettings();
            
            // ⭐ Mevcut verilerdeki duplikat borç kayıtlarını temizle
            cleanDuplicateDebts();
            
            updateDashboard();
            setDefaultDate();
            generateYearSelection();
            
            // Initialize chart only if logged in
            const isLoggedIn = localStorage.getItem('tpjd_logged_in');
            if (isLoggedIn === 'true') {
                initializeDonutCharts();
                updateSettingsInfo();
                // Otomatik yıllık borçlandırma DEVRE DIŞI
                // checkAndCreateYearlyDebts(); // Manuel borçlandırma için Ayarlar'ı kullanın
            }
            
            // Fix tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    const tabName = this.getAttribute('onclick').match(/switchTab\('([^']+)'/)[1];
                    switchTab(tabName, e);
                });
            });
        });

        // Tab switching
        function switchTab(tabName, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.currentTarget.classList.add('active');
            
            // Reload data based on tab
            if (tabName === 'members') loadMembersTable();
            if (tabName === 'payments') loadPaymentsTable();
            if (tabName === 'notifications') loadNotifications();
            if (tabName === 'settings') updateSettingsInfo();
            if (tabName === 'dashboard') {
                updateDashboard();
                updateDonutCharts();
            }
        }

        // Generate ID
        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // Set default date
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['paymentDate', 'transactionDate'];
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = today;
            });
        }
        
        // Generate year selection checkboxes
        function generateYearSelection() {
            const container = document.getElementById('yearSelectionGrid');
            const currentYear = new Date().getFullYear();
            const startYear = 2000;
            
            container.innerHTML = '';
            
            for (let year = startYear; year < currentYear; year++) {
                const div = document.createElement('div');
                div.className = 'year-checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="year${year}" value="${year}">
                    <label for="year${year}">${year}</label>
                `;
                container.appendChild(div);
            }
        }
        
        // Toggle year selection
        function toggleYearSelection() {
            const checkbox = document.getElementById('gecmisYillarBorclandir');
            const container = document.getElementById('yearSelectionContainer');
            container.style.display = checkbox.checked ? 'block' : 'none';
        }
        
        // Update aidat amount based on membership type
        function updateAidatAmount() {
            const membershipType = document.getElementById('membershipType').value;
            const paymentAmountInput = document.getElementById('paymentAmount');
            
            if (paymentAmountInput) {
                if (membershipType === 'Öğrenci Üye') {
                    paymentAmountInput.value = '50.00';
                } else if (membershipType === 'Asil Üye') {
                    paymentAmountInput.value = '100.00';
                } else {
                    paymentAmountInput.value = '0.00';
                }
            }
        }
        
        // Update payment amount when member is selected
        function updatePaymentAmount() {
            const memberId = document.getElementById('paymentMemberId').value;
            const member = members.find(m => m.id === memberId);
            
            if (member) {
                if (member.membershipType === 'Öğrenci Üye') {
                    document.getElementById('paymentAmount').value = '50.00';
                } else if (member.membershipType === 'Asil Üye') {
                    document.getElementById('paymentAmount').value = '100.00';
                } else {
                    document.getElementById('paymentAmount').value = '0.00';
                }
            }
        }

        // Send notification to current member (NEW FUNCTION)
        function sendNotificationToCurrentMember() {
            if (!currentMemberId) {
                showNotification('Lütfen bir üye seçin!', 'warning');
                return;
            }
            
            const member = members.find(m => m.id === currentMemberId);
            if (!member) {
                showNotification('Üye bulunamadı!', 'error');
                return;
            }
            
            closeModal('memberDetailModal');
            
            // Open notification modal with individual type pre-selected
            openModal('notificationModal');
            document.getElementById('notificationType').value = 'individual';
            toggleRecipientSelection();
            
            // Show pre-selected member info and hide normal selection
            document.getElementById('preSelectedMemberInfo').style.display = 'block';
            document.getElementById('normalMemberSelection').style.display = 'none';
            document.getElementById('preSelectedMemberName').textContent = 
                `${member.memberNo} - ${member.firstName} ${member.lastName}`;
            
            // Set the member ID in hidden way
            document.getElementById('individualMemberId').innerHTML = 
                `<option value="${member.id}" selected>${member.memberNo} - ${member.firstName} ${member.lastName}</option>`;
        }
        
        // Change notification recipient
        function changeNotificationRecipient() {
            document.getElementById('preSelectedMemberInfo').style.display = 'none';
            document.getElementById('normalMemberSelection').style.display = 'block';
            populateIndividualMemberSelect();
        }
        
        // Add payment for current member (Borçlu detayından)
        function addPaymentForCurrentMember() {
            if (!currentMemberId) {
                showNotification('Lütfen bir üye seçin!', 'warning');
                return;
            }
            
            const member = members.find(m => m.id === currentMemberId);
            if (!member) {
                showNotification('Üye bulunamadı!', 'error');
                return;
            }
            
            // Detay modalını kapat
            closeModal('memberDetailModal');
            
            // Ödeme modalını aç
            openModal('paymentModal');
            
            // Üyeyi seç
            populateMemberSelect();
            document.getElementById('paymentMemberId').value = member.id;
            
            // Varsayılan değerler
            const currentYear = new Date().getFullYear();
            document.getElementById('paymentYear').value = currentYear;
            document.getElementById('paymentType').value = 'aidat';
            document.getElementById('paymentStatus').value = 'tamamlandı';
            
            // Aidat tutarını otomatik doldur
            updatePaymentAmount();
            
            showNotification(`${member.firstName} ${member.lastName} için ödeme ekleniyor...`, 'info');
        }
        
        // Quick pay debt - Detay sayfasından hızlı ödeme
        function quickPayDebt(paymentId) {
            // Bekleyen ödemeyi bul
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) {
                showNotification('Ödeme kaydı bulunamadı!', 'error');
                return;
            }
            
            if (payment.status !== 'bekliyor') {
                showNotification('Bu ödeme zaten tamamlanmış!', 'warning');
                return;
            }
            
            // Üyeyi bul
            const member = members.find(m => m.id === payment.memberId);
            if (!member) {
                showNotification('Üye bulunamadı!', 'error');
                return;
            }
            
            // Detay modalını kapat
            closeModal('memberDetailModal');
            
            // Ödeme modalını aç
            openModal('paymentModal');
            
            // Formu doldur - BEKLEYEN ÖDEMEYİ DÜZENLİYORUZ
            document.getElementById('paymentId').value = payment.id; // ← Önemli: Mevcut ID
            
            // Üye listesini doldur ve seç
            populateMemberSelect();
            document.getElementById('paymentMemberId').value = payment.memberId;
            
            // Diğer alanları doldur
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentType').value = payment.type;
            document.getElementById('paymentYear').value = payment.year;
            document.getElementById('paymentDescription').value = payment.description;
            document.getElementById('paymentStatus').value = 'tamamlandı'; // Ödeme yapılacak
            
            // Bugünün tarihini set et
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
            
            // Fiş no alanına focus
            setTimeout(() => {
                document.getElementById('receiptNo')?.focus();
            }, 300);
            
            showNotification(`💳 ${member.firstName} ${member.lastName} - ${payment.year} yılı ödeme yapılıyor...`, 'info');
        }
        
// Initialize Donut Charts
        function initializeDonutCharts() {
            // Payment Donut Chart
            const paymentCtx = document.getElementById('paymentDonutChart');
            if (!paymentCtx) return;
            
            paymentDonutChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ödeme Yapan', 'Ödeme Beklenen'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            '#10b981',  // Modern yeşil (Ödeme Yapan)
                            '#f59e0b'   // Modern amber (Ödeme Beklenen)
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} üye (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Membership Type Donut Chart
            const membershipCtx = document.getElementById('membershipDonutChart');
            if (!membershipCtx) return;
            
            membershipDonutChart = new Chart(membershipCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Asil Üye', 'Asil Onursal', 'Öğrenci Üye', 'Fahri Üye', 'Fahri Onursal'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#3b82f6',  // Modern mavi (Asil Üye)
                            '#8b5cf6',  // Modern mor (Asil Onursal)
                            '#ef4444',  // Modern kırmızı (Öğrenci Üye)
                            '#f59e0b',  // Modern amber (Fahri Üye)
                            '#ec4899'   // Modern pembe (Fahri Onursal)
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} üye (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            updateDonutCharts();
        }
        
        // Update Donut Charts
        function updateDonutCharts() {
            if (!paymentDonutChart || !membershipDonutChart) return;
            
            const currentYear = new Date().getFullYear();
            let paidCount = 0;
            let unpaidCount = 0;
            
            // Sadece aktif ve pasif üyeleri say (ayrılanları dahil etme)
            const activeMembers = members.filter(m => m.membershipStatus !== 'ayrıldı');
            
            // Update payment chart
            activeMembers.forEach(member => {
                const hasPaid = payments.some(p => 
                    p.memberId === member.id && 
                    p.type === 'aidat' && 
                    p.year == currentYear && 
                    p.status === 'tamamlandı'
                );
                
                const hasDebt = payments.some(p => 
                    p.memberId === member.id && 
                    p.type === 'aidat' && 
                    p.status === 'bekliyor'
                );
                
                if (hasPaid) {
                    paidCount++;
                } else if (hasDebt) {
                    unpaidCount++;
                }
            });
            
            paymentDonutChart.data.datasets[0].data = [paidCount, unpaidCount];
            paymentDonutChart.update();
            
            // Update membership type chart (sadece aktif üyeler)
            const membershipCounts = {
                'Asil Üye': 0,
                'Asil Onursal': 0,
                'Öğrenci Üye': 0,
                'Fahri Üye': 0,
                'Fahri Onursal': 0
            };
            
            activeMembers.forEach(member => {
                if (membershipCounts.hasOwnProperty(member.membershipType)) {
                    membershipCounts[member.membershipType]++;
                }
            });
            
            membershipDonutChart.data.datasets[0].data = [
                membershipCounts['Asil Üye'],
                membershipCounts['Asil Onursal'],
                membershipCounts['Öğrenci Üye'],
                membershipCounts['Fahri Üye'],
                membershipCounts['Fahri Onursal']
            ];
            membershipDonutChart.update();
        }

        // LocalStorage functions
        function saveMembers() {
            localStorage.setItem('tpjd_members', JSON.stringify(members));
        }

        function loadMembers() {
            const stored = localStorage.getItem('tpjd_members');
            members = stored ? JSON.parse(stored) : [];
        }

        function savePayments() {
            localStorage.setItem('tpjd_payments', JSON.stringify(payments));
        }

        function loadPayments() {
            const stored = localStorage.getItem('tpjd_payments');
            payments = stored ? JSON.parse(stored) : [];
        }

        function saveNotifications() {
            localStorage.setItem('tpjd_notifications', JSON.stringify(notifications));
        }

        function loadNotifications() {
            const stored = localStorage.getItem('tpjd_notifications');
            notifications = stored ? JSON.parse(stored) : [];
            displayNotifications();
        }

        // Update membership type - Auto set aidat status
        function updateMembershipType() {
            const membershipType = document.getElementById('membershipType').value;
            const aidatAktifCheckbox = document.getElementById('aidatAktif');
            
            // Asil Onursal veya Fahri Onursal seçilirse aidat pasif olsun
            if (membershipType === 'Asil Onursal' || membershipType === 'Fahri Onursal') {
                aidatAktifCheckbox.checked = false;
            } else {
                // Diğer üyelik tipleri için aktif yap
                aidatAktifCheckbox.checked = true;
            }
        }

        // Toggle notification recipient selection
        function toggleRecipientSelection() {
            const notificationType = document.getElementById('notificationType').value;
            const groupContainer = document.getElementById('groupSelectionContainer');
            const individualContainer = document.getElementById('individualSelectionContainer');
            const individualButtons = document.getElementById('individualSendButtons');
            const groupButtons = document.getElementById('groupSendButtons');
            
            if (notificationType === 'group') {
                groupContainer.style.display = 'block';
                individualContainer.style.display = 'none';
                individualButtons.style.display = 'none';
                groupButtons.style.display = 'flex';
            } else if (notificationType === 'individual') {
                groupContainer.style.display = 'none';
                individualContainer.style.display = 'block';
                individualButtons.style.display = 'block';
                groupButtons.style.display = 'none';
                populateIndividualMemberSelect();
            } else {
                groupContainer.style.display = 'none';
                individualContainer.style.display = 'none';
                individualButtons.style.display = 'none';
                groupButtons.style.display = 'flex';
            }
        }

        // Populate individual member select
        function populateIndividualMemberSelect(searchTerm = '') {
            const select = document.getElementById('individualMemberId');
            select.innerHTML = '<option value="">Üye seçiniz</option>';
            
            let filteredMembers = members;
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredMembers = members.filter(member => 
                    member.firstName.toLowerCase().includes(term) ||
                    member.lastName.toLowerCase().includes(term) ||
                    member.memberNo.toLowerCase().includes(term)
                );
            }
            
            filteredMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.memberNo} - ${member.firstName} ${member.lastName}`;
                select.appendChild(option);
            });
        }

        // Search member for notification
        function searchMemberForNotification() {
            const searchTerm = document.getElementById('memberSearchInput').value;
            populateIndividualMemberSelect(searchTerm);
        }

        // Send notification
        function sendNotification() {
            const notificationType = document.getElementById('notificationType').value;
            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;
            const priority = document.getElementById('notificationPriority').value;
            
            // Validate required fields with specific error messages
            if (!notificationType) {
                showNotification('Lütfen gönderim türünü seçin!', 'warning');
                return;
            }
            
            if (!title) {
                showNotification('Lütfen bildirim başlığını girin!', 'warning');
                return;
            }
            
            if (!message) {
                showNotification('Lütfen bildirim mesajını girin!', 'warning');
                return;
            }
            
            let recipientIds = [];
            let recipientCount = 0;
            
            if (notificationType === 'group') {
                const targetGroup = document.getElementById('targetGroup').value;
                if (!targetGroup) {
                    showNotification('Lütfen hedef grubu seçin!', 'warning');
                    return;
                }
                recipientIds = getGroupMemberIds(targetGroup);
                recipientCount = recipientIds.length;
            } else if (notificationType === 'individual') {
                const memberId = document.getElementById('individualMemberId').value;
                if (!memberId) {
                    showNotification('Lütfen bir üye seçin!', 'warning');
                    return;
                }
                recipientIds = [memberId];
                recipientCount = 1;
            }
            
            if (recipientIds.length === 0) {
                showNotification('Bildirim gönderilecek üye bulunamadı!', 'warning');
                return;
            }
            
            // Create notification for each recipient
            recipientIds.forEach(memberId => {
                const member = members.find(m => m.id === memberId);
                if (!member) return;
                
                const notification = {
                    id: generateId(),
                    memberId: memberId,
                    memberName: `${member.firstName} ${member.lastName}`,
                    title: title,
                    message: message,
                    priority: priority,
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('tr-TR'),
                    status: 'gönderildi',
                    createdAt: new Date().toISOString()
                };
                
                notifications.push(notification);
            });
            
            saveNotifications();
            displayNotifications();
            closeModal('notificationModal');
            showNotification(`${recipientCount} üyeye bildirim başarıyla gönderildi!`, 'success');
        }

        // Get group member IDs based on target group
        function getGroupMemberIds(targetGroup) {
            const currentYear = new Date().getFullYear();
            
            switch(targetGroup) {
                case 'all':
                    return members.map(m => m.id);
                    
                case 'active':
                    return members.filter(m => m.aidatAktif).map(m => m.id);
                    
                case 'inactive':
                    return members.filter(m => !m.aidatAktif).map(m => m.id);
                    
                case 'paid':
                    return members.filter(m => {
                        return payments.some(p => 
                            p.memberId === m.id && 
                            p.type === 'aidat' && 
                            p.year == currentYear && 
                            p.status === 'tamamlandı'
                        );
                    }).map(m => m.id);
                    
                case 'unpaid':
                    return members.filter(m => {
                        const hasPaid = payments.some(p => 
                            p.memberId === m.id && 
                            p.type === 'aidat' && 
                            p.year == currentYear && 
                            p.status === 'tamamlandı'
                        );
                        return !hasPaid && m.aidatAktif;
                    }).map(m => m.id);
                    
                case 'asil':
                    return members.filter(m => m.membershipType === 'Asil Üye').map(m => m.id);
                    
                case 'asil-onursal':
                    return members.filter(m => m.membershipType === 'Asil Onursal').map(m => m.id);
                    
                case 'ogrenci':
                    return members.filter(m => m.membershipType === 'Öğrenci Üye').map(m => m.id);
                    
                case 'fahri':
                    return members.filter(m => m.membershipType === 'Fahri Üye').map(m => m.id);
                    
                case 'fahri-onursal':
                    return members.filter(m => m.membershipType === 'Fahri Onursal').map(m => m.id);
                    
                default:
                    return [];
            }
        }
        
        // BİREYSEL İLETİŞİM FONKSİYONLARI
        
        // Bireysel bildirim validasyonu
        function validateIndividualNotification() {
            const title = document.getElementById('notificationTitle').value.trim();
            const message = document.getElementById('notificationMessage').value.trim();
            const memberId = document.getElementById('individualMemberId').value;
            
            if (!title) {
                showNotification('Lütfen bildirim başlığı girin!', 'warning');
                return null;
            }
            
            if (!message) {
                showNotification('Lütfen mesaj girin!', 'warning');
                return null;
            }
            
            if (!memberId) {
                showNotification('Lütfen bir üye seçin!', 'warning');
                return null;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showNotification('Üye bulunamadı!', 'error');
                return null;
            }
            
            return { title, message, member };
        }
        
        // WhatsApp'tan bireysel gönder
        function sendViaWhatsAppIndividual() {
            const data = validateIndividualNotification();
            if (!data) return;
            
            // Telefon numarasını kontrol et
            if (!data.member.phone || data.member.phone.trim() === '') {
                showNotification('Bu üyenin telefon numarası kayıtlı değil!', 'error');
                return;
            }
            
            // Telefon numarasını temizle (sadece rakamlar)
            let phone = data.member.phone.replace(/\D/g, '');
            
            // Türkiye ülke kodu ekle (90) eğer yoksa
            if (!phone.startsWith('90')) {
                phone = '90' + phone;
            }
            
            // Mesajı hazırla
            const fullMessage = `*${data.title}*\n\n${data.message}\n\n_TPJD Yönetimi_`;
            const encodedMessage = encodeURIComponent(fullMessage);
            
            // WhatsApp URL
            const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
            
            // Onay iste
            if (!confirm(`${data.member.firstName} ${data.member.lastName} isimli üyeye WhatsApp üzerinden mesaj göndermek üzeresiniz.\n\nTelefon: ${data.member.phone}\n\nDevam etmek istiyor musunuz?`)) {
                return;
            }
            
            // WhatsApp'ı aç
            window.open(whatsappUrl, '_blank');
            
            // Bildirim kaydet
            saveIndividualNotification(data.member, data.title, data.message, 'WhatsApp');
            
            closeModal('notificationModal');
            showNotification(`✅ WhatsApp açıldı! ${data.member.firstName} ${data.member.lastName}'a mesaj gönderin.`, 'success');
        }
        
        // Telegram'dan bireysel gönder
        function sendViaTelegramIndividual() {
            const data = validateIndividualNotification();
            if (!data) return;
            
            // Telefon numarasını kontrol et
            if (!data.member.phone || data.member.phone.trim() === '') {
                showNotification('Bu üyenin telefon numarası kayıtlı değil!', 'error');
                return;
            }
            
            // Telefon numarasını temizle
            let phone = data.member.phone.replace(/\D/g, '');
            
            // Türkiye ülke kodu ekle
            if (!phone.startsWith('90')) {
                phone = '90' + phone;
            }
            
            // Mesajı hazırla
            const fullMessage = `*${data.title}*\n\n${data.message}\n\n_TPJD Yönetimi_`;
            const encodedMessage = encodeURIComponent(fullMessage);
            
            // Telegram URL (telefon ile)
            const telegramUrl = `https://t.me/+${phone}`;
            
            // Bilgi mesajı
            alert(`Telegram açılacak. Lütfen şu kişiye mesaj gönderin:\n\n${data.member.firstName} ${data.member.lastName}\nTelefon: +${phone}\n\nMesajınız:\n${fullMessage}`);
            
            // Telegram'ı aç
            window.open(telegramUrl, '_blank');
            
            // Bildirim kaydet
            saveIndividualNotification(data.member, data.title, data.message, 'Telegram');
            
            closeModal('notificationModal');
            showNotification(`✅ Telegram açıldı! Kişiyi bulup mesaj gönderin.`, 'info');
        }
        
        // E-posta ile bireysel gönder
        function sendViaEmailIndividual() {
            const data = validateIndividualNotification();
            if (!data) return;
            
            // E-posta adresini kontrol et
            if (!data.member.email || data.member.email.trim() === '') {
                showNotification('Bu üyenin e-posta adresi kayıtlı değil!', 'error');
                return;
            }
            
            const email = data.member.email.trim();
            const subject = encodeURIComponent(data.title);
            const body = encodeURIComponent(`${data.message}\n\n---\nTPJD Yönetimi`);
            
            // Mailto URL
            const mailtoUrl = `mailto:${email}?subject=${subject}&body=${body}`;
            
            // Onay iste
            if (!confirm(`${data.member.firstName} ${data.member.lastName} isimli üyeye e-posta göndermek üzeresiniz.\n\nE-posta: ${email}\n\nDevam etmek istiyor musunuz?`)) {
                return;
            }
            
            // Mail programını aç
            window.location.href = mailtoUrl;
            
            // Bildirim kaydet
            saveIndividualNotification(data.member, data.title, data.message, 'E-posta');
            
            // Kısa gecikme ile modal'ı kapat
            setTimeout(() => {
                closeModal('notificationModal');
                showNotification(`✅ Mail programınız açıldı! ${data.member.firstName} ${data.member.lastName}'a e-posta gönderin.`, 'success');
            }, 500);
        }
        
        // Bireysel bildirim kaydını oluştur
        function saveIndividualNotification(member, title, message, method) {
            const notification = {
                id: generateId(),
                memberId: member.id,
                memberName: `${member.firstName} ${member.lastName}`,
                title: `${title} (${method})`,
                message: message,
                priority: 'normal',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('tr-TR'),
                status: 'gönderildi',
                createdAt: new Date().toISOString()
            };
            
            notifications.push(notification);
            saveNotifications();
            displayNotifications();
        }

        // Check and create yearly debts (call this on page load or manually)
        function checkAndCreateYearlyDebts() {
            const currentYear = new Date().getFullYear();
            const lastDebtYear = localStorage.getItem('tpjd_last_debt_year');
            
            // If it's a new year and we haven't created debts yet
            if (lastDebtYear != currentYear) {
                let debtCount = 0;
                
                members.forEach(member => {
                    // Only create debt if aidat is active
                    if (member.aidatAktif) {
                        // Check if debt already exists for this year
                        const debtExists = payments.some(p => 
                            p.memberId === member.id && 
                            p.type === 'aidat' && 
                            p.year == currentYear
                        );
                        
                        if (!debtExists) {
                            createAidatDebt(member.id, currentYear);
                            debtCount++;
                        }
                    }
                });
                
                localStorage.setItem('tpjd_last_debt_year', currentYear);
                
                if (debtCount > 0) {
                    showNotification(`${currentYear} yılı için ${debtCount} üyeye aidat borcu oluşturuldu.`, 'info');
                }
            }
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            
            if (modalId === 'memberModal') {
                document.getElementById('memberForm').reset();
                document.getElementById('memberId').value = '';
                document.getElementById('aidatAktif').checked = true;
                document.getElementById('gecmisYillarBorclandir').checked = false;
                toggleYearSelection();
            } else if (modalId === 'paymentModal') {
                document.getElementById('paymentForm').reset();
                document.getElementById('paymentId').value = '';
                populateMemberSelect();
                setDefaultDate();
            } else if (modalId === 'notificationModal') {
                document.getElementById('notificationForm').reset();
                document.getElementById('notificationType').value = '';
                // Reset pre-selected member info
                document.getElementById('preSelectedMemberInfo').style.display = 'none';
                document.getElementById('normalMemberSelection').style.display = 'block';
                toggleRecipientSelection();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Toggle exit fields visibility
        function toggleExitFields() {
            const status = document.getElementById('membershipStatus').value;
            const container = document.getElementById('exitFieldsContainer');
            
            if (status === 'ayrıldı') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                // Alanları temizle
                document.getElementById('exitDate').value = '';
                document.getElementById('exitReasonType').value = '';
                document.getElementById('exitReason').value = '';
            }
        }
        
        // Toggle edit exit fields visibility (Üye Düzenle için)
        function toggleEditExitFields() {
            const status = document.getElementById('editMembershipStatus').value;
            const container = document.getElementById('editExitFieldsContainer');
            
            if (status === 'ayrıldı') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // Populate member select
        function populateMemberSelect() {
            const select = document.getElementById('paymentMemberId');
            select.innerHTML = '<option value="">Üye seçiniz</option>';
            
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.memberNo} - ${member.firstName} ${member.lastName}`;
                select.appendChild(option);
            });
        }

        // Save member
        function saveMember() {
            const memberId = document.getElementById('memberId').value;
            
            const member = {
                id: memberId || generateId(),
                memberNo: document.getElementById('memberNo').value,
                membershipType: document.getElementById('membershipType').value,
                aidatAktif: document.getElementById('aidatAktif').checked,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                tcNo: document.getElementById('tcNo').value,
                gender: document.getElementById('gender').value,
                birthDate: document.getElementById('birthDate').value,
                phone: document.getElementById('phone').value,
                phoneHome: document.getElementById('phoneHome').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                neighborhood: document.getElementById('neighborhood').value,
                bloodType: document.getElementById('bloodType').value,
                employmentStatus: document.getElementById('employmentStatus').value,
                fatherName: document.getElementById('fatherName').value,
                motherName: document.getElementById('motherName').value,
                maritalStatus: document.getElementById('maritalStatus').value,
                graduation: document.getElementById('graduation').value,
                graduationYear: document.getElementById('graduationYear').value,
                workplace: document.getElementById('workplace').value,
                position: document.getElementById('position').value,
                birthCity: document.getElementById('birthCity').value,
                birthDistrict: document.getElementById('birthDistrict').value,
                volumeNo: document.getElementById('volumeNo').value,
                familyNo: document.getElementById('familyNo').value,
                lineNo: document.getElementById('lineNo').value,
                registrationDate: new Date().toISOString().split('T')[0],
                lastPaymentDate: '',
                notes: document.getElementById('notes').value,
                // Yeni üye her zaman aktif başlar
                membershipStatus: 'aktif',
                exitDate: null,
                exitReasonType: null,
                exitReason: null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Validate required fields - Her alanı tek tek kontrol et
            const requiredFields = [
                { field: member.memberNo, name: 'Üye No', id: 'memberNo' },
                { field: member.firstName, name: 'Ad', id: 'firstName' },
                { field: member.lastName, name: 'Soyad', id: 'lastName' },
                { field: member.tcNo, name: 'TC Kimlik No', id: 'tcNo' },
                { field: member.gender, name: 'Cinsiyet', id: 'gender' },
                { field: member.birthDate, name: 'Doğum Tarihi', id: 'birthDate' },
                { field: member.email, name: 'E-posta', id: 'email' },
                { field: member.phone, name: 'Telefon', id: 'phone' },
                { field: member.address, name: 'Adres', id: 'address' },
                { field: member.city, name: 'Şehir', id: 'city' },
                { field: member.membershipType, name: 'Üyelik Tipi', id: 'membershipType' }
            ];
            
            for (let item of requiredFields) {
                if (!item.field || item.field.trim() === '') {
                    showNotification(`❌ ${item.name} alanı zorunludur!`, 'warning');
                    document.getElementById(item.id)?.focus();
                    return;
                }
            }
            
            // ÜYE NO DUPLICATE KONTROLÜ
            if (!memberId) { // Sadece yeni üye eklerken kontrol et
                const existingMember = members.find(m => m.memberNo === member.memberNo);
                if (existingMember) {
                    showNotification(`❌ Bu üye numarası zaten kullanılıyor! (${existingMember.firstName} ${existingMember.lastName})`, 'error');
                    return;
                }
            } else {
                // Düzenlerken kendi üye no'su hariç kontrol et
                const existingMember = members.find(m => m.memberNo === member.memberNo && m.id !== memberId);
                if (existingMember) {
                    showNotification(`❌ Bu üye numarası başka bir üye tarafından kullanılıyor! (${existingMember.firstName} ${existingMember.lastName})`, 'error');
                    return;
                }
            }

            if (memberId) {
                // Update existing member
                const index = members.findIndex(m => m.id === memberId);
                if (index !== -1) {
                    member.createdAt = members[index].createdAt;
                    // Mevcut ayrılma bilgilerini koru
                    member.membershipStatus = members[index].membershipStatus || 'aktif';
                    member.exitDate = members[index].exitDate || null;
                    member.exitReasonType = members[index].exitReasonType || null;
                    member.exitReason = members[index].exitReason || null;
                    members[index] = member;
                }
            } else {
                // Add new member
                members.push(member);
                
                // Create aidat debt for current year if aidatAktif is true
                const currentYear = new Date().getFullYear();
                if (member.aidatAktif) {
                    createAidatDebt(member.id, currentYear);
                }
                
                // Create debts for past years if selected
                if (document.getElementById('gecmisYillarBorclandir').checked) {
                    const yearCheckboxes = document.querySelectorAll('#yearSelectionGrid input[type="checkbox"]:checked');
                    yearCheckboxes.forEach(checkbox => {
                        const year = parseInt(checkbox.value);
                        createAidatDebt(member.id, year);
                    });
                }
            }

            saveMembers();
            loadMembersTable();
            updateDashboard();
            updateDonutCharts();
            closeModal('memberModal');
            showNotification('Üye başarıyla kaydedildi!', 'success');
        }
        
        // Create aidat debt
        function createAidatDebt(memberId, year) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // Aidat tutarını ayarlardan al
            const amount = aidatSettings[member.membershipType] || 0;
            
            // Eğer aidat tutarı 0 ise borç oluşturma
            if (amount === 0) return;
            
            const payment = {
                id: generateId(),
                memberId: memberId,
                amount: amount,
                type: 'aidat',
                date: '',
                year: year,
                receiptNo: '',
                description: `${year} yılı ${member.membershipType} aidatı`,
                status: 'bekliyor',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            payments.push(payment);
            savePayments();
        }

        // Delete member
        function deleteMember(id) {
            if (!confirm('Bu üyeyi silmek istediğinizden emin misiniz?')) return;

            members = members.filter(m => m.id !== id);
            payments = payments.filter(p => p.memberId !== id);
            
            saveMembers();
            savePayments();
            loadMembersTable();
            updateDashboard();
            updateDonutCharts();
            showNotification('Üye başarıyla silindi!', 'success');
        }
// View member details - TAM DETAYLI BORÇ BİLGİSİ
        function viewMemberDetail(id) {
            currentMemberId = id;
            const member = members.find(m => m.id === id);
            if (!member) return;

            const memberPayments = payments.filter(p => p.memberId === id);
            
            // Ödenen yıllar
            const paidPayments = memberPayments.filter(p => p.status === 'tamamlandı' && p.type === 'aidat');
            const paidYears = paidPayments.map(p => p.year).sort((a, b) => a - b);
            const totalPaid = paidPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // Bekleyen ödemeler (BORÇLAR)
            const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor' && p.type === 'aidat');
            const debtYears = pendingPayments.map(p => p.year).sort((a, b) => a - b);
            const totalDebt = pendingPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // Toplam
            const grandTotal = totalPaid + totalDebt;

            let detailHTML = `
                <!-- Üyelik Durumu Badge -->
                ${member.membershipStatus === 'ayrıldı' ? `
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-user-times" style="font-size: 48px; opacity: 0.8;"></i>
                            <div>
                                <h3 style="margin: 0; font-size: 22px;">ÜYELİKTEN AYRILMIŞ</h3>
                                <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;">
                                    <strong>Ayrılış Tarihi:</strong> ${member.exitDate ? formatDate(member.exitDate) : '-'}<br>
                                    <strong>Ayrılış Nedeni:</strong> ${member.exitReasonType || '-'}
                                    ${member.exitReason ? `<br><strong>Detay:</strong> ${member.exitReason}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : member.membershipStatus === 'pasif' ? `
                    <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <i class="fas fa-pause-circle"></i> <strong>PASİF ÜYE</strong> - Geçici olarak aidat ödemesi beklenmemektedir
                    </div>
                ` : ''}
                
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Üye No</label>
                        <div class="value">${member.memberNo}</div>
                    </div>
                    <div class="detail-item">
                        <label>Ad Soyad</label>
                        <div class="value">${member.firstName} ${member.lastName}</div>
                    </div>
                    <div class="detail-item">
                        <label>TC Kimlik No</label>
                        <div class="value">${member.tcNo}</div>
                    </div>
                    <div class="detail-item">
                        <label>Üyelik Tipi</label>
                        <div class="value">${member.membershipType}</div>
                    </div>
                    <div class="detail-item">
                        <label>Doğum Tarihi</label>
                        <div class="value">${formatDate(member.birthDate)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Nereli</label>
                        <div class="value">${member.birthCity || '-'} / ${member.birthDistrict || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>Kayıt Tarihi</label>
                        <div class="value">${formatDate(member.registrationDate)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Aidat Aktif</label>
                        <div class="value">${member.aidatAktif ? '<span class="badge success">Aktif</span>' : '<span class="badge warning">Pasif</span>'}</div>
                    </div>
                </div>
                
                <!-- Mali Durum Özeti -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">ÖDENDİ</div>
                        <div style="font-size: 28px; font-weight: 700;">₺${totalPaid.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${paidPayments.length} ödeme</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">BORÇ</div>
                        <div style="font-size: 28px; font-weight: 700;">₺${totalDebt.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${pendingPayments.length} bekleyen</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">TOPLAM</div>
                        <div style="font-size: 28px; font-weight: 700;">₺${grandTotal.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${memberPayments.length} işlem</div>
                    </div>
                </div>
                
                <!-- Yıllara Göre Ödeme Durumu -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid var(--tpjd-light);">
                    <h4 style="color: var(--tpjd-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-calendar-check"></i> Ödenen Yıllar
                    </h4>
                    <div style="color: ${paidYears.length > 0 ? 'var(--tpjd-success)' : '#95a5a6'}; font-size: 16px; font-weight: 600;">
                        ${paidYears.length > 0 ? paidYears.join(', ') : 'Henüz ödeme yapılmamış'}
                    </div>
                </div>
                
                <div style="background: #fff5f5; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #ffcdd2;">
                    <h4 style="color: var(--tpjd-danger); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle"></i> Borçlu Yıllar
                    </h4>
                    <div style="color: ${debtYears.length > 0 ? 'var(--tpjd-danger)' : 'var(--tpjd-success)'}; font-size: 16px; font-weight: 600;">
                        ${debtYears.length > 0 ? debtYears.join(', ') + ` (Toplam: ₺${totalDebt.toFixed(2)})` : '✓ Borç yok - Tüm ödemeler güncel'}
                    </div>
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: var(--tpjd-dark);">
                    <i class="fas fa-list"></i> Detaylı Ödeme Dökümü
                </h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Yıl</th>
                                <th>Tip</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>Tarih</th>
                                <th>Fiş No</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${memberPayments.length > 0 ? memberPayments.sort((a, b) => (b.year || 0) - (a.year || 0)).map(payment => `
                                <tr style="${payment.status === 'bekliyor' ? 'background: #fff5f5;' : ''}">
                                    <td><strong>${payment.year || '-'}</strong></td>
                                    <td>${payment.type === 'aidat' ? 'Aidat' : payment.type}</td>
                                    <td><strong style="color: ${payment.status === 'bekliyor' ? 'var(--tpjd-danger)' : 'var(--tpjd-success)'};">₺${payment.amount.toFixed(2)}</strong></td>
                                    <td>
                                        ${payment.status === 'tamamlandı' ? 
                                            '<span class="badge success"><i class="fas fa-check"></i> ÖDENDİ</span>' : 
                                            '<span class="badge danger"><i class="fas fa-clock"></i> BEKLİYOR</span>'}
                                    </td>
                                    <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                                    <td><small>${payment.receiptNo || '-'}</small></td>
                                    <td>
                                        ${payment.status === 'bekliyor' ? 
                                            `<button class="btn btn-primary" onclick="quickPayDebt('${payment.id}')" 
                                                    style="padding: 5px 12px; font-size: 12px;" title="Hızlı Ödeme">
                                                <i class="fas fa-credit-card"></i> Öde
                                            </button>` : 
                                            '<span style="color: var(--tpjd-success); font-size: 12px;">✓ Ödendi</span>'}
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        <i class="fas fa-info-circle"></i>
                                        <p>Henüz ödeme kaydı bulunmamaktadır</p>
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('memberDetailContent').innerHTML = detailHTML;
            openModal('memberDetailModal');
        }
        
        // Download member detail as HTML
        function downloadMemberDetail() {
            if (!currentMemberId) return;
            
            const member = members.find(m => m.id === currentMemberId);
            if (!member) return;
            
            const memberPayments = payments.filter(p => p.memberId === currentMemberId);
            const paidYears = memberPayments.filter(p => p.status === 'tamamlandı' && p.type === 'aidat').map(p => p.year);
            const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor');
            
            let html = `
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${member.firstName} ${member.lastName} - Üye Detayı</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { margin: 0 0 10px 0; }
        .header p { margin: 0; opacity: 0.9; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-item { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .info-item label { display: block; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .info-item .value { font-size: 16px; color: #2c3e50; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        .footer { margin-top: 30px; text-align: center; color: #7f8c8d; font-size: 14px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>TPJD - Üye Detay Raporu</h1>
        <p>Türkiye Petrol Jeologları Derneği</p>
    </div>
    
    <div class="info-grid">
        <div class="info-item"><label>Üye No</label><div class="value">${member.memberNo}</div></div>
        <div class="info-item"><label>Ad Soyad</label><div class="value">${member.firstName} ${member.lastName}</div></div>
        <div class="info-item"><label>TC Kimlik No</label><div class="value">${member.tcNo}</div></div>
        <div class="info-item"><label>Üyelik Tipi</label><div class="value">${member.membershipType}</div></div>
        <div class="info-item"><label>Doğum Tarihi</label><div class="value">${formatDate(member.birthDate)}</div></div>
        <div class="info-item"><label>Nereli</label><div class="value">${member.birthCity || '-'} / ${member.birthDistrict || '-'}</div></div>
        <div class="info-item"><label>Kayıt Tarihi</label><div class="value">${formatDate(member.registrationDate)}</div></div>
        <div class="info-item"><label>Ödenen Yıllar</label><div class="value">${paidYears.length > 0 ? paidYears.join(', ') : 'Henüz ödeme yok'}</div></div>
        <div class="info-item"><label>Bekleyen Ödeme</label><div class="value">${pendingPayments.length} adet</div></div>
    </div>
    
    <h3>Borç ve Ödeme Dökümü</h3>
    <table>
        <thead>
            <tr>
                <th>Yıl</th>
                <th>Tip</th>
                <th>Tutar</th>
                <th>Durum</th>
                <th>Tarih</th>
            </tr>
        </thead>
        <tbody>
            ${memberPayments.map(payment => `
                <tr>
                    <td>${payment.year}</td>
                    <td>${payment.type}</td>
                    <td>₺${payment.amount.toFixed(2)}</td>
                    <td>${payment.status === 'tamamlandı' ? 'Ödendi' : 'Bekliyor'}</td>
                    <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    
    <div class="footer">
        <p>Bu rapor ${new Date().toLocaleDateString('tr-TR')} tarihinde oluşturulmuştur.</p>
    </div>
</body>
</html>
            `;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${member.memberNo}_${member.firstName}_${member.lastName}_detay.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Üye detayı HTML olarak indirildi!', 'success');
        }

        // Save payment
        function savePayment() {
            const paymentId = document.getElementById('paymentId').value;
            
            const payment = {
                id: paymentId || generateId(),
                memberId: document.getElementById('paymentMemberId').value,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                type: document.getElementById('paymentType').value,
                date: document.getElementById('paymentDate').value,
                year: parseInt(document.getElementById('paymentYear').value),
                receiptNo: document.getElementById('receiptNo').value,
                description: document.getElementById('paymentDescription').value,
                status: document.getElementById('paymentStatus').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (!payment.memberId) {
                showNotification('❌ Üye seçimi zorunludur!', 'warning');
                document.getElementById('paymentMemberId')?.focus();
                return;
            }
            if (!payment.amount || payment.amount <= 0) {
                showNotification('❌ Geçerli bir tutar giriniz!', 'warning');
                document.getElementById('paymentAmount')?.focus();
                return;
            }
            if (!payment.date) {
                showNotification('❌ Tarih alanı zorunludur!', 'warning');
                document.getElementById('paymentDate')?.focus();
                return;
            }
            if (!payment.description || payment.description.trim() === '') {
                showNotification('❌ Açıklama alanı zorunludur!', 'warning');
                document.getElementById('paymentDescription')?.focus();
                return;
            }

            if (paymentId) {
                const index = payments.findIndex(p => p.id === paymentId);
                if (index !== -1) {
                    payment.createdAt = payments[index].createdAt;
                    payments[index] = payment;
                }
            } else {
                payments.push(payment);
            }
            
            // ⭐ KRİTİK: Ödeme "tamamlandı" ise, aynı yıl için bekleyen borç kaydını sil
            if (payment.status === 'tamamlandı' && payment.type === 'aidat') {
                // Aynı üye, aynı yıl, aynı tip için bekleyen kayıtları bul
                const duplicateDebts = payments.filter(p => 
                    p.id !== payment.id && // Kendisi değil
                    p.memberId === payment.memberId && 
                    p.year === payment.year && 
                    p.type === 'aidat' && 
                    p.status === 'bekliyor'
                );
                
                // Eski borç kayıtlarını sil
                if (duplicateDebts.length > 0) {
                    payments = payments.filter(p => !duplicateDebts.some(d => d.id === p.id));
                    console.log(`🗑️ ${duplicateDebts.length} adet bekleyen borç kaydı silindi (çünkü ödeme yapıldı)`);
                }
            }

            // Update member's last payment date
            const member = members.find(m => m.id === payment.memberId);
            if (member && payment.status === 'tamamlandı') {
                member.lastPaymentDate = payment.date;
                saveMembers();
            }


            savePayments();
            loadPaymentsTable();
            updateDashboard();
            updateDonutCharts();
            closeModal('paymentModal');
            showNotification('Ödeme başarıyla kaydedildi!', 'success');
        }

        // Edit payment
        function editPayment(id) {
            const payment = payments.find(p => p.id === id);
            if (!payment) return;
            
            // ÖNCE modalı aç (bu form'u reset edecek)
            openModal('paymentModal');
            
            // SONRA değerleri doldur
            document.getElementById('paymentId').value = payment.id;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentType').value = payment.type;
            document.getElementById('paymentDate').value = payment.date;
            document.getElementById('paymentYear').value = payment.year;
            document.getElementById('receiptNo').value = payment.receiptNo || '';
            document.getElementById('paymentDescription').value = payment.description;
            document.getElementById('paymentStatus').value = payment.status;

            // Üye listesini doldur ve seç
            populateMemberSelect();
            document.getElementById('paymentMemberId').value = payment.memberId;
        }

        // Delete payment
        function deletePayment(id) {
            if (!confirm('Bu ödemeyi silmek istediğinizden emin misiniz?')) return;

            const payment = payments.find(p => p.id === id);
            if (!payment) return;
            
            // Ödemeyi sil
            payments = payments.filter(p => p.id !== id);
            
            // ⭐ KRİTİK: Eğer silinen ödeme "tamamlandı" aidat ise, borç kaydını geri oluştur
            if (payment.status === 'tamamlandı' && payment.type === 'aidat') {
                // Aynı üye, aynı yıl için başka bir tamamlanmış ödeme var mı kontrol et
                const otherCompletedPayment = payments.some(p => 
                    p.memberId === payment.memberId && 
                    p.year === payment.year && 
                    p.type === 'aidat' && 
                    p.status === 'tamamlandı'
                );
                
                // Eğer başka tamamlanmış ödeme yoksa, borç kaydı oluştur
                if (!otherCompletedPayment) {
                    // Aynı yıl için zaten bekleyen kayıt var mı?
                    const existingDebt = payments.some(p => 
                        p.memberId === payment.memberId && 
                        p.year === payment.year && 
                        p.type === 'aidat' && 
                        p.status === 'bekliyor'
                    );
                    
                    // Borç kaydı yoksa oluştur
                    if (!existingDebt) {
                        const debtPayment = {
                            id: generateId(),
                            memberId: payment.memberId,
                            amount: payment.amount,
                            type: 'aidat',
                            date: '',
                            year: payment.year,
                            receiptNo: '',
                            description: `${payment.year} yılı ${payment.type} borcu (ödeme silindi)`,
                            status: 'bekliyor',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        payments.push(debtPayment);
                        console.log(`🔄 Borç kaydı geri oluşturuldu: ${payment.year} yılı`);
                    }
                }
            }
            
            savePayments();
            loadPaymentsTable();
            updateDashboard();
            updateDonutCharts();
            showNotification('Ödeme başarıyla silindi!', 'success');
        }

        // Load members table
        function loadMembersTable() {
            const tbody = document.getElementById('membersTable');
            const currentYear = new Date().getFullYear();
            
            if (members.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>Henüz üye kaydı bulunmamaktadır</h3>
                            <p>Yeni üye eklemek için "Yeni Üye Ekle" butonuna tıklayın</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = members.map(member => {
                const hasPaid = payments.some(p => p.memberId === member.id && p.type === 'aidat' && p.year == currentYear && p.status === 'tamamlandı');
                const paymentBadge = hasPaid ? 
                    '<span class="badge success">Ödedi</span>' : 
                    '<span class="badge warning">Bekliyor</span>';
                
                // Üyelik durumu badge'i
                let statusBadge = '<span class="badge success">Aktif</span>';
                if (member.membershipStatus === 'ayrıldı') {
                    statusBadge = `<span class="badge danger" title="${member.exitReasonType || 'Ayrıldı'}">Ayrıldı</span>`;
                } else if (member.membershipStatus === 'pasif') {
                    statusBadge = '<span class="badge warning">Pasif</span>';
                }
                
                return `
                    <tr style="${member.membershipStatus === 'ayrıldı' ? 'opacity: 0.6;' : ''}">
                        <td>${member.memberNo}</td>
                        <td>${member.firstName} ${member.lastName} ${statusBadge}</td>
                        <td>${member.tcNo}</td>
                        <td>${member.email}</td>
                        <td>${member.phone}</td>
                        <td>${member.membershipType}</td>
                        <td>${formatDate(member.registrationDate)}</td>
                        <td>
                            <button class="action-btn view" onclick="viewMemberDetail('${member.id}')" title="Detayları Görüntüle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteMember('${member.id}')" title="Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        // Load payments table with accordion
        function loadPaymentsTable() {
            const container = document.getElementById('paymentsAccordion');
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3>Henüz ödeme kaydı bulunmamaktadır</h3>
                        <p>Yeni ödeme eklemek için "Ödeme Ekle" butonuna tıklayın</p>
                    </div>
                `;
                return;
            }

            // Group payments by member
            const paymentsByMember = {};
            payments.forEach(payment => {
                if (!paymentsByMember[payment.memberId]) {
                    paymentsByMember[payment.memberId] = [];
                }
                paymentsByMember[payment.memberId].push(payment);
            });

            container.innerHTML = '';

            Object.keys(paymentsByMember).forEach(memberId => {
                const member = members.find(m => m.id === memberId);
                if (!member) return;

                const memberPayments = paymentsByMember[memberId];
                const totalPaid = memberPayments.filter(p => p.status === 'tamamlandı').reduce((sum, p) => sum + p.amount, 0);
                const totalPending = memberPayments.filter(p => p.status === 'bekliyor').reduce((sum, p) => sum + p.amount, 0);

                const accordion = document.createElement('div');
                accordion.className = 'accordion';
                
                const accordionHeader = document.createElement('div');
                accordionHeader.className = 'accordion-header';
                accordionHeader.innerHTML = `
                    <h3>
                        <i class="fas fa-user"></i>
                        ${member.memberNo} - ${member.firstName} ${member.lastName}
                        <span class="member-stats">
                            <span class="member-stat-badge" style="background: #27ae60;">₺${totalPaid.toFixed(2)} Ödendi</span>
                            <span class="member-stat-badge" style="background: #e67e22;">₺${totalPending.toFixed(2)} Bekliyor</span>
                        </span>
                    </h3>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                `;
                
                const accordionContent = document.createElement('div');
                accordionContent.className = 'accordion-content';
                
                const accordionBody = document.createElement('div');
                accordionBody.className = 'accordion-body';
                
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Fiş No</th>
                            <th>Tip</th>
                            <th>Yıl</th>
                            <th>Tutar</th>
                            <th>Açıklama</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${memberPayments.map(payment => `
                            <tr>
                                <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                                <td>${payment.receiptNo || '-'}</td>
                                <td>${payment.type}</td>
                                <td>${payment.year}</td>
                                <td>₺${payment.amount.toFixed(2)}</td>
                                <td>${payment.description}</td>
                                <td>
                                    ${payment.status === 'tamamlandı' ? 
                                        '<span class="badge success">Tamamlandı</span>' : 
                                        '<span class="badge warning">Bekliyor</span>'}
                                </td>
                                <td>
                                    <button class="action-btn edit" onclick="editPayment('${payment.id}')" title="Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="deletePayment('${payment.id}')" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
                accordionBody.appendChild(table);
                accordionContent.appendChild(accordionBody);
                accordion.appendChild(accordionHeader);
                accordion.appendChild(accordionContent);
                container.appendChild(accordion);
                
                // Add click event to toggle accordion
                accordionHeader.addEventListener('click', function() {
                    this.classList.toggle('active');
                    accordionContent.classList.toggle('active');
                });
            });
        }

        // Save transaction

        // Display notifications
        function displayNotifications() {
            const container = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>Henüz bildirim bulunmamaktadır</h3>
                        <p>Yeni bildirim göndermek için "Yeni Bildirim Gönder" butonuna tıklayın</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map(notif => `
                <div class="stat-card ${notif.read ? '' : 'info'}" style="margin-bottom: 15px;">
                    <h3>${notif.title || 'Başlıksız Bildirim'}</h3>
                    <p style="margin: 10px 0;">${notif.message || notif.content || 'İçerik yok'}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <small style="color: #7f8c8d;">
                            <i class="fas fa-calendar"></i> ${formatDateTime(notif.date)} | 
                            <i class="fas fa-user"></i> ${notif.memberName || 'Tüm Üyeler'}
                        </small>
                        <button class="action-btn delete" onclick="deleteNotification('${notif.id}')" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Delete notification
        function deleteNotification(id) {
            if (!confirm('Bu bildirimi silmek istediğinizden emin misiniz?')) return;

            notifications = notifications.filter(n => n.id !== id);
            saveNotifications();
            loadNotifications();
            showNotification('Bildirim başarıyla silindi!', 'success');
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR') + ' ' + date.toLocaleTimeString('tr-TR');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notificationToast');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Search functions
        function searchMembers() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#membersTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function searchPayments() {
            const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
            const accordions = document.querySelectorAll('#paymentsAccordion .accordion');
            
            accordions.forEach(accordion => {
                const text = accordion.textContent.toLowerCase();
                accordion.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }


        // Export functions
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Members sheet
            const membersData = members.map(member => ({
                'Üye No': member.memberNo,
                'Ad': member.firstName,
                'Soyad': member.lastName,
                'TC No': member.tcNo,
                'E-posta': member.email,
                'Telefon': member.phone,
                'Üyelik Tipi': member.membershipType,
                'Kayıt Tarihi': member.registrationDate
            }));
            const wsMembers = XLSX.utils.json_to_sheet(membersData);
            XLSX.utils.book_append_sheet(wb, wsMembers, 'Üyeler');
            
            // Payments sheet
            const paymentsData = payments.map(payment => {
                const member = members.find(m => m.id === payment.memberId);
                return {
                    'Üye': member ? `${member.memberNo} - ${member.firstName} ${member.lastName}` : 'Bilinmeyen',
                    'Tutar': payment.amount,
                    'Tip': payment.type,
                    'Yıl': payment.year,
                    'Tarih': payment.date,
                    'Fiş No': payment.receiptNo,
                    'Açıklama': payment.description,
                    'Durum': payment.status
                };
            });
            const wsPayments = XLSX.utils.json_to_sheet(paymentsData);
            XLSX.utils.book_append_sheet(wb, wsPayments, 'Ödemeler');
            
            XLSX.writeFile(wb, 'tpjd_veriler.xlsx');
            showNotification('Excel dosyası indirildi!', 'success');
        }

        function exportMembersToExcel() {
            const membersData = members.map(member => ({
                'Üye No': member.memberNo,
                'Ad': member.firstName,
                'Soyad': member.lastName,
                'TC No': member.tcNo,
                'E-posta': member.email,
                'Telefon': member.phone,
                'Üyelik Tipi': member.membershipType,
                'Kayıt Tarihi': member.registrationDate
            }));
            
            const ws = XLSX.utils.json_to_sheet(membersData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Üyeler');
            XLSX.writeFile(wb, 'tpjd_uyeler.xlsx');
            showNotification('Üyeler Excel dosyası indirildi!', 'success');
        }

        function exportPaymentsToExcel() {
            const paymentsData = payments.map(payment => {
                const member = members.find(m => m.id === payment.memberId);
                return {
                    'Üye': member ? `${member.memberNo} - ${member.firstName} ${member.lastName}` : 'Bilinmeyen',
                    'Tutar': payment.amount,
                    'Tip': payment.type,
                    'Yıl': payment.year,
                    'Tarih': payment.date,
                    'Fiş No': payment.receiptNo,
                    'Açıklama': payment.description,
                    'Durum': payment.status
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(paymentsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ödemeler');
            XLSX.writeFile(wb, 'tpjd_odemeler.xlsx');
            showNotification('Ödemeler Excel dosyası indirildi!', 'success');
        }


        function exportToJSON() {
            const data = {
                members: members,
                payments: payments,
                notifications: notifications,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tpjd_yedek.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('JSON yedek dosyası indirildi!', 'success');
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('JSON dosyası yüklenecek. Mevcut veriler silinecek. Emin misiniz?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.members) members = data.members;
                    if (data.payments) payments = data.payments;
                    if (data.notifications) notifications = data.notifications;
                    
                    saveMembers();
                    savePayments();
                    saveNotifications();
                    
                    loadMembersTable();
                    loadPaymentsTable();
                    loadNotifications();
                    updateDashboard();
                    updateDonutCharts();
                    
                    showNotification('JSON dosyası başarıyla yüklendi!', 'success');
                } catch (error) {
                    showNotification('JSON dosyası okunamadı!', 'error');
                    console.error('JSON import error:', error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Dashboard update function
        function updateDashboard() {
            const currentYear = new Date().getFullYear();
            // Sadece aktif ve pasif üyeleri say (ayrılanları çıkar)
            const activeMembersList = members.filter(m => m.membershipStatus !== 'ayrıldı');
            let totalMembers = activeMembersList.length;
            let activeMembers = 0;
            let pendingPayments = 0;
            let totalIncome = 0;

            activeMembersList.forEach(member => {
                const hasPaid = payments.some(p => 
                    p.memberId === member.id && 
                    p.type === 'aidat' && 
                    p.year == currentYear && 
                    p.status === 'tamamlandı'
                );
                
                // Bekleyen ödeme kaydı var mı?
                const hasDebt = payments.some(p => 
                    p.memberId === member.id && 
                    p.type === 'aidat' && 
                    p.status === 'bekliyor'
                );
                
                if (hasPaid) {
                    activeMembers++;
                }
                
                if (hasDebt) {
                    pendingPayments++;
                }
            });

            // Gelir hesapla - ÖDEMELER
            // Ödemelerden gelen gelirler (aidat ödemeleri)
            payments.forEach(payment => {
                if (payment.status === 'tamamlandı' && payment.year == currentYear) {
                    totalIncome += payment.amount;
                }
            });
            
            // UI güncelle
            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('activeMembers').textContent = activeMembers;
            document.getElementById('pendingPayments').textContent = pendingPayments;
            document.getElementById('totalIncome').textContent = '₺' + totalIncome.toFixed(2);
            
            // Dashboard tablosunu güncelle
            updateDashboardTable();
        }

        // Dashboard tablosu güncelleme - SADECE BORÇLU ÜYELERİ GÖSTER
        function updateDashboardTable() {
            const tbody = document.getElementById('dashboardMembersTable');
            const currentYear = new Date().getFullYear();
            
            // Borçlu üyeleri filtrele (ayrılanları dahil etme)
            const debtorMembers = members.filter(member => {
                // Ayrılan üyeleri gösterme
                if (member.membershipStatus === 'ayrıldı') return false;
                
                const pendingPayments = payments.filter(p => 
                    p.memberId === member.id && 
                    p.type === 'aidat' && 
                    p.status === 'bekliyor'
                );
                return pendingPayments.length > 0;
            });
            
            if (debtorMembers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-check-circle" style="color: var(--tpjd-success);"></i>
                            <h3>Harika! Borçlu üye bulunmamaktadır</h3>
                            <p>Tüm üyelerin ödemeleri güncel</p>
                        </td>
                    </tr>
                `;
                document.getElementById('debtorCount').textContent = '0 Borçlu Üye';
                return;
            }
            
            document.getElementById('debtorCount').textContent = `${debtorMembers.length} Borçlu Üye`;

            tbody.innerHTML = debtorMembers.map(member => {
                // Bu yıl ödedi mi?
                const hasPaidThisYear = payments.some(p => 
                    p.memberId === member.id && 
                    p.type === 'aidat' && 
                    p.year == currentYear && 
                    p.status === 'tamamlandı'
                );
                
                // Bekleyen tüm ödemeleri al
                const pendingPayments = payments.filter(p => 
                    p.memberId === member.id && 
                    p.type === 'aidat' && 
                    p.status === 'bekliyor'
                );
                
                // Toplam borç hesapla
                const totalDebt = pendingPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
                
                // Borçlu yıllar
                const debtYears = pendingPayments.map(p => p.year).sort((a, b) => a - b);
                
                const paymentBadge = hasPaidThisYear ? 
                    '<span class="badge success">ÖDEDİ</span>' : 
                    '<span class="badge danger">BEKLİYOR</span>';
                    
                const debtDisplay = `
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <strong style="color: var(--tpjd-danger); font-size: 16px;">₺${totalDebt.toFixed(2)}</strong>
                        <small style="color: #7f8c8d;">${debtYears.length} yıl: ${debtYears.join(', ')}</small>
                    </div>
                `;

                return `
                    <tr>
                        <td><strong>${member.memberNo}</strong></td>
                        <td>${member.firstName} ${member.lastName}</td>
                        <td>${member.membershipType}</td>
                        <td><small>${member.email}</small></td>
                        <td><small>${member.phone}</small></td>
                        <td>${paymentBadge}</td>
                        <td>${debtDisplay}</td>
                        <td>
                            <button class="action-btn view" onclick="viewMemberDetail('${member.id}')" title="Detayları Görüntüle">
                                <i class="fas fa-eye"></i> Detay
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Sample data function
        function loadSampleData() {
            if (!confirm('Örnek veriler yüklenecek. Mevcut veriler silinecek. Emin misiniz?')) return;
            
            // Clear existing data
            members = [];
            payments = [];
            notifications = [];
            
            // Sample members with new membership types
            members = [
                {
                    id: '1',
                    memberNo: 'TPJD001',
                    membershipType: 'Asil Üye',
                    aidatAktif: true,
                    firstName: 'Ahmet',
                    lastName: 'Yılmaz',
                    tcNo: '12345678901',
                    gender: 'Erkek',
                    birthDate: '1975-05-15',
                    phone: '+905551234567',
                    email: 'ahmet.yilmaz@email.com',
                    address: 'Atatürk Bulvarı No:123 Daire:5',
                    city: 'İstanbul',
                    registrationDate: '2010-01-15',
                    birthCity: 'Ankara',
                    createdAt: '2010-01-15T10:00:00.000Z',
                    updatedAt: '2024-01-10T10:00:00.000Z'
                },
                {
                    id: '2',
                    memberNo: 'TPJD002',
                    membershipType: 'Asil Onursal',
                    aidatAktif: false,
                    firstName: 'Prof. Dr. Mehmet',
                    lastName: 'Kaya',
                    tcNo: '12345678902',
                    gender: 'Erkek',
                    birthDate: '1960-08-20',
                    phone: '+905551234568',
                    email: 'mehmet.kaya@email.com',
                    address: 'Üniversiteler Mahallesi Kampüs İçi',
                    city: 'Ankara',
                    registrationDate: '2008-03-20',
                    birthCity: 'Ankara',
                    createdAt: '2008-03-20T10:00:00.000Z',
                    updatedAt: '2023-12-15T10:00:00.000Z'
                },
                {
                    id: '3',
                    memberNo: 'TPJD003',
                    membershipType: 'Öğrenci Üye',
                    aidatAktif: true,
                    firstName: 'Ayşe',
                    lastName: 'Demir',
                    tcNo: '12345678903',
                    gender: 'Kadın',
                    birthDate: '2001-12-10',
                    phone: '+905551234569',
                    email: 'ayse.demir@email.com',
                    address: 'Öğrenci Yurdu Kampüs İçi',
                    city: 'İzmir',
                    registrationDate: '2022-09-10',
                    birthCity: 'İzmir',
                    createdAt: '2022-09-10T10:00:00.000Z',
                    updatedAt: '2025-01-05T10:00:00.000Z'
                },
                {
                    id: '4',
                    memberNo: 'TPJD004',
                    membershipType: 'Fahri Üye',
                    aidatAktif: true,
                    firstName: 'Zeynep',
                    lastName: 'Şahin',
                    tcNo: '12345678904',
                    gender: 'Kadın',
                    birthDate: '1988-03-25',
                    phone: '+905551234570',
                    email: 'zeynep.sahin@email.com',
                    address: 'Çamlıca Mahallesi Sokak No:45/7',
                    city: 'Ankara',
                    registrationDate: '2015-06-12',
                    birthCity: 'Bursa',
                    createdAt: '2015-06-12T10:00:00.000Z',
                    updatedAt: '2025-01-15T10:00:00.000Z'
                },
                {
                    id: '5',
                    memberNo: 'TPJD005',
                    membershipType: 'Fahri Onursal',
                    aidatAktif: false,
                    firstName: 'Mustafa',
                    lastName: 'Arslan',
                    tcNo: '12345678906',
                    gender: 'Erkek',
                    birthDate: '1990-11-05',
                    phone: '+905551234572',
                    email: 'mustafa.arslan@email.com',
                    address: 'Kültür Mahallesi Cumhuriyet Caddesi No:88',
                    city: 'Konya',
                    registrationDate: '2018-04-10',
                    birthCity: 'Konya',
                    createdAt: '2018-04-10T10:00:00.000Z',
                    updatedAt: '2018-04-10T10:00:00.000Z'
                }
            ];
            
            // Sample payments
            const currentYear = new Date().getFullYear();
            payments = [
                {
                    id: 'p1',
                    memberId: '3',
                    amount: 50,
                    type: 'aidat',
                    date: '2025-01-05',
                    year: currentYear,
                    receiptNo: 'FİŞ001',
                    description: `${currentYear} yılı öğrenci aidat ödemesi`,
                    status: 'tamamlandı',
                    createdAt: '2025-01-05T10:00:00.000Z'
                },
                {
                    id: 'p2',
                    memberId: '4',
                    amount: 100,
                    type: 'aidat',
                    date: '2025-01-15',
                    year: currentYear,
                    receiptNo: 'FİŞ002',
                    description: `${currentYear} yılı aidat ödemesi`,
                    status: 'tamamlandı',
                    createdAt: '2025-01-15T10:00:00.000Z'
                }
            ];
            
            // Save all data to localStorage
            saveMembers();
            savePayments();
            saveNotifications();
            
            // Update all UI components
            loadMembersTable();
            loadPaymentsTable();
            loadNotifications();
            updateDashboard();
            updateDonutCharts();
            
            showNotification('✅ Örnek veriler başarıyla yüklendi! 5 üye ve 2 ödeme eklendi.', 'success');
        }
    </script>
    
    <script>
        function openBulkEmailModal() {
            document.getElementById('bulkEmailModal').classList.add('active');
            document.getElementById('bulkEmailTarget').value = '';
            document.getElementById('bulkEmailSubject').value = '';
            document.getElementById('bulkEmailMessage').value = '';
            document.getElementById('emailPreviewSection').style.display = 'none';
        }

        function closeBulkEmailModal() {
            document.getElementById('bulkEmailModal').classList.remove('active');
        }
        
        // Alıcıları önizleme
        function updateEmailPreview() {
            const target = document.getElementById('bulkEmailTarget').value;
            const previewSection = document.getElementById('emailPreviewSection');
            
            if (!target) {
                previewSection.style.display = 'none';
                return;
            }
            
            const recipients = getEmailRecipients(target);
            
            if (recipients.length === 0) {
                previewSection.style.display = 'block';
                document.getElementById('emailRecipientCount').innerHTML = '<span style="color: var(--tpjd-danger);">⚠️ Bu grupta e-posta adresi olan üye bulunamadı!</span>';
                document.getElementById('emailRecipientList').innerHTML = '<em>Alıcı yok</em>';
                return;
            }
            
            previewSection.style.display = 'block';
            document.getElementById('emailRecipientCount').textContent = `📧 ${recipients.length} kişiye gönderilecek`;
            
            // E-posta listesini göster
            const emailList = recipients.map(r => `<div style="padding: 3px 0;">• ${r.name} - ${r.email}</div>`).join('');
            document.getElementById('emailRecipientList').innerHTML = emailList;
        }
        
        // Alıcıları al
        function getEmailRecipients(target) {
            let recipientMembers = [];
            const currentYear = new Date().getFullYear();

            if (target === 'all') {
                recipientMembers = members;
            } else if (target === 'paid') {
                recipientMembers = members.filter(member => {
                    const paid = payments.some(p => p.memberId === member.id && p.type === 'aidat' && p.year == currentYear && p.status === 'tamamlandı');
                    return paid;
                });
            } else if (target === 'unpaid') {
                recipientMembers = members.filter(member => {
                    const hasDebt = payments.some(p => p.memberId === member.id && p.type === 'aidat' && p.status === 'bekliyor');
                    return hasDebt;
                });
            }
            
            // Sadece email adresi olanları al
            return recipientMembers
                .filter(m => m.email && m.email.trim() !== '')
                .map(m => ({
                    name: `${m.firstName} ${m.lastName}`,
                    email: m.email.trim()
                }));
        }
        
        // Validasyon
        function validateEmailForm() {
            const target = document.getElementById('bulkEmailTarget').value;
            const subject = document.getElementById('bulkEmailSubject').value.trim();
            const message = document.getElementById('bulkEmailMessage').value.trim();
            
            if (!target) {
                showNotification('Lütfen hedef grup seçin!', 'warning');
                return null;
            }
            
            if (!subject) {
                showNotification('Lütfen e-posta konusu girin!', 'warning');
                return null;
            }
            
            if (!message) {
                showNotification('Lütfen e-posta mesajı girin!', 'warning');
                return null;
            }
            
            const recipients = getEmailRecipients(target);
            
            if (recipients.length === 0) {
                showNotification('Seçilen grupta e-posta adresi olan üye bulunamadı!', 'error');
                return null;
            }
            
            return { recipients, subject, message };
        }
        
        // Gmail'den gönder
        function sendViaGmail() {
            const data = validateEmailForm();
            if (!data) return;
            
            const emails = data.recipients.map(r => r.email).join(',');
            const subject = encodeURIComponent(data.subject);
            const body = encodeURIComponent(data.message);
            
            // Gmail compose URL
            const gmailUrl = `https://mail.google.com/mail/?view=cm&bcc=${emails}&su=${subject}&body=${body}`;
            
            // Yeni sekmede aç
            window.open(gmailUrl, '_blank');
            
            // Bildirim kaydet
            saveEmailNotification(data.recipients.length, 'Gmail');
            
            closeBulkEmailModal();
            showNotification(`✅ Gmail açıldı! ${data.recipients.length} alıcı BCC olarak eklendi.`, 'success');
        }
        
        // Outlook'tan gönder
        function sendViaOutlook() {
            const data = validateEmailForm();
            if (!data) return;
            
            const emails = data.recipients.map(r => r.email).join(';'); // Outlook noktalı virgül kullanır
            const subject = encodeURIComponent(data.subject);
            const body = encodeURIComponent(data.message);
            
            // Outlook Web compose URL
            const outlookUrl = `https://outlook.live.com/mail/0/deeplink/compose?bcc=${emails}&subject=${subject}&body=${body}`;
            
            // Yeni sekmede aç
            window.open(outlookUrl, '_blank');
            
            // Bildirim kaydet
            saveEmailNotification(data.recipients.length, 'Outlook');
            
            closeBulkEmailModal();
            showNotification(`✅ Outlook açıldı! ${data.recipients.length} alıcı BCC olarak eklendi.`, 'success');
        }
        
        // Varsayılan mail programından gönder
        function sendViaDefaultMail() {
            const data = validateEmailForm();
            if (!data) return;
            
            const emails = data.recipients.map(r => r.email).join(',');
            const subject = encodeURIComponent(data.subject);
            const body = encodeURIComponent(data.message);
            
            // Mailto protokolü
            const mailtoUrl = `mailto:?bcc=${emails}&subject=${subject}&body=${body}`;
            
            // Varsayılan mail programını aç
            window.location.href = mailtoUrl;
            
            // Bildirim kaydet
            saveEmailNotification(data.recipients.length, 'Varsayılan Mail');
            
            // Kısa bir gecikme ile modal'ı kapat
            setTimeout(() => {
                closeBulkEmailModal();
                showNotification(`✅ Mail programınız açıldı! ${data.recipients.length} alıcı eklendi.`, 'success');
            }, 500);
        }
        
        // E-posta gönderim bildirimini kaydet
        function saveEmailNotification(recipientCount, method) {
            const notification = {
                id: generateId(),
                memberId: 'system',
                memberName: 'Sistem',
                title: `Toplu E-posta Gönderimi (${method})`,
                message: `${recipientCount} kişiye e-posta gönderilmek üzere ${method} açıldı.`,
                priority: 'normal',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('tr-TR'),
                status: 'gönderildi',
                createdAt: new Date().toISOString()
            };
            
            notifications.push(notification);
            saveNotifications();
        }

        // ESKİ FONKSİYON - ARTIK KULLANILMIYOR (geriye dönük uyumluluk için)
        function sendBulkEmail() {
            sendViaDefaultMail();
        }

        // Üye düzenleme fonksiyonları
        function filterMembersForEdit() {
            const memberNo = document.getElementById('filterMemberNo').value.toLowerCase().trim();
            const firstName = document.getElementById('filterFirstName').value.toLowerCase().trim();
            const lastName = document.getElementById('filterLastName').value.toLowerCase().trim();
            const tcNo = document.getElementById('filterTcNo').value.toLowerCase().trim();
            const phone = document.getElementById('filterPhone').value.toLowerCase().trim();
            const city = document.getElementById('filterCity').value.toLowerCase().trim();

            // En az bir filtre doldurulmuş olmalı
            if (!memberNo && !firstName && !lastName && !tcNo && !phone && !city) {
                document.getElementById('editMembersList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>Üye aramak için yukarıdaki filtreleri kullanın</h3>
                        <p>Düzenlemek istediğiniz üyeyi bulun ve tıklayın</p>
                    </div>
                `;
                document.getElementById('filteredMemberCount').textContent = '';
                return;
            }

            let filtered = members.filter(member => {
                const matchMemberNo = !memberNo || (member.memberNo || '').toLowerCase().includes(memberNo);
                const matchFirstName = !firstName || (member.firstName || '').toLowerCase().includes(firstName);
                const matchLastName = !lastName || (member.lastName || '').toLowerCase().includes(lastName);
                const matchTcNo = !tcNo || (member.tcNo || '').toLowerCase().includes(tcNo);
                const matchPhone = !phone || (member.phone || '').toLowerCase().includes(phone);
                const matchCity = !city || (member.city || '').toLowerCase().includes(city);

                return matchMemberNo && matchFirstName && matchLastName && matchTcNo && matchPhone && matchCity;
            });

            if (filtered.length === 0) {
                document.getElementById('editMembersList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-slash"></i>
                        <h3>Üye bulunamadı</h3>
                        <p>Arama kriterlerinize uygun üye bulunamadı</p>
                    </div>
                `;
                document.getElementById('filteredMemberCount').textContent = '';
            } else {
                document.getElementById('filteredMemberCount').textContent = `(${filtered.length} üye bulundu)`;
                document.getElementById('editMembersList').innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Üye No</th>
                                <th>Ad Soyad</th>
                                <th>TC No</th>
                                <th>Telefon</th>
                                <th>Şehir</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(member => `
                                <tr>
                                    <td><strong>${member.memberNo}</strong></td>
                                    <td>${member.firstName} ${member.lastName}</td>
                                    <td>${member.tcNo || '-'}</td>
                                    <td>${member.phone || '-'}</td>
                                    <td>${member.city || '-'}</td>
                                    <td>
                                        <button class="btn-action edit" onclick="loadMemberForEdit('${member.id}')" title="Düzenle">
                                            <i class="fas fa-edit"></i> Düzenle
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        function clearEditFilters() {
            document.getElementById('filterMemberNo').value = '';
            document.getElementById('filterFirstName').value = '';
            document.getElementById('filterLastName').value = '';
            document.getElementById('filterTcNo').value = '';
            document.getElementById('filterPhone').value = '';
            document.getElementById('filterCity').value = '';
            
            document.getElementById('editMembersList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h3>Üye aramak için yukarıdaki filtreleri kullanın</h3>
                    <p>Düzenlemek istediğiniz üyeyi bulun ve tıklayın</p>
                </div>
            `;
            document.getElementById('filteredMemberCount').textContent = '';
            
            // Düzenleme formunu gizle
            document.getElementById('editMemberFormContainer').style.display = 'none';
        }

        function loadMemberForEdit(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showNotification('Üye bulunamadı!', 'error');
                return;
            }

            // Form container'ı göster
            document.getElementById('editMemberFormContainer').style.display = 'block';
            
            // Formu doldur
            document.getElementById('editingMemberName').textContent = `${member.firstName} ${member.lastName}`;
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editMemberNo').value = member.memberNo || '';
            document.getElementById('editMembershipType').value = member.membershipType || '';
            document.getElementById('editAidatAktif').checked = member.aidatAktif !== false;
            document.getElementById('editFirstName').value = member.firstName || '';
            document.getElementById('editLastName').value = member.lastName || '';
            document.getElementById('editTcNo').value = member.tcNo || '';
            document.getElementById('editGender').value = member.gender || '';
            document.getElementById('editBirthDate').value = member.birthDate || '';
            document.getElementById('editPhone').value = member.phone || '';
            document.getElementById('editPhoneHome').value = member.phoneHome || '';
            document.getElementById('editEmail').value = member.email || '';
            document.getElementById('editAddress').value = member.address || '';
            document.getElementById('editCity').value = member.city || '';
            document.getElementById('editDistrict').value = member.district || '';
            document.getElementById('editNeighborhood').value = member.neighborhood || '';
            document.getElementById('editBloodType').value = member.bloodType || '';
            document.getElementById('editEmploymentStatus').value = member.employmentStatus || '';
            document.getElementById('editFatherName').value = member.fatherName || '';
            document.getElementById('editMotherName').value = member.motherName || '';
            document.getElementById('editMaritalStatus').value = member.maritalStatus || '';
            document.getElementById('editGraduation').value = member.graduation || '';
            document.getElementById('editGraduationYear').value = member.graduationYear || '';
            document.getElementById('editWorkplace').value = member.workplace || '';
            document.getElementById('editPosition').value = member.position || '';
            document.getElementById('editBirthCity').value = member.birthCity || '';
            document.getElementById('editBirthDistrict').value = member.birthDistrict || '';
            document.getElementById('editVolumeNo').value = member.volumeNo || '';
            document.getElementById('editFamilyNo').value = member.familyNo || '';
            document.getElementById('editLineNo').value = member.lineNo || '';
            document.getElementById('editNotes').value = member.notes || '';
            
            // Ayrılma bilgilerini yükle
            document.getElementById('editMembershipStatus').value = member.membershipStatus || 'aktif';
            document.getElementById('editExitDate').value = member.exitDate || '';
            document.getElementById('editExitReasonType').value = member.exitReasonType || '';
            document.getElementById('editExitReason').value = member.exitReason || '';
            toggleEditExitFields();

            // Forma scroll yap
            document.getElementById('editMemberFormContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function saveEditedMember() {
            const memberId = document.getElementById('editMemberId').value;
            
            // Zorunlu alanları kontrol et
            const requiredFields = [
                { id: 'editMemberNo', name: 'Üye No' },
                { id: 'editMembershipType', name: 'Üyelik Tipi' },
                { id: 'editFirstName', name: 'Ad' },
                { id: 'editLastName', name: 'Soyad' },
                { id: 'editTcNo', name: 'TC No' },
                { id: 'editGender', name: 'Cinsiyet' },
                { id: 'editBirthDate', name: 'Doğum Tarihi' },
                { id: 'editEmail', name: 'E-posta' },
                { id: 'editPhone', name: 'Telefon' },
                { id: 'editCity', name: 'Şehir' },
                { id: 'editAddress', name: 'Adres' }
            ];

            for (let field of requiredFields) {
                const value = document.getElementById(field.id).value.trim();
                if (!value) {
                    showNotification(`${field.name} alanı zorunludur!`, 'warning');
                    document.getElementById(field.id).focus();
                    return;
                }
            }

            // TC No kontrolü
            const tcNo = document.getElementById('editTcNo').value.trim();
            if (tcNo.length !== 11 || !/^\d+$/.test(tcNo)) {
                showNotification('TC Kimlik No 11 haneli olmalıdır!', 'warning');
                return;
            }

            // E-posta kontrolü
            const email = document.getElementById('editEmail').value.trim();
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showNotification('Geçerli bir e-posta adresi girin!', 'warning');
                return;
            }
            
            // Ayrılış bilgisi kontrolü
            const membershipStatus = document.getElementById('editMembershipStatus').value;
            if (membershipStatus === 'ayrıldı') {
                const exitDate = document.getElementById('editExitDate').value;
                const exitReasonType = document.getElementById('editExitReasonType').value;
                
                if (!exitDate) {
                    showNotification('Ayrılış tarihi zorunludur!', 'warning');
                    return;
                }
                if (!exitReasonType) {
                    showNotification('Ayrılış nedeni seçmelisiniz!', 'warning');
                    return;
                }
            }

            // Üye nesnesini güncelle
            const memberIndex = members.findIndex(m => m.id === memberId);
            if (memberIndex === -1) {
                showNotification('Üye bulunamadı!', 'error');
                return;
            }

            const updatedMember = {
                ...members[memberIndex],
                memberNo: document.getElementById('editMemberNo').value.trim(),
                membershipType: document.getElementById('editMembershipType').value,
                aidatAktif: document.getElementById('editAidatAktif').checked,
                firstName: document.getElementById('editFirstName').value.trim(),
                lastName: document.getElementById('editLastName').value.trim(),
                tcNo: document.getElementById('editTcNo').value.trim(),
                gender: document.getElementById('editGender').value,
                birthDate: document.getElementById('editBirthDate').value,
                phone: document.getElementById('editPhone').value.trim(),
                phoneHome: document.getElementById('editPhoneHome').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                city: document.getElementById('editCity').value.trim(),
                district: document.getElementById('editDistrict').value.trim(),
                neighborhood: document.getElementById('editNeighborhood').value.trim(),
                bloodType: document.getElementById('editBloodType').value,
                employmentStatus: document.getElementById('editEmploymentStatus').value,
                fatherName: document.getElementById('editFatherName').value.trim(),
                motherName: document.getElementById('editMotherName').value.trim(),
                maritalStatus: document.getElementById('editMaritalStatus').value,
                graduation: document.getElementById('editGraduation').value.trim(),
                graduationYear: document.getElementById('editGraduationYear').value.trim(),
                workplace: document.getElementById('editWorkplace').value.trim(),
                position: document.getElementById('editPosition').value.trim(),
                birthCity: document.getElementById('editBirthCity').value.trim(),
                birthDistrict: document.getElementById('editBirthDistrict').value.trim(),
                volumeNo: document.getElementById('editVolumeNo').value.trim(),
                familyNo: document.getElementById('editFamilyNo').value.trim(),
                lineNo: document.getElementById('editLineNo').value.trim(),
                notes: document.getElementById('editNotes').value.trim(),
                // Ayrılma bilgileri
                membershipStatus: document.getElementById('editMembershipStatus').value,
                exitDate: document.getElementById('editExitDate').value || null,
                exitReasonType: document.getElementById('editExitReasonType').value || null,
                exitReason: document.getElementById('editExitReason').value.trim() || null,
                updatedAt: new Date().toISOString()
            };

            members[memberIndex] = updatedMember;
            saveMembers();
            
            // UI güncellemeleri
            loadMembersTable();
            updateDashboard();
            updateDonutCharts();
            
            showNotification('✅ Üye bilgileri başarıyla güncellendi!', 'success');
            
            // Filtreyi yeniden uygula
            filterMembersForEdit();
            
            // Formu gizle
            document.getElementById('editMemberFormContainer').style.display = 'none';
        }

        function cancelEditMember() {
            document.getElementById('editMemberFormContainer').style.display = 'none';
            document.getElementById('editMemberForm').reset();
        }
    </script>

</body>
</html>