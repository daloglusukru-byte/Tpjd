<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPJD Üyelik Yönetim Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --tpjd-dark: #2c3e50;
            --tpjd-gray: #34495e;
            --tpjd-gold: #f39c12;
            --tpjd-light-gold: #f1c40f;
            --tpjd-light: #ecf0f1;
            --tpjd-border: #bdc3c7;
            --tpjd-success: #27ae60;
            --tpjd-danger: #e74c3c;
            --tpjd-warning: #e67e22;
            --tpjd-info: #3498db;
            /* Theme variables - Light Mode (default) */
            --bg-primary: #f8f9fa;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-muted: #95a5a6;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --shadow-hover: rgba(0, 0, 0, 0.15);
            --table-header-bg: #f8f9fa;
            --table-stripe: rgba(0, 0, 0, 0.02);
            --table-hover: rgba(0, 0, 0, 0.04);
            --tab-bg: var(--tpjd-light);
            --tab-active-bg: #ffffff;
            --tab-text: var(--tpjd-gray);
            --calendar-text: #2c3e50;
            --calendar-day-hover: rgba(52, 152, 219, 0.15);
            --calendar-header-text: #7f8c8d;
            --calendar-detail-text: #34495e;
            --calendar-detail-border: rgba(0, 0, 0, 0.08);
            --modal-bg: #ffffff;
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --btn-secondary-bg: rgba(0, 0, 0, 0.05);
            --dashboard-header-bg: linear-gradient(135deg, #2c3e50, #34495e);
            --dashboard-header-text: #ffffff;
            --dashboard-header-sub: #bdc3c7;
        }

        body.dark-mode {
            --bg-primary: #1a1d23;
            --bg-card: #21252b;
            --bg-input: #2c313a;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --text-muted: #6c757d;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.5);
            --table-header-bg: #282c34;
            --table-stripe: rgba(255, 255, 255, 0.02);
            --table-hover: rgba(255, 255, 255, 0.05);
            --tab-bg: #282c34;
            --tab-active-bg: #21252b;
            --tab-text: #b0b3b8;
            --calendar-text: #e4e6eb;
            --calendar-day-hover: rgba(52, 152, 219, 0.25);
            --calendar-header-text: #7f8c8d;
            --calendar-detail-text: #b0b3b8;
            --calendar-detail-border: rgba(255, 255, 255, 0.06);
            --modal-bg: #21252b;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --btn-secondary-bg: rgba(255, 255, 255, 0.08);
            --dashboard-header-bg: linear-gradient(135deg, rgba(44, 62, 80, 0.95), rgba(52, 73, 94, 0.9));
            --dashboard-header-text: #ffffff;
            --dashboard-header-sub: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1d23 0%, #21252b 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 15px 50px var(--shadow-color);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: background 0.3s, border-color 0.3s;
        }

        .header {
            background: linear-gradient(135deg, var(--tpjd-dark) 0%, var(--tpjd-gray) 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
            border-bottom: 4px solid var(--tpjd-gold);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: var(--tpjd-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 24px;
        }

        .logo i {
            display: block;
        }

        .header-text h1 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header-text p {
            opacity: 0.9;
            font-size: 14px;
            color: var(--tpjd-light);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tabs {
            display: flex;
            background: var(--tab-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            padding: 0 10px;
        }

        .tab {
            padding: 18px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--tab-text);
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab:hover {
            background: rgba(52, 73, 94, 0.05);
            color: var(--tpjd-dark);
        }

        .tab.active {
            color: var(--text-primary);
            border-bottom: 3px solid var(--tpjd-gold);
            background: var(--tab-active-bg);
        }

        .tab i {
            margin-right: 8px;
            opacity: 0.8;
        }

        .content {
            padding: 30px;
            background: var(--bg-primary);
            transition: background 0.3s;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px var(--shadow-color);
            border-left: 5px solid var(--tpjd-gold);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-hover);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--tpjd-light-gold) 0%, transparent 70%);
            opacity: 0.1;
            border-radius: 0 0 0 100%;
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .stat-card .subtitle {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .stat-card.success {
            border-left-color: var(--tpjd-success);
        }

        .stat-card.warning {
            border-left-color: var(--tpjd-warning);
        }

        .stat-card.info {
            border-left-color: var(--tpjd-info);
        }

        .chart-container {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px var(--shadow-color);
            margin-bottom: 35px;
            transition: background 0.3s;
        }

        .chart-container h3 {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .chart-wrapper {
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }

        @media (max-width: 768px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 50px 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--tpjd-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 32px;
            margin: 0 auto 30px;
        }

        .login-logo i {
            display: block;
        }

        .login-box h1 {
            font-size: 28px;
            color: var(--tpjd-dark);
            margin-bottom: 10px;
        }

        .login-box p {
            color: #7f8c8d;
            margin-bottom: 35px;
            font-size: 15px;
        }

        .login-form .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--tpjd-dark);
            font-weight: 600;
            font-size: 14px;
        }

        .login-form input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .login-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--tpjd-danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .main-app {
            display: none;
        }

        .main-app.show {
            display: block;
        }

        .logout-btn {
            background: var(--tpjd-danger);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: background 0.3s;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn i {
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--tpjd-gray), var(--tpjd-dark));
        }

        .btn-success {
            background: var(--tpjd-success);
            color: white;
        }

        .btn-warning {
            background: var(--tpjd-warning);
            color: white;
        }

        .btn-danger {
            background: var(--tpjd-danger);
            color: white;
        }

        .btn-info {
            background: var(--tpjd-info);
            color: white;
        }

        .btn-secondary {
            background: var(--tpjd-border);
            color: var(--tpjd-dark);
        }

        .table-container {
            background: var(--bg-card);
            border-radius: 10px;
            box-shadow: 0 5px 20px var(--shadow-color);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: background 0.3s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
        }

        thead th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--table-hover);
        }

        tbody td {
            padding: 14px 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge.success {
            background: rgba(39, 174, 96, 0.15);
            color: var(--tpjd-success);
        }

        .badge.warning {
            background: rgba(230, 126, 34, 0.15);
            color: var(--tpjd-warning);
        }

        .badge.danger {
            background: rgba(231, 76, 60, 0.15);
            color: var(--tpjd-danger);
        }

        .badge.info {
            background: rgba(52, 152, 219, 0.15);
            color: var(--tpjd-info);
        }

        .action-btn {
            padding: 8px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .action-btn.edit {
            background: var(--tpjd-info);
            color: white;
        }

        .action-btn.delete {
            background: var(--tpjd-danger);
            color: white;
        }

        .action-btn.view {
            background: var(--tpjd-warning);
            color: white;
        }

        .action-btn.download {
            background: var(--tpjd-success);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--modal-bg);
            padding: 0;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
            color: var(--text-primary);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--tpjd-gold);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tpjd-dark);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .modal-footer {
            padding: 20px 25px;
            background: var(--tpjd-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--tpjd-border);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 2000;
            min-width: 300px;
            border-left: 5px solid var(--tpjd-success);
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left-color: var(--tpjd-success);
        }

        .notification.error {
            border-left-color: var(--tpjd-danger);
        }

        .notification.warning {
            border-left-color: var(--tpjd-warning);
        }

        .notification.info {
            border-left-color: var(--tpjd-info);
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tpjd-gray);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--tpjd-gold);
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            thead th,
            tbody td {
                padding: 10px 8px;
            }
        }

        .spinner {
            border: 3px solid var(--tpjd-light);
            border-top: 3px solid var(--tpjd-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--tpjd-gray);
        }

        .empty-state p {
            font-size: 14px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .detail-item {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid var(--tpjd-gold);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .detail-item label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .detail-item .value {
            font-size: 16px;
            color: var(--tpjd-dark);
            font-weight: 500;
        }

        .accordion {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid var(--tpjd-border);
        }

        .accordion-header {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            padding: 18px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg, var(--tpjd-gray), var(--tpjd-dark));
        }

        .accordion-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accordion-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .accordion-content.active {
            max-height: 2000px;
        }

        .accordion-body {
            padding: 0;
        }

        .accordion-body table {
            margin: 0;
        }

        .member-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .member-stat-badge {
            background: var(--tpjd-gold);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .form-group.checkbox-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group.checkbox-inline input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .form-group.checkbox-inline label {
            margin: 0;
            cursor: pointer;
        }

        .year-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: var(--tpjd-light);
            border-radius: 8px;
        }

        .year-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid var(--tpjd-border);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .year-checkbox-item:hover {
            border-color: var(--tpjd-gold);
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.2);
        }

        .year-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--tpjd-gold);
        }

        .year-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: var(--tpjd-dark);
        }

        .year-checkbox-item input[type="checkbox"]:checked+label {
            color: var(--tpjd-gold);
            font-weight: 600;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: 0.3s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
        }

        input:checked+.slider {
            background: #27ae60;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .slider.round {
            border-radius: 24px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ═══════════════════════════════════════ */
        /* DARK MODE - COMPREHENSIVE OVERRIDES     */
        /* ═══════════════════════════════════════ */

        /* Theme toggle button */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: white;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(20deg);
        }

        /* Dark mode - Form elements */
        body.dark-mode input[type="text"],
        body.dark-mode input[type="email"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="number"],
        body.dark-mode input[type="tel"],
        body.dark-mode input[type="date"],
        body.dark-mode input[type="time"],
        body.dark-mode input[type="search"],
        body.dark-mode select,
        body.dark-mode textarea {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        /* Dark mode - Labels and text */
        body.dark-mode label,
        body.dark-mode .form-group label {
            color: var(--text-secondary) !important;
        }

        /* Dark mode - inline white bg panels */
        body.dark-mode [style*="background:white"],
        body.dark-mode [style*="background: white"],
        body.dark-mode [style*="background:#fff"],
        body.dark-mode [style*="background: #fff"] {
            background: var(--bg-card) !important;
        }

        /* Dark mode - inline color:#333 text */
        body.dark-mode [style*="color:#333"],
        body.dark-mode [style*="color: #333"],
        body.dark-mode [style*="color:#555"],
        body.dark-mode [style*="color: #555"] {
            color: var(--text-primary) !important;
        }

        /* Dark mode - accordion */
        body.dark-mode .accordion-header {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        body.dark-mode .accordion-body {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        /* Dark mode - calendar container fix */
        body.dark-mode .chart-container {
            background: var(--bg-card) !important;
        }

        /* Dark mode - calendar day colors */
        body.dark-mode .chart-container [style*="color:#ecf0f1"] {
            color: var(--calendar-text) !important;
        }

        /* Dark mode - scrollbar */
        body.dark-mode ::-webkit-scrollbar {
            width: 8px;
        }

        body.dark-mode ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        body.dark-mode ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        /* Dark mode - notification area */
        body.dark-mode .notification-container {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-logo" style="padding:0;background:none;width:100px;height:100px;margin:0 auto 15px;">
                <img src="tpjdlogo.jfif" alt="TPJD Logo"
                    style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.3);box-shadow:0 4px 15px rgba(0,0,0,0.3);">
            </div>
            <h1>TPJD Üyelik Yönetim Sistemi</h1>
            <p style="margin-bottom: 35px;">Giriş yaparak sisteme erişebilirsiniz</p>

            <div id="loginError" class="login-error">
                Kullanıcı adı veya şifre hatalı!
            </div>

            <form class="login-form" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginUsername">Kullanıcı Adı</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Şifre</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Giriş Yap
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo" style="padding:0;overflow:hidden;">
                            <img src="tpjdlogo.jfif" alt="TPJD Logo"
                                style="width:60px;height:60px;border-radius:50%;object-fit:cover;">
                        </div>
                        <div class="header-text">
                            <h1>TPJD</h1>
                            <p>Türkiye Petrol Jeologları Derneği - Üyelik Yönetim Sistemi</p>
                        </div>
                    </div>
                    <div class="user-info" style="display:flex;align-items:center;gap:10px;">
                        <button class="theme-toggle" onclick="toggleTheme()" title="Tema Değiştir"
                            id="themeToggleBtn">☀️</button>
                        <span><i class="fas fa-user-circle"></i> Yönetici Paneli</span>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Çıkış
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard', event)">
                    <i class="fas fa-home"></i> Ana Sayfa
                </button>
                <button class="tab" onclick="switchTab('members', event)">
                    <i class="fas fa-users"></i> Üyeler
                </button>
                <button class="tab" onclick="switchTab('payments', event)">
                    <i class="fas fa-money-bill-wave"></i> Ödemeler
                </button>
                <button class="tab" onclick="switchTab('notifications', event)">
                    <i class="fas fa-bell"></i> Bildirimler
                </button>
                <button class="tab" onclick="switchTab('settings', event)">
                    <i class="fas fa-cog"></i> Ayarlar
                </button>
                <button class="tab" onclick="switchTab('agents', event)">
                    <i class="fas fa-robot"></i> Ajanlar
                </button>
            </div>
            <!-- Content -->
            <div class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <!-- Tarih + Canlı Saat -->
                    <div id="dashboardHeader"
                        style="display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:20px;padding:14px 20px;background:linear-gradient(135deg,rgba(44,62,80,0.95),rgba(52,73,94,0.9));border-radius:12px;border-left:4px solid var(--tpjd-gold);">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div id="liveDate" style="color:#ecf0f1;font-size:15px;font-weight:600;"></div>
                            <div style="width:1px;height:24px;background:rgba(255,255,255,0.2);"></div>
                            <div id="liveClock"
                                style="color:var(--tpjd-gold);font-size:22px;font-weight:700;font-family:'Courier New',monospace;">
                            </div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Toplam Üye</h3>
                            <div class="value" id="totalMembers">0</div>
                            <div class="subtitle">Kayıtlı üye sayısı</div>
                        </div>
                        <div class="stat-card success">
                            <h3>Aktif Üye</h3>
                            <div class="value" id="activeMembers">0</div>
                            <div class="subtitle" id="activeSubtitle">Yıllık aidat ödemesi yapan</div>
                        </div>
                        <div class="stat-card warning">
                            <h3>Bekleyen Ödeme</h3>
                            <div class="value" id="pendingPayments">0</div>
                            <div class="subtitle">Aidat ödemeyen üye sayısı</div>
                        </div>
                        <div class="stat-card info">
                            <h3>Toplam Gelir</h3>
                            <div class="value" id="totalIncome">₺0</div>
                            <div class="subtitle" id="incomeSubtitle">Yıllık toplam aidat geliri</div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="charts-row">
                        <!-- İnteraktif Takvim -->
                        <div class="chart-container" style="padding:15px;">
                            <div
                                style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <button onclick="calendarPrevMonth()"
                                    style="background:none;border:1px solid var(--border-color);color:var(--tpjd-gold);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:14px;">◀</button>
                                <h3 id="calendarTitle" style="margin:0;font-size:16px;"><i
                                        class="fas fa-calendar-alt"></i> Şubat 2026</h3>
                                <button onclick="calendarNextMonth()"
                                    style="background:none;border:1px solid var(--border-color);color:var(--tpjd-gold);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:14px;">▶</button>
                            </div>
                            <div id="calendarGrid" style="font-size:13px;"></div>
                            <div id="calendarDayDetail"
                                style="margin-top:10px;max-height:200px;overflow-y:auto;font-size:12px;color:var(--calendar-detail-text);border-top:1px solid var(--calendar-detail-border);padding-top:8px;">
                            </div>
                        </div>

                        <!-- Üyelik Tipi Dağılımı Simit Grafik -->
                        <div class="chart-container">
                            <h3><i class="fas fa-chart-pie"></i> Üyelik Tipi Dağılımı</h3>
                            <div class="chart-wrapper">
                                <canvas id="membershipDonutChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('memberModal')">
                            <i class="fas fa-user-plus"></i> Yeni Üye Ekle
                        </button>
                        <button class="btn btn-success" onclick="openModal('paymentModal')">
                            <i class="fas fa-plus-circle"></i> Ödeme Ekle
                        </button>
                        <button class="btn btn-warning" onclick="openBulkEmailModal()">
                            <i class="fas fa-envelope"></i> Toplu E-posta
                        </button>
                        <button class="btn" style="background:#ff5722;color:white;border-color:#ff5722;"
                            onclick="openModal('eventModal')">
                            <i class="fas fa-bullhorn"></i> Etkinlik Duyuru
                        </button>
                        <button class="btn btn-secondary" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Excel'e Aktar
                        </button>
                        <button class="btn btn-secondary" onclick="exportToJSON()">
                            <i class="fas fa-file-code"></i> JSON İndir
                        </button>
                    </div>

                    <div
                        style="background: white; padding: 20px; border-radius: 12px; margin-top: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                        <h3
                            style="margin: 0 0 20px 0; color: var(--tpjd-dark); display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--tpjd-danger);"></i>
                            Borçlu Üyeler Listesi
                            <span id="debtorCount"
                                style="margin-left: auto; font-size: 14px; color: var(--tpjd-warning); background: rgba(230, 126, 34, 0.1); padding: 5px 15px; border-radius: 20px;"></span>
                        </h3>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Üye No</th>
                                        <th>Ad Soyad</th>
                                        <th>Üyelik Tipi</th>
                                        <th>E-posta</th>
                                        <th>Telefon</th>
                                        <th>Ödeme Durumu</th>
                                        <th>Borç Tutarı</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboardMembersTable">
                                    <tr>
                                        <td colspan="8" class="empty-state">
                                            <i class="fas fa-users"></i>
                                            <h3>Henüz üye kaydı bulunmamaktadır</h3>
                                            <p>Yeni üye eklemek için "Yeni Üye Ekle" butonuna tıklayın</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Members Tab -->
                <div id="members" class="tab-content">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('memberModal')">
                            <i class="fas fa-user-plus"></i> Yeni Üye Ekle
                        </button>
                        <div id="membersStatusLine"
                            style="margin-left: 15px; font-weight: bold; color: #4f46e5; display: flex; align-items: center;">
                            Yüklenen üye sayısı: <span id="loadedMembersCount">0</span></div>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="memberSearch" placeholder="Üye ara..." onkeyup="searchMembers()">
                        </div>
                        <button class="btn btn-secondary" onclick="exportMembersToExcel()">
                            <i class="fas fa-file-excel"></i> Excel'e Aktar
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Üye No</th>
                                    <th>Ad Soyad</th>
                                    <th>TC No</th>
                                    <th>E-posta</th>
                                    <th>Telefon</th>
                                    <th>Üyelik Tipi</th>
                                    <th>Kayıt Tarihi</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="membersTable">
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <h3>Henüz üye kaydı bulunmamaktadır</h3>
                                        <p>Yeni üye eklemek için "Yeni Üye Ekle" butonuna tıklayın</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Tab with Accordion -->
                <div id="payments" class="tab-content">
                    <div class="toolbar">
                        <button class="btn btn-success" onclick="openModal('paymentModal')">
                            <i class="fas fa-plus-circle"></i> Ödeme Ekle
                        </button>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="paymentSearch" placeholder="Ödeme ara..." onkeyup="searchPayments()">
                        </div>
                        <button class="btn btn-secondary" onclick="exportPaymentsToExcel()">
                            <i class="fas fa-file-excel"></i> Excel'e Aktar
                        </button>
                    </div>

                    <div id="paymentsAccordion">
                        <!-- Accordion items will be dynamically generated here -->
                    </div>
                </div>

                <!-- Transactions Tab -->

                <!-- Notifications Tab -->
                <div id="notifications" class="tab-content">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('notificationModal')">
                            <i class="fas fa-bell"></i> Yeni Bildirim Gönder
                        </button>
                        <button class="btn btn-warning" onclick="openBulkEmailModal()">
                            <i class="fas fa-envelope"></i> Toplu E-posta Gönder
                        </button>
                        <button class="btn btn-success" onclick="openBulkSMSModal()"
                            style="background: #25D366; border-color: #25D366;">
                            <i class="fas fa-sms"></i> Toplu SMS Gönder
                        </button>
                        <button class="btn btn-success" onclick="openBulkWhatsAppModal()"
                            style="background: #25D366; border-color: #128C7E;">
                            <i class="fab fa-whatsapp"></i> Toplu WhatsApp
                        </button>
                    </div>

                    <div id="notificationsList">
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <h3>Henüz bildirim bulunmamaktadır</h3>
                            <p>Yeni bildirim göndermek için "Yeni Bildirim Gönder" butonuna tıklayın</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings" class="tab-content">
                    <div class="stats-grid" style="grid-template-columns: 1fr;">
                        <div class="stat-card">
                            <h3><i class="fas fa-key"></i> Kullanıcı Adı ve Şifre Değiştir</h3>
                            <form id="passwordForm" style="margin-top: 20px;">
                                <div class="form-group">
                                    <label>Mevcut Kullanıcı Adı</label>
                                    <input type="text" id="currentUsername" readonly style="background: #f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>Mevcut Şifre</label>
                                    <input type="password" id="currentPasswordCheck" required
                                        placeholder="Mevcut şifrenizi girin">
                                </div>
                                <div class="form-group">
                                    <label>Yeni Kullanıcı Adı</label>
                                    <input type="text" id="newUsername" required placeholder="Yeni kullanıcı adı">
                                </div>
                                <div class="form-group">
                                    <label>Yeni Şifre</label>
                                    <input type="password" id="newPassword" required
                                        placeholder="Yeni şifre (min. 6 karakter)">
                                </div>
                                <div class="form-group">
                                    <label>Yeni Şifre Tekrar</label>
                                    <input type="password" id="newPasswordConfirm" required
                                        placeholder="Yeni şifre tekrar">
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveAllSettings()"
                                    style="width: 100%; margin-top: 10px;">
                                    <i class="fas fa-save"></i> Değişiklikleri Kaydet
                                </button>
                            </form>
                        </div>

                        <!-- Agent Mail Ayarları -->
                        <div class="stat-card" style="border-left:4px solid #9b59b6;">
                            <h3><i class="fas fa-envelope-open-text" style="color:#9b59b6;"></i> Agent Mail Ayarları
                            </h3>
                            <p style="margin:10px 0 20px;color:#7f8c8d;font-size:13px;">
                                Aylık rapor ve bildirimler hangi email adreslerine gönderilsin? Virgülle ayırarak birden
                                fazla adres girebilirsiniz.
                            </p>

                            <div
                                style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
                                <!-- Aylık Rapor Alıcıları -->
                                <div class="form-group">
                                    <label><i class="fas fa-chart-bar" style="color:#673ab7;"></i> Aylık Rapor
                                        Alıcıları</label>
                                    <textarea id="settingMonthlyEmails" rows="3"
                                        placeholder="ornek@tpjd.org.tr, baskan@tpjd.org.tr"
                                        style="width:100%;padding:10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;resize:vertical;"></textarea>
                                    <small style="color:#7f8c8d;">Ay sonunda mali özet raporu bu adreslere
                                        gönderilir</small>
                                </div>

                                <!-- Genel Bildirim Alıcıları -->
                                <div class="form-group">
                                    <label><i class="fas fa-bell" style="color:#e67e22;"></i> Genel Bildirim
                                        Alıcıları</label>
                                    <textarea id="settingNotifyEmails" rows="3" placeholder="yonetim@tpjd.org.tr"
                                        style="width:100%;padding:10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;resize:vertical;"></textarea>
                                    <small style="color:#7f8c8d;">Sistem bildirimleri (hata, uyarı) bu adreslere
                                        gönderilir</small>
                                </div>
                            </div>

                            <div
                                style="margin-top:15px;padding:15px;background:rgba(155,89,182,0.05);border-radius:8px;">
                                <h4 style="margin:0 0 12px;font-size:14px;color:var(--tpjd-dark);"><i
                                        class="fas fa-users"></i> Hızlı Kişi Ekleme</h4>
                                <div
                                    style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;">
                                    <div class="form-group" style="margin:0;">
                                        <label style="font-size:12px;">Dernek Başkanı</label>
                                        <input type="email" id="settingPresidentEmail" placeholder="baskan@ornek.com"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <label style="font-size:12px;">Sayman</label>
                                        <input type="email" id="settingTreasurerEmail" placeholder="sayman@ornek.com"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <label style="font-size:12px;">Genel Sekreter</label>
                                        <input type="email" id="settingSecretaryEmail" placeholder="sekreter@ornek.com"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                    </div>
                                </div>
                                <button type="button" onclick="addQuickEmailsToMonthly()" class="btn"
                                    style="margin-top:10px;padding:6px 14px;background:#9b59b6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                                    <i class="fas fa-plus"></i> Yukarıdaki kişileri Aylık Rapor'a ekle
                                </button>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="saveAgentEmailSettings()"
                                style="width:100%;margin-top:15px;">
                                <i class="fas fa-save"></i> Agent Mail Ayarlarını Kaydet
                            </button>
                        </div>

                        <!-- WhatsApp Kurulumu -->
                        <div class="stat-card" style="border-left:4px solid #25D366;">
                            <h3><i class="fab fa-whatsapp" style="color:#25D366;"></i> WhatsApp Kurulumu</h3>
                            <p style="margin:10px 0 15px;color:var(--text-muted);font-size:13px;">
                                WhatsApp mesaj gönderimi için bilgisayarınıza küçük bir program kurmanız gerekiyor.
                                Aşağıdaki adımları takip edin.
                            </p>

                            <!-- Durum Kontrolü -->
                            <div id="wpSetupStatus"
                                style="padding:12px 16px;border-radius:8px;margin-bottom:15px;background:var(--btn-secondary-bg);display:flex;align-items:center;gap:10px;">
                                <div id="wpStatusDot"
                                    style="width:10px;height:10px;border-radius:50%;background:#e74c3c;flex-shrink:0;">
                                </div>
                                <span id="wpStatusText" style="font-size:13px;color:var(--text-secondary);">Bağlantı
                                    kontrol edilmedi</span>
                                <button onclick="checkWPServerStatus()"
                                    style="margin-left:auto;padding:5px 12px;background:#25D366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                                    <i class="fas fa-sync-alt"></i> Kontrol Et
                                </button>
                            </div>

                            <!-- İndirme Butonları -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
                                <a href="TPJD_WhatsApp_Kurulum.zip" download
                                    style="display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;border-radius:8px;text-decoration:none;font-weight:600;font-size:13px;transition:transform 0.2s;"
                                    onmouseover="this.style.transform='translateY(-2px)'"
                                    onmouseout="this.style.transform='none'">
                                    <i class="fas fa-download"></i> WhatsApp Paketi İndir
                                </a>
                                <a href="https://nodejs.org/en/download/" target="_blank"
                                    style="display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;background:linear-gradient(135deg,#68A063,#3C873A);color:white;border-radius:8px;text-decoration:none;font-weight:600;font-size:13px;transition:transform 0.2s;"
                                    onmouseover="this.style.transform='translateY(-2px)'"
                                    onmouseout="this.style.transform='none'">
                                    <i class="fab fa-node-js"></i> Node.js İndir
                                </a>
                            </div>

                            <!-- Kurulum Adımları -->
                            <div style="background:var(--btn-secondary-bg);border-radius:10px;padding:16px;">
                                <h4 style="margin:0 0 14px;font-size:14px;color:var(--text-primary);">📋 Kurulum
                                    Adımları</h4>

                                <div style="display:flex;flex-direction:column;gap:12px;">
                                    <!-- Adım 1 -->
                                    <div style="display:flex;gap:10px;align-items:start;">
                                        <div
                                            style="width:28px;height:28px;border-radius:50%;background:#25D366;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;">
                                            1</div>
                                        <div style="font-size:13px;color:var(--text-secondary);line-height:1.5;">
                                            <strong style="color:var(--text-primary);">Node.js Kur</strong><br>
                                            Yukarıdaki yeşil "Node.js İndir" butonuna tıklayın → <strong>LTS</strong>
                                            sürümünü indirip kurun (Next → Next → Finish)
                                        </div>
                                    </div>

                                    <!-- Adım 2 -->
                                    <div style="display:flex;gap:10px;align-items:start;">
                                        <div
                                            style="width:28px;height:28px;border-radius:50%;background:#25D366;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;">
                                            2</div>
                                        <div style="font-size:13px;color:var(--text-secondary);line-height:1.5;">
                                            <strong style="color:var(--text-primary);">WhatsApp Paketini
                                                İndir</strong><br>
                                            Yeşil "WhatsApp Paketi İndir" butonuna tıklayın → ZIP dosyasını
                                            <strong>masaüstüne</strong> çıkartın
                                        </div>
                                    </div>

                                    <!-- Adım 3 -->
                                    <div style="display:flex;gap:10px;align-items:start;">
                                        <div
                                            style="width:28px;height:28px;border-radius:50%;background:#25D366;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;">
                                            3</div>
                                        <div style="font-size:13px;color:var(--text-secondary);line-height:1.5;">
                                            <strong style="color:var(--text-primary);">Programı Başlat</strong><br>
                                            Çıkartılan klasördeki <strong>TPJD_WHATSAPP.bat</strong> dosyasını çift
                                            tıklayarak açın. İlk çalıştırmada gerekli dosyalar otomatik inecektir (1-2
                                            dk).
                                        </div>
                                    </div>

                                    <!-- Adım 4 -->
                                    <div style="display:flex;gap:10px;align-items:start;">
                                        <div
                                            style="width:28px;height:28px;border-radius:50%;background:#25D366;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;">
                                            4</div>
                                        <div style="font-size:13px;color:var(--text-secondary);line-height:1.5;">
                                            <strong style="color:var(--text-primary);">QR Kod Okut</strong><br>
                                            Ekranda QR kodu çıkacak → Telefonunuzda <strong>WhatsApp → Bağlı Cihazlar →
                                                Cihaz Bağla</strong> ile okutun
                                        </div>
                                    </div>

                                    <!-- Adım 5 -->
                                    <div style="display:flex;gap:10px;align-items:start;">
                                        <div
                                            style="width:28px;height:28px;border-radius:50%;background:#25D366;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;">
                                            5</div>
                                        <div style="font-size:13px;color:var(--text-secondary);line-height:1.5;">
                                            <strong style="color:var(--text-primary);">Hazır!</strong><br>
                                            "WHATSAPP BAGLANDI!" mesajını gördükten sonra bu panel üzerinden mesaj
                                            gönderebilirsiniz. <strong>Siyah pencereyi kapatmayın!</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Uyarılar -->
                            <div
                                style="margin-top:15px;padding:12px;background:rgba(241,196,15,0.08);border:1px solid rgba(241,196,15,0.2);border-radius:8px;font-size:12px;color:var(--text-secondary);line-height:1.6;">
                                <strong style="color:#f39c12;">⚠️ Önemli Notlar:</strong><br>
                                • Siyah pencere (komut satırı) açık kalmalıdır — kapatırsanız WhatsApp bağlantısı
                                kesilir<br>
                                • İlk QR okutmadan sonra oturum hatırlanır, tekrar okutmanız gerekmez<br>
                                • Bilgisayarı yeniden başlattığınızda <strong>TPJD_WHATSAPP.bat</strong>'ı tekrar
                                çalıştırmanız yeterli<br>
                                • Sorun yaşarsanız: <code
                                    style="background:var(--btn-secondary-bg);padding:2px 6px;border-radius:3px;">whatsapp-server</code>
                                klasöründeki <code
                                    style="background:var(--btn-secondary-bg);padding:2px 6px;border-radius:3px;">.wwebjs_auth</code>
                                klasörünü silin ve tekrar başlatın
                            </div>
                        </div>

                        <div class="stat-card info">
                            <h3><i class="fas fa-info-circle"></i> Sistem Bilgileri</h3>
                            <div style="margin-top: 20px;">
                                <div class="detail-item" style="margin-bottom: 15px;">
                                    <label>Toplam Üye Sayısı</label>
                                    <div class="value" id="settingsTotalMembers">0</div>
                                </div>
                                <div class="detail-item" style="margin-bottom: 15px;">
                                    <label>Toplam Ödeme Sayısı</label>
                                    <div class="value" id="settingsTotalPayments">0</div>
                                </div>
                                <div class="detail-item">
                                    <label>Versiyon</label>
                                    <div class="value">v1.0.0</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card warning">
                            <h3><i class="fas fa-money-bill-wave"></i> Aidat Tutarları</h3>
                            <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                                Her üyelik tipi için yıllık aidat tutarlarını belirleyin. Bu tutarlar otomatik
                                borçlandırma işleminde kullanılacaktır.
                            </p>
                            <form id="aidatSettingsForm" style="margin-top: 20px;">
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div class="form-group">
                                        <label>Asil Üye Aidatı (₺)</label>
                                        <input type="number" id="aidatAsilUye" min="0" step="0.01" value="100" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Asil Onursal Aidatı (₺)</label>
                                        <input type="number" id="aidatAsilOnursal" min="0" step="0.01" value="0"
                                            required>
                                        <small style="color: #7f8c8d;">0 ise borçlandırılmaz</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Öğrenci Üye Aidatı (₺)</label>
                                        <input type="number" id="aidatOgrenciUye" min="0" step="0.01" value="50"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label>Fahri Üye Aidatı (₺)</label>
                                        <input type="number" id="aidatFahriUye" min="0" step="0.01" value="100"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label>Fahri Onursal Aidatı (₺)</label>
                                        <input type="number" id="aidatFahriOnursal" min="0" step="0.01" value="0"
                                            required>
                                        <small style="color: #7f8c8d;">0 ise borçlandırılmaz</small>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveAllSettings()"
                                    style="width: 100%; margin-top: 15px;">
                                    <i class="fas fa-save"></i> Aidat Tutarlarını Kaydet
                                </button>
                            </form>

                            <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid var(--tpjd-light);">
                                <h4 style="color: var(--tpjd-dark); margin-bottom: 15px;">
                                    <i class="fas fa-calendar-check"></i> Otomatik Yıllık Borçlandırma
                                </h4>
                                <p style="margin: 10px 0; color: #7f8c8d; font-size: 14px;">
                                    Tüm üyeleri yukarıdaki tutarlar üzerinden seçtiğiniz yıl için otomatik borçlandırın.
                                </p>
                                <div style="display: flex; gap: 15px; align-items: flex-end; margin-top: 15px;">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Borçlandırma Yılı</label>
                                        <input type="number" id="borclandirmaYili" min="2020" max="2050" required
                                            style="width: 100%;">
                                    </div>
                                </div>

                                <div class="stat-card" style="border-left: 4px solid #2980b9; margin-top: 25px;">
                                    <h3><i class="fas fa-university"></i> Banka / IBAN Bilgileri</h3>
                                    <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                                        Borç hatırlatma mesajlarına otomatik eklenir. Üyeler bu bilgilerle ödeme
                                        yapabilir.
                                    </p>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                                        <div class="form-group">
                                            <label>Banka Adı</label>
                                            <input type="text" id="ibanBankaAdi" placeholder="Örn: Ziraat Bankası"
                                                style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                        </div>
                                        <div class="form-group">
                                            <label>Hesap Sahibi</label>
                                            <input type="text" id="ibanHesapSahibi" placeholder="Örn: TPJD Derneği"
                                                style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-top: 15px;">
                                        <label>IBAN Numarası</label>
                                        <input type="text" id="ibanNumarasi"
                                            placeholder="TR00 0000 0000 0000 0000 0000 00"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:14px;font-family:monospace;width:100%;letter-spacing:1px;">
                                    </div>
                                    <div class="form-group" style="margin-top: 15px;">
                                        <label>Ödeme Açıklaması <small style="color:#95a5a6;">(opsiyonel — üyeye
                                                "açıklamaya şunu yazın" diye gider)</small></label>
                                        <input type="text" id="ibanAciklama" placeholder="Örn: TPJD Aidat - Ad Soyad"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="saveIbanSettings()"
                                        style="width: 100%; margin-top: 15px;">
                                        <i class="fas fa-save"></i> IBAN Bilgilerini Kaydet
                                    </button>
                                </div>


                                <div class="stat-card" style="border-left: 4px solid #25D366;">
                                    <h3><i class="fas fa-sms"></i> NETGSM SMS Ayarları</h3>
                                    <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                                        Üyelere SMS gönderimi için NETGSM API entegrasyon ayarlarını yapılandırın.
                                    </p>
                                    <form id="netgsmSettingsForm" style="margin-top: 20px;">
                                        <div
                                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                            <div class="form-group">
                                                <label>NETGSM Abone Numarası (Kullanıcı Adı)</label>
                                                <input type="text" id="netgsmUsername"
                                                    placeholder="850XXXXXXX veya 312XXXXXXX" required>
                                                <small style="color: #7f8c8d;">Abone numaranız (850xxxxxxx
                                                    formatında)</small>
                                            </div>
                                            <div class="form-group">
                                                <label>NETGSM Şifre (Alt Kullanıcı)</label>
                                                <input type="password" id="netgsmPassword"
                                                    placeholder="Alt kullanıcı şifreniz" required>
                                                <small style="color: #7f8c8d;">API yetkili alt kullanıcı şifresi</small>
                                            </div>
                                            <div class="form-group">
                                                <label>Gönderici Adı (Mesaj Başlığı)</label>
                                                <input type="text" id="netgsmHeader" placeholder="SMS BASLIK"
                                                    maxlength="11" required>
                                                <small style="color: #7f8c8d;">3-11 karakter, sistemde tanımlı
                                                    olmalı</small>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                                            <button type="button" class="btn btn-primary" onclick="saveNetgsmSettings()"
                                                style="flex: 1;">
                                                <i class="fas fa-save"></i> SMS Ayarlarını Kaydet
                                            </button>
                                            <button type="button" class="btn btn-secondary"
                                                onclick="testNetgsmConnection()" style="flex: 1;">
                                                <i class="fas fa-plug"></i> Bağlantıyı Test Et
                                            </button>
                                        </div>
                                    </form>
                                </div>




                                <!-- Yedekleme Paneli (Akordiyon) -->
                                <details class="stat-card"
                                    style="border-left: 4px solid #27ae60; margin-top: 20px; cursor: pointer;">
                                    <summary
                                        style="list-style: none; display: flex; align-items: center; justify-content: space-between; padding: 5px 0;">
                                        <h3 style="margin: 0;"><i class="fas fa-shield-alt" style="color:#27ae60;"></i>
                                            Yedekleme</h3>
                                        <i class="fas fa-chevron-down"
                                            style="color: #7f8c8d; transition: transform 0.3s;"></i>
                                    </summary>

                                    <!-- JSON Yedekleme kaldırıldı — sadece sunucu yedekleme aktif -->

                                    <!-- Sunucu Yedekleme -->
                                    <div
                                        style="margin-top: 15px; padding: 15px; background: rgba(39,174,96,0.05); border-radius: 8px;">
                                        <h4 style="margin: 0 0 10px; font-size: 14px; color: var(--tpjd-dark);">
                                            <i class="fas fa-hdd" style="color:#27ae60;"></i> Sunucu Yedekleme
                                        </h4>
                                        <p style="margin: 0 0 10px; color: #7f8c8d; font-size: 13px;">
                                            Veritabanının tamamını sunucu tarafında yedekleyin. Sayfa açıldığında
                                            haftada 1 otomatik yedek alınır.
                                            30 günden eski yedekler otomatik temizlenir.
                                        </p>

                                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                            <button type="button" class="btn" onclick="createServerBackup()"
                                                style="background:#27ae60; color:white; border:none;">
                                                <i class="fas fa-plus-circle"></i> Yeni Yedek Oluştur
                                            </button>
                                            <button type="button" class="btn btn-secondary"
                                                onclick="loadServerBackups()">
                                                <i class="fas fa-sync"></i> Listeyi Yenile
                                            </button>
                                        </div>

                                        <div id="serverBackupResult"
                                            style="display:none; margin-bottom:10px; padding:10px; border-radius:6px;">
                                        </div>

                                        <div id="serverBackupList"
                                            style="background: #f8f9fa; border-radius: 8px; padding: 10px;">
                                            <p style="color: #95a5a6; text-align: center;">Yükleniyor...</p>
                                        </div>
                                    </div>



                                </details>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent Dashboard Tab -->
                <div id="agents" class="tab-content">
                    <!-- WhatsApp Bağlantı Durumu -->
                    <div id="waStatusCard"
                        style="background:white;padding:20px 25px;border-radius:12px;margin-bottom:25px;box-shadow:0 5px 20px rgba(0,0,0,0.08);border-left:5px solid #95a5a6;display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:250px;">
                            <i class="fab fa-whatsapp" style="font-size:32px;color:#25D366;"></i>
                            <div>
                                <strong style="font-size:16px;color:var(--tpjd-dark);">WhatsApp Lokal
                                    Sunucu</strong>
                                <div id="waStatusText" style="font-size:13px;color:#95a5a6;margin-top:2px;">
                                    Kontrol
                                    ediliyor...</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <span id="waStatusBadge" class="badge"
                                style="background:rgba(149,165,166,0.15);color:#95a5a6;">Bilinmiyor</span>
                            <button class="btn" onclick="checkWhatsAppStatus()"
                                style="font-size:12px;padding:8px 14px;background:var(--tpjd-info);color:white;">
                                <i class="fas fa-sync-alt"></i> Kontrol Et
                            </button>
                            <button class="btn" onclick="showWhatsAppQR()"
                                style="font-size:12px;padding:8px 14px;background:#25D366;color:white;">
                                <i class="fas fa-qrcode"></i> QR Kod
                            </button>
                        </div>
                    </div>

                    <!-- WhatsApp QR Modal -->
                    <div id="waQRModal" class="modal">
                        <div class="modal-content" style="max-width:400px;">
                            <div class="modal-header" style="background:linear-gradient(135deg,#25D366,#128C7E);">
                                <h2><i class="fab fa-whatsapp"></i> WhatsApp Bağla</h2>
                                <button class="close"
                                    onclick="document.getElementById('waQRModal').classList.remove('active')">&times;</button>
                            </div>
                            <div class="modal-body" style="text-align:center;padding:30px;">
                                <div id="waQRContent">
                                    <p style="color:#555;margin-bottom:20px;">QR kodu yüklemek için
                                        <strong>TPJD_WHATSAPP.bat</strong>'ı çalıştırın
                                    </p>
                                    <div id="waQRImage" style="margin:20px auto;"></div>
                                    <p style="font-size:12px;color:#999;margin-top:15px;">WhatsApp > Bağlı
                                        Cihazlar >
                                        Cihaz Bağla</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Stats -->
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left: 4px solid #9b59b6;">
                            <h3><i class="fas fa-robot" style="color:#9b59b6"></i> Aktif Ajanlar</h3>
                            <div class="value" id="activeAgentsCount">0</div>
                            <div class="subtitle">Çalışan otomasyon sayısı</div>
                        </div>
                        <div class="stat-card success">
                            <h3><i class="fas fa-check-circle"></i> Bu Ay İşlemler</h3>
                            <div class="value" id="monthlyAgentActions">0</div>
                            <div class="subtitle">Başarılı agent işlemi</div>
                        </div>
                        <div class="stat-card info">
                            <h3><i class="fas fa-percentage"></i> Tahsilat Oranı</h3>
                            <div class="value" id="collectionRate">%0</div>
                            <div class="subtitle">Toplam aidat tahsilat oranı</div>
                        </div>
                        <div class="stat-card warning">
                            <h3><i class="fas fa-exclamation-triangle"></i> Borçlu Üye</h3>
                            <div class="value" id="debtorCountAgent">0</div>
                            <div class="subtitle" id="totalDebtAmount">₺0 toplam borç</div>
                        </div>
                    </div>

                    <!-- Agent Controls -->
                    <div
                        style="background:white;padding:25px;border-radius:12px;margin-top:25px;box-shadow:0 5px 20px rgba(0,0,0,0.08);">
                        <h3 style="margin:0 0 20px;color:var(--tpjd-dark);display:flex;align-items:center;gap:10px;">
                            <i class="fas fa-sliders-h" style="color:#9b59b6;"></i>
                            Agent Kontrol Paneli
                            <button id="agentRunAllBtn" class="btn" onclick="agentManager.runAllAgents()"
                                style="margin-left:auto;font-size:13px;background:#8e44ad;border-color:#8e44ad;color:white;">
                                <i class="fas fa-play-circle"></i> Tümünü Çalıştır
                            </button>
                            <button id="agentRefreshBtn" class="btn" onclick="agentManager.refreshAll()"
                                style="font-size:13px;background:#e74c3c;border-color:#e74c3c;color:white;">
                                <i class="fas fa-sync-alt"></i> Yenile
                            </button>
                            <span id="agentLastRefresh"
                                style="font-size:11px;color:#95a5a6;margin-left:8px;white-space:nowrap;"></span>
                        </h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:15px;"
                            id="agentCards">
                            <!-- Payment Confirm Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #27ae60;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-check-double" style="color:#27ae60"></i>
                                            Ödeme Onay</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_payment_confirm" checked
                                            onchange="agentManager.toggleAgent('payment_confirm',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Ödeme
                                    kaydedildiğinde otomatik Email+WA bildirimi</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_payment_confirm">—
                                </div>
                            </div>
                            <!-- Welcome Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #3498db;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-hand-sparkles" style="color:#3498db"></i>
                                            Hoş Geldin</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_welcome" checked
                                            onchange="agentManager.toggleAgent('welcome',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Yeni üye kaydında
                                    karşılama mesajı gönderir</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_welcome">
                                    —</div>
                            </div>
                            <!-- Debt Reminder Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #e67e22;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-bell" style="color:#e67e22"></i> Borç
                                            Hatırlatma</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_debt_reminder" checked
                                            onchange="agentManager.toggleAgent('debt_reminder',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">3 kademeli borç
                                    hatırlatma (nazik→resmi→son uyarı)</p>
                                <div style="display:flex;gap:8px;margin-top:8px;">
                                    <button class="btn btn-warning" onclick="agentManager.runDebtReminder(1)"
                                        style="font-size:11px;padding:4px 10px;">Kademe 1</button>
                                    <button class="btn btn-warning" onclick="agentManager.runDebtReminder(2)"
                                        style="font-size:11px;padding:4px 10px;">Kademe 2</button>
                                    <button class="btn btn-danger" onclick="agentManager.runDebtReminder(3)"
                                        style="font-size:11px;padding:4px 10px;">Kademe 3</button>
                                </div>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_debt_reminder">—
                                </div>
                            </div>
                            <!-- Yearly Charge Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #f39c12;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-calendar-alt" style="color:#f39c12"></i>
                                            Yıllık Borçlandırma</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_yearly_charge" checked
                                            onchange="agentManager.toggleAgent('yearly_charge',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Yılbaşında otomatik
                                    aidat borçlandırması</p>
                                <button class="btn btn-primary" onclick="agentManager.runYearlyCharge()"
                                    style="font-size:12px;padding:5px 12px;margin-top:8px;">
                                    <i class="fas fa-play"></i> Şimdi Çalıştır
                                </button>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_yearly_charge">—
                                </div>
                            </div>
                            <!-- Birthday Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #e91e63;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-birthday-cake" style="color:#e91e63"></i>
                                            Doğum Günü</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_birthday" checked
                                            onchange="agentManager.toggleAgent('birthday',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Doğum günü kutlama
                                    mesajı gönderir</p>
                                <button class="btn btn-primary" onclick="agentManager.runBirthdayAgent()"
                                    style="font-size:12px;padding:5px 12px;margin-top:8px;background:#e91e63;border-color:#e91e63;">
                                    <i class="fas fa-play"></i> Bugünü Kontrol Et
                                </button>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_birthday">—
                                </div>
                            </div>
                            <!-- Accounting Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #00bcd4;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-calculator" style="color:#00bcd4"></i>
                                            Muhasebe</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_accounting" checked
                                            onchange="agentManager.toggleAgent('accounting',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Tahsilat oranı,
                                    aylık gelir, toplam borç takibi</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_accounting">—
                                </div>
                            </div>
                            <!-- Monthly Report Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #673ab7;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-chart-bar" style="color:#673ab7"></i>
                                            Aylık Rapor</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_monthly_report" checked
                                            onchange="agentManager.toggleAgent('monthly_report',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Ay sonunda mali özet
                                    raporu
                                    gönderilir (Ayarlar→Agent Mail)</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_monthly_report">—
                                </div>
                            </div>
                            <!-- Event Announcement Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #ff5722;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-bullhorn" style="color:#ff5722"></i>
                                            Etkinlik Duyuru</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_event_announce" checked
                                            onchange="agentManager.toggleAgent('event_announce',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Etkinlik detaylarını
                                    üyelere duyurur</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_event_announce">—
                                </div>
                            </div>
                            <!-- Seniority Promotion Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #ff9800;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-medal" style="color:#ff9800"></i>
                                            Kıdem Terfi</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_seniority_promotion" checked
                                            onchange="agentManager.toggleAgent('seniority_promotion',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">20+ yıllık üyeleri
                                    otomatik onursal üyeliğe terfi eder</p>
                                <button class="btn btn-primary" onclick="agentManager.runSeniorityAgent()"
                                    style="font-size:12px;padding:5px 12px;margin-top:8px;background:#ff9800;border-color:#ff9800;">
                                    <i class="fas fa-play"></i> Şimdi Kontrol Et
                                </button>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_seniority_promotion">
                                    —
                                </div>
                            </div>
                            <!-- Special Day Greeting Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #e91e63;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-gift" style="color:#e91e63"></i>
                                            Özel Gün Kutlama</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_special_day_greeting"
                                            checked
                                            onchange="agentManager.toggleAgent('special_day_greeting',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Özel günlerde (Kadınlar G.,
                                    Anneler G., bayramlar vs.) otomatik kutlama mesajı gönderir</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;"
                                    id="stat_special_day_greeting">—
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Logs - Single Accordion -->
                    <div
                        style="background:white;border-radius:12px;margin-top:25px;box-shadow:0 5px 20px rgba(0,0,0,0.08);overflow:hidden;">
                        <!-- Accordion Header (clickable) -->
                        <div onclick="document.getElementById('agentLogsBody').style.display = document.getElementById('agentLogsBody').style.display === 'none' ? 'block' : 'none'; this.querySelector('.accordion-chevron').classList.toggle('fa-chevron-down'); this.querySelector('.accordion-chevron').classList.toggle('fa-chevron-up');"
                            style="padding:18px 25px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background 0.15s;"
                            onmouseover="this.style.background='rgba(155,89,182,0.05)'"
                            onmouseout="this.style.background='transparent'">
                            <i class="fas fa-history" style="color:#9b59b6;font-size:18px;"></i>
                            <span style="font-size:16px;font-weight:700;color:var(--tpjd-dark);">Agent İşlem
                                Geçmişi</span>
                            <span id="agentLogCount"
                                style="background:#9b59b6;color:white;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">0</span>
                            <i class="fas fa-chevron-down accordion-chevron"
                                style="margin-left:auto;color:#95a5a6;transition:transform 0.2s;"></i>
                        </div>

                        <!-- Accordion Body (default hidden) -->
                        <div id="agentLogsBody" style="display:none;">
                            <!-- Filter + Bulk Toolbar -->
                            <div style="padding:0 25px 15px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                                <select id="agentLogFilter" onchange="agentManager.loadLogs()"
                                    style="padding:6px 12px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;background:rgba(255,255,255,0.05);">
                                    <option value="">Tüm Ajanlar</option>
                                    <option value="payment_confirm">Ödeme Onay</option>
                                    <option value="welcome">Hoş Geldin</option>
                                    <option value="debt_reminder">Borç Hatırlatma</option>
                                    <option value="yearly_charge">Yıllık Borçlandırma</option>
                                    <option value="birthday">Doğum Günü</option>
                                    <option value="accounting">Muhasebe</option>
                                    <option value="monthly_report">Aylık Rapor</option>
                                    <option value="event_announce">Etkinlik Duyuru</option>
                                </select>

                                <label
                                    style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:13px;color:inherit;">
                                    <input type="checkbox" id="logSelectAll"
                                        onchange="agentManager.toggleSelectAll(this.checked)"
                                        style="width:15px;height:15px;cursor:pointer;">
                                    Tümünü Seç
                                </label>
                                <span id="logSelectedCount" style="font-size:12px;color:#95a5a6;">0
                                    seçili</span>
                                <button onclick="agentManager.deleteSelected()" id="logDeleteSelectedBtn"
                                    style="margin-left:auto;padding:6px 14px;background:#e74c3c;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;display:none;">
                                    <i class="fas fa-trash-alt"></i> Seçilenleri Sil
                                </button>
                            </div>

                            <!-- Log Table -->
                            <div style="padding:0 25px 20px;overflow-x:auto;">
                                <table style="width:100%;border-collapse:separate;border-spacing:0 4px;">
                                    <thead>
                                        <tr>
                                            <th style="width:30px;padding:8px 6px;"></th>
                                            <th
                                                style="text-align:left;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                                Agent</th>
                                            <th
                                                style="text-align:left;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                                Alıcı</th>
                                            <th
                                                style="text-align:left;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                                Detay</th>
                                            <th
                                                style="text-align:left;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;">
                                                Tarih</th>
                                            <th
                                                style="text-align:center;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                                Durum</th>
                                            <th style="width:40px;padding:8px 6px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="agentLogsTable">
                                        <tr>
                                            <td colspan="7" style="text-align:center;padding:40px;">
                                                <i class="fas fa-robot" style="font-size:48px;color:#bdc3c7;"></i>
                                                <p style="color:#95a5a6;margin-top:10px;">Henüz agent işlemi yok
                                                </p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk SMS Modal -->
        <div id="bulkSMSModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2><i class="fas fa-sms"></i> Toplu SMS Gönder</h2>
                    <span class="close" onclick="closeBulkSMSModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Hedef Grup *</label>
                        <select id="bulkSMSTarget" onchange="updateSMSPreview()">
                            <option value="">-- Seçiniz --</option>
                            <option value="all">Tüm Üyeler</option>
                            <option value="debtors">Borçlu Üyeler</option>
                            <option value="active">Aktif Üyeler (Aidat Ödeyen)</option>
                            <option value="asil">Asil Üyeler</option>
                            <option value="ogrenci">Öğrenci Üyeler</option>
                            <option value="fahri">Fahri Üyeler</option>
                        </select>
                    </div>

                    <!-- Önizleme Alanı -->
                    <div id="smsPreviewSection"
                        style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #25D366;">
                        <h4 style="margin: 0 0 10px 0; color: var(--tpjd-dark); font-size: 14px;">
                            <i class="fas fa-users"></i> Alıcılar
                        </h4>
                        <div id="smsRecipientCount"
                            style="font-size: 16px; font-weight: 600; color: #25D366; margin-bottom: 10px;">
                        </div>
                        <details style="cursor: pointer;">
                            <summary style="color: var(--tpjd-primary); font-weight: 600; font-size: 13px;">
                                Telefon numaralarını göster</summary>
                            <div id="smsRecipientList"
                                style="max-height: 120px; overflow-y: auto; margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 12px; color: #666;">
                            </div>
                        </details>
                    </div>

                    <div class="form-group">
                        <label>Mesaj İçeriği *</label>
                        <textarea id="bulkSMSMessage" placeholder="SMS mesajınızı buraya yazın..." rows="6"
                            maxlength="917" oninput="updateSMSCharCount()"></textarea>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <small style="color: #7f8c8d;">
                                <i class="fas fa-info-circle"></i> Maksimum 917 karakter
                            </small>
                            <small id="smsCharCount" style="color: var(--tpjd-primary); font-weight: 600;">0 /
                                917</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>İYS Filtresi (Ticari İleti)</label>
                        <select id="smsIysFilter">
                            <option value="0">Bilgilendirme (İYS kontrolü yok)</option>
                            <option value="11">Ticari - Bireysel (İYS kontrollü)</option>
                            <option value="12">Ticari - Tacir (İYS kontrollü)</option>
                        </select>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            <i class="fas fa-exclamation-triangle"></i> Ticari içerikli mesajlar İYS'den kontrol
                            edilir.
                        </small>
                    </div>
                </div>
                <div class="modal-footer" style="flex-direction: column; gap: 15px;">
                    <div
                        style="width: 100%; padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #25D366;">
                        <strong style="color: #2e7d32; font-size: 14px;">
                            <i class="fas fa-info-circle"></i> SMS Gönderim Bilgisi
                        </strong>
                        <p style="margin: 8px 0 0 0; font-size: 13px; color: #2e7d32;">
                            SMS gönderimi NETGSM üzerinden gerçekleştirilir. Gönderim ücretleri NETGSM
                            paketinizden düşülür.
                        </p>
                    </div>

                    <div style="display: flex; gap: 10px; width: 100%;">
                        <button type="button" class="btn btn-secondary" onclick="closeBulkSMSModal()" style="flex: 1;">
                            <i class="fas fa-times"></i> İptal
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendBulkSMS()"
                            style="flex: 2; background: #25D366; border-color: #25D366;">
                            <i class="fas fa-paper-plane"></i> SMS Gönder
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk WhatsApp Wizard Modal -->
        <div id="bulkWhatsAppModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white;">
                    <h2><i class="fab fa-whatsapp"></i> Toplu WhatsApp Gönder</h2>
                    <span class="close" onclick="closeBulkWhatsAppModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- Step 1: Setup -->
                    <div id="waStep1">
                        <div class="form-group">
                            <label>Hedef Grup *</label>
                            <select id="bulkWATarget" onchange="updateWAPreview()">
                                <option value="">-- Seçiniz --</option>
                                <option value="all">Tüm Üyeler</option>
                                <option value="debtors">Borçlu Üyeler</option>
                                <option value="active">Aktif Üyeler (Aidat Ödeyen)</option>
                                <option value="asil">Asil Üyeler</option>
                                <option value="ogrenci">Öğrenci Üyeler</option>
                                <option value="fahri">Fahri Üyeler</option>
                            </select>
                        </div>

                        <!-- Recipient Preview -->
                        <div id="waPreviewSection"
                            style="display:none;background:#f0faf4;padding:15px;border-radius:8px;margin:15px 0;border-left:4px solid #25D366;">
                            <h4 style="margin:0 0 10px;color:#2e7d32;font-size:14px;">
                                <i class="fas fa-users"></i> Alıcılar
                            </h4>
                            <div id="waRecipientCount"
                                style="font-size:16px;font-weight:600;color:#25D366;margin-bottom:5px;"></div>
                            <small id="waNoPhoneWarning" style="color:#e67e22;"></small>
                        </div>

                        <div class="form-group">
                            <label>Mesaj İçeriği *</label>
                            <textarea id="bulkWAMessage" placeholder="WhatsApp mesajınızı yazın..." rows="5"
                                style="width:100%;padding:10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:14px;"></textarea>
                            <small style="color:#7f8c8d;"><i class="fas fa-info-circle"></i> *kalın*, _italik_
                                formatı
                                desteklenir</small>
                        </div>
                    </div>

                    <!-- Step 2: Sending Progress -->
                    <div id="waStep2" style="display:none;">
                        <div style="text-align:center;padding:20px 0;">
                            <div id="waProgressIcon" style="font-size:48px;color:#25D366;margin-bottom:15px;">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <h3 id="waProgressTitle" style="color:var(--tpjd-dark);margin:0 0 10px;">Gönderime
                                Hazır
                            </h3>
                            <p id="waProgressSubtitle" style="color:#7f8c8d;font-size:14px;"></p>

                            <!-- Progress Bar -->
                            <div
                                style="background:#e9ecef;border-radius:10px;height:12px;margin:20px 0;overflow:hidden;">
                                <div id="waProgressBar"
                                    style="height:100%;background:linear-gradient(90deg,#25D366,#128C7E);border-radius:10px;transition:width 0.3s;width:0%;">
                                </div>
                            </div>
                            <div id="waProgressText" style="font-size:14px;color:var(--tpjd-dark);font-weight:600;">0 /
                                0</div>
                        </div>

                        <!-- Current Recipient Card -->
                        <div id="waCurrentRecipient"
                            style="display:none;background:#f8f9fa;padding:15px;border-radius:10px;margin:15px 0;border:1px solid #e9ecef;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="width:40px;height:40px;border-radius:50%;background:#25D366;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;"
                                    id="waRecipientAvatar"></div>
                                <div>
                                    <div id="waRecipientName"
                                        style="font-weight:600;color:var(--tpjd-dark);font-size:15px;"></div>
                                    <div id="waRecipientPhone" style="color:#7f8c8d;font-size:13px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Sent Log -->
                        <div id="waSentLog" style="max-height:150px;overflow-y:auto;margin-top:10px;"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div
                        style="width:100%;padding:10px 14px;background:#e8f5e9;border-radius:6px;border-left:4px solid #25D366;margin-bottom:12px;">
                        <p style="margin:0;font-size:12px;color:#2e7d32;">
                            <i class="fas fa-info-circle"></i> Mesajlar lokal WhatsApp sunucusu üzerinden
                            gönderilir.
                            Ajanlar sekmesinden WhatsApp bağlantınızın aktif olduğundan emin olun.
                        </p>
                    </div>
                    <div style="display:flex;gap:10px;width:100%;">
                        <button type="button" class="btn btn-secondary" onclick="closeBulkWhatsAppModal()"
                            style="flex:1;">
                            <i class="fas fa-times"></i> <span id="waCancelText">İptal</span>
                        </button>
                        <button type="button" id="waStartBtn" class="btn btn-success" onclick="startBulkWhatsApp()"
                            style="flex:2;background:#25D366;border-color:#128C7E;">
                            <i class="fab fa-whatsapp"></i> Gönderime Başla
                        </button>
                        <button type="button" id="waStopBtn" class="btn btn-danger" onclick="stopBulkWhatsApp()"
                            style="display:none;flex:1;">
                            <i class="fas fa-stop"></i> Durdur
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div id="notificationToast" class="notification"></div>
        <!-- Member Modal -->
        <div id="memberModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-plus"></i> Üye İşlemleri</h2>
                    <span class="close" onclick="closeModal('memberModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="memberForm">
                        <input type="hidden" id="memberId">

                        <div class="form-row">
                            <div class="form-group">
                                <label>Üye No *</label>
                                <input type="text" id="memberNo" required placeholder="TPJD001">
                            </div>
                            <div class="form-group">
                                <label>Üyelik Tipi *</label>
                                <select id="membershipType" required onchange="updateMembershipType()">
                                    <option value="">Seçiniz</option>
                                    <option value="Asil Üye">Asil Üye</option>
                                    <option value="Asil Onursal">Asil Onursal</option>
                                    <option value="Öğrenci Üye">Öğrenci Üye</option>
                                    <option value="Fahri Üye">Fahri Üye</option>
                                    <option value="Fahri Onursal">Fahri Onursal</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ad *</label>
                                <input type="text" id="firstName" required placeholder="Ad">
                            </div>
                            <div class="form-group">
                                <label>Soyad *</label>
                                <input type="text" id="lastName" required placeholder="Soyad">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>TC Kimlik No *</label>
                                <input type="text" id="tcNo" required placeholder="12345678901" maxlength="11">
                            </div>
                            <div class="form-group">
                                <label>Cinsiyet *</label>
                                <select id="gender" required>
                                    <option value="">Seçiniz</option>
                                    <option value="Erkek">Erkek</option>
                                    <option value="Kadın">Kadın</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Doğum Tarihi *</label>
                                <input type="date" id="birthDate" required>
                            </div>
                            <div class="form-group">
                                <label>Kan Grubu</label>
                                <select id="bloodType">
                                    <option value="">Seçiniz</option>
                                    <option value="A Rh+">A Rh+</option>
                                    <option value="A Rh-">A Rh-</option>
                                    <option value="B Rh+">B Rh+</option>
                                    <option value="B Rh-">B Rh-</option>
                                    <option value="AB Rh+">AB Rh+</option>
                                    <option value="AB Rh-">AB Rh-</option>
                                    <option value="0 Rh+">0 Rh+</option>
                                    <option value="0 Rh-">0 Rh-</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>E-posta *</label>
                                <input type="email" id="email" required placeholder="ornek@email.com">
                            </div>
                            <div class="form-group">
                                <label>Telefon *</label>
                                <input type="tel" id="phone" required placeholder="+905551234567">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ev Telefonu</label>
                                <input type="tel" id="phoneHome" placeholder="+902121234567">
                            </div>
                            <div class="form-group">
                                <label>Medeni Durum</label>
                                <select id="maritalStatus">
                                    <option value="">Seçiniz</option>
                                    <option value="Bekar">Bekar</option>
                                    <option value="Evli">Evli</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>İl *</label>
                                <input type="text" id="city" required placeholder="İl" list="cityList">
                                <datalist id="cityList">
                                    <option value="Adana">
                                    <option value="Adıyaman">
                                    <option value="Afyonkarahisar">
                                    <option value="Ağrı">
                                    <option value="Aksaray">
                                    <option value="Amasya">
                                    <option value="Ankara">
                                    <option value="Antalya">
                                    <option value="Ardahan">
                                    <option value="Artvin">
                                    <option value="Aydın">
                                    <option value="Balıkesir">
                                    <option value="Bartın">
                                    <option value="Batman">
                                    <option value="Bayburt">
                                    <option value="Bilecik">
                                    <option value="Bingöl">
                                    <option value="Bitlis">
                                    <option value="Bolu">
                                    <option value="Burdur">
                                    <option value="Bursa">
                                    <option value="Çanakkale">
                                    <option value="Çankırı">
                                    <option value="Çorum">
                                    <option value="Denizli">
                                    <option value="Diyarbakır">
                                    <option value="Düzce">
                                    <option value="Edirne">
                                    <option value="Elazığ">
                                    <option value="Erzincan">
                                    <option value="Erzurum">
                                    <option value="Eskişehir">
                                    <option value="Gaziantep">
                                    <option value="Giresun">
                                    <option value="Gümüşhane">
                                    <option value="Hakkari">
                                    <option value="Hatay">
                                    <option value="Iğdır">
                                    <option value="Isparta">
                                    <option value="İstanbul">
                                    <option value="İzmir">
                                    <option value="Kahramanmaraş">
                                    <option value="Karabük">
                                    <option value="Karaman">
                                    <option value="Kars">
                                    <option value="Kastamonu">
                                    <option value="Kayseri">
                                    <option value="Kırıkkale">
                                    <option value="Kırklareli">
                                    <option value="Kırşehir">
                                    <option value="Kilis">
                                    <option value="Kocaeli">
                                    <option value="Konya">
                                    <option value="Kütahya">
                                    <option value="Malatya">
                                    <option value="Manisa">
                                    <option value="Mardin">
                                    <option value="Mersin">
                                    <option value="Muğla">
                                    <option value="Muş">
                                    <option value="Nevşehir">
                                    <option value="Niğde">
                                    <option value="Ordu">
                                    <option value="Osmaniye">
                                    <option value="Rize">
                                    <option value="Sakarya">
                                    <option value="Samsun">
                                    <option value="Siirt">
                                    <option value="Sinop">
                                    <option value="Sivas">
                                    <option value="Şanlıurfa">
                                    <option value="Şırnak">
                                    <option value="Tekirdağ">
                                    <option value="Tokat">
                                    <option value="Trabzon">
                                    <option value="Tunceli">
                                    <option value="Uşak">
                                    <option value="Van">
                                    <option value="Yalova">
                                    <option value="Yozgat">
                                    <option value="Zonguldak">
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label>İlçe</label>
                                <input type="text" id="district" placeholder="İlçe">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Mahalle</label>
                            <input type="text" id="neighborhood" placeholder="Mahalle">
                        </div>

                        <div class="form-group">
                            <label>Adres *</label>
                            <textarea id="address" required placeholder="Tam adres"></textarea>
                        </div>



                        <div class="form-row">
                            <div class="form-group">
                                <label>Mezuniyet</label>
                                <input type="text" id="graduation" placeholder="Üniversite adı">
                            </div>
                            <div class="form-group">
                                <label>Mezuniyet Yılı</label>
                                <input type="text" id="graduationYear" placeholder="2020">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>İş Durumu</label>
                                <select id="employmentStatus">
                                    <option value="">Seçiniz</option>
                                    <option value="Çalışıyor">Çalışıyor</option>
                                    <option value="Öğrenci">Öğrenci</option>
                                    <option value="Emekli">Emekli</option>
                                    <option value="İşsiz">İşsiz</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>İş Yeri</label>
                                <input type="text" id="workplace" placeholder="Şirket adı">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Pozisyon</label>
                            <input type="text" id="position" placeholder="Ünvan">
                        </div>



                        <div class="form-group">
                            <label>Kayıt Tarihi</label>
                            <input type="date" id="registrationDate" required>
                        </div>



                        <div class="form-group">
                            <label>Notlar</label>
                            <textarea id="notes" placeholder="Üye ile ilgili notlar..." rows="3"></textarea>
                        </div>

                        <div class="form-group checkbox-inline">
                            <input type="checkbox" id="aidatAktif" checked onchange="toggleAidatBedelField()">
                            <label for="aidatAktif">Aidat Aktif (Her yıl otomatik aidat borcu
                                oluşturulacak)</label>
                        </div>

                        <div id="aidatBedelContainer" class="form-group"
                            style="display: none; margin-top: 10px; padding: 12px; background: rgba(241,196,15,0.1); border-radius: 8px; border-left: 4px solid #f1c40f;">
                            <label><i class="fas fa-coins" style="color: #f39c12;"></i> Cari Yıl Aidat Bedeli
                                (₺)</label>
                            <input type="number" id="manuelAidatBedel" min="0" step="1"
                                placeholder="Ayarlardan otomatik çekilir">
                            <small style="color: #7f8c8d;">Boş bırakırsanız ayarlardaki varsayılan tutar
                                kullanılır.
                                Manuel değiştirmek için yazın.</small>
                        </div>

                        <div class="form-group checkbox-inline">
                            <input type="checkbox" id="gecmisYillarBorclandir" onchange="toggleYearSelection()">
                            <label for="gecmisYillarBorclandir">Geçmiş Yıllardan Borçlandır</label>
                        </div>

                        <div id="yearSelectionContainer" style="display: none;">
                            <div class="form-group"
                                style="padding: 15px; background: rgba(52,152,219,0.06); border-radius: 10px; border-left: 4px solid #3498db;">
                                <label style="font-weight:600;margin-bottom:10px;display:block;"><i
                                        class="fas fa-calendar-plus" style="color:#3498db;"></i> Borç Ekle</label>
                                <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
                                    <div style="flex:1;min-width:120px;">
                                        <label style="font-size:12px;color:#7f8c8d;">Yıl</label>
                                        <select id="pastDebtYear" class="form-control" style="padding:8px 12px;">
                                        </select>
                                    </div>
                                    <div style="flex:1;min-width:120px;">
                                        <label style="font-size:12px;color:#7f8c8d;">Tutar (₺)</label>
                                        <input type="number" id="pastDebtAmount" class="form-control" min="0" step="1"
                                            placeholder="Tutar" style="padding:8px 12px;">
                                    </div>
                                    <button type="button" class="btn btn-info" onclick="addPastDebtEntry()"
                                        style="padding:8px 16px;white-space:nowrap;">
                                        <i class="fas fa-plus"></i> Ekle
                                    </button>
                                </div>
                                <div id="pastDebtList" style="margin-top:12px;"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('memberModal')">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveMember()">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="paymentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-money-bill-wave"></i> Ödeme İşlemleri</h2>
                    <span class="close" onclick="closeModal('paymentModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId">

                        <div class="form-group">
                            <label>Üye Seçin *</label>
                            <select id="paymentMemberId" required onchange="updatePaymentAmount()">
                                <option value="">Üye seçiniz</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ödeme Tipi *</label>
                                <select id="paymentType" required>
                                    <option value="aidat">Aidat</option>
                                    <option value="bağış">Bağış</option>
                                    <option value="diğer">Diğer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Yıl *</label>
                                <input type="number" id="paymentYear" required min="2000" max="2100">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tutar (₺) *</label>
                                <input type="number" id="paymentAmount" required step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>Tarih *</label>
                                <input type="date" id="paymentDate" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Fiş No</label>
                            <input type="text" id="receiptNo" placeholder="FİŞ001">
                        </div>

                        <div class="form-group">
                            <label>Açıklama *</label>
                            <textarea id="paymentDescription" required placeholder="Ödeme açıklaması"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Durum *</label>
                            <select id="paymentStatus" required>
                                <option value="tamamlandı">Ödendi</option>
                                <option value="bekliyor">Ödenmedi</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="button" class="btn btn-success" onclick="savePayment()">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </div>
        </div>
        <!-- Notification Modal (UPDATED) -->
        <div id="notificationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-bell"></i> Bildirim Gönder</h2>
                    <span class="close" onclick="closeModal('notificationModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="notificationForm">
                        <div class="form-group">
                            <label>Gönderim Türü *</label>
                            <select id="notificationType" required onchange="toggleRecipientSelection()">
                                <option value="">Seçiniz</option>
                                <option value="group">Hedef Grup</option>
                                <option value="individual">Bireysel</option>
                            </select>
                        </div>

                        <!-- Hedef Grup Seçimi -->
                        <div id="groupSelectionContainer" style="display: none;">
                            <div class="form-group">
                                <label>Hedef Grup *</label>
                                <select id="targetGroup">
                                    <option value="all">Tüm Üyeler</option>
                                    <option value="active">Aidat Aktif Üyeler</option>
                                    <option value="inactive">Aidat Pasif Üyeler</option>
                                    <option value="paid">Bu Yıl Ödeme Yapan Üyeler</option>
                                    <option value="unpaid">Bu Yıl Ödeme Yapmayan Üyeler</option>
                                    <option value="asil">Asil Üyeler</option>
                                    <option value="asil-onursal">Asil Onursal Üyeler</option>
                                    <option value="ogrenci">Öğrenci Üyeler</option>
                                    <option value="fahri">Fahri Üyeler</option>
                                    <option value="fahri-onursal">Fahri Onursal Üyeler</option>
                                </select>
                            </div>
                        </div>

                        <!-- Bireysel Üye Seçimi -->
                        <div id="individualSelectionContainer" style="display: none;">
                            <!-- Seçili üye gösterimi -->
                            <div id="preSelectedMemberInfo" style="display: none;">
                                <div class="form-group"
                                    style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid var(--tpjd-success);">
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <i class="fas fa-user-check" style="color: var(--tpjd-success);"></i>
                                        <strong>Seçili Üye</strong>
                                    </label>
                                    <div id="preSelectedMemberName"
                                        style="font-size: 16px; color: var(--tpjd-dark); font-weight: 600;">
                                    </div>
                                    <button type="button" class="btn btn-secondary"
                                        onclick="changeNotificationRecipient()"
                                        style="margin-top: 10px; padding: 5px 15px; font-size: 13px;">
                                        <i class="fas fa-exchange-alt"></i> Farklı Üye Seç
                                    </button>
                                </div>
                            </div>

                            <!-- Normal üye seçim alanı -->
                            <div id="normalMemberSelection">
                                <div class="form-group">
                                    <label>Üye Ara</label>
                                    <input type="text" id="memberSearchInput"
                                        placeholder="Üye adı, soyadı veya üye no ile ara..."
                                        oninput="searchMemberForNotification()">
                                </div>

                                <div class="form-group">
                                    <label>Üye Seçin *</label>
                                    <select id="individualMemberId" size="5" style="height: 150px;">
                                        <option value="">Üye seçiniz</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Bildirim Başlığı *</label>
                            <input type="text" id="notificationTitle" required placeholder="Bildirim başlığı">
                        </div>

                        <div class="form-group">
                            <label>Bildirim Mesajı *</label>
                            <textarea id="notificationMessage" required placeholder="Bildirim mesajı..."
                                rows="6"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Öncelik</label>
                            <select id="notificationPriority">
                                <option value="normal">Normal</option>
                                <option value="high">Yüksek</option>
                                <option value="urgent">Acil</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="flex-direction: column; gap: 15px;">
                    <!-- Bireysel Gönderim İçin Özel Butonlar -->
                    <div id="individualSendButtons" style="display: none; width: 100%;">
                        <div
                            style="width: 100%; padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196F3; margin-bottom: 15px;">
                            <strong style="color: #1565C0; font-size: 14px;">
                                <i class="fas fa-info-circle"></i> Bireysel İletişim
                            </strong>
                            <p style="margin: 8px 0 0 0; font-size: 13px; color: #1565C0;">
                                Mesajınız seçtiğiniz kanal üzerinden gönderilecek.
                            </p>
                        </div>

                        <div style="display: flex; gap: 10px; width: 100%;">
                            <button type="button" class="btn" onclick="sendViaWhatsAppIndividual()"
                                style="flex:1; background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;">
                                <i class="fab fa-whatsapp" style="font-size: 18px;"></i>
                                <span>WhatsApp</span>
                            </button>
                            <button type="button" class="btn" onclick="sendViaEmailIndividual()"
                                style="flex:1; background: #EA4335; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;">
                                <i class="fas fa-envelope" style="font-size: 18px;"></i>
                                <span>E-posta</span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')"
                                style="padding: 10px 16px;">
                                <i class="fas fa-times"></i> İptal
                            </button>
                        </div>
                    </div>

                    <!-- Grup Gönderimi İçin Normal Butonlar -->
                    <div id="groupSendButtons" style="width: 100%;">
                        <!-- Gönderim Kanalları -->
                        <div
                            style="margin-bottom:15px;padding:12px;background:rgba(52,152,219,0.08);border-radius:8px;border-left:4px solid #3498db;">
                            <label
                                style="display:block;font-weight:600;font-size:13px;color:var(--tpjd-dark);margin-bottom:10px;">
                                <i class="fas fa-share-alt" style="color:#3498db;"></i> Gönderim Kanalları
                            </label>
                            <div style="display:flex;gap:15px;flex-wrap:wrap;">
                                <label
                                    style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;color:var(--tpjd-dark);">
                                    <input type="checkbox" id="channelEmail" checked
                                        style="width:18px;height:18px;accent-color:#EA4335;">
                                    📧 E-posta
                                </label>
                                <label
                                    style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;color:var(--tpjd-dark);">
                                    <input type="checkbox" id="channelWhatsApp"
                                        style="width:18px;height:18px;accent-color:#25D366;">
                                    💬 WhatsApp
                                </label>
                                <label
                                    style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;color:var(--tpjd-dark);">
                                    <input type="checkbox" id="channelSMS"
                                        style="width:18px;height:18px;accent-color:#ff9800;">
                                    📱 SMS
                                </label>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')"
                                style="flex: 1;">
                                <i class="fas fa-times"></i> İptal
                            </button>
                            <button type="button" class="btn btn-primary" onclick="sendNotification()" style="flex: 2;">
                                <i class="fas fa-paper-plane"></i> Bildirim Gönder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Email Modal -->
        <div id="bulkEmailModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2><i class="fas fa-envelope"></i> Toplu E-posta Gönder</h2>
                    <span class="close" onclick="closeBulkEmailModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Hedef Grup *</label>
                        <select id="bulkEmailTarget" onchange="updateEmailPreview()">
                            <option value="">-- Seçiniz --</option>
                            <option value="all">Tüm Üyeler</option>
                            <option value="paid" id="bulkEmailPaidOption">Aidat Ödeyenler</option>
                            <option value="unpaid">Aidat Ödemeyenler (Borçlular)</option>
                        </select>
                    </div>

                    <!-- Önizleme Alanı -->
                    <div id="emailPreviewSection"
                        style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--tpjd-info);">
                        <h4 style="margin: 0 0 10px 0; color: var(--tpjd-dark); font-size: 14px;">
                            <i class="fas fa-users"></i> Alıcılar
                        </h4>
                        <div id="emailRecipientCount"
                            style="font-size: 16px; font-weight: 600; color: var(--tpjd-info); margin-bottom: 10px;">
                        </div>
                        <details style="cursor: pointer;">
                            <summary style="color: var(--tpjd-primary); font-weight: 600; font-size: 13px;">
                                E-posta adreslerini göster</summary>
                            <div id="emailRecipientList"
                                style="max-height: 120px; overflow-y: auto; margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 12px; color: #666;">
                            </div>
                        </details>
                    </div>

                    <div class="form-group">
                        <label>Konu *</label>
                        <input type="text" id="bulkEmailSubject" placeholder="E-posta konusu (örn: Aidat Hatırlatması)"
                            maxlength="100">
                    </div>

                    <div class="form-group">
                        <label>Mesaj *</label>
                        <textarea id="bulkEmailMessage" placeholder="E-posta mesajınızı buraya yazın..." rows="6"
                            maxlength="2000"></textarea>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Not: Çok uzun mesajlar mail programlarında
                            kesilme yapabilir.
                        </small>
                    </div>
                </div>
                <div class="modal-footer" style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeBulkEmailModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="button" class="btn btn-success" onclick="sendBulkEmailDirect()"
                        style="flex: 2; background: #27ae60; border-color: #27ae60;">
                        <i class="fas fa-paper-plane"></i> Gönder
                    </button>
                </div>
            </div>
        </div>

        <!-- Event Announcement Modal -->
        <div id="eventModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #ff5722, #ff9800);">
                    <h2 style="color: white;"><i class="fas fa-bullhorn"></i> Etkinlik Duyurusu</h2>
                    <span class="close" onclick="closeModal('eventModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label><i class="fas fa-heading" style="color:#ff5722"></i> Etkinlik Adı *</label>
                        <input type="text" id="eventTitle" placeholder="Örn: TPJD 2026 Yıllık Konferansı"
                            maxlength="150">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label><i class="fas fa-calendar-alt" style="color:#e67e22"></i> Tarih *</label>
                            <input type="date" id="eventDate">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-clock" style="color:#e67e22"></i> Saat</label>
                            <input type="time" id="eventTime" value="10:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt" style="color:#e74c3c"></i> Konum</label>
                        <input type="text" id="eventLocation" placeholder="Örn: Ankara, TPJD Konferans Salonu">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-align-left" style="color:#3498db"></i> Etkinlik Açıklaması
                            *</label>
                        <textarea id="eventDescription" placeholder="Etkinlik hakkında detaylı bilgi yazın..." rows="5"
                            maxlength="3000"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-users" style="color:#9b59b6"></i> Hedef Kitle</label>
                        <select id="eventTarget">
                            <option value="all">Tüm Aktif Üyeler</option>
                            <option value="paid">Aidatını Ödeyenler</option>
                        </select>
                    </div>
                    <!-- Alıcı Önizleme -->
                    <div id="eventRecipientPreview"
                        style="background: #f0f9ff; padding: 12px 16px; border-radius: 8px; border-left: 4px solid #3498db; margin-top: 10px;">
                        <i class="fas fa-info-circle" style="color:#3498db"></i>
                        <span id="eventRecipientCount" style="font-weight:600; color:#2c3e50;">Yükleniyor...</span>
                    </div>
                    <!-- Gönderim Kanalı -->
                    <div class="form-group" style="margin-top:15px;">
                        <label><i class="fas fa-share-alt" style="color:#16a085"></i> Gönderim Kanalı</label>
                        <div style="display:flex;gap:20px;margin-top:8px;">
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                                <input type="radio" name="eventChannel" value="email" checked>
                                <i class="fas fa-envelope" style="color:#3498db"></i> E-posta
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                                <input type="radio" name="eventChannel" value="whatsapp">
                                <i class="fab fa-whatsapp" style="color:#25D366"></i> WhatsApp
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                                <input type="radio" name="eventChannel" value="both">
                                <i class="fas fa-layer-group" style="color:#9b59b6"></i> Her İkisi
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('eventModal')" style="flex:1;">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="button" class="btn" id="sendEventBtn" onclick="sendEventAnnouncement()"
                        style="flex:2; background:#ff5722; color:white; border-color:#ff5722;">
                        <i class="fas fa-paper-plane"></i> Duyuru Gönder
                    </button>
                </div>
            </div>
        </div>

        <!-- Member Detail Modal (UPDATED WITH NOTIFICATION BUTTON) -->
        <div id="memberDetailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user"></i> Üye Detayları</h2>
                    <span class="close" onclick="closeModal('memberDetailModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="memberDetailContent">
                        <!-- Member details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('memberDetailModal')">
                        <i class="fas fa-times"></i> Kapat
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addPaymentForCurrentMember()"
                        title="Bu üye için ödeme ekle">
                        <i class="fas fa-plus-circle"></i> Ödeme Ekle
                    </button>
                    <button type="button" class="btn btn-warning" onclick="sendNotificationToCurrentMember()">
                        <i class="fas fa-bell"></i> Bildirim Gönder
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadMemberDetail()"
                        id="downloadDetailBtn">
                        <i class="fas fa-download"></i> HTML İndir
                    </button>
                </div>
            </div>
        </div>

        <!-- Direct Notify Modal (Üye Detay → Bildirim Gönder) -->
        <div id="directNotifyModal" class="modal">
            <div class="modal-content" style="max-width: 560px;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white;">
                    <h2><i class="fas fa-paper-plane"></i> Bildirim Gönder</h2>
                    <span class="close" onclick="closeModal('directNotifyModal')" style="color: white;">&times;</span>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <!-- Üye Bilgisi -->
                    <div id="directNotifyMemberInfo"
                        style="background: linear-gradient(135deg, #1a2332, #2c3e50); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                        <div
                            style="background: var(--tpjd-primary); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div id="directNotifyMemberName" style="font-weight: 700; font-size: 16px;"></div>
                            <div id="directNotifyMemberDebt" style="font-size: 13px; opacity: 0.8; margin-top: 3px;">
                            </div>
                        </div>
                    </div>

                    <!-- Kanal Seçimi -->
                    <label style="font-weight: 600; color: var(--tpjd-dark); margin-bottom: 10px; display: block;">
                        <i class="fas fa-broadcast-tower"></i> Gönderim Kanalları
                    </label>
                    <div id="directNotifyChannels"
                        style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    </div>

                    <!-- Konu -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="font-weight: 600;"><i class="fas fa-tag"></i> Konu</label>
                        <input type="text" id="directNotifySubject" value="Aidat Hatırlatma"
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 14px;">
                    </div>

                    <!-- Mesaj -->
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-weight: 600;"><i class="fas fa-comment-alt"></i> Mesaj</label>
                        <textarea id="directNotifyMessage" rows="8"
                            style="width: 100%; padding: 12px 14px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; line-height: 1.6;"></textarea>
                    </div>

                    <!-- Gönderim Sonuçları -->
                    <div id="directNotifyResults" style="display: none; margin-top: 15px;"></div>
                </div>
                <div class="modal-footer" style="padding: 15px 20px; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('directNotifyModal')">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="button" id="directNotifySendBtn" class="btn btn-primary"
                        onclick="sendDirectNotification()"
                        style="flex: 2; background: linear-gradient(135deg, #e67e22, #d35400); border: none; font-weight: 600;">
                        <i class="fas fa-paper-plane"></i> Gönder
                    </button>
                </div>
            </div>
        </div>

        <script>
            // IMMEDIATE DEBUG MODE
            window.addEventListener('error', e => {
                console.error("Global JS Error:", e.error || e.message);
                alert("JS Hatası: " + e.message);
            });
            window.addEventListener('unhandledrejection', e => {
                console.error("Unhandled Promise Rejection:", e.reason);
                alert("Promise Hatası: " + (e.reason?.message || e.reason));
            });

            // API Configuration - dynamically determine based on current path
            const pathParts = window.location.pathname.split('/');
            const basePath = pathParts.slice(0, -1).join('/') || '';
            const API_BASE = basePath + "/api";
            console.log("API_BASE initialized as:", API_BASE);

            // ─── Global Fetch Wrapper (Session Auth) ───────────────
            // Tüm fetch çağrılarına credentials:'same-origin' ekler
            // 401 yanıtlarında otomatik login'e yönlendirir
            const _origFetch = window.fetch;
            window.fetch = function (url, options = {}) {
                options.credentials = 'same-origin';
                return _origFetch.call(this, url, options).then(response => {
                    if (response.status === 401 && !url.includes('login.php')) {
                        console.warn('Session expired, redirecting to login');
                        isAuthenticated = false;
                        localStorage.removeItem('tpjd_isAuthenticated');
                        localStorage.removeItem('tpjd_adminUsername');
                        document.getElementById('loginContainer').style.display = 'flex';
                        document.getElementById('mainApp').classList.remove('show');
                        showNotification('Oturum süresi doldu. Lütfen tekrar giriş yapın.', 'warning');
                    }
                    return response;
                });
            };

            // Global variables
            let members = [];
            let payments = [];
            let notifications = [];
            let debtors = [];
            let adminUsername = '';
            let aidatSettings = {};
            let historicalAidatSettings = {};
            let settings = {}; // Store all settings including NETGSM

            let currentMemberId = null;
            let membershipDonutChart = null;
            let isAuthenticated = false;
            let lastDebtYearMemory = null;

            // Aidat tutarları (boş olarak başlatılıyor, MySQL'den yüklenecek)


            // Login function
            async function login(event) {
                if (event) event.preventDefault();

                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const response = await fetch(`${API_BASE}/login.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const result = await response.json();

                    if (result.success) {
                        isAuthenticated = true;
                        localStorage.setItem('tpjd_isAuthenticated', 'true');
                        localStorage.setItem('tpjd_adminUsername', username);

                        document.getElementById('loginContainer').style.display = 'none';
                        document.getElementById('mainApp').classList.add('show');

                        initializeDonutCharts();
                        updateSettingsInfo();
                        loadAllData();
                        agentManager.init();
                        loadWhatsAppSettings();
                        renderCalendar();
                        setTimeout(() => autoRunAgents(), 3000);
                    } else {
                        alert('Hatalı kullanıcı adı veya şifre!');
                        document.getElementById('loginError').classList.add('show');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('Giriş sırasında bir hata oluştu. Lütfen konsolu kontrol edin.');
                    document.getElementById('loginError').classList.add('show');
                }
            }

            // Logout function
            function logout() {
                if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                    // Sunucu session'ını da sonlandır
                    fetch(`${API_BASE}/login.php?action=logout`).catch(() => { });
                    isAuthenticated = false;
                    localStorage.removeItem('tpjd_isAuthenticated');
                    localStorage.removeItem('tpjd_adminUsername');
                    window.location.reload();
                }
            }

            // Update settings info
            function updateSettingsInfo() {
                const totalMembers = members ? members.length : 0;
                const totalPayments = payments ? payments.length : 0;

                document.getElementById('settingsTotalMembers').textContent = totalMembers;
                document.getElementById('settingsTotalPayments').textContent = totalPayments;

                // Load aidat settings
                loadAidatSettingsToForm();
            }

            // Backward-compatible helper (was missing); reuses existing populateSettingsForm
            function loadAidatSettingsToForm() {
                populateSettingsForm();
            }

            // Aidat Ayarları Fonksiyonları
            async function loadAllSettings() {
                try {
                    const response = await fetch(`${API_BASE}/settings.php?action=all`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        // Store all settings globally
                        settings = result.data;
                        // Load aidat settings
                        if (result.data.aidat_settings) {
                            aidatSettings = result.data.aidat_settings;
                        }
                        // Load historical settings if available
                        if (result.data.historical_aidat_settings) {
                            historicalAidatSettings = result.data.historical_aidat_settings;
                        }
                        // Load admin username to display in settings form
                        if (result.data.admin_username) {
                            adminUsername = result.data.admin_username;
                        }
                        populateSettingsForm();
                    } else {
                        console.error('Settings could not be loaded.');
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }

            // ===== Agent Mail Ayarları =====
            function saveAgentEmailSettings() {
                const monthlyEmails = document.getElementById('settingMonthlyEmails').value.trim();
                const notifyEmails = document.getElementById('settingNotifyEmails').value.trim();
                const presidentEmail = document.getElementById('settingPresidentEmail').value.trim();
                const treasurerEmail = document.getElementById('settingTreasurerEmail').value.trim();
                const secretaryEmail = document.getElementById('settingSecretaryEmail').value.trim();

                const settings = {
                    monthly_report_recipients: monthlyEmails.split(',').map(e => e.trim()).filter(e => e),
                    notify_recipients: notifyEmails.split(',').map(e => e.trim()).filter(e => e),
                    president_email: presidentEmail,
                    treasurer_email: treasurerEmail,
                    secretary_email: secretaryEmail
                };

                localStorage.setItem('agentEmailSettings', JSON.stringify(settings));

                // Also save to API
                fetch('api/agents.php?action=save_email_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                }).then(r => r.json()).then(res => {
                    showNotification('Agent mail ayarları kaydedildi!', 'success');
                }).catch(e => {
                    // At least localStorage has it
                    showNotification('Ayarlar yerel olarak kaydedildi', 'success');
                });
            }

            function loadAgentEmailSettings() {
                const saved = localStorage.getItem('agentEmailSettings');
                if (!saved) return;
                try {
                    const s = JSON.parse(saved);
                    if (s.monthly_report_recipients) document.getElementById('settingMonthlyEmails').value = s.monthly_report_recipients.join(', ');
                    if (s.notify_recipients) document.getElementById('settingNotifyEmails').value = s.notify_recipients.join(', ');
                    if (s.president_email) document.getElementById('settingPresidentEmail').value = s.president_email;
                    if (s.treasurer_email) document.getElementById('settingTreasurerEmail').value = s.treasurer_email;
                    if (s.secretary_email) document.getElementById('settingSecretaryEmail').value = s.secretary_email;
                } catch (e) { console.warn('Agent email settings parse error', e); }
            }

            function addQuickEmailsToMonthly() {
                const fields = ['settingPresidentEmail', 'settingTreasurerEmail', 'settingSecretaryEmail'];
                const textarea = document.getElementById('settingMonthlyEmails');
                const existing = textarea.value.split(',').map(e => e.trim()).filter(e => e);

                let added = 0;
                fields.forEach(id => {
                    const email = document.getElementById(id).value.trim();
                    if (email && !existing.includes(email)) {
                        existing.push(email);
                        added++;
                    }
                });

                textarea.value = existing.join(', ');
                if (added > 0) {
                    showNotification(added + ' kişi eklendi!', 'success');
                } else {
                    showNotification('Eklenecek yeni adres bulunamadı', 'warning');
                }
            }

            // Load on page ready
            document.addEventListener('DOMContentLoaded', loadAgentEmailSettings);



            // ===== Sunucu Yedekleme Fonksiyonları =====
            async function createServerBackup() {
                const resultDiv = document.getElementById('serverBackupResult');
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(52,152,219,0.1)';
                resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yedek oluşturuluyor...';
                try {
                    const res = await fetch(API_BASE + '/backup.php?action=create', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        resultDiv.style.background = 'rgba(39,174,96,0.1)';
                        resultDiv.innerHTML = '<i class="fas fa-check-circle" style="color:#27ae60;"></i> ' + data.message;
                        showNotification('Yedek oluşturuldu!', 'success');
                        loadServerBackups();
                    } else {
                        resultDiv.style.background = 'rgba(231,76,60,0.1)';
                        resultDiv.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> ' + data.message;
                    }
                } catch (e) {
                    resultDiv.style.background = 'rgba(231,76,60,0.1)';
                    resultDiv.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> Hata: ' + e.message;
                }
            }

            async function loadServerBackups() {
                const container = document.getElementById('serverBackupList');
                if (!container) return;
                try {
                    const res = await fetch(API_BASE + '/backup.php?action=list');
                    const data = await res.json();
                    if (data.success && data.data && data.data.length > 0) {
                        let html = '<table style="width:100%; font-size:12px; border-collapse:collapse;">';
                        html += '<tr style="background:#e8e8e8;"><th style="padding:6px;text-align:left;">Dosya</th><th style="padding:6px;">Boyut</th><th style="padding:6px;">Tarih</th><th style="padding:6px;">İşlem</th></tr>';
                        data.data.forEach(b => {
                            html += '<tr style="border-bottom:1px solid #eee;">';
                            html += '<td style="padding:5px;"><i class="fas fa-file-archive" style="color:#27ae60;"></i> ' + b.filename + '</td>';
                            html += '<td style="padding:5px;text-align:center;">' + b.size_kb + ' KB</td>';
                            html += '<td style="padding:5px;text-align:center;">' + b.created_at + '</td>';
                            html += '<td style="padding:5px;text-align:center;">';
                            html += '<a href="' + API_BASE + '/backup.php?action=download&file=' + b.filename + '" style="color:#3498db;margin-right:10px;" title="İndir"><i class="fas fa-download"></i></a>';
                            html += '<a href="#" onclick="deleteServerBackup(\'' + b.filename + '\');return false;" style="color:#e74c3c;" title="Sil"><i class="fas fa-trash"></i></a>';
                            html += '</td></tr>';
                        });
                        html += '</table>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">Henüz yedek yok</p>';
                    }
                } catch (e) {
                    container.innerHTML = '<p style="color:#95a5a6;text-align:center;">Yedekler yüklenemedi</p>';
                }
            }

            async function deleteServerBackup(filename) {
                if (!confirm('Bu yedeği silmek istediğinize emin misiniz?\n' + filename)) return;
                try {
                    const res = await fetch(API_BASE + '/backup.php?action=delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file: filename })
                    });
                    const data = await res.json();
                    if (data.success) {
                        showNotification('Yedek silindi', 'success');
                        loadServerBackups();
                    } else {
                        showNotification('Hata: ' + data.message, 'error');
                    }
                } catch (e) {
                    showNotification('Silme hatası: ' + e.message, 'error');
                }
            }

            // Settings sekmesinde Yedekleme verilerini yükle
            const origShowTab = window.showTab;
            if (typeof origShowTab === 'function') {
                window.showTab = function (tabName) {
                    origShowTab(tabName);
                    if (tabName === 'settings') {
                        loadServerBackups();
                    }
                };
            }

            async function saveAllSettings() {
                const newUsername = document.getElementById('newUsername').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;

                if (!newUsername) {
                    showNotification('Kullanıcı adı boş olamaz!', 'warning');
                    return;
                }

                if (newPassword && newPassword.length < 6) {
                    showNotification('Yeni şifre en az 6 karakter olmalıdır!', 'warning');
                    return;
                }

                if (newPassword !== newPasswordConfirm) {
                    showNotification('Yeni şifreler eşleşmiyor!', 'warning');
                    return;
                }

                const settingsToSave = {
                    aidat_settings: {
                        'Asil Üye': parseFloat(document.getElementById('aidatAsilUye').value) || 0,
                        'Asil Onursal': parseFloat(document.getElementById('aidatAsilOnursal').value) || 0,
                        'Öğrenci Üye': parseFloat(document.getElementById('aidatOgrenciUye').value) || 0,
                        'Fahri Üye': parseFloat(document.getElementById('aidatFahriUye').value) || 0,
                        'Fahri Onursal': parseFloat(document.getElementById('aidatFahriOnursal').value) || 0
                    },
                    admin_username: newUsername,
                    admin_password: newPassword // Send empty string if not changed, server will ignore it
                };

                try {
                    const response = await fetch(`${API_BASE}/settings.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settingsToSave)
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Ayarlar başarıyla kaydedildi!', 'success');
                        adminUsername = newUsername; // Update global variable
                        await loadAllSettings(); // Reload settings from DB
                    } else {
                        showNotification('Ayarlar kaydedilirken hata oluştu: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showNotification('Ayarlar kaydedilirken bir ağ hatası oluştu.', 'error');
                }
            }

            async function saveIbanSettings() {
                const ibanData = {
                    iban_settings: {
                        banka_adi: document.getElementById('ibanBankaAdi').value.trim(),
                        hesap_sahibi: document.getElementById('ibanHesapSahibi').value.trim(),
                        iban: document.getElementById('ibanNumarasi').value.trim(),
                        aciklama: document.getElementById('ibanAciklama').value.trim()
                    }
                };
                try {
                    const response = await fetch(`${API_BASE}/settings.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ibanData)
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification('✅ IBAN bilgileri kaydedildi!', 'success');
                        await loadAllSettings();
                    } else {
                        showNotification('❌ IBAN kaydetme hatası: ' + result.message, 'error');
                    }
                } catch (error) {
                    showNotification('❌ Ağ hatası', 'error');
                }
            }


            function populateSettingsForm() {
                // Populate aidat settings from MySQL data
                document.getElementById('aidatAsilUye').value = aidatSettings['Asil Üye'] || 0;
                document.getElementById('aidatAsilOnursal').value = aidatSettings['Asil Onursal'] || 0;
                document.getElementById('aidatOgrenciUye').value = aidatSettings['Öğrenci Üye'] || 0;
                document.getElementById('aidatFahriUye').value = aidatSettings['Fahri Üye'] || 0;
                document.getElementById('aidatFahriOnursal').value = aidatSettings['Fahri Onursal'] || 0;

                // Populate credentials
                document.getElementById('currentUsername').value = adminUsername;
                document.getElementById('newUsername').value = adminUsername;
                document.getElementById('newPassword').value = '';
                document.getElementById('newPasswordConfirm').value = '';

                // Set current year as default
                const currentYear = new Date().getFullYear();
                document.getElementById('borclandirmaYili').value = currentYear;

                // Populate NETGSM settings if available
                populateNetgsmSettings();

                // Populate IBAN settings
                const ibanSettings = settings && settings.iban_settings ? settings.iban_settings : {};
                document.getElementById('ibanBankaAdi').value = ibanSettings.banka_adi || '';
                document.getElementById('ibanHesapSahibi').value = ibanSettings.hesap_sahibi || '';
                document.getElementById('ibanNumarasi').value = ibanSettings.iban || '';
                document.getElementById('ibanAciklama').value = ibanSettings.aciklama || '';
            }

            // NETGSM Settings Functions
            function populateNetgsmSettings() {
                const netgsmSettings = settings && settings.netgsm_settings ? settings.netgsm_settings : {};
                document.getElementById('netgsmUsername').value = netgsmSettings.username || '';
                document.getElementById('netgsmPassword').value = netgsmSettings.password || '';
                document.getElementById('netgsmHeader').value = netgsmSettings.header || '';
            }

            async function saveNetgsmSettings() {
                const username = document.getElementById('netgsmUsername').value.trim();
                const password = document.getElementById('netgsmPassword').value;
                const header = document.getElementById('netgsmHeader').value.trim();

                if (!username || !password || !header) {
                    showNotification('Tüm NETGSM alanları zorunludur!', 'warning');
                    return;
                }

                if (header.length < 3 || header.length > 11) {
                    showNotification('Gönderici adı 3-11 karakter arasında olmalıdır!', 'warning');
                    return;
                }

                const settingsToSave = {
                    netgsm_settings: {
                        username: username,
                        password: password,
                        header: header
                    }
                };

                try {
                    const response = await fetch(`${API_BASE}/settings.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settingsToSave)
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification('NETGSM ayarları başarıyla kaydedildi!', 'success');
                        await loadAllSettings(); // Reload settings from DB
                    } else {
                        showNotification('NETGSM ayarları kaydedilirken hata oluştu: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error saving NETGSM settings:', error);
                    showNotification('NETGSM ayarları kaydedilirken bir ağ hatası oluştu.', 'error');
                }
            }

            async function testNetgsmConnection() {
                showNotification('Bağlantı testi yapılıyor...', 'info');

                try {
                    const response = await fetch(`${API_BASE}/sms.php?action=test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification('✅ NETGSM bağlantısı başarılı! Kredi: ' + (result.data.balance || 'Bilinmiyor'), 'success');
                    } else {
                        showNotification('❌ Bağlantı hatası: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('NETGSM test error:', error);
                    showNotification('Bağlantı testi sırasında bir hata oluştu.', 'error');
                }
            }

            // Otomatik Yıllık Borçlandırma Fonksiyonu
            async function otomatikBorclandir() {
                const year = parseInt(document.getElementById('borclandirmaYili').value);

                if (!year || year < 2020 || year > 2050) {
                    showNotification('Lütfen geçerli bir yıl girin!', 'warning');
                    return;
                }

                if (!confirm(`Tüm aktif üyeler ${year} yılı için borçlandırılacak. Bu işlem mevcut borç kayıtlarını etkilemez. Devam etmek istiyor musunuz?`)) {
                    return;
                }

                try {
                    showNotification('İşlem başlatıldı, lütfen bekleyin...', 'info');

                    const response = await fetch(`${API_BASE}/batch_debt.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ year: year })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const createdCount = result.data.created || 0;
                        const skippedCount = result.data.skipped || 0;
                        showNotification(`✅ Otomatik borçlandırma tamamlandı!\n${createdCount} yeni borç kaydı oluşturuldu, ${skippedCount} üye atlandı.`, 'success');
                        loadAllData(); // Refresh UI
                    } else {
                        showNotification(`Hata: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Batch debt creation error:', error);
                    showNotification('Otomatik borçlandırma sırasında bir ağ hatası oluştu.', 'error');
                }
            }

            // ═══════════════════════════════════════
            // DARK / LIGHT THEME TOGGLE
            // ═══════════════════════════════════════
            function toggleTheme() {
                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem('tpjd_theme', isDark ? 'dark' : 'light');
                updateThemeIcon(isDark);
                // Takvimi yeniden çiz (renk uyumu için)
                if (typeof renderCalendar === 'function') renderCalendar();
            }

            function applyTheme() {
                const saved = localStorage.getItem('tpjd_theme');
                // Default: light mode
                const isDark = saved === 'dark';
                if (isDark) document.body.classList.add('dark-mode');
                else document.body.classList.remove('dark-mode');
                updateThemeIcon(isDark);
            }

            function updateThemeIcon(isDark) {
                const btn = document.getElementById('themeToggleBtn');
                if (btn) btn.textContent = isDark ? '🌙' : '☀️';
            }

            // Tema'yı sayfa yüklenirken uygula (flash önleme)
            applyTheme();

            // Check authentication
            function checkAuth() {
                const storedAuth = localStorage.getItem('tpjd_isAuthenticated');
                const storedUsername = localStorage.getItem('tpjd_adminUsername');

                if (storedAuth === 'true') {
                    isAuthenticated = true;
                    if (storedUsername) adminUsername = storedUsername;

                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainApp').classList.add('show');

                    // Load data if authenticated
                    initializeDonutCharts();
                    updateSettingsInfo();
                    loadAllData();
                } else {
                    isAuthenticated = false;
                    document.getElementById('loginContainer').style.display = 'flex';
                    document.getElementById('mainApp').classList.remove('show');
                }
            }

            // Initialize

            // Duplikat borç kayıtlarını temizle (Tek seferlik temizlik)
            async function cleanDuplicateDebts() {
                try {
                    let duplicateIds = [];

                    const completedPayments = payments.filter(p =>
                        p.type === 'aidat' &&
                        p.status === 'tamamlandı'
                    );

                    completedPayments.forEach(completedPayment => {
                        const duplicateDebts = payments.filter(p =>
                            p.id !== completedPayment.id &&
                            p.memberId === completedPayment.memberId &&
                            p.year === completedPayment.year &&
                            p.type === 'aidat' &&
                            p.status === 'bekliyor'
                        );
                        duplicateIds = duplicateIds.concat(duplicateDebts.map(d => d.id));
                    });

                    if (duplicateIds.length === 0) {
                        return;
                    }

                    await Promise.all(
                        duplicateIds.map(id => fetch(`${API_BASE}/payments.php?id=${id}`, { method: 'DELETE' }))
                    );

                    await Promise.all([loadPayments(), loadDebtors()]);
                    showNotification(`✅ ${duplicateIds.length} adet duplikat borç kaydı temizlendi!`, 'success');
                } catch (error) {
                    console.error('Duplikat borç temizleme hatası:', error);
                    showNotification('Duplikat borçlar temizlenirken hata oluştu.', 'error');
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                checkAuth();
                setDefaultDate();
                generateYearSelection();

                // Fix tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function (e) {
                        const tabName = this.getAttribute('onclick').match(/switchTab\('([^']+)'/)[1];
                        switchTab(tabName, e);
                    });
                });
            });

            // Tab switching
            function switchTab(tabName, event) {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Show selected tab content
                document.getElementById(tabName).classList.add('active');

                // Add active class to clicked tab
                event.currentTarget.classList.add('active');

                // Reload data based on tab
                if (tabName === 'members') loadMembersTable();
                if (tabName === 'payments') loadPaymentsTable();
                if (tabName === 'notifications') loadNotifications();
                if (tabName === 'settings') populateSettingsForm();
                if (tabName === 'dashboard') {
                    updateDashboard();
                    updateDonutCharts();
                }
            }

            // Generate ID
            function generateId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            }

            // Set default date
            function setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                const dateInputs = ['paymentDate', 'transactionDate'];
                dateInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.value = today;
                });
            }

            // Generate year selection checkboxes
            // Geçmiş yıl borçlandırma — dropdown oluştur
            let pendingPastDebts = []; // [{year, amount}]

            function generateYearSelection() {
                const select = document.getElementById('pastDebtYear');
                if (!select) return;
                const currentYear = new Date().getFullYear();
                select.innerHTML = '';
                for (let year = currentYear - 1; year >= 2000; year--) {
                    select.innerHTML += `<option value="${year}">${year}</option>`;
                }
                // Üyelik tipine göre varsayılan tutarı doldur
                updatePastDebtDefaultAmount();
            }

            function updatePastDebtDefaultAmount() {
                const membershipType = document.getElementById('membershipType')?.value;
                const amountInput = document.getElementById('pastDebtAmount');
                if (amountInput && membershipType && typeof aidatSettings !== 'undefined') {
                    const defaultAmount = parseFloat(aidatSettings[membershipType] || 0);
                    amountInput.placeholder = defaultAmount > 0 ? `Vars.: ₺${defaultAmount}` : 'Tutar';
                }
            }

            function addPastDebtEntry() {
                const yearSelect = document.getElementById('pastDebtYear');
                const amountInput = document.getElementById('pastDebtAmount');
                const year = yearSelect.value;
                let amount = parseFloat(amountInput.value);

                // Tutar girilmemişse varsayılanı kullan
                if (!amount || amount <= 0) {
                    const membershipType = document.getElementById('membershipType')?.value;
                    if (membershipType && typeof aidatSettings !== 'undefined') {
                        amount = parseFloat(aidatSettings[membershipType] || 0);
                    }
                }

                if (!year) { showNotification('Lütfen yıl seçin!', 'warning'); return; }
                if (!amount || amount <= 0) { showNotification('Lütfen tutar girin!', 'warning'); return; }

                // Aynı yıl zaten eklenmişse uyar
                if (pendingPastDebts.find(d => d.year === year)) {
                    showNotification(`${year} yılı zaten listede!`, 'warning');
                    return;
                }

                pendingPastDebts.push({ year, amount });
                amountInput.value = '';
                renderPastDebtList();
            }

            function removePastDebtEntry(index) {
                pendingPastDebts.splice(index, 1);
                renderPastDebtList();
            }

            function renderPastDebtList() {
                const container = document.getElementById('pastDebtList');
                if (!container) return;
                if (pendingPastDebts.length === 0) {
                    container.innerHTML = '<span style="font-size:12px;color:#95a5a6;font-style:italic;">Henüz borç eklenmedi</span>';
                    return;
                }
                const total = pendingPastDebts.reduce((s, d) => s + d.amount, 0);
                container.innerHTML = pendingPastDebts.map((d, i) => `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:rgba(52,152,219,0.08);border-radius:6px;margin-bottom:4px;font-size:13px;">
                        <span><strong>${d.year}</strong> — ₺${d.amount.toLocaleString('tr-TR')}</span>
                        <button type="button" onclick="removePastDebtEntry(${i})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:14px;" title="Kaldır"><i class="fas fa-times-circle"></i></button>
                    </div>
                `).join('') + `<div style="font-size:12px;color:#3498db;font-weight:600;margin-top:6px;text-align:right;">Toplam: ₺${total.toLocaleString('tr-TR')} (${pendingPastDebts.length} yıl)</div>`;
            }

            // Toggle year selection
            function toggleYearSelection() {
                const checkbox = document.getElementById('gecmisYillarBorclandir');
                const container = document.getElementById('yearSelectionContainer');
                if (checkbox && container) {
                    container.style.display = checkbox.checked ? 'block' : 'none';
                    if (checkbox.checked) generateYearSelection();
                }
            }

            // Update aidat amount based on membership type and selected year
            function updateAidatAmount() {
                const membershipType = document.getElementById('membershipType').value;
                const paymentAmountInput = document.getElementById('paymentAmount');
                const year = document.getElementById('paymentYear')?.value || new Date().getFullYear();

                if (paymentAmountInput) {
                    // Use historical settings if available for that year, otherwise current settings
                    const yearSettings = (historicalAidatSettings && historicalAidatSettings[year]) ? historicalAidatSettings[year] : aidatSettings;
                    paymentAmountInput.value = (yearSettings[membershipType] || 0).toFixed(2);
                }
            }

            // Update payment amount when member is selected
            function updatePaymentAmount() {
                const memberId = document.getElementById('paymentMemberId').value;
                const member = members.find(m => m.id === memberId);
                const year = document.getElementById('paymentYear')?.value || new Date().getFullYear();

                if (member) {
                    // Use historical settings if available for that year, otherwise current settings
                    const yearSettings = (historicalAidatSettings && historicalAidatSettings[year]) ? historicalAidatSettings[year] : aidatSettings;
                    document.getElementById('paymentAmount').value = (yearSettings[member.membershipType] || 0).toFixed(2);
                }
            }

            // ─── Direct Notification System (Üye Detay → Bildirim) ───
            let directNotifyMember = null;

            function sendNotificationToCurrentMember() {
                if (!currentMemberId) {
                    showNotification('Lütfen bir üye seçin!', 'warning');
                    return;
                }

                const member = members.find(m => m.id === currentMemberId);
                if (!member) {
                    showNotification('Üye bulunamadı!', 'error');
                    return;
                }

                directNotifyMember = member;

                // Üye bilgilerini doldur
                document.getElementById('directNotifyMemberName').textContent =
                    `${member.memberNo} — ${member.firstName} ${member.lastName}`;

                // Borç bilgisi
                const memberPayments = payments.filter(p => p.memberId === member.id);
                const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor' && p.type === 'aidat');
                const totalDebt = pendingPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                document.getElementById('directNotifyMemberDebt').textContent =
                    totalDebt > 0 ? `💰 Borç: ₺${totalDebt.toFixed(2)} (${pendingPayments.length} yıl)` : '✓ Borç yok';

                // Kanalları render et
                renderDirectNotifyChannels(member);

                // Mesajı otomatik oluştur
                document.getElementById('directNotifySubject').value = 'Aidat Hatırlatma';
                document.getElementById('directNotifyMessage').value = generateDebtMessage(member);

                // Sonuçları sıfırla
                document.getElementById('directNotifyResults').style.display = 'none';
                document.getElementById('directNotifyResults').innerHTML = '';
                document.getElementById('directNotifySendBtn').disabled = false;
                document.getElementById('directNotifySendBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Gönder';

                // Detay modalını KAPATMADAN üstüne aç
                openModal('directNotifyModal');
            }

            function renderDirectNotifyChannels(member) {
                const hasEmail = member.email && member.email.trim() !== '';
                const hasPhone = member.phone && member.phone.trim() !== '';

                const channels = [
                    {
                        id: 'email', label: 'E-posta', icon: 'fas fa-envelope',
                        color: '#EA4335', info: hasEmail ? member.email : 'E-posta yok',
                        enabled: hasEmail, checked: hasEmail
                    },
                    {
                        id: 'sms', label: 'SMS', icon: 'fas fa-comment-sms',
                        color: '#2196F3', info: hasPhone ? member.phone : 'Telefon yok',
                        enabled: hasPhone, checked: false
                    },
                    {
                        id: 'whatsapp', label: 'WhatsApp', icon: 'fab fa-whatsapp',
                        color: '#25D366', info: hasPhone ? member.phone : 'Telefon yok',
                        enabled: hasPhone, checked: hasPhone
                    }
                ];

                const container = document.getElementById('directNotifyChannels');
                container.innerHTML = channels.map(ch => `
                    <label style="display: flex; flex-direction: column; align-items: center; padding: 14px 10px;
                                  background: ${ch.enabled && ch.checked ? ch.color + '15' : '#f8f9fa'};
                                  border: 2px solid ${ch.enabled && ch.checked ? ch.color : '#e0e6ed'}; border-radius: 10px;
                                  cursor: ${ch.enabled ? 'pointer' : 'not-allowed'}; opacity: ${ch.enabled ? '1' : '0.5'};
                                  transition: all 0.2s; position: relative;" id="directCh_${ch.id}_card"
                           onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='none'">
                        <input type="checkbox" id="directCh_${ch.id}" ${ch.checked ? 'checked' : ''} ${ch.enabled ? '' : 'disabled'}
                               style="position: absolute; top: 8px; right: 8px; width: 16px; height: 16px; accent-color: ${ch.color};"
                               onchange="updateChannelCardStyle('${ch.id}', '${ch.color}')">
                        <i class="${ch.icon}" style="font-size: 24px; color: ${ch.color}; margin-bottom: 6px;"></i>
                        <span style="font-weight: 600; font-size: 13px; color: var(--tpjd-dark);">${ch.label}</span>
                        <span style="font-size: 10px; color: #7f8c8d; margin-top: 4px; text-align: center; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ch.info}</span>
                    </label>
                `).join('');
            }

            function updateChannelCardStyle(channelId, color) {
                const checkbox = document.getElementById(`directCh_${channelId}`);
                const card = document.getElementById(`directCh_${channelId}_card`);
                if (checkbox.checked) {
                    card.style.background = color + '15';
                    card.style.borderColor = color;
                } else {
                    card.style.background = '#f8f9fa';
                    card.style.borderColor = '#e0e6ed';
                }
            }

            function generateDebtMessage(member) {
                const memberPayments = payments.filter(p => p.memberId === member.id);
                const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor' && p.type === 'aidat');
                const debtYears = pendingPayments.map(p => p.year).sort((a, b) => a - b);
                const totalDebt = pendingPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                let msg = `Sayın ${member.firstName} ${member.lastName},\n\n`;

                if (debtYears.length > 0) {
                    msg += `TPJD üyelik aidatlarınız ile ilgili bilgilendirme:\n\n`;
                    msg += `Borçlu yıllar: ${debtYears.join(', ')}\n`;
                    msg += `Toplam borç: ₺${totalDebt.toFixed(2)}\n\n`;
                    msg += `Aidat ödemelerinizi dernek hesabına yapabilirsiniz.\n\n`;
                } else {
                    msg += `TPJD üyelik durumunuz ile ilgili bilgilendirme.\n\n`;
                }

                msg += `Saygılarımızla,\nTPJD Yönetim Kurulu`;
                return msg;
            }

            async function sendDirectNotification() {
                if (!directNotifyMember) return;

                const member = directNotifyMember;
                const subject = document.getElementById('directNotifySubject').value.trim();
                const message = document.getElementById('directNotifyMessage').value.trim();

                if (!subject || !message) {
                    showNotification('Konu ve mesaj alanları zorunludur!', 'warning');
                    return;
                }

                const sendEmail = document.getElementById('directCh_email')?.checked;
                const sendSms = document.getElementById('directCh_sms')?.checked;
                const sendWhatsapp = document.getElementById('directCh_whatsapp')?.checked;

                if (!sendEmail && !sendSms && !sendWhatsapp) {
                    showNotification('En az bir kanal seçmelisiniz!', 'warning');
                    return;
                }

                // Disable button
                const btn = document.getElementById('directNotifySendBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...';

                const results = [];
                const resultsDiv = document.getElementById('directNotifyResults');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div style="color: #7f8c8d; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Gönderiliyor...</div>';

                // ── Email ──
                if (sendEmail && member.email) {
                    try {
                        const res = await fetch(`${API_BASE}/send_email.php`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                recipients: [{ email: member.email, name: `${member.firstName} ${member.lastName}` }],
                                subject: subject,
                                message: message
                            })
                        });
                        const data = await res.json();
                        results.push({ channel: 'E-posta', icon: 'fas fa-envelope', color: '#EA4335', success: data.success, msg: data.message });
                    } catch (e) {
                        results.push({ channel: 'E-posta', icon: 'fas fa-envelope', color: '#EA4335', success: false, msg: e.message });
                    }
                }

                // ── SMS ──
                if (sendSms && member.phone) {
                    try {
                        const res = await fetch(`${API_BASE}/sms.php?action=send`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                recipients: [member.phone],
                                message: `${subject}\n\n${message}`
                            })
                        });
                        const data = await res.json();
                        results.push({ channel: 'SMS', icon: 'fas fa-comment-sms', color: '#2196F3', success: data.success, msg: data.message });
                    } catch (e) {
                        results.push({ channel: 'SMS', icon: 'fas fa-comment-sms', color: '#2196F3', success: false, msg: e.message });
                    }
                }

                // ── WhatsApp (Evolution API via server) ──
                if (sendWhatsapp && member.phone) {
                    try {
                        const res = await fetch(`${API_BASE}/notifications.php?action=whatsapp_send`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                phone: member.phone,
                                message: `*${subject}*\n\n${message}`
                            })
                        });
                        const data = await res.json();
                        results.push({ channel: 'WhatsApp', icon: 'fab fa-whatsapp', color: '#25D366', success: data.success, msg: data.message });
                    } catch (e) {
                        results.push({ channel: 'WhatsApp', icon: 'fab fa-whatsapp', color: '#25D366', success: false, msg: e.message });
                    }
                }

                // Sonuçları göster
                resultsDiv.innerHTML = results.map(r => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; margin-bottom: 8px;
                                background: ${r.success ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;
                                border-left: 4px solid ${r.success ? '#4caf50' : '#ef5350'};">
                        <i class="${r.icon}" style="color: ${r.color}; font-size: 18px; width: 24px; text-align: center;"></i>
                        <span style="font-weight: 600; min-width: 70px;">${r.channel}</span>
                        <span style="font-size: 13px; color: ${r.success ? '#2e7d32' : '#c62828'};">
                            ${r.success ? '✅ ' : '❌ '}${r.msg}
                        </span>
                    </div>
                `).join('');

                // Save notification record
                const successChannels = results.filter(r => r.success).map(r => r.channel);
                if (successChannels.length > 0) {
                    try {
                        await fetch(`${API_BASE}/notifications.php`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: generateId(),
                                memberId: member.id,
                                memberName: `${member.firstName} ${member.lastName}`,
                                title: `${subject} (${successChannels.join('+')})`,
                                message: message,
                                priority: 'normal',
                                recipients: [member.id],
                                sentAt: new Date().toISOString()
                            })
                        });
                    } catch (e) { console.error('Notification log error:', e); }
                }

                // Update button
                btn.disabled = false;
                const allSuccess = results.every(r => r.success);
                btn.innerHTML = allSuccess
                    ? '<i class="fas fa-check"></i> Tamamlandı'
                    : '<i class="fas fa-paper-plane"></i> Tekrar Gönder';

                if (allSuccess) {
                    showNotification(`✅ ${successChannels.join(', ')} ile bildirim gönderildi!`, 'success');
                }
            }


            // Change notification recipient
            function changeNotificationRecipient() {
                document.getElementById('preSelectedMemberInfo').style.display = 'none';
                document.getElementById('normalMemberSelection').style.display = 'block';
                populateIndividualMemberSelect();
            }

            // Add payment for current member (Borçlu detayından)
            function addPaymentForCurrentMember() {
                if (!currentMemberId) {
                    showNotification('Lütfen bir üye seçin!', 'warning');
                    return;
                }

                const member = members.find(m => m.id === currentMemberId);
                if (!member) {
                    showNotification('Üye bulunamadı!', 'error');
                    return;
                }

                // Detay modalını kapat
                closeModal('memberDetailModal');

                // Ödeme modalını aç
                openModal('paymentModal');

                // Üyeyi seç
                populateMemberSelect();
                document.getElementById('paymentMemberId').value = member.id;

                // Varsayılan değerler
                const currentYear = new Date().getFullYear();
                document.getElementById('paymentYear').value = currentYear;
                document.getElementById('paymentType').value = 'aidat';
                document.getElementById('paymentStatus').value = 'tamamlandı';

                // Aidat tutarını otomatik doldur
                updatePaymentAmount();

                showNotification(`${member.firstName} ${member.lastName} için ödeme ekleniyor...`, 'info');
            }

            // Quick pay debt - Detay sayfasından hızlı ödeme
            function quickPayDebt(paymentId) {
                // Bekleyen ödemeyi bul
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) {
                    showNotification('Ödeme kaydı bulunamadı!', 'error');
                    return;
                }

                if (payment.status !== 'bekliyor') {
                    showNotification('Bu ödeme zaten tamamlanmış!', 'warning');
                    return;
                }

                // Üyeyi bul
                const member = members.find(m => m.id === payment.memberId);
                if (!member) {
                    showNotification('Üye bulunamadı!', 'error');
                    return;
                }

                // Detay modalını kapat
                closeModal('memberDetailModal');

                // Ödeme modalını aç
                openModal('paymentModal');

                // Formu doldur - BEKLEYEN ÖDEMEYİ DÜZENLİYORUZ
                document.getElementById('paymentId').value = payment.id; // ← Önemli: Mevcut ID

                // Üye listesini doldur ve seç
                populateMemberSelect();
                document.getElementById('paymentMemberId').value = payment.memberId;

                // Diğer alanları doldur
                document.getElementById('paymentAmount').value = payment.amount;
                document.getElementById('paymentType').value = payment.type;
                document.getElementById('paymentYear').value = payment.year;
                document.getElementById('paymentDescription').value = payment.description;
                document.getElementById('paymentStatus').value = 'tamamlandı'; // Ödeme yapılacak

                // Bugünün tarihini set et
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('paymentDate').value = today;

                // Fiş no alanına focus
                setTimeout(() => {
                    document.getElementById('receiptNo')?.focus();
                }, 300);

                showNotification(` ${member.firstName} ${member.lastName} - ${payment.year} yılı ödeme yapılıyor...`, 'info');
            }

            // Initialize Donut Charts
            function initializeDonutCharts() {
                // Destroy existing charts if they exist to avoid "Canvas is already in use" error
                if (membershipDonutChart) {
                    membershipDonutChart.destroy();
                    membershipDonutChart = null;
                }

                // Check if Chart is available
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded');
                    return;
                }

                // Membership Type Donut Chart
                const membershipCtx = document.getElementById('membershipDonutChart');
                if (!membershipCtx) {
                    console.error('Membership chart canvas not found');
                    return;
                }

                membershipDonutChart = new Chart(membershipCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Asil Üye', 'Asil Onursal', 'Öğrenci Üye', 'Fahri Üye', 'Fahri Onursal'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: [
                                '#1a73e8',  // Asil Üye — Mavi
                                '#9333ea',  // Asil Onursal — Mor
                                '#059669',  // Öğrenci — Yeşil
                                '#d97706',  // Fahri Üye — Amber
                                '#dc2626'   // Fahri Onursal — Kırmızı
                            ],
                            hoverBackgroundColor: [
                                '#4285f4',
                                '#a855f7',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444'
                            ],
                            borderWidth: 3,
                            borderColor: document.body.classList.contains('dark-mode') ? '#21252b' : '#ffffff',
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 18,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleFont: { size: 14, weight: '700' },
                                bodyFont: { size: 13 },
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function (ctx) {
                                        const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                        const pct = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                                        return ` ${ctx.label}: ${ctx.parsed} üye (%${pct})`;
                                    }
                                }
                            }
                        }
                    }
                });

                updateDonutCharts();
            }

            // Update Donut Charts
            function updateDonutCharts() {
                // Re-initialize charts if they don't exist
                if (!membershipDonutChart) {
                    console.log('Charts not initialized, re-initializing...');
                    initializeDonutCharts();
                }

                // Check again after initialization
                if (!membershipDonutChart) {
                    console.error('Charts still not available after initialization');
                    return;
                }

                const currentYear = new Date().getFullYear();

                // Dinamik yıl — stat kartı subtitle'ları güncelle
                const activeSub = document.getElementById('activeSubtitle');
                const incomeSub = document.getElementById('incomeSubtitle');
                if (activeSub) activeSub.textContent = `${currentYear} yılı aidat ödemesi yapan`;
                if (incomeSub) incomeSub.textContent = `${currentYear} yılı toplam aidat geliri`;

                // Update membership type chart (sadece aktif üyeler)
                const membershipCounts = {
                    'Asil Üye': 0,
                    'Asil Onursal': 0,
                    'Öğrenci Üye': 0,
                    'Fahri Üye': 0,
                    'Fahri Onursal': 0
                };

                const activeMembers = members.filter(m => m.membershipStatus !== 'ayrıldı');
                activeMembers.forEach(member => {
                    if (membershipCounts.hasOwnProperty(member.membershipType)) {
                        membershipCounts[member.membershipType]++;
                    }
                });

                membershipDonutChart.data.datasets[0].data = [
                    membershipCounts['Asil Üye'],
                    membershipCounts['Asil Onursal'],
                    membershipCounts['Öğrenci Üye'],
                    membershipCounts['Fahri Üye'],
                    membershipCounts['Fahri Onursal']
                ];
                membershipDonutChart.update();
            }

            function populateIndividualMemberSelect(searchTerm = '') {
                const select = document.getElementById('individualMemberId');
                if (!select) return;
                select.innerHTML = '<option value="">Üye seçiniz</option>';
                const term = searchTerm.toLowerCase();
                const filtered = members.filter(m => !term || `${m.memberNo} ${m.firstName} ${m.lastName}`.toLowerCase().includes(term));
                filtered.forEach(m => select.add(new Option(`${m.memberNo} - ${m.firstName} ${m.lastName}`, m.id)));
                if (filtered.length === 1 && term) select.selectedIndex = 1; // Auto select if there is only 1 match
            }

            function searchMemberForNotification() {
                populateIndividualMemberSelect(document.getElementById('memberSearchInput').value);
            }

            let currentNotificationId = null;
            function editNotification(id) {
                const n = notifications.find(notif => notif.id === id);
                if (!n) return;
                currentNotificationId = id;
                openModal('notificationModal');
                document.getElementById('notificationTitle').value = n.title || '';
                document.getElementById('notificationMessage').value = n.message || '';
                document.getElementById('notificationPriority').value = n.priority || 'normal';
                if (n.recipients?.length > 0) {
                    document.getElementById('notificationType').value = 'individual';
                    toggleRecipientSelection();
                    const select = document.getElementById('individualMemberId');
                    select.innerHTML = '';
                    n.recipients.forEach(rid => {
                        const memberIdStr = typeof rid === 'object' ? rid.id : rid;
                        const m = members.find(mem => mem.id === memberIdStr);
                        if (m) select.add(new Option(`${m.firstName} ${m.lastName}`, m.id, true, true));
                    });
                } else {
                    document.getElementById('notificationType').value = 'group';
                    toggleRecipientSelection();
                }
            }

            function validateIndividualNotification() {
                const title = document.getElementById('notificationTitle').value.trim();
                const message = document.getElementById('notificationMessage').value.trim();
                const mid = document.getElementById('individualMemberId').value;
                if (!title || !message || !mid) {
                    showNotification('Lütfen başlık, mesaj girin ve aşağıdaki listeden bir üye SEÇİN!', 'warning');
                    return null;
                }
                const member = members.find(m => m.id === mid);
                return member ? { title, message, member } : null;
            }

            async function saveIndividualNotification(member, title, message, method) {
                try {
                    const response = await fetch(`${API_BASE}/notifications.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: generateId(),
                            memberId: member.id,
                            memberName: `${member.firstName} ${member.lastName}`,
                            title: `${title} (${method})`,
                            message,
                            priority: 'normal',
                            recipients: [{ id: member.id, name: `${member.firstName} ${member.lastName}` }],
                            sentAt: new Date().toISOString()
                        })
                    });
                    if ((await response.json()).success) await loadNotifications();
                } catch (e) { console.error(e); }
            }

            async function sendViaWhatsAppIndividual() {
                const d = validateIndividualNotification();
                if (!d || !d.member.phone) {
                    showNotification('Telefon numarası bulunamadı!', 'warning');
                    return;
                }
                let phone = d.member.phone.replace(/\D/g, '');
                if (phone.startsWith('0')) phone = '90' + phone.substring(1);
                else if (!phone.startsWith('90')) phone = '90' + phone;

                const WA = 'http://localhost:3456';
                try {
                    // Önce sunucu durumunu kontrol et
                    const statusRes = await fetch(`${WA}/status`, { signal: AbortSignal.timeout(3000) }).catch(() => null);
                    if (!statusRes || !statusRes.ok) {
                        showNotification('⚠️ WhatsApp sunucusu çalışmıyor! Ajanlar sekmesinden QR kod ile bağlanın.', 'warning');
                        return;
                    }
                    const statusData = await statusRes.json();
                    if (!statusData.authenticated) {
                        showNotification('⚠️ WhatsApp bağlı değil! Ajanlar sekmesinden QR kod ile bağlanın.', 'warning');
                        return;
                    }

                    // Mesaj gönder
                    showNotification('📤 WhatsApp mesajı gönderiliyor...', 'info');
                    const res = await fetch(`${WA}/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ number: phone, message: `*${d.title}*\n\n${d.message}` })
                    });
                    const result = await res.json();
                    if (result.success) {
                        showNotification('✅ WhatsApp mesajı gönderildi!', 'success');
                        saveIndividualNotification(d.member, d.title, d.message, 'WhatsApp');
                    } else {
                        showNotification('❌ Mesaj gönderilemedi: ' + (result.error || 'Bilinmeyen hata'), 'error');
                    }
                } catch (e) {
                    console.error('WA send error:', e);
                    showNotification('❌ WhatsApp sunucusuna bağlanılamadı!', 'error');
                }
            }

            function sendViaTelegramIndividual() {
                const d = validateIndividualNotification();
                if (!d || !d.member.phone) return;
                let phone = d.member.phone.replace(/\D/g, '');
                if (!phone.startsWith('90')) phone = '90' + phone;
                window.open(`https://t.me/+${phone}`, '_blank');
                saveIndividualNotification(d.member, d.title, d.message, 'Telegram');
            }

            function sendViaEmailIndividual() {
                const d = validateIndividualNotification();
                if (!d || !d.member.email) return;

                // Send via server instead of opening mail client
                const emailData = {
                    recipients: [{ email: d.member.email, name: `${d.member.firstName} ${d.member.lastName}` }],
                    subject: d.title,
                    message: d.message
                };

                fetch(`${API_BASE}/send_email.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailData)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            saveIndividualNotification(d.member, d.title, d.message, 'E-posta');
                            closeModal('notificationModal');
                            showNotification(`✅ E-posta başarıyla gönderildi: ${d.member.email}`, 'success');
                        } else {
                            showNotification(`❌ E-posta gönderilemedi: ${result.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Email sending error:', error);
                        showNotification('❌ E-posta gönderilirken bir hata oluştu.', 'error');
                    });
            }

            // ═══════════════════════════════════════════════════════
            // Grup Bildirim Gönderimi — checkbox'lara göre çoklu kanal
            // ═══════════════════════════════════════════════════════
            async function sendNotification() {
                const title = document.getElementById('notificationTitle').value.trim();
                const message = document.getElementById('notificationMessage').value.trim();
                const priority = document.getElementById('notificationPriority').value;
                const targetGroup = document.getElementById('targetGroup').value;

                if (!title || !message) {
                    showNotification('Lütfen başlık ve mesaj girin!', 'warning');
                    return;
                }
                if (!targetGroup) {
                    showNotification('Lütfen hedef grup seçin!', 'warning');
                    return;
                }

                // Seçili kanalları oku
                const useEmail = document.getElementById('channelEmail')?.checked;
                const useWhatsApp = document.getElementById('channelWhatsApp')?.checked;
                const useSMS = document.getElementById('channelSMS')?.checked;

                if (!useEmail && !useWhatsApp && !useSMS) {
                    showNotification('En az bir gönderim kanalı seçin!', 'warning');
                    return;
                }

                // Hedef üyeleri belirle
                let targetMembers = [];
                const currentYear = new Date().getFullYear();
                const paidIds = new Set(
                    payments
                        .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandı')
                        .map(p => p.memberId)
                );

                switch (targetGroup) {
                    case 'all':
                        targetMembers = members.filter(m => m.membershipStatus === 'aktif');
                        break;
                    case 'active':
                        targetMembers = members.filter(m => m.aidatAktif !== false && m.membershipStatus === 'aktif');
                        break;
                    case 'inactive':
                        targetMembers = members.filter(m => m.aidatAktif === false);
                        break;
                    case 'paid':
                        targetMembers = members.filter(m => m.membershipStatus === 'aktif' && paidIds.has(m.id));
                        break;
                    case 'unpaid':
                        targetMembers = members.filter(m => m.membershipStatus === 'aktif' && !paidIds.has(m.id));
                        break;
                    case 'asil':
                        targetMembers = members.filter(m => m.membershipType === 'Asil Üye');
                        break;
                    case 'asil-onursal':
                        targetMembers = members.filter(m => m.membershipType?.includes('Onursal'));
                        break;
                    case 'ogrenci':
                        targetMembers = members.filter(m => m.membershipType === 'Öğrenci Üye');
                        break;
                    case 'fahri':
                        targetMembers = members.filter(m => m.membershipType === 'Fahri Üye');
                        break;
                    default:
                        targetMembers = members.filter(m => m.membershipStatus === 'aktif');
                }

                if (targetMembers.length === 0) {
                    showNotification('Seçilen grupta üye bulunamadı!', 'error');
                    return;
                }

                const channels = [];
                if (useEmail) channels.push('📧 E-posta');
                if (useWhatsApp) channels.push('💬 WhatsApp');
                if (useSMS) channels.push('📱 SMS');

                if (!confirm(`${targetMembers.length} üyeye ${channels.join(' + ')} ile bildirim gönderilecek.\n\nDevam edilsin mi?`)) {
                    return;
                }

                let results = [];

                // 1. E-posta gönderimi
                if (useEmail) {
                    const emailRecipients = targetMembers
                        .filter(m => m.email && m.email.trim())
                        .map(m => ({ email: m.email.trim(), name: `${m.firstName} ${m.lastName}` }));

                    if (emailRecipients.length > 0) {
                        showNotification(`📧 ${emailRecipients.length} kişiye e-posta gönderiliyor...`, 'info');
                        try {
                            const res = await fetch(`${API_BASE}/send_email.php`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ recipients: emailRecipients, subject: title, message })
                            });
                            const data = await res.json();
                            results.push(`📧 E-posta: ${data.data?.success_count || 0} başarılı`);
                        } catch (e) {
                            results.push('📧 E-posta: Hata!');
                        }
                    } else {
                        results.push('📧 E-posta: E-posta adresi olan üye yok');
                    }
                }

                // 2. WhatsApp gönderimi (lokal sunucu üzerinden)
                if (useWhatsApp) {
                    const waRecipients = targetMembers.filter(m => m.phone && m.phone.trim());
                    if (waRecipients.length > 0) {
                        showNotification(`💬 ${waRecipients.length} kişiye WhatsApp gönderiliyor...`, 'info');
                        const waQueue = waRecipients.map(m => {
                            let phone = (m.phone || '').replace(/\D/g, '');
                            if (phone.startsWith('0')) phone = '90' + phone.substring(1);
                            else if (!phone.startsWith('90')) phone = '90' + phone;
                            return { number: phone, message: `*${title}*\n\n${message}`, recipient_id: m.id };
                        });
                        try {
                            await processWhatsAppQueue(waQueue, 'notification');
                            results.push(`💬 WhatsApp: ${waQueue.length} mesaj kuyruğa alındı`);
                        } catch (e) {
                            results.push('💬 WhatsApp: Hata — sunucu çalışıyor mu?');
                        }
                    } else {
                        results.push('💬 WhatsApp: Telefon numarası olan üye yok');
                    }
                }

                // 3. SMS (henüz aktif değil)
                if (useSMS) {
                    results.push('📱 SMS: Henüz aktif değil (NetGSM entegrasyonu gerekli)');
                }

                // Bildirimi DB'ye kaydet — alıcı isimlerini de kaydet
                const targetGroupLabels = {
                    'all': 'Tüm Üyeler', 'active': 'Aktif Üyeler', 'inactive': 'Pasif Üyeler',
                    'paid': 'Ödeme Yapanlar', 'unpaid': 'Ödeme Yapmayanlar',
                    'asil': 'Asil Üyeler', 'asil-onursal': 'Onursal Üyeler',
                    'ogrenci': 'Öğrenci Üyeler', 'fahri': 'Fahri Üyeler'
                };
                try {
                    await fetch(`${API_BASE}/notifications.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: generateId(),
                            title,
                            message,
                            priority,
                            recipients: targetMembers.map(m => ({ id: m.id, name: `${m.firstName} ${m.lastName}` })),
                            recipientGroup: targetGroupLabels[targetGroup] || targetGroup,
                            sentAt: new Date().toISOString(),
                            channels: channels.join(', ')
                        })
                    });
                    await loadNotifications();
                } catch (e) { console.error('Notification save error:', e); }

                closeModal('notificationModal');
                showNotification(`✅ Bildirim gönderildi! ${results.join(' | ')}`, 'success');
            }

            function openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
                if (modalId === 'memberModal') {
                    document.getElementById('memberForm').reset();
                    document.getElementById('memberId').value = '';
                    document.getElementById('aidatAktif').checked = true;
                    document.getElementById('gecmisYillarBorclandir').checked = false;
                    pendingPastDebts = [];
                    toggleYearSelection();
                } else if (modalId === 'paymentModal') {
                    document.getElementById('paymentForm').reset();
                    document.getElementById('paymentId').value = '';
                    populateMemberSelect();
                    setDefaultDate();
                } else if (modalId === 'notificationModal') {
                    document.getElementById('notificationForm').reset();
                    document.getElementById('notificationType').value = '';
                    // Reset pre-selected member info
                    document.getElementById('preSelectedMemberInfo').style.display = 'none';
                    document.getElementById('normalMemberSelection').style.display = 'block';
                    toggleRecipientSelection();
                } else if (modalId === 'eventModal') {
                    document.getElementById('eventTitle').value = '';
                    document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('eventTime').value = '10:00';
                    document.getElementById('eventLocation').value = '';
                    document.getElementById('eventDescription').value = '';
                    // Aktif üye sayısını göster
                    try {
                        const activeCount = members.filter(m => m.membershipStatus === 'aktif' && m.email).length;
                        document.getElementById('eventRecipientCount').textContent = activeCount + ' aktif üyeye email gönderilecek';
                    } catch (e) {
                        document.getElementById('eventRecipientCount').textContent = 'Üye verileri yükleniyor...';
                    }
                }
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            // Toggle exit fields visibility
            function toggleExitFields() {
                const status = document.getElementById('membershipStatus').value;
                const container = document.getElementById('exitFieldsContainer');

                if (status === 'ayrıldı') {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                    // Alanları temizle
                    document.getElementById('exitDate').value = '';
                    document.getElementById('exitReasonType').value = '';
                    document.getElementById('exitReason').value = '';
                }
            }

            // Toggle edit exit fields visibility (Üye Düzenle için)
            function toggleEditExitFields() {
                const status = document.getElementById('editMembershipStatus').value;
                const container = document.getElementById('editExitFieldsContainer');

                if (status === 'ayrıldı') {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            }

            // Populate member select
            function populateMemberSelect() {
                const select = document.getElementById('paymentMemberId');
                select.innerHTML = '<option value="">Üye seçiniz</option>';

                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.memberNo} - ${member.firstName} ${member.lastName}`;
                    select.appendChild(option);
                });
            }

            // Save member
            async function saveMember() {
                console.log("saveMember called");
                const saveBtn = document.querySelector('#memberModal .btn-primary');
                const originalBtnText = saveBtn ? saveBtn.innerHTML : 'Kaydet';

                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                }

                const memberIdInput = document.getElementById('memberId').value;
                const ensuredId = memberIdInput || generateId();

                const normalize = (val) => {
                    if (val === undefined || val === null) return '';
                    return val.toString().trim();
                };

                const normalizePhone = (val) => {
                    const digits = normalize(val).replace(/\D/g, '');
                    if (!digits) return '';
                    if (digits.startsWith('90')) return `+${digits}`;
                    if (digits.startsWith('0')) return `+9${digits.replace(/^0+/, '')}`;
                    return `+90${digits}`;
                };

                const member = {
                    id: ensuredId,
                    memberNo: normalize(document.getElementById('memberNo').value),
                    membershipType: normalize(document.getElementById('membershipType').value),
                    aidatAktif: document.getElementById('aidatAktif').checked,
                    firstName: normalize(document.getElementById('firstName').value),
                    lastName: normalize(document.getElementById('lastName').value),
                    tcNo: normalize(document.getElementById('tcNo').value),
                    gender: normalize(document.getElementById('gender').value),
                    birthDate: normalize(document.getElementById('birthDate').value),
                    phone: normalizePhone(document.getElementById('phone').value),
                    phoneHome: normalize(document.getElementById('phoneHome').value),
                    email: normalize(document.getElementById('email').value),
                    address: normalize(document.getElementById('address').value),
                    city: normalize(document.getElementById('city').value),
                    district: normalize(document.getElementById('district').value),
                    neighborhood: normalize(document.getElementById('neighborhood').value),
                    bloodType: normalize(document.getElementById('bloodType').value),
                    employmentStatus: normalize(document.getElementById('employmentStatus').value),

                    maritalStatus: normalize(document.getElementById('maritalStatus').value),
                    graduation: normalize(document.getElementById('graduation').value),
                    graduationYear: normalize(document.getElementById('graduationYear').value),
                    workplace: normalize(document.getElementById('workplace').value),
                    position: normalize(document.getElementById('position').value),

                    registrationDate: normalize(document.getElementById('registrationDate').value) || new Date().toISOString().split('T')[0],
                    lastPaymentDate: '',
                    notes: normalize(document.getElementById('notes').value),
                    membershipStatus: 'aktif',
                    exitDate: null,
                    exitReasonType: null,
                    exitReason: null
                };

                const requiredFields = [
                    { field: member.memberNo, name: 'Üye No', id: 'memberNo' },
                    { field: member.firstName, name: 'Ad', id: 'firstName' },
                    { field: member.lastName, name: 'Soyad', id: 'lastName' },
                    { field: member.tcNo, name: 'TC Kimlik No', id: 'tcNo' },
                    { field: member.gender, name: 'Cinsiyet', id: 'gender' },
                    { field: member.birthDate, name: 'Doğum Tarihi', id: 'birthDate' },
                    { field: member.email, name: 'E-posta', id: 'email' },
                    { field: member.phone, name: 'Telefon', id: 'phone' },
                    { field: member.address, name: 'Adres', id: 'address' },
                    { field: member.city, name: 'Şehir', id: 'city' },
                    { field: member.membershipType, name: 'Üyelik Tipi', id: 'membershipType' }
                ];

                for (let item of requiredFields) {
                    if (!item.field || item.field.trim() === '') {
                        alert(`❌ ${item.name} alanı zorunludur!`);
                        document.getElementById(item.id)?.focus();
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                        return;
                    }
                }

                // API'ye üyeyi kaydet
                const method = memberIdInput ? 'PUT' : 'POST';
                console.log(`Sending ${method} request to members.php with payload:`, member);

                // Capture past debt options before saving
                const isPastDebtRequested = document.getElementById('gecmisYillarBorclandir').checked;
                const selectedPastDebts = [...pendingPastDebts]; // snapshot

                try {
                    const response = await fetch(`${API_BASE}/members.php`, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(member)
                    });

                    const text = await response.text();
                    console.log("Raw save response:", text);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        throw new Error("API non-JSON response: " + text);
                    }

                    if (result.success) {
                        // Determine the correct Member ID
                        const savedMemberId = memberIdInput || (result.data && result.data.id) || ensuredId;

                        // Handle Past Debts if requested
                        if (isPastDebtRequested && selectedPastDebts.length > 0 && savedMemberId) {
                            console.log(`Creating past debts for member ${savedMemberId}:`, selectedPastDebts);
                            await createPastDebts(savedMemberId, selectedPastDebts.map(d => d.year), selectedPastDebts);
                        }

                        // ─ Yeni üye kaydında otomatik cari yıl borçlandırma ─
                        if (!memberIdInput && member.aidatAktif) {
                            const currentYear = new Date().getFullYear();
                            const alreadyCharged = isPastDebtRequested && selectedYears.includes(String(currentYear));
                            if (!alreadyCharged) {
                                try {
                                    // Manuel bedel girilmiş mi kontrol et
                                    const manuelBedel = document.getElementById('manuelAidatBedel').value;
                                    let aidatAmount = 0;

                                    if (manuelBedel && parseFloat(manuelBedel) > 0) {
                                        aidatAmount = parseFloat(manuelBedel);
                                    } else {
                                        // Ayarlardan çek
                                        aidatAmount = parseFloat(aidatSettings[member.membershipType] || 0);
                                    }

                                    if (aidatAmount > 0) {
                                        const debtPayload = {
                                            memberId: savedMemberId,
                                            year: currentYear,
                                            type: 'aidat',
                                            amount: aidatAmount,
                                            status: 'bekliyor',
                                            date: new Date().toISOString().split('T')[0]
                                        };
                                        await fetch(`${API_BASE}/payments.php`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(debtPayload)
                                        });
                                        console.log(`💰 Otomatik ${currentYear} aidat borcu oluşturuldu: ₺${aidatAmount}`);
                                    }
                                } catch (e) { console.error('Otomatik borçlandırma hatası:', e); }
                            }
                        }

                        alert("Başarıyla kaydedildi.");
                        // Agent Hook: Welcome new member
                        if (!memberIdInput && typeof agentManager !== 'undefined') {
                            agentManager.onNewMember(member);
                        }
                        closeModal('memberModal');

                        // Reload ALL data to ensure payments, debts, and dashboard are in sync
                        await loadAllData();
                    } else {
                        alert(`Hata: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Save member error:', error);
                    alert('Kaydetme sırasında bir hata oluştu: ' + error.message);
                } finally {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalBtnText;
                    }
                }
            }

            // Create aidat debt
            function createAidatDebt(memberId, year) {
                const member = members.find(m => m.id === memberId);
                if (!member) return;

                // Aidat tutarını ayarlardan al
                const amount = aidatSettings[member.membershipType] || 0;

                // Eğer aidat tutarı 0 ise borç oluşturma
                if (amount === 0) return;

                const payment = {
                    id: generateId(),
                    memberId: memberId,
                    amount: amount,
                    type: 'aidat',
                    date: '',
                    year: year,
                    receiptNo: '',
                    description: `${year} yılı ${member.membershipType} aidatı`,
                    status: 'bekliyor',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // API'ye kaydet
                fetch(`${API_BASE}/payments.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payment)
                }).then(() => {
                    loadPayments();
                    loadDebtors(year);
                }).catch(err => console.error('Aidat borcu eklenemedi:', err));
            }

            // Delete member
            async function loadMemberForEdit(id) {
                try {
                    // API'den ÇÖZÜLMÜŞ (decrypt) veri al — cache'deki maskelenmiş veri KULLANILMAMALI
                    const response = await fetch(`${API_BASE}/members.php?action=get&id=${id}`);
                    const result = await response.json();
                    if (!result.success || !result.data) {
                        showNotification('Üye verisi alınamadı: ' + (result.message || ''), 'error');
                        return;
                    }
                    const member = result.data;

                    openModal('memberModal');

                    // Formu doldur — decrypt edilmiş gerçek verilerle
                    document.getElementById('memberId').value = member.id;
                    document.getElementById('memberNo').value = member.memberNo;
                    document.getElementById('membershipType').value = member.membershipType;
                    document.getElementById('aidatAktif').checked = member.aidatAktif;
                    document.getElementById('firstName').value = member.firstName;
                    document.getElementById('lastName').value = member.lastName;
                    document.getElementById('tcNo').value = member.tcNo || '';
                    document.getElementById('gender').value = member.gender;
                    document.getElementById('birthDate').value = member.birthDate || '';
                    document.getElementById('phone').value = member.phone || '';
                    document.getElementById('phoneHome').value = member.phoneHome || '';
                    document.getElementById('email').value = member.email;
                    document.getElementById('address').value = member.address || '';
                    document.getElementById('city').value = member.city || '';
                    document.getElementById('district').value = member.district || '';
                    document.getElementById('neighborhood').value = member.neighborhood || '';
                    document.getElementById('bloodType').value = member.bloodType || '';
                    document.getElementById('employmentStatus').value = member.employmentStatus || '';

                    document.getElementById('maritalStatus').value = member.maritalStatus || '';
                    document.getElementById('graduation').value = member.graduation || '';
                    document.getElementById('graduationYear').value = member.graduationYear || '';
                    document.getElementById('workplace').value = member.workplace || '';
                    document.getElementById('position').value = member.position || '';

                    document.getElementById('registrationDate').value = member.registrationDate || '';
                    document.getElementById('notes').value = member.notes || '';

                    // Change modal title for editing
                    document.querySelector('#memberModal .modal-header h2').innerHTML = '<i class="fas fa-user-edit"></i> Üye Düzenle';
                } catch (error) {
                    console.error('Edit fetch error:', error);
                    showNotification('Üye düzenleme verisi alınamadı: ' + error.message, 'error');
                }
            }

            async function createPastDebts(memberId, years, debtEntries) {
                try {
                    const response = await fetch(`${API_BASE}/batch_past_debt.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ memberId, years, amounts: debtEntries ? debtEntries.map(d => ({ year: d.year, amount: d.amount })) : undefined })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification(result.message, 'success');
                    } else {
                        showNotification(`Geçmiş borç oluşturma hatası: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Error creating past debts:', error);
                    showNotification('Geçmiş borçlar oluşturulurken bir ağ hatası oluştu.', 'error');
                }
            }

            function deleteMember(id) {
                if (!confirm('Bu üyeyi silmek istediğinizden emin misiniz?')) return;

                fetch(`${API_BASE}/members.php?id=${id}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            showNotification('Üye başarıyla silindi!', 'success');
                            loadAllData(); // Reload all data to ensure UI is in sync
                        } else {
                            showNotification(`Hata: ${result.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('API Error:', error);
                        showNotification('Veritabanı bağlantı hatası!', 'error');
                    });
            }
            // View member details - TAM DETAYLI BORÇ BİLGİSİ
            async function viewMemberDetail(id) {
                currentMemberId = id;

                // API'den ÇÖZÜLMÜŞ (decrypt) veri al — cache'deki maskelenmiş veri KULLANILMAMALI
                let member;
                try {
                    const response = await fetch(`${API_BASE}/members.php?action=get&id=${id}`);
                    const result = await response.json();
                    if (!result.success || !result.data) {
                        showNotification('Üye detayı alınamadı!', 'error');
                        return;
                    }
                    member = result.data;
                } catch (error) {
                    console.error('Member detail fetch error:', error);
                    showNotification('Üye detayı alınamadı: ' + error.message, 'error');
                    return;
                }

                const memberPayments = payments.filter(p => p.memberId === id);

                // Ödenen yıllar
                const paidPayments = memberPayments.filter(p => p.status === 'tamamlandı' && p.type === 'aidat');
                const paidYears = paidPayments.map(p => p.year).sort((a, b) => a - b);
                const totalPaid = paidPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                // Bekleyen ödemeler (BORÇLAR)
                const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor' && p.type === 'aidat');
                const debtYears = pendingPayments.map(p => p.year).sort((a, b) => a - b);
                const totalDebt = pendingPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                // Toplam
                const grandTotal = totalPaid + totalDebt;

                let detailHTML = `
                <!-- Üyelik Durumu Badge -->
                ${member.membershipStatus === 'ayrıldı' ? `
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-user-times" style="font-size: 48px; opacity: 0.8;"></i>
                            <div>
                                <h3 style="margin: 0; font-size: 22px;">ÜYELİKTEN AYRILMIŞ</h3>
                                <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;">
                                    <strong>Ayrılış Tarihi:</strong> ${member.exitDate ? formatDate(member.exitDate) : '-'}<br>
                                    <strong>Ayrılış Nedeni:</strong> ${member.exitReasonType || '-'}
                                    ${member.exitReason ? `<br><strong>Detay:</strong> ${member.exitReason}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : member.membershipStatus === 'pasif' ? `
                    <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <i class="fas fa-pause-circle"></i> <strong>PASİF ÜYE</strong> - Geçici olarak aidat ödemesi beklenmemektedir
                    </div>
                ` : ''}
                
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Üye No</label>
                        <div class="value">${member.memberNo}</div>
                    </div>
                    <div class="detail-item">
                        <label>Ad Soyad</label>
                        <div class="value">${member.firstName} ${member.lastName}</div>
                    </div>
                    <div class="detail-item">
                        <label>TC Kimlik No</label>
                        <div class="value">${member.tcNo}</div>
                    </div>
                    <div class="detail-item">
                        <label>Üyelik Tipi</label>
                        <div class="value">${member.membershipType}</div>
                    </div>
                    <div class="detail-item">
                        <label>Doğum Tarihi</label>
                        <div class="value">${formatDate(member.birthDate)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Adres</label>
                        <div class="value">${member.city || '-'} / ${member.district || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>Kayıt Tarihi</label>
                        <div class="value">${formatDate(member.registrationDate)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Aidat Aktif</label>
                        <div class="value">${member.aidatAktif ? '<span class="badge success">Aktif</span>' : '<span class="badge warning">Pasif</span>'}</div>
                    </div>
                </div>
                
                <!-- Mali Durum Özeti -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">ÖDENDİ</div>
                        <div style="font-size: 28px; font-weight: 700;">₺${totalPaid.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${paidPayments.length} ödeme</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">BORÇ</div>
                        <div style="font-size: 28px; font-weight: 700;">₺${totalDebt.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${pendingPayments.length} bekleyen</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">TOPLAM</div>
                        <div style="font-size: 28px; font-weight: 700;">₺${grandTotal.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${memberPayments.length} işlem</div>
                    </div>
                </div>
                
                <!-- Yıllara Göre Ödeme Durumu -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid var(--tpjd-light);">
                    <h4 style="color: var(--tpjd-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-calendar-check"></i> Ödenen Yıllar
                    </h4>
                    <div style="color: ${paidYears.length > 0 ? 'var(--tpjd-success)' : '#95a5a6'}; font-size: 16px; font-weight: 600;">
                        ${paidYears.length > 0 ? paidYears.join(', ') : 'Henüz ödeme yapılmamış'}
                    </div>
                </div>
                
                <div style="background: #fff5f5; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #ffcdd2;">
                    <h4 style="color: var(--tpjd-danger); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle"></i> Borçlu Yıllar
                    </h4>
                    <div style="color: ${debtYears.length > 0 ? 'var(--tpjd-danger)' : 'var(--tpjd-success)'}; font-size: 16px; font-weight: 600;">
                        ${debtYears.length > 0 ? debtYears.join(', ') + ` (Toplam: ₺${totalDebt.toFixed(2)})` : '✓ Borç yok - Tüm ödemeler güncel'}
                    </div>
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: var(--tpjd-dark);">
                    <i class="fas fa-list"></i> Detaylı Ödeme Dökümü
                </h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Yıl</th>
                                <th>Tip</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>Tarih</th>
                                <th>Fiş No</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${memberPayments.length > 0 ? memberPayments.sort((a, b) => (b.year || 0) - (a.year || 0)).map(payment => `
                                <tr style="${payment.status === 'bekliyor' ? 'background: #fff5f5;' : ''}">
                                    <td><strong>${payment.year || '-'}</strong></td>
                                    <td>${payment.type === 'aidat' ? 'Aidat' : payment.type}</td>
                                    <td><strong style="color: ${payment.status === 'bekliyor' ? 'var(--tpjd-danger)' : 'var(--tpjd-success)'};">₺${parseFloat(payment.amount || 0).toFixed(2)}</strong></td>
                                    <td>
                                        ${payment.status === 'tamamlandı' ?
                        '<span class="badge success"><i class="fas fa-check"></i> ÖDENDİ</span>' :
                        '<span class="badge danger"><i class="fas fa-clock"></i> ÖDENMEDİ</span>'}
                                    </td>
                                    <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                                    <td><small>${payment.receiptNo || '-'}</small></td>
                                    <td>
                                        ${payment.status === 'bekliyor' ?
                        `<button class="btn btn-primary" onclick="quickPayDebt('${payment.id}')" 
                                                    style="padding: 5px 12px; font-size: 12px;" title="Hızlı Ödeme">
                                                <i class="fas fa-credit-card"></i> Öde
                                            </button>` :
                        '<span style="color: var(--tpjd-success); font-size: 12px;">✓ Ödendi</span>'}
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        <i class="fas fa-info-circle"></i>
                                        <p>Henüz ödeme kaydı bulunmamaktadır</p>
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;

                document.getElementById('memberDetailContent').innerHTML = detailHTML;
                openModal('memberDetailModal');
            }

            // Download member detail as HTML
            function downloadMemberDetail() {
                if (!currentMemberId) return;

                const member = members.find(m => m.id === currentMemberId);
                if (!member) return;

                const memberPayments = payments.filter(p => p.memberId === currentMemberId);
                const paidYears = memberPayments.filter(p => p.status === 'tamamlandı' && p.type === 'aidat').map(p => p.year);
                const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor');

                let html = `
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${member.firstName} ${member.lastName} - Üye Detayı</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { margin: 0 0 10px 0; }
        .header p { margin: 0; opacity: 0.9; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-item { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .info-item label { display: block; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .info-item .value { font-size: 16px; color: #2c3e50; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        .footer { margin-top: 30px; text-align: center; color: #7f8c8d; font-size: 14px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>TPJD - Üye Detay Raporu</h1>
        <p>Türkiye Petrol Jeologları Derneği</p>
    </div>
    
    <div class="info-grid">
        <div class="info-item"><label>Üye No</label><div class="value">${member.memberNo}</div></div>
        <div class="info-item"><label>Ad</label><div class="value">${member.firstName}</div></div>
        <div class="info-item"><label>Soyad</label><div class="value">${member.lastName}</div></div>
        <div class="info-item"><label>TC No</label><div class="value">${member.tcNo}</div></div>
        <div class="info-item"><label>Üyelik Tipi</label><div class="value">${member.membershipType}</div></div>
        <div class="info-item"><label>Doğum Tarihi</label><div class="value">${formatDate(member.birthDate)}</div></div>
        <div class="info-item"><label>Nereli</label><div class="value">${member.birthCity || '-'} / ${member.birthDistrict || '-'}</div></div>
        <div class="info-item"><label>Kayıt Tarihi</label><div class="value">${formatDate(member.registrationDate)}</div></div>
        <div class="info-item"><label>Ödenen Yıllar</label><div class="value">${paidYears.length > 0 ? paidYears.join(', ') : 'Henüz ödeme yok'}</div></div>
        <div class="info-item"><label>Bekleyen Ödeme</label><div class="value">${pendingPayments.length} adet</div></div>
    </div>
    
    <h3>Borç ve Ödeme Dökümü</h3>
    <table>
        <thead>
            <tr>
                <th>Yıl</th>
                <th>Tip</th>
                <th>Tutar</th>
                <th>Durum</th>
                <th>Tarih</th>
            </tr>
        </thead>
        <tbody>
            ${memberPayments.map(payment => `
                <tr>
                    <td>${payment.year}</td>
                    <td>${payment.type}</td>
                    <td>₺${parseFloat(payment.amount || 0).toFixed(2)}</td>
                    <td>${payment.status === 'tamamlandı' ? 'Ödendi' : 'Ödenmedi'}</td>
                    <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    
    <div class="footer">
        <p>Bu rapor ${new Date().toLocaleDateString('tr-TR')} tarihinde oluşturulmuştur.</p>
    </div>
</body>
</html>
            `;

                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${member.memberNo}_${member.firstName}_${member.lastName}_detay.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Üye detayı HTML olarak indirildi!', 'success');
            }

            // Save payment
            function savePayment() {
                console.log("savePayment called");
                const saveBtn = document.querySelector('#paymentModal .btn-primary');
                const originalBtnText = saveBtn ? saveBtn.innerHTML : 'Kaydet';

                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                }

                const paymentId = document.getElementById('paymentId').value;
                const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

                const payment = {
                    id: paymentId || generateId(),
                    memberId: document.getElementById('paymentMemberId').value,
                    amount: parseFloat(document.getElementById('paymentAmount').value),
                    type: document.getElementById('paymentType').value,
                    date: document.getElementById('paymentDate').value,
                    year: parseInt(document.getElementById('paymentYear').value),
                    receiptNo: document.getElementById('receiptNo').value,
                    description: document.getElementById('paymentDescription').value,
                    status: document.getElementById('paymentStatus').value,
                    createdAt: now,
                    updatedAt: now
                };

                if (!payment.memberId) {
                    alert('❌ Üye seçimi zorunludur!');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
                    return;
                }
                if (!payment.amount || payment.amount <= 0) {
                    alert('❌ Geçerli bir tutar giriniz!');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
                    return;
                }
                if (!payment.date) {
                    alert('❌ Tarih alanı zorunludur!');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
                    return;
                }
                if (!payment.year || isNaN(payment.year)) {
                    alert('❌ Geçerli bir yıl giriniz!');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
                    return;
                }

                // API'ye ödeme kaydet
                const method = paymentId ? 'PUT' : 'POST';
                console.log(`Sending ${method} request to payments.php with payload:`, payment);

                fetch(`${API_BASE}/payments.php`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payment)
                })
                    .then(async response => {
                        const text = await response.text();
                        console.log("Raw payment save response:", text);
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            throw new Error("API non-JSON response: " + text);
                        }
                    })
                    .then(result => {
                        if (result.success) {
                            alert("Ödeme başarıyla kaydedildi.");
                            closeModal('paymentModal');
                            loadAllData();
                            // Agent Hook: Payment Confirmation
                            if (payment.status === 'tamamlandı' && typeof agentManager !== 'undefined') {
                                agentManager.onPaymentConfirmed(payment);
                            }
                            // Direct updates for immediate UI refresh
                            setTimeout(() => {
                                updateDashboard();
                                updateDonutCharts();
                            }, 500);
                        } else {
                            alert('Hata: ' + result.message);
                        }
                    })
                    .catch(error => {
                        console.error('Save payment error:', error);
                        alert('Ödeme kaydedilirken bir hata oluştu: ' + error.message);
                    })
                    .finally(() => {
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                    });
            }

            // Edit payment
            function editPayment(id) {
                const payment = payments.find(p => p.id === id);
                if (!payment) return;

                // ÖNCE modalı aç (bu form'u reset edecek)
                openModal('paymentModal');

                // SONRA değerleri doldur
                document.getElementById('paymentId').value = payment.id;
                document.getElementById('paymentAmount').value = payment.amount;
                document.getElementById('paymentType').value = payment.type;
                document.getElementById('paymentDate').value = payment.date;
                document.getElementById('paymentYear').value = payment.year;
                document.getElementById('receiptNo').value = payment.receiptNo || '';
                document.getElementById('paymentDescription').value = payment.description;
                document.getElementById('paymentStatus').value = payment.status;

                // Üye listesini doldur ve seç
                populateMemberSelect();
                document.getElementById('paymentMemberId').value = payment.memberId;
            }

            // Delete payment
            function deletePayment(id) {
                if (!confirm('Bu ödemeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) return;

                fetch(`${API_BASE}/payments.php?id=${id}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            showNotification('Ödeme başarıyla silindi!', 'success');
                            loadAllData(); // Reload all data to ensure UI is in sync
                        } else {
                            showNotification(`Hata: ${result.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('API Error:', error);
                        showNotification('Veritabanı bağlantı hatası!', 'error');
                    });
            }

            // Load members table
            function loadMembersTable() {
                const tbody = document.getElementById('membersTable');
                const searchTerm = document.getElementById('memberSearchInput').value.toLowerCase();
                const currentYear = new Date().getFullYear();

                const filteredMembers = members.filter(member => {
                    const fullName = `${member.firstName} ${member.lastName}`.toLowerCase();
                    const memberNo = member.memberNo.toLowerCase();
                    return fullName.includes(searchTerm) || memberNo.includes(searchTerm);
                });

                if (filteredMembers.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>Henüz üye kaydı bulunmamaktadır</h3>
                            <p>Yeni üye eklemek için "Yeni Üye Ekle" butonuna tıklayın</p>
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = filteredMembers.map(member => {
                    const hasPaid = payments.some(p =>
                        p.memberId === member.id &&
                        p.type === 'aidat' &&
                        p.year == currentYear &&
                        p.status === 'tamamlandı'
                    );

                    // Üyelik durumu badge'i
                    let statusBadge = '<span class="badge success">Aktif</span>';
                    if (member.membershipStatus === 'ayrıldı') {
                        statusBadge = `<span class="badge danger" title="${member.exitReasonType || 'Ayrıldı'}">Ayrıldı</span>`;
                    } else if (member.membershipStatus === 'pasif') {
                        statusBadge = '<span class="badge warning">Pasif</span>';
                    }

                    return `
                    <tr style="${member.membershipStatus === 'ayrıldı' ? 'opacity: 0.6;' : ''}">
                        <td>${member.memberNo}</td>
                        <td>${member.firstName} ${member.lastName} ${statusBadge}</td>
                        <td>${member.tcNo}</td>
                        <td>${member.email}</td>
                        <td>${member.phone}</td>
                        <td>${member.membershipType}</td>
                        <td>${formatDate(member.registrationDate)}</td>
                        <td>
                            <button class="action-btn view" onclick="viewMemberDetail('${member.id}')" title="Detayları Görüntüle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="loadMemberForEdit('${member.id}')" title="Düzenle">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteMember('${member.id}')" title="Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            }
            // Load payments table with accordion
            function loadPaymentsTable() {
                const container = document.getElementById('paymentsAccordion');

                if (payments.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3>Henüz ödeme kaydı bulunmamaktadır</h3>
                        <p>Yeni ödeme eklemek için "Ödeme Ekle" butonuna tıklayın</p>
                    </div>
                `;
                    return;
                }

                // Group payments by member
                const paymentsByMember = {};
                payments.forEach(payment => {
                    if (!paymentsByMember[payment.memberId]) {
                        paymentsByMember[payment.memberId] = [];
                    }
                    paymentsByMember[payment.memberId].push(payment);
                });

                container.innerHTML = '';

                Object.keys(paymentsByMember).forEach(memberId => {
                    const member = members.find(m => m.id === memberId);
                    if (!member) return;

                    const memberPayments = paymentsByMember[memberId];
                    const totalPaid = memberPayments.filter(p => p.status === 'tamamlandı').reduce((sum, p) => sum + parseFloat(p.amount), 0);
                    const totalPending = memberPayments.filter(p => p.status === 'bekliyor').reduce((sum, p) => sum + parseFloat(p.amount), 0);

                    const accordion = document.createElement('div');
                    accordion.className = 'accordion';

                    const accordionHeader = document.createElement('div');
                    accordionHeader.className = 'accordion-header';
                    accordionHeader.innerHTML = `
                    <h3>
                        <i class="fas fa-user"></i>
                        ${member.memberNo} - ${member.firstName} ${member.lastName}
                        <span class="member-stats">
                            <span class="member-stat-badge" style="background: #27ae60;">₺${totalPaid.toFixed(2)} Ödendi</span>
                            <span class="member-stat-badge" style="background: #e67e22;">₺${totalPending.toFixed(2)} Ödenmedi</span>
                        </span>
                    </h3>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                `;

                    const accordionContent = document.createElement('div');
                    accordionContent.className = 'accordion-content';

                    const accordionBody = document.createElement('div');
                    accordionBody.className = 'accordion-body';

                    const table = document.createElement('table');
                    table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Fiş No</th>
                            <th>Tip</th>
                            <th>Yıl</th>
                            <th>Tutar</th>
                            <th>Açıklama</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${memberPayments.map(payment => `
                            <tr>
                                <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                                <td>${payment.receiptNo || '-'}</td>
                                <td>${payment.type}</td>
                                <td>${payment.year}</td>
                                <td>₺${parseFloat(payment.amount).toFixed(2)}</td>
                                <td>${payment.description}</td>
                                <td>
                                    ${payment.status === 'tamamlandı' ?
                            '<span class="badge success">Ödendi</span>' :
                            '<span class="badge warning">Ödenmedi</span>'}
                                </td>
                                <td>
                                    <button class="action-btn edit" onclick="editPayment('${payment.id}')" title="Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="deletePayment('${payment.id}')" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;

                    accordionBody.appendChild(table);
                    accordionContent.appendChild(accordionBody);
                    accordion.appendChild(accordionHeader);
                    accordion.appendChild(accordionContent);
                    container.appendChild(accordion);

                    // Add click event to toggle accordion
                    accordionHeader.addEventListener('click', function () {
                        this.classList.toggle('active');
                        accordionContent.classList.toggle('active');
                    });
                });
            }

            // Save transaction

            // Display notifications
            function resolveRecipientName(r) {
                // r bir obje ise (yeni format: {id, name})
                if (typeof r === 'object' && r !== null) {
                    return r.name || r.fullName || r.firstName || r.email || 'Bilinmeyen';
                }
                // r bir string ise (eski format: sadece ID)
                if (typeof r === 'string') {
                    const member = members.find(m => m.id === r);
                    if (member) return `${member.firstName} ${member.lastName}`;
                    if (r === 'bulk_email') return 'Toplu E-posta';
                    return r;
                }
                return 'Bilinmeyen';
            }

            function displayNotifications() {
                const container = document.getElementById('notificationsList');

                if (notifications.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>Henüz bildirim bulunmamaktadır</h3>
                        <p>Yeni bildirim göndermek için "Yeni Bildirim Gönder" butonuna tıklayın</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = notifications.map(notif => {
                    const dateText = notif.sentAt || notif.createdAt || notif.date || '';
                    let recipientLabel = 'Alıcı belirtilmedi';

                    // Grup etiketi varsa (yeni format)
                    if (notif.recipientGroup) {
                        const count = Array.isArray(notif.recipients) ? notif.recipients.length : 0;
                        recipientLabel = `${notif.recipientGroup} (${count} kişi)`;
                    } else if (Array.isArray(notif.recipients) && notif.recipients.length > 0) {
                        const names = notif.recipients.map(r => resolveRecipientName(r)).filter(Boolean);
                        if (names.length <= 3) {
                            recipientLabel = names.join(', ');
                        } else {
                            recipientLabel = names.slice(0, 3).join(', ') + ` ve ${names.length - 3} kişi daha`;
                        }
                        if (names.length > 1) recipientLabel += ` (${names.length} kişi)`;
                    } else if (notif.recipientName || notif.memberName) {
                        recipientLabel = notif.recipientName || notif.memberName;
                    }
                    return `
                <div class="stat-card ${notif.read ? '' : 'info'}" style="margin-bottom: 15px;">
                    <h3>${notif.title || 'Başlıksız Bildirim'}</h3>
                    <p style="margin: 10px 0;">${notif.message || notif.content || 'İçerik yok'}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <small style="color: #7f8c8d;">
                            <i class="fas fa-calendar"></i> ${formatDateTime(dateText)} | 
                            <i class="fas fa-user"></i> ${recipientLabel}
                        </small>
                        <div style="display:flex;gap:8px;">
                            <button class="action-btn delete" onclick="deleteNotification('${notif.id}')" title="Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="action-btn edit" onclick="editNotification('${notif.id}')" title="Düzenle">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
                }).join('');
            }

            // Delete notification
            async function deleteNotification(id) {
                if (!confirm('Bu bildirimi silmek istediğinizden emin misiniz?')) return;

                try {
                    const response = await fetch(`${API_BASE}/notifications.php?id=${id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) {
                        await loadNotifications();
                        showNotification('Bildirim başarıyla silindi!', 'success');
                    } else {
                        showNotification(`Hata: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Bildirim silme hatası:', error);
                    showNotification('Bildirim silinemedi.', 'error');
                }
            }

            // Utility functions
            function formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('tr-TR');
            }

            function formatDateTime(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('tr-TR') + ' ' + date.toLocaleTimeString('tr-TR');
            }

            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notificationToast');
                notification.textContent = message;
                notification.className = `notification ${type} show`;

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }

            // Search functions
            function searchMembers() {
                const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
                const rows = document.querySelectorAll('#membersTable tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }

            function searchPayments() {
                const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
                const accordions = document.querySelectorAll('#paymentsAccordion .accordion');

                accordions.forEach(accordion => {
                    const text = accordion.textContent.toLowerCase();
                    accordion.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }


            // Export functions
            function exportToExcel() {
                const wb = XLSX.utils.book_new();

                // Members sheet
                const membersData = members.map(member => ({
                    'Üye No': member.memberNo,
                    'Ad': member.firstName,
                    'Soyad': member.lastName,
                    'TC No': member.tcNo,
                    'E-posta': member.email,
                    'Telefon': member.phone,
                    'Üyelik Tipi': member.membershipType,
                    'Kayıt Tarihi': member.registrationDate
                }));
                const wsMembers = XLSX.utils.json_to_sheet(membersData);
                XLSX.utils.book_append_sheet(wb, wsMembers, 'Üyeler');

                // Payments sheet
                const paymentsData = payments.map(payment => {
                    const member = members.find(m => m.id === payment.memberId);
                    return {
                        'Üye': member ? `${member.memberNo} - ${member.firstName} ${member.lastName}` : 'Bilinmeyen',
                        'Tutar': payment.amount,
                        'Tip': payment.type,
                        'Yıl': payment.year,
                        'Tarih': payment.date,
                        'Fiş No': payment.receiptNo,
                        'Açıklama': payment.description,
                        'Durum': payment.status
                    };
                });
                const wsPayments = XLSX.utils.json_to_sheet(paymentsData);
                XLSX.utils.book_append_sheet(wb, wsPayments, 'Ödemeler');

                XLSX.writeFile(wb, 'tpjd_veriler.xlsx');
                showNotification('Excel dosyası indirildi!', 'success');
            }

            function exportMembersToExcel() {
                const membersData = members.map(member => ({
                    'Üye No': member.memberNo,
                    'Ad': member.firstName,
                    'Soyad': member.lastName,
                    'TC No': member.tcNo,
                    'E-posta': member.email,
                    'Telefon': member.phone,
                    'Üyelik Tipi': member.membershipType,
                    'Kayıt Tarihi': member.registrationDate
                }));

                const ws = XLSX.utils.json_to_sheet(membersData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Üyeler');
                XLSX.writeFile(wb, 'tpjd_uyeler.xlsx');
                showNotification('Üyeler Excel dosyası indirildi!', 'success');
            }

            function exportPaymentsToExcel() {
                const paymentsData = payments.map(payment => {
                    const member = members.find(m => m.id === payment.memberId);
                    return {
                        'Üye': member ? `${member.memberNo} - ${member.firstName} ${member.lastName}` : 'Bilinmeyen',
                        'Tutar': payment.amount,
                        'Tip': payment.type,
                        'Yıl': payment.year,
                        'Tarih': payment.date,
                        'Fiş No': payment.receiptNo,
                        'Açıklama': payment.description,
                        'Durum': payment.status
                    };
                });

                const ws = XLSX.utils.json_to_sheet(paymentsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ödemeler');
                XLSX.writeFile(wb, 'tpjd_odemeler.xlsx');
                showNotification('Ödemeler Excel dosyası indirildi!', 'success');
            }


            function exportToJSON() {
                const data = {
                    members: members,
                    payments: payments,
                    notifications: notifications,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tpjd_yedek.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('JSON yedek dosyası indirildi!', 'success');
            }

            async function importFromJSON(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm('JSON dosyası yüklenecek. Mevcut veriler API üzerinden güncellenecek. Emin misiniz?')) {
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        if (Array.isArray(data.members)) {
                            for (const member of data.members) {
                                await fetch(`${API_BASE}/members.php`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(member)
                                });
                            }
                        }
                        if (Array.isArray(data.payments)) {
                            for (const payment of data.payments) {
                                await fetch(`${API_BASE}/payments.php`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payment)
                                });
                            }
                        }
                        if (Array.isArray(data.notifications)) {
                            for (const notif of data.notifications) {
                                await fetch(`${API_BASE}/notifications.php`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(notif)
                                });
                            }
                        }

                        await loadAllData();
                        showNotification('JSON dosyası başarıyla yüklendi!', 'success');
                    } catch (error) {
                        showNotification('JSON dosyası okunamadı!', 'error');
                        console.error('JSON import error:', error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            // Dashboard update function
            function updateDashboard() {
                const currentYear = new Date().getFullYear();
                const activeMembersList = members.filter(m => m.membershipStatus !== 'ayrıldı');
                const totalMembers = activeMembersList.length;
                let paidMembers = 0;
                let totalIncome = 0;

                // All completed payments (for total income)
                const completedPayments = payments.filter(p => p.status === 'tamamlandı');

                // Current year completed payments (for paid members count)
                const currentYearPayments = completedPayments.filter(p =>
                    String(p.year) === String(currentYear)
                );

                console.log('All completed payments:', completedPayments);
                console.log('Current year payments:', currentYearPayments);

                // Calculate total income from ALL completed payments
                completedPayments.forEach(payment => {
                    totalIncome += parseFloat(payment.amount || 0);
                });

                activeMembersList.forEach(member => {
                    const hasPaid = currentYearPayments.some(p => p.memberId === member.id);
                    if (hasPaid) {
                        paidMembers++;
                    }
                });

                console.log(`Dashboard Update: currentYear=${currentYear}, totalMembers=${totalMembers}, totalIncome=${totalIncome}, paidMembers=${paidMembers}`);

                document.getElementById('totalMembers').textContent = totalMembers;
                document.getElementById('activeMembers').textContent = paidMembers || totalMembers;
                document.getElementById('pendingPayments').textContent = debtors.length;
                document.getElementById('totalIncome').textContent = '₺' + totalIncome.toFixed(2);

                updateDashboardTable();
            }

            // Dashboard tablosu güncelleme - SADECE BORÇLU ÜYELERİ GÖSTER
            function updateDashboardTable() {
                const tbody = document.getElementById('dashboardMembersTable');
                if (!debtors || debtors.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-check-circle" style="color: var(--tpjd-success);"></i>
                            <h3>Harika! Borçlu üye bulunmamaktadır</h3>
                            <p>Tüm üyelerin ödemeleri güncel</p>
                        </td>
                    </tr>
                `;
                    document.getElementById('debtorCount').textContent = '0 Borçlu Üye';
                    return;
                }

                document.getElementById('debtorCount').textContent = `${debtors.length} Borçlu Üye`;

                tbody.innerHTML = debtors.map(debtor => {
                    // Ensure debtor.memberId is a string and properly escaped for HTML attributes
                    const mId = String(debtor.memberId).replace(/'/g, "\\'");
                    return `
                <tr>
                    <td><strong>${debtor.memberNo}</strong></td>
                    <td>${debtor.fullName}</td>
                    <td>${debtor.membershipType}</td>
                    <td><small>${debtor.email || '-'}</small></td>
                    <td><small>${debtor.phone || '-'}</small></td>
                    <td><span class="badge danger">BEKLİYOR</span></td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <strong style="color: var(--tpjd-danger); font-size: 16px;">₺${Number(debtor.due).toFixed(2)}</strong>
                            <small style="color: #7f8c8d;">Ödenen: ₺${Number(debtor.paid).toFixed(2)}</small>
                        </div>
                    </td>
                    <td>
                        <button class="action-btn view" onclick="viewMemberDetail('${mId}')" title="Detayları Görüntüle">
                            <i class="fas fa-eye"></i> Detay
                        </button>
                    </td>
                </tr>
            `}).join('');
            }

            // Sample data function (API-backed)
            async function loadSampleData() {
                if (!confirm('Örnek veriler yüklenecek. Mevcut veriler korunur, yeni kayıtlar eklenecek. Emin misiniz?')) return;

                const currentYear = new Date().getFullYear();
                const sampleMembers = [
                    {
                        id: generateId(),
                        memberNo: `TPJD${Math.floor(Math.random() * 900 + 100)}`,
                        membershipType: 'Asil Üye',
                        aidatAktif: true,
                        firstName: 'Ahmet',
                        lastName: 'Yılmaz',
                        tcNo: `${Date.now().toString().slice(-11)}`,
                        gender: 'Erkek',
                        birthDate: '1975-05-15',
                        phone: '+905551234567',
                        email: `ahmet${Date.now()}@email.com`,
                        address: 'Atatürk Bulvarı No:123 Daire:5',
                        city: 'İstanbul',
                        registrationDate: '2010-01-15',
                        birthCity: 'Ankara'
                    },
                    {
                        id: generateId(),
                        memberNo: `TPJD${Math.floor(Math.random() * 900 + 100)}`,
                        membershipType: 'Öğrenci Üye',
                        aidatAktif: true,
                        firstName: 'Ayşe',
                        lastName: 'Demir',
                        tcNo: `${(Date.now() + 1).toString().slice(-11)}`,
                        gender: 'Kadın',
                        birthDate: '2001-12-10',
                        phone: '+905551234569',
                        email: `ayse${Date.now()}@email.com`,
                        address: 'Öğrenci Yurdu Kampüs İçi',
                        city: 'İzmir',
                        registrationDate: '2022-09-10',
                        birthCity: 'İzmir'
                    },
                    {
                        id: generateId(),
                        memberNo: `TPJD${Math.floor(Math.random() * 900 + 100)}`,
                        membershipType: 'Fahri Üye',
                        aidatAktif: true,
                        firstName: 'Zeynep',
                        lastName: 'Şahin',
                        tcNo: `${(Date.now() + 2).toString().slice(-11)}`,
                        gender: 'Kadın',
                        birthDate: '1988-03-25',
                        phone: '+905551234570',
                        email: `zeynep${Date.now()}@email.com`,
                        address: 'Çamlıca Mahallesi Sokak No:45/7',
                        city: 'Ankara',
                        registrationDate: '2015-06-12',
                        birthCity: 'Bursa'
                    }
                ];

                try {
                    for (const m of sampleMembers) {
                        await fetch(`${API_BASE}/members.php`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(m)
                        });
                    }

                    const paymentsToInsert = [
                        {
                            id: generateId(),
                            memberId: sampleMembers[1].id,
                            amount: 50,
                            type: 'aidat',
                            date: `${currentYear}-01-05`,
                            year: currentYear,
                            receiptNo: 'FIS001',
                            description: `${currentYear} yılı öğrenci aidat ödemesi`,
                            status: 'tamamlandı'
                        },
                        {
                            id: generateId(),
                            memberId: sampleMembers[2].id,
                            amount: 100,
                            type: 'aidat',
                            date: `${currentYear}-01-15`,
                            year: currentYear,
                            receiptNo: 'FIS002',
                            description: `${currentYear} yılı aidat ödemesi`,
                            status: 'tamamlandı'
                        }
                    ];

                    for (const p of paymentsToInsert) {
                        await fetch(`${API_BASE}/payments.php`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(p)
                        });
                    }

                    await loadAllData();
                    showNotification('✅ Örnek veriler başarıyla eklendi!', 'success');
                } catch (error) {
                    console.error('Örnek veri yükleme hatası:', error);
                    showNotification('Örnek veriler eklenirken hata oluştu.', 'error');
                }
            }

        </script>

        <script>
            // Event Announcement Function
            async function sendEventAnnouncement() {
                const title = document.getElementById('eventTitle').value.trim();
                const date = document.getElementById('eventDate').value;
                const time = document.getElementById('eventTime').value || '10:00';
                const location = document.getElementById('eventLocation').value.trim();
                const description = document.getElementById('eventDescription').value.trim();
                const target = document.getElementById('eventTarget').value;
                const channel = document.querySelector('input[name="eventChannel"]:checked')?.value || 'email';

                if (!title || !date || !description) {
                    showNotification('Etkinlik adı, tarih ve açıklama zorunludur!', 'error');
                    return;
                }

                const sendEmail = (channel === 'email' || channel === 'both');
                const sendWhatsApp = (channel === 'whatsapp' || channel === 'both');

                const btn = document.getElementById('sendEventBtn');
                const origHTML = btn.innerHTML;

                // Build WhatsApp message for event
                const dateFormatted = new Date(date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                const waMessage = `📢 *${title}*\n\n📅 Tarih: ${dateFormatted}\n🕐 Saat: ${time}${location ? '\n📍 Konum: ' + location : ''}\n\n${description}\n\n_TPJD_`;

                // Send Email if selected (always call PHP to get whatsapp_queue)
                let phpResult = null;
                if (sendEmail || sendWhatsApp) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...';
                    btn.style.opacity = '0.7';

                    try {
                        const response = await fetch('api/agents.php?action=event_announce', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, date, time, location, description, target, channel })
                        });
                        phpResult = await response.json();

                        if (sendEmail) {
                            if (phpResult.success) {
                                showNotification(`✅ E-posta: ${phpResult.data?.sent || 0} üyeye gönderildi!`, 'success');
                            } else {
                                showNotification('❌ E-posta gönderilemedi: ' + (phpResult.message || ''), 'error');
                            }
                        }
                    } catch (error) {
                        showNotification('❌ Hata: ' + error.message, 'error');
                    }
                }

                // Send WhatsApp from PHP's whatsapp_queue (has decrypted phones)
                if (sendWhatsApp && phpResult?.data?.whatsapp_queue?.length > 0) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> WhatsApp gönderiliyor...';
                    await processWhatsAppQueue(phpResult.data.whatsapp_queue, 'event_announce');
                } else if (sendWhatsApp) {
                    showNotification('⚠️ WhatsApp kuyruğu oluşturulamadı', 'warning');
                }

                btn.innerHTML = origHTML;
                btn.style.opacity = '1';
                btn.disabled = false;

                // Close modal after all sends complete
                setTimeout(() => { closeModal('eventModal'); }, 1500);
            }
        </script>

        <script>
            // Bulk Email Modal Functions
            function openBulkEmailModal() {
                document.getElementById('bulkEmailModal').classList.add('active');
                document.getElementById('bulkEmailTarget').value = '';
                document.getElementById('emailPreviewSection').style.display = 'none';
            }

            function closeBulkEmailModal() {
                document.getElementById('bulkEmailModal').classList.remove('active');
            }

            // Bulk SMS Functions
            function openBulkSMSModal() {
                document.getElementById('bulkSMSModal').classList.add('active');
                document.getElementById('smsPreviewSection').style.display = 'none';
                document.getElementById('bulkSMSMessage').value = '';
                document.getElementById('bulkSMSTarget').value = '';
                updateSMSCharCount();
            }

            function closeBulkSMSModal() {
                document.getElementById('bulkSMSModal').classList.remove('active');
            }

            // ═══ Bulk WhatsApp Wizard ═══════════════════════════════
            let waRecipients = [];
            let waCurrentIndex = 0;
            let waSentCount = 0;
            let waSkippedCount = 0;
            let waSending = false;

            function openBulkWhatsAppModal() {
                document.getElementById('bulkWhatsAppModal').classList.add('active');
                document.getElementById('waStep1').style.display = 'block';
                document.getElementById('waStep2').style.display = 'none';
                document.getElementById('bulkWATarget').value = '';
                document.getElementById('bulkWAMessage').value = '';
                document.getElementById('waPreviewSection').style.display = 'none';
                document.getElementById('waStartBtn').style.display = '';
                document.getElementById('waStopBtn').style.display = 'none';
                document.getElementById('waCancelText').textContent = 'İptal';
                waRecipients = [];
                waCurrentIndex = 0;
                waSentCount = 0;
                waSkippedCount = 0;
                waSending = false;
            }

            function closeBulkWhatsAppModal() {
                waSending = false;
                document.getElementById('bulkWhatsAppModal').classList.remove('active');
            }

            function updateWAPreview() {
                const target = document.getElementById('bulkWATarget').value;
                const previewSection = document.getElementById('waPreviewSection');
                const countEl = document.getElementById('waRecipientCount');
                const warningEl = document.getElementById('waNoPhoneWarning');

                if (!target) { previewSection.style.display = 'none'; return; }

                const currentYear = new Date().getFullYear();
                let filtered = [];
                let totalInGroup = 0;

                switch (target) {
                    case 'all':
                        filtered = members.filter(m => m.membershipStatus !== 'ayrıldı');
                        break;
                    case 'debtors':
                        const debtorIds = new Set(debtors.map(d => d.memberId));
                        filtered = members.filter(m => debtorIds.has(m.id));
                        break;
                    case 'active':
                        const activeIds = new Set(
                            payments.filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandı').map(p => p.memberId)
                        );
                        filtered = members.filter(m => activeIds.has(m.id));
                        break;
                    case 'asil':
                        filtered = members.filter(m => m.membershipType === 'Asil Üye' && m.membershipStatus !== 'ayrıldı');
                        break;
                    case 'ogrenci':
                        filtered = members.filter(m => m.membershipType === 'Öğrenci Üye' && m.membershipStatus !== 'ayrıldı');
                        break;
                    case 'fahri':
                        filtered = members.filter(m => m.membershipType === 'Fahri Üye' && m.membershipStatus !== 'ayrıldı');
                        break;
                }

                totalInGroup = filtered.length;
                const withPhone = filtered.filter(m => m.phone);
                const noPhoneCount = totalInGroup - withPhone.length;

                countEl.textContent = `${withPhone.length} kişiye gönderilecek`;
                warningEl.textContent = noPhoneCount > 0 ? `⚠️ ${noPhoneCount} üyenin telefon numarası yok, atlanacak` : '';
                previewSection.style.display = 'block';

                // Store for later
                waRecipients = withPhone.map(m => ({
                    id: m.id,
                    name: `${m.firstName} ${m.lastName}`,
                    phone: m.phone
                }));
            }

            async function startBulkWhatsApp() {
                const message = document.getElementById('bulkWAMessage').value.trim();
                if (!waRecipients.length) { showNotification('Lütfen hedef grup seçin!', 'warning'); return; }
                if (!message) { showNotification('Lütfen mesaj yazın!', 'warning'); return; }

                // Check WhatsApp local server status
                try {
                    const statusCheck = await fetch('http://localhost:3456/status', { signal: AbortSignal.timeout(3000) });
                    const statusData = await statusCheck.json();
                    if (!statusData.authenticated) {
                        showNotification('⚠️ WhatsApp bağlı değil! Ajanlar sekmesinden QR kod ile bağlanın.', 'warning');
                        return;
                    }
                } catch (e) {
                    showNotification('⚠️ WhatsApp sunucusu çalışmıyor! Ajanlar sekmesinden QR kod ile bağlantı kurun.', 'warning');
                    return;
                }

                // Switch to Step 2
                document.getElementById('waStep1').style.display = 'none';
                document.getElementById('waStep2').style.display = 'block';
                document.getElementById('waStartBtn').style.display = 'none';
                document.getElementById('waStopBtn').style.display = '';
                document.getElementById('waCancelText').textContent = 'Kapat';

                waCurrentIndex = 0;
                waSentCount = 0;
                waSkippedCount = 0;
                waSending = true;
                document.getElementById('waSentLog').innerHTML = '';

                updateWAProgress();

                // Auto-send loop
                for (let i = 0; i < waRecipients.length; i++) {
                    if (!waSending) break; // Stopped by user

                    waCurrentIndex = i;
                    showCurrentWARecipient();

                    try {
                        const r = waRecipients[i];
                        const response = await fetch(`${API_BASE}/agents.php?action=send_notification`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                channel: 'whatsapp',
                                memberId: r.id,
                                message: message,
                                subject: 'Toplu WhatsApp'
                            })
                        });
                        const result = await response.json();

                        if (result.success || result.data?.status === 'success') {
                            addWASentLog(r.name, 'sent');
                            waSentCount++;
                        } else {
                            addWASentLog(r.name + ' — ' + (result.data?.detail || result.message || 'Hata'), 'error');
                            waSkippedCount++;
                        }
                    } catch (err) {
                        addWASentLog(waRecipients[i].name + ' — Bağlantı hatası', 'error');
                        waSkippedCount++;
                    }

                    updateWAProgress();

                    // Small delay to avoid rate limiting
                    if (waSending && i < waRecipients.length - 1) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }

                waSending = false;
                document.getElementById('waStopBtn').style.display = 'none';
                updateWAProgress();
            }

            function stopBulkWhatsApp() {
                waSending = false;
                document.getElementById('waStopBtn').style.display = 'none';
                document.getElementById('waProgressTitle').textContent = '⏹️ Gönderim Durduruldu';
                document.getElementById('waProgressSubtitle').textContent = `${waSentCount} gönderildi, ${waSkippedCount} hata, ${waRecipients.length - waSentCount - waSkippedCount} kalan`;
                document.getElementById('waCurrentRecipient').style.display = 'none';
                showNotification(`⏹️ WhatsApp gönderimi durduruldu. ${waSentCount} mesaj gönderildi.`, 'info');
            }

            function updateWAProgress() {
                const total = waRecipients.length;
                const done = waSentCount + waSkippedCount;
                const pct = total > 0 ? Math.round((done / total) * 100) : 0;

                document.getElementById('waProgressBar').style.width = pct + '%';
                document.getElementById('waProgressText').textContent = `${done} / ${total}`;
                document.getElementById('waProgressTitle').textContent =
                    done >= total ? '✅ Gönderim Tamamlandı!' : 'Gönderim Devam Ediyor...';
                document.getElementById('waProgressSubtitle').textContent =
                    done >= total ? `${waSentCount} gönderildi, ${waSkippedCount} hata` : `${waSentCount} gönderildi...`;

                if (done >= total && total > 0) {
                    document.getElementById('waStopBtn').style.display = 'none';
                    document.getElementById('waCurrentRecipient').style.display = 'none';
                    document.getElementById('waCancelText').textContent = 'Kapat';
                    document.getElementById('waProgressIcon').innerHTML = '<i class="fas fa-check-circle" style="color:#27ae60;"></i>';

                    // Log to notifications
                    const target = document.getElementById('bulkWATarget').value;
                    saveNotification(null, 'Toplu WhatsApp', `${target} grubuna ${waSentCount} kişiye WhatsApp mesajı gönderildi`, 'WhatsApp');
                    showNotification(`✅ ${waSentCount} kişiye WhatsApp gönderildi!`, 'success');
                }
            }

            function showCurrentWARecipient() {
                if (waCurrentIndex >= waRecipients.length) return;

                const r = waRecipients[waCurrentIndex];
                document.getElementById('waCurrentRecipient').style.display = 'block';
                document.getElementById('waRecipientAvatar').textContent = r.name.charAt(0).toUpperCase();
                document.getElementById('waRecipientName').textContent = r.name;
                document.getElementById('waRecipientPhone').textContent = r.phone;
            }

            function addWASentLog(name, status) {
                const log = document.getElementById('waSentLog');
                const color = status === 'sent' ? '#27ae60' : '#e74c3c';
                const icon = status === 'sent' ? 'check' : 'exclamation-triangle';
                const label = status === 'sent' ? 'Gönderildi' : 'Hata';
                log.innerHTML = `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:13px;color:${color};">
                    <i class="fas fa-${icon}"></i> ${name} — ${label}
                </div>` + log.innerHTML;
            }

            async function saveNotification(memberId, title, message, channel) {
                try {
                    await fetch(API_BASE + '/notifications.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ memberId, title, message, channel, status: 'sent' })
                    });
                } catch (e) { console.warn('Notification save failed:', e); }
            }

            function updateSMSCharCount() {
                const message = document.getElementById('bulkSMSMessage').value;
                const count = message.length;
                document.getElementById('smsCharCount').textContent = `${count} / 917`;
            }

            function updateSMSPreview() {
                const target = document.getElementById('bulkSMSTarget').value;
                const previewSection = document.getElementById('smsPreviewSection');
                const recipientCountEl = document.getElementById('smsRecipientCount');
                const recipientListEl = document.getElementById('smsRecipientList');

                if (!target) {
                    previewSection.style.display = 'none';
                    return;
                }

                let recipients = [];
                const currentYear = new Date().getFullYear();

                switch (target) {
                    case 'all':
                        recipients = members
                            .filter(m => m.phone && m.membershipStatus !== 'ayrıldı')
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'debtors':
                        const debtorIds = new Set(debtors.map(d => d.memberId));
                        recipients = members
                            .filter(m => debtorIds.has(m.id) && m.phone)
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'active':
                        const activeIds = new Set(
                            payments
                                .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandı')
                                .map(p => p.memberId)
                        );
                        recipients = members
                            .filter(m => activeIds.has(m.id) && m.phone)
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'asil':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Asil Üye' && m.membershipStatus !== 'ayrıldı')
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'ogrenci':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Öğrenci Üye' && m.membershipStatus !== 'ayrıldı')
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'fahri':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Fahri Üye' && m.membershipStatus !== 'ayrıldı')
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                }

                if (recipients.length === 0) {
                    recipientCountEl.textContent = '0 kişi';
                    recipientListEl.innerHTML = '<p style="color: #999;">Seçilen grupta telefon numarası olan üye bulunmamaktadır.</p>';
                } else {
                    recipientCountEl.textContent = `${recipients.length} kişi`;
                    recipientListEl.innerHTML = recipients
                        .map(r => `<div>${r.name} - ${r.phone}</div>`)
                        .join('');
                }

                previewSection.style.display = 'block';
            }

            async function sendBulkSMS() {
                const target = document.getElementById('bulkSMSTarget').value;
                const message = document.getElementById('bulkSMSMessage').value.trim();
                const iysFilter = document.getElementById('smsIysFilter').value;

                if (!target) {
                    showNotification('Lütfen bir hedef grup seçin!', 'warning');
                    return;
                }

                if (!message) {
                    showNotification('Lütfen bir mesaj yazın!', 'warning');
                    return;
                }

                if (message.length > 917) {
                    showNotification('Mesaj 917 karakterden uzun olamaz!', 'warning');
                    return;
                }

                // Get recipients based on target
                let recipients = [];
                const currentYear = new Date().getFullYear();

                switch (target) {
                    case 'all':
                        recipients = members
                            .filter(m => m.phone && m.membershipStatus !== 'ayrıldı')
                            .map(m => m.phone);
                        break;
                    case 'debtors':
                        const debtorIds = new Set(debtors.map(d => d.memberId));
                        recipients = members
                            .filter(m => debtorIds.has(m.id) && m.phone)
                            .map(m => m.phone);
                        break;
                    case 'active':
                        const activeIds = new Set(
                            payments
                                .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandı')
                                .map(p => p.memberId)
                        );
                        recipients = members
                            .filter(m => activeIds.has(m.id) && m.phone)
                            .map(m => m.phone);
                        break;
                    case 'asil':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Asil Üye' && m.membershipStatus !== 'ayrıldı')
                            .map(m => m.phone);
                        break;
                    case 'ogrenci':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Öğrenci Üye' && m.membershipStatus !== 'ayrıldı')
                            .map(m => m.phone);
                        break;
                    case 'fahri':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Fahri Üye' && m.membershipStatus !== 'ayrıldı')
                            .map(m => m.phone);
                        break;
                }

                if (recipients.length === 0) {
                    showNotification('Seçilen grupta telefon numarası olan üye bulunmamaktadır.', 'warning');
                    return;
                }

                if (!confirm(`${recipients.length} kişiye SMS göndermek istediğinize emin misiniz?`)) {
                    return;
                }

                showNotification('SMS gönderiliyor...', 'info');

                try {
                    const response = await fetch(`${API_BASE}/sms.php?action=send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recipients: recipients,
                            message: message,
                            iysFilter: iysFilter
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification(`✅ SMS başarıyla kuyruğa alındı! Görev ID: ${result.data.jobId}`, 'success');
                        closeBulkSMSModal();
                    } else {
                        showNotification('❌ SMS gönderilemedi: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('SMS send error:', error);
                    showNotification('SMS gönderilirken bir hata oluştu.', 'error');
                }
            }

            // Alıcıları önizleme
            function updateEmailPreview() {
                const target = document.getElementById('bulkEmailTarget').value;
                const previewSection = document.getElementById('emailPreviewSection');
                const recipientCountEl = document.getElementById('emailRecipientCount');
                const recipientListEl = document.getElementById('emailRecipientList');

                if (!target) {
                    previewSection.style.display = 'none';
                    return;
                }

                let recipients = [];
                const currentYear = new Date().getFullYear();

                switch (target) {
                    case 'all':
                        recipients = members
                            .filter(m => m.email && m.membershipStatus === 'aktif')
                            .map(m => ({ email: m.email, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'paid':
                        const paidMemberIds = new Set(
                            payments
                                .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandı')
                                .map(p => p.memberId)
                        );
                        recipients = members
                            .filter(m => m.email && m.membershipStatus === 'aktif' && paidMemberIds.has(m.id))
                            .map(m => ({ email: m.email, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'unpaid':
                        const paidMemberIdsForUnpaid = new Set(
                            payments
                                .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandı')
                                .map(p => p.memberId)
                        );
                        recipients = members
                            .filter(m => m.email && m.membershipStatus === 'aktif' && !paidMemberIdsForUnpaid.has(m.id))
                            .map(m => ({ email: m.email, name: `${m.firstName} ${m.lastName}` }));
                        break;
                }

                recipientCountEl.textContent = `${recipients.length} alıcı bulundu.`;
                recipientListEl.innerHTML = recipients.map(r => `<div>${r.name} (${r.email})</div>`).join('');
                previewSection.style.display = 'block';
            }

            // Server-side email sending function
            async function sendBulkEmailDirect() {
                const target = document.getElementById('bulkEmailTarget').value;
                const subject = document.getElementById('bulkEmailSubject').value.trim();
                const message = document.getElementById('bulkEmailMessage').value.trim();

                if (!target) {
                    showNotification('Lütfen bir hedef grup seçin!', 'warning');
                    return;
                }

                if (!subject) {
                    showNotification('Lütfen e-posta konusu girin!', 'warning');
                    return;
                }

                if (!message) {
                    showNotification('Lütfen e-posta mesajı girin!', 'warning');
                    return;
                }

                const recipients = getEmailRecipients(target);

                if (recipients.length === 0) {
                    showNotification('Seçilen grupta e-posta adresi olan üye bulunamadı!', 'error');
                    return;
                }

                if (!confirm(`${recipients.length} kişiye e-posta göndermek istediğinize emin misiniz?`)) {
                    return;
                }

                showNotification('E-posta gönderiliyor...', 'info');

                try {
                    const response = await fetch(`${API_BASE}/send_email.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recipients: recipients,
                            subject: subject,
                            message: message
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const successCount = result.data.success_count || 0;
                        const failureCount = result.data.failure_count || 0;
                        showNotification(`✅ E-posta gönderildi! Başarılı: ${successCount}, Başarısız: ${failureCount}`, 'success');
                        closeBulkEmailModal();
                    } else {
                        showNotification('❌ E-posta gönderilemedi: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Email send error:', error);
                    showNotification('E-posta gönderilirken bir hata oluştu.', 'error');
                }
            }

            // Alıcıları al
            function getEmailRecipients(target) {
                let recipientMembers = [];
                const currentYear = new Date().getFullYear();

                if (target === 'all') {
                    recipientMembers = members;
                } else if (target === 'paid') {
                    recipientMembers = members.filter(member => {
                        const paid = payments.some(p => p.memberId === member.id && p.type === 'aidat' && p.year == currentYear && p.status === 'tamamlandı');
                        return paid;
                    });
                } else if (target === 'unpaid') {
                    recipientMembers = members.filter(member => {
                        const hasDebt = payments.some(p => p.memberId === member.id && p.type === 'aidat' && p.status === 'bekliyor');
                        return hasDebt;
                    });
                }

                // Sadece email adresi olanları al
                return recipientMembers
                    .filter(m => m.email && m.email.trim() !== '')
                    .map(m => ({
                        name: `${m.firstName} ${m.lastName}`,
                        email: m.email.trim()
                    }));
            }

            // Validasyon
            function validateEmailForm() {
                const target = document.getElementById('bulkEmailTarget').value;
                const subject = document.getElementById('bulkEmailSubject').value.trim();
                const message = document.getElementById('bulkEmailMessage').value.trim();

                if (!target) {
                    showNotification('Lütfen hedef grup seçin!', 'warning');
                    return null;
                }

                if (!subject) {
                    showNotification('Lütfen e-posta konusu girin!', 'warning');
                    return null;
                }

                if (!message) {
                    showNotification('Lütfen e-posta mesajı girin!', 'warning');
                    return null;
                }

                const recipients = getEmailRecipients(target);

                if (recipients.length === 0) {
                    showNotification('Seçilen grupta e-posta adresi olan üye bulunamadı!', 'error');
                    return null;
                }

                return { recipients, subject, message };
            }

            // Gmail'den gönder
            function sendViaGmail() {
                const data = validateEmailForm();
                if (!data) return;

                const emails = data.recipients.map(r => r.email).join(',');
                const subject = encodeURIComponent(data.subject);
                const body = encodeURIComponent(data.message);

                // Gmail compose URL
                const gmailUrl = `https://mail.google.com/mail/?view=cm&bcc=${emails}&su=${subject}&body=${body}`;

                // Yeni sekmede aç
                window.open(gmailUrl, '_blank');

                // Bildirim kaydet
                saveEmailNotification(data.recipients.length, 'Gmail');

                closeBulkEmailModal();
                showNotification(`✅ Gmail açıldı! ${data.recipients.length} alıcı BCC olarak eklendi.`, 'success');
            }

            // Outlook'tan gönder
            function sendViaOutlook() {
                const data = validateEmailForm();
                if (!data) return;

                const emails = data.recipients.map(r => r.email).join(';'); // Outlook noktalı virgül kullanır
                const subject = encodeURIComponent(data.subject);
                const body = encodeURIComponent(data.message);

                // Outlook Web compose URL
                const outlookUrl = `https://outlook.live.com/mail/0/deeplink/compose?bcc=${emails}&subject=${subject}&body=${body}`;

                // Yeni sekmede aç
                window.open(outlookUrl, '_blank');

                // Bildirim kaydet
                saveEmailNotification(data.recipients.length, 'Outlook');

                closeBulkEmailModal();
                showNotification(`✅ Outlook açıldı! ${data.recipients.length} alıcı BCC olarak eklendi.`, 'success');
            }

            // Varsayılan mail programından gönder
            function sendViaDefaultMail() {
                const data = validateEmailForm();
                if (!data) return;

                const emails = data.recipients.map(r => r.email).join(',');
                const subject = encodeURIComponent(data.subject);
                const body = encodeURIComponent(data.message);

                // Mailto protokolü
                const mailtoUrl = `mailto:?bcc=${emails}&subject=${subject}&body=${body}`;

                // Varsayılan mail programını aç
                window.location.href = mailtoUrl;

                // Bildirim kaydet
                saveEmailNotification(data.recipients.length, 'Varsayılan Mail');

                // Kısa bir gecikme ile modal'ı kapat
                setTimeout(() => {
                    closeBulkEmailModal();
                    showNotification(`✅ Mail programınız açıldı! ${data.recipients.length} alıcı eklendi.`, 'success');
                }, 500);
            }

            // E-posta gönderim bildirimini kaydet
            async function saveEmailNotification(recipientCount, method) {
                const notification = {
                    id: generateId(),
                    memberId: 'system',
                    memberName: 'Sistem',
                    title: `Toplu E-posta Gönderimi (${method})`,
                    message: `${recipientCount} kişiye e-posta gönderilmek üzere ${method} açıldı.`,
                    priority: 'normal',
                    recipients: ['bulk_email'],
                    sentAt: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };

                await persistNotification(notification);
            }

            // Load all data
            async function loadAllData() {
                // First load settings to ensure correct aidat values are available
                await loadAllSettings();

                // Then load other data in parallel
                await Promise.all([
                    loadMembers(),
                    loadPayments(),
                    loadNotifications()
                ]);

                // Load debtors for ALL years (not just current) to show complete debt list on dashboard
                await loadDebtors('all');

                // Refresh all UI components that depend on this data
                updateDashboard();
                updateDonutCharts();
                loadMembersTable();
                loadPaymentsTable();
                displayNotifications();
                updateSettingsInfo(); // Update settings statistics after data is loaded
                populateSettingsForm();
            }

            async function loadMembers() {
                console.log("loadMembers called");
                try {
                    const response = await fetch(`${API_BASE}/members.php?action=list`);
                    const text = await response.text();
                    console.log("Raw members response:", text);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        console.error("JSON Parse Error:", e);
                        alert("API JSON hatası (Üyeler): " + text);
                        return;
                    }

                    if (result.success) {
                        members = result.data || [];
                        console.log("Members loaded:", members.length);
                        // Add visible status line
                        const statusEl = document.getElementById('membersStatusLine');
                        if (statusEl) statusEl.textContent = `Sistemdeki Üye Sayısı: ${members.length}`;
                        loadMembersTable();
                    } else {
                        console.error('Failed to load members:', result.message);
                        members = [];
                        alert('Üyeler yüklenemedi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Load members error:', error);
                    members = [];
                    alert('Üyeleri yüklerken bir ağ hatası oluştu: ' + error.message);
                }
            }

            async function loadPayments() {
                console.log("loadPayments called");
                try {
                    const response = await fetch(`${API_BASE}/payments.php?action=list`);
                    const text = await response.text();
                    console.log("Raw payments response:", text);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        console.error("JSON Parse Error (Payments):", e);
                        alert("API JSON hatası (Ödemeler): " + text);
                        return;
                    }

                    if (result.success) {
                        payments = result.data || [];
                        console.log("Payments loaded:", payments.length);
                        loadPaymentsTable();
                    } else {
                        console.error('Failed to load payments:', result.message);
                        payments = [];
                        alert('Ödemeler yüklenemedi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Load payments error:', error);
                    payments = [];
                    alert('Ödemeleri yüklerken bir ağ hatası oluştu: ' + error.message);
                }
            }

            async function loadNotifications() {
                try {
                    const response = await fetch(`${API_BASE}/notifications.php?action=list`);
                    const result = await response.json();
                    if (result.success) {
                        notifications = result.data || [];
                    } else {
                        console.error('Failed to load notifications:', result.message);
                        notifications = [];
                        showNotification('Bildirimler yüklenemedi: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Load notifications error:', error);
                    notifications = [];
                    showNotification('Bildirimleri yüklerken bir ağ hatası oluştu.', 'error');
                }
                displayNotifications();
            }

            async function loadDebtors(year = new Date().getFullYear()) {
                console.log(`loadDebtors called for year: ${year}`);
                console.log("Current Window Location:", window.location.href);
                console.log("Current Origin:", window.origin);
                try {
                    const url = `${API_BASE}/reports.php?action=debtors&year=${year}`;
                    console.log(`Fetching debtors from: ${url}`);

                    const startTime = performance.now();
                    const response = await fetch(url).catch(err => {
                        console.error("Fetch implementation caught error:", err);
                        throw err; // Re-throw for outer catch
                    });
                    const duration = performance.now() - startTime;
                    console.log(`Fetch completed in ${duration.toFixed(2)}ms`);

                    if (!response.ok) {
                        throw new Error(`HTTP Hata! Kod: ${response.status} - ${response.statusText}`);
                    }

                    const text = await response.text();
                    console.log("Raw debtors response length:", text.length);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        console.error("JSON Parse Error (Debtors):", e);
                        alert("API JSON hatası (Borçlular): " + (text.substring(0, 500)));
                        return;
                    }

                    if (result.success && result.data) {
                        debtors = result.data.data || result.data || [];
                        console.log("Debtors loaded:", debtors.length);
                        updateDashboardTable();
                    } else {
                        console.error('Failed to load debtors:', result.message);
                        debtors = [];
                    }
                } catch (error) {
                    console.error('Detailed fetch error (Debtors):', error);
                    console.error('Error Name:', error.name);
                    console.error('Error Message:', error.message);
                    console.error('Error Stack:', error.stack);

                    let msg = error.message;
                    if (error.name === 'TypeError' && msg === 'Failed to fetch') {
                        msg = "Sunucuya bağlanılamadı (Network error). Laragon'un açık olduğundan ve API_BASE yolunun doğruluğundan emin olun. Tarayıcı konsolundaki (F12) Network sekmesini kontrol edin.";
                    }

                    alert('Borçlu listesi yüklenirken bir hata oluştu: ' + msg);
                    debtors = [];
                }
            }

            function toggleRecipientSelection() {
                const type = document.getElementById('notificationType').value;
                document.getElementById('groupSelectionContainer').style.display = type === 'group' ? 'block' : 'none';
                document.getElementById('individualSelectionContainer').style.display = type === 'individual' ? 'block' : 'none';
                document.getElementById('individualSendButtons').style.display = type === 'individual' ? 'block' : 'none';
                document.getElementById('groupSendButtons').style.display = type === 'group' ? 'block' : 'none';
                if (type === 'individual') populateIndividualMemberSelect();
            }

            function updateMembershipType() {
                const type = document.getElementById('membershipType').value;
                const aidatAktifCheckbox = document.getElementById('aidatAktif');

                if (aidatAktifCheckbox) {
                    aidatAktifCheckbox.checked = !(type.includes('Onursal'));
                }
                toggleAidatBedelField();
            }

            function toggleAidatBedelField() {
                const isNewMember = !document.getElementById('memberId').value;
                const aidatAktif = document.getElementById('aidatAktif').checked;
                const container = document.getElementById('aidatBedelContainer');
                const bedelInput = document.getElementById('manuelAidatBedel');
                const membershipType = document.getElementById('membershipType').value;

                if (isNewMember && aidatAktif && container) {
                    container.style.display = 'block';
                    // Ayarlardan varsayılan tutarı doldur
                    if (membershipType && typeof aidatSettings !== 'undefined') {
                        const defaultAmount = parseFloat(aidatSettings[membershipType] || 0);
                        bedelInput.placeholder = defaultAmount > 0
                            ? `Varsayılan: ₺${defaultAmount} (ayarlardan)`
                            : 'Bu üyelik tipi borçlandırılmaz';
                    }
                } else if (container) {
                    container.style.display = 'none';
                }
            }

            // ═══════════════════════════════════════════════════════
            // AgentManager - TPJD Agent System v0.9
            // ═══════════════════════════════════════════════════════
            class AgentManager {
                constructor() {
                    this.config = {};
                    this.stats = {};
                    this.apiBase = API_BASE + '/agents.php';
                }

                async init() {
                    try {
                        await this.loadConfig();
                        await this.loadStats();
                        await this.loadLogs();
                        this.applyConfig();
                        console.log('🤖 AgentManager initialized');
                    } catch (e) {
                        console.warn('AgentManager init warning:', e.message);
                    }
                }

                async loadConfig() {
                    try {
                        const res = await fetch(`${this.apiBase}?action=config`);
                        const data = await res.json();
                        if (data.success) this.config = data.data || {};
                    } catch (e) { console.warn('Config load failed:', e); }
                }

                async loadStats() {
                    try {
                        const res = await fetch(`${this.apiBase}?action=stats`);
                        const data = await res.json();
                        if (data.success) {
                            this.stats = data.data;
                            this.updateStatsUI();
                        }
                    } catch (e) { console.warn('Stats load failed:', e); }
                }

                updateStatsUI() {
                    const s = this.stats;
                    // Active agents count — tüm 9 agent'ı say, config'de olmayanlar da enabled kabul edilir
                    const allAgentKeys = ['payment_confirm', 'welcome', 'debt_reminder', 'yearly_charge', 'birthday', 'accounting', 'monthly_report', 'event_announce', 'seniority_promotion', 'special_day_greeting'];
                    const activeCount = allAgentKeys.filter(k => this.config[k]?.enabled !== false).length;
                    const el = (id) => document.getElementById(id);
                    if (el('activeAgentsCount')) el('activeAgentsCount').textContent = activeCount;

                    // Monthly actions
                    if (s.agents && el('monthlyAgentActions')) {
                        const total = Object.values(s.agents).reduce((sum, a) => sum + parseInt(a.total_actions || 0), 0);
                        el('monthlyAgentActions').textContent = total;
                    }

                    // Collection rate
                    if (s.collection && el('collectionRate')) {
                        el('collectionRate').textContent = '%' + (s.collection.rate || 0);
                    }

                    // Debtor count
                    if (s.pending) {
                        if (el('debtorCountAgent')) el('debtorCountAgent').textContent = s.pending.debtor_count || 0;
                        if (el('totalDebtAmount')) el('totalDebtAmount').textContent = '₺' + (s.pending.total_debt || 0).toLocaleString('tr-TR') + ' toplam borç';
                    }

                    // Per-agent stats
                    if (s.agents) {
                        Object.entries(s.agents).forEach(([name, stat]) => {
                            const statEl = el('stat_' + name);
                            if (statEl) statEl.textContent = `${stat.success_count || 0} başarılı / ${stat.error_count || 0} hata — Son: ${stat.last_run ? new Date(stat.last_run).toLocaleString('tr-TR') : '—'}`;
                        });
                    }
                }

                applyConfig() {
                    Object.entries(this.config).forEach(([agent, cfg]) => {
                        const toggle = document.getElementById('toggle_' + agent);
                        if (toggle) toggle.checked = cfg.enabled !== false;
                    });
                }

                async toggleAgent(agent, enabled) {
                    this.config[agent] = this.config[agent] || {};
                    this.config[agent].enabled = enabled;
                    await this.saveConfig();
                    showNotification(enabled ? `${agent} agent'ı aktifleştirildi` : `${agent} agent'ı devre dışı bırakıldı`, enabled ? 'success' : 'warning');
                }

                async saveConfig() {
                    try {
                        await fetch(`${this.apiBase}?action=config`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.config)
                        });
                    } catch (e) { console.error('Config save error:', e); }
                }

                async loadLogs() {
                    try {
                        const filter = document.getElementById('agentLogFilter')?.value || '';
                        const url = filter ? `${this.apiBase}?action=logs&agent=${filter}&limit=50` : `${this.apiBase}?action=logs&limit=50`;
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.success) this.renderLogs(data.data || []);
                    } catch (e) { console.warn('Logs load failed:', e); }
                }

                renderLogs(logs) {
                    const tbody = document.getElementById('agentLogsTable');
                    if (!tbody) return;
                    this._logData = logs;

                    // Update count badge in header
                    const countBadge = document.getElementById('agentLogCount');
                    if (countBadge) countBadge.textContent = logs.length;

                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;"><i class="fas fa-robot" style="font-size:48px;color:#bdc3c7;"></i><p style="color:#95a5a6;margin-top:10px;">Henüz agent işlemi yok</p></td></tr>';
                        document.getElementById('logSelectAll').checked = false;
                        this.updateSelectionCount();
                        return;
                    }

                    const agentNames = {
                        payment_confirm: '💳 Ödeme Onay', welcome: '👋 Hoş Geldin', debt_reminder: '🔔 Borç Hatırlatma',
                        yearly_charge: '📅 Yıllık Borç', birthday: '🎂 Doğum Günü', accounting: '🧮 Muhasebe',
                        monthly_report: '📊 Aylık Rapor', event_announce: '📢 Etkinlik'
                    };
                    const agentColors = {
                        payment_confirm: '#3498db', welcome: '#2ecc71', debt_reminder: '#e67e22',
                        yearly_charge: '#9b59b6', birthday: '#e91e63', accounting: '#00bcd4',
                        monthly_report: '#ff9800', event_announce: '#ff5722'
                    };
                    const statusColors = { success: '#27ae60', error: '#e74c3c', pending: '#f39c12' };
                    const statusLabels = { success: 'Başarılı', error: 'Hata', pending: 'Bekliyor' };

                    tbody.innerHTML = logs.map((log, i) => {
                        const agentColor = agentColors[log.agent_name] || '#95a5a6';
                        const sColor = statusColors[log.status] || '#95a5a6';
                        const dateStr = new Date(log.created_at).toLocaleString('tr-TR');
                        const agentLabel = agentNames[log.agent_name] || log.agent_name;
                        const sLabel = statusLabels[log.status] || log.status;
                        const detail = (log.details || '—').replace(/"/g, '&quot;');
                        const shortDetail = detail.length > 40 ? detail.substring(0, 40) + '…' : detail;

                        return `<tr data-log-id="${log.id}" style="background:rgba(255,255,255,0.02);transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                            <td style="padding:10px 6px;text-align:center;"><input type="checkbox" class="log-checkbox" data-index="${i}" onchange="agentManager.updateSelectionCount()" style="width:15px;height:15px;cursor:pointer;"></td>
                            <td style="padding:10px;"><span style="background:${agentColor};color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;white-space:nowrap;">${agentLabel}</span></td>
                            <td style="padding:10px;font-size:13px;">${log.recipient_name || '—'}</td>
                            <td style="padding:10px;font-size:12px;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#aaa;" title="${detail}">${shortDetail}</td>
                            <td style="padding:10px;font-size:12px;white-space:nowrap;color:#95a5a6;">${dateStr}</td>
                            <td style="padding:10px;text-align:center;"><span style="background:${sColor};color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;">${sLabel}</span></td>
                            <td style="padding:10px;text-align:center;"><button onclick="agentManager.deleteLog('${log.id}')" title="Sil" style="background:none;border:none;cursor:pointer;color:#e74c3c;font-size:14px;padding:4px;"><i class="fas fa-trash-alt"></i></button></td>
                        </tr>`;
                    }).join('');

                    document.getElementById('logSelectAll').checked = false;
                    this.updateSelectionCount();
                }

                toggleSelectAll(checked) {
                    document.querySelectorAll('.log-checkbox').forEach(cb => cb.checked = checked);
                    this.updateSelectionCount();
                }

                updateSelectionCount() {
                    const checked = document.querySelectorAll('.log-checkbox:checked').length;
                    const countEl = document.getElementById('logSelectedCount');
                    const deleteBtn = document.getElementById('logDeleteSelectedBtn');
                    if (countEl) countEl.textContent = checked + ' seçili';
                    if (deleteBtn) deleteBtn.style.display = checked > 0 ? 'inline-block' : 'none';
                }

                async deleteLog(logId) {
                    if (!confirm('Bu log kaydını silmek istediğinize emin misiniz?')) return;
                    try {
                        const res = await fetch(`${this.apiBase}?action=delete_log&id=${logId}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            showNotification('Log kaydı silindi', 'success');
                            await this.loadLogs();
                        } else {
                            showNotification('Silme hatası: ' + (data.message || ''), 'error');
                        }
                    } catch (e) {
                        showNotification('Silme hatası', 'error');
                    }
                }

                async deleteSelected() {
                    const checkboxes = document.querySelectorAll('.log-checkbox:checked');
                    if (checkboxes.length === 0) return;
                    if (!confirm(`${checkboxes.length} log kaydını silmek istediğinize emin misiniz?`)) return;

                    const ids = [];
                    checkboxes.forEach(cb => {
                        const item = cb.closest('tr[data-log-id]');
                        if (item) ids.push(item.dataset.logId);
                    });

                    try {
                        const res = await fetch(`${this.apiBase}?action=delete_logs`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ids })
                        });
                        const data = await res.json();
                        if (data.success) {
                            showNotification(`${ids.length} log kaydı silindi`, 'success');
                            await this.loadLogs();
                        } else {
                            showNotification('Toplu silme hatası: ' + (data.message || ''), 'error');
                        }
                    } catch (e) {
                        showNotification('Toplu silme hatası', 'error');
                    }
                }

                async refreshAll() {
                    const btn = document.getElementById('agentRefreshBtn');
                    if (btn) { btn.style.background = '#f39c12'; btn.style.borderColor = '#f39c12'; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yenileniyor...'; }
                    showNotification('Agent verileri yenileniyor...', 'info');
                    await this.loadConfig();
                    await this.loadStats();
                    await this.loadLogs();
                    this.applyConfig();
                    if (btn) { btn.style.background = '#27ae60'; btn.style.borderColor = '#27ae60'; btn.innerHTML = '<i class="fas fa-check"></i> Güncel'; }
                    const now = new Date();
                    const timeStr = now.toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
                    const span = document.getElementById('agentLastRefresh');
                    if (span) span.textContent = `Son: ${timeStr}`;
                    showNotification('Agent verileri güncellendi', 'success');
                }

                async runAllAgents() {
                    const btn = document.getElementById('agentRunAllBtn');
                    if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Çalışıyor...'; btn.style.background = '#f39c12'; btn.style.borderColor = '#f39c12'; }
                    showNotification('Tüm agentlar sırayla çalıştırılıyor...', 'info');
                    let ran = 0;

                    // Borç Hatırlatma (Kademe 1 - nazik)
                    if (this.config.debt_reminder?.enabled) {
                        try { await this.runDebtReminder(1); ran++; } catch (e) { console.error('Debt reminder error:', e); }
                    }

                    // Doğum Günü
                    if (this.config.birthday?.enabled) {
                        try { await this.runBirthdayAgent(); ran++; } catch (e) { console.error('Birthday agent error:', e); }
                    }

                    // Verileri yenile
                    await this.loadStats();
                    await this.loadLogs();

                    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check-circle"></i> Tamamlandı!'; btn.style.background = '#27ae60'; btn.style.borderColor = '#27ae60'; }
                    setTimeout(() => { if (btn) { btn.innerHTML = '<i class="fas fa-play-circle"></i> Tümünü Çalıştır'; btn.style.background = '#8e44ad'; btn.style.borderColor = '#8e44ad'; } }, 3000);
                    showNotification(`✅ ${ran} agent başarıyla çalıştırıldı!`, 'success');
                }

                // ── Event Hooks ────────────────────────────
                async onPaymentConfirmed(payment) {
                    if (!this.config.payment_confirm?.enabled) return;
                    const member = members.find(m => m.id === payment.memberId);
                    if (!member) return;
                    const subject = 'Ödeme Onayı - TPJD';
                    const message = `Sayın ${member.firstName} ${member.lastName},\n\n${payment.year} yılı ${payment.type} ödemeniz (₺${payment.amount}) başarıyla alınmıştır.\n\nMakbuz No: ${payment.receiptNo || 'Belirtilmemiş'}\nTarih: ${payment.date}\n\nTeşekkür ederiz.\nTPJD Yönetimi`;

                    const channels = this.config.payment_confirm?.channels || ['email'];
                    for (const channel of channels) {
                        if (channel === 'whatsapp') {
                            // WhatsApp mesajını tarayıcıdan gönder
                            if (member.phone) {
                                let waPhone = (member.phone || '').replace(/[^0-9]/g, '');
                                if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                await processWhatsAppQueue([{
                                    number: waPhone, message, recipient_id: member.id,
                                    recipient_name: `${member.firstName} ${member.lastName}`,
                                    detail: `💰 Ödeme onayı — ₺${payment.amount}`
                                }], 'payment_confirm');
                            }
                        } else {
                            try {
                                const response = await fetch(`${this.apiBase}?action=send-notification`, {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ agent_name: 'payment_confirm', channel, recipient_id: member.id, subject, message })
                                });
                                const result = await response.json();
                                if (result.success) {
                                    showNotification(`📧 Ödeme makbuzu ${member.firstName} ${member.lastName} isimli üyeye (${channel}) gönderildi!`, 'success');
                                } else {
                                    console.warn(`Payment confirm ${channel} error:`, result.message);
                                }
                            } catch (e) {
                                console.error(`Payment confirm ${channel} error:`, e);
                            }
                        }
                    }
                }

                async onNewMember(member) {
                    if (!this.config.welcome?.enabled) return;
                    const subject = 'TPJD\'ye Hoş Geldiniz!';
                    const message = `Sayın ${member.firstName} ${member.lastName},\n\nTürkiye Petrol Jeologları Derneği ailesine hoş geldiniz!\n\nÜye Numaranız: ${member.memberNo}\nÜyelik Tipiniz: ${member.membershipType}\n\nSorularınız için uye@tpjd.org.tr adresinden bize ulaşabilirsiniz.\n\nSaygılarımızla,\nTPJD Yönetimi`;

                    const channels = this.config.welcome?.channels || ['email'];
                    for (const channel of channels) {
                        if (channel === 'whatsapp') {
                            if (member.phone) {
                                let waPhone = (member.phone || '').replace(/[^0-9]/g, '');
                                if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                await processWhatsAppQueue([{
                                    number: waPhone, message, recipient_id: member.id,
                                    recipient_name: `${member.firstName} ${member.lastName}`,
                                    detail: '👋 Hoş geldin mesajı'
                                }], 'welcome');
                            }
                        } else {
                            try {
                                await fetch(`${this.apiBase}?action=send-notification`, {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ agent_name: 'welcome', channel, recipient_id: member.id, subject, message })
                                });
                                console.log(`🤖 Welcome (${channel}) sent to`, member.firstName);
                            } catch (e) { console.error(`Welcome ${channel} error:`, e); }
                        }
                    }
                }

                async runDebtReminder(tier) {
                    if (!this.config.debt_reminder?.enabled) { alert('Borç Hatırlatma agent\'ı devre dışı!'); return; }
                    const tierNames = { 1: 'Nazik Hatırlatma', 2: 'Resmi Uyarı', 3: 'Son Uyarı' };
                    if (!confirm(`Kademe ${tier} (${tierNames[tier]}) borç hatırlatması gönderilecek. Devam?`)) return;

                    try {
                        showNotification('Borçlu üyeler taranıyor...', 'info');
                        const res = await fetch(`${this.apiBase}?action=debtors&tier=${tier}`);
                        const data = await res.json();
                        if (!data.success) { alert('Hata: ' + data.message); return; }

                        const debtors = data.data?.data || [];
                        if (debtors.length === 0) { showNotification('Bu kademe için borçlu üye bulunamadı', 'warning'); return; }

                        let sent = 0;
                        const waQueue = [];
                        // IBAN bilgisi varsa mesaja ekle
                        const iban = settings?.iban_settings || {};
                        let ibanBlock = '';
                        if (iban.iban) {
                            ibanBlock = `\n\n🏦 Ödeme Bilgileri:\nBanka: ${iban.banka_adi || '-'}\nHesap Sahibi: ${iban.hesap_sahibi || '-'}\nIBAN: ${iban.iban}${iban.aciklama ? '\nAçıklama: ' + iban.aciklama : ''}`;
                        }
                        for (const debtor of debtors) {
                            const subjects = { 1: 'Aidat Hatırlatması - TPJD', 2: 'Resmi Aidat Uyarısı - TPJD', 3: 'Son Uyarı: Aidat Borcunuz - TPJD' };
                            const messages = {
                                1: `Sayın ${debtor.fullName},\n\n${debtor.debtYears} yıllarına ait toplam ₺${debtor.totalDebt} aidat borcunuz bulunmaktadır. En yakın zamanda ödemenizi yapmanızı rica ederiz.${ibanBlock}\n\nTPJD Yönetimi`,
                                2: `Sayın ${debtor.fullName},\n\nDaha önce bildirilen ₺${debtor.totalDebt} tutarındaki ${debtor.debtYears} yıllarına ait aidat borcunuz hâlâ ödenmemiştir. En kısa sürede ödeme yapmanızı önemle rica ederiz.${ibanBlock}\n\nTPJD Yönetim Kurulu`,
                                3: `Sayın ${debtor.fullName},\n\nÖdenmemiş ₺${debtor.totalDebt} aidat borcunuz (${debtor.debtYears}) için son uyarıdır. 30 gün içinde ödeme yapılmaması halinde üyelik durumunuz değerlendirmeye alınacaktır.${ibanBlock}\n\nTPJD Yönetim Kurulu`
                            };

                            // Email gönder
                            await fetch(`${this.apiBase}?action=send-notification`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ agent_name: 'debt_reminder', channel: 'email', recipient_id: debtor.memberId, subject: subjects[tier], message: messages[tier] })
                            });
                            sent++;

                            // WhatsApp kuyruğuna ekle
                            if (debtor.phone) {
                                let waPhone = debtor.phone.replace(/[^0-9]/g, '');
                                if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;

                                waQueue.push({
                                    number: waPhone,
                                    message: messages[tier],
                                    recipient_id: debtor.memberId,
                                    recipient_name: debtor.fullName,
                                    detail: `🔔 Borç hatırlatma Kademe ${tier} — ₺${debtor.totalDebt}`
                                });
                            }
                        }
                        showNotification(`Kademe ${tier}: ${sent} üyeye email gönderildi`, 'success');

                        // WhatsApp mesajlarını tarayıcıdan gönder
                        if (waQueue.length > 0) {
                            await processWhatsAppQueue(waQueue, 'debt_reminder');
                        }

                        this.loadLogs();
                        this.loadStats();
                    } catch (e) { alert('Borç hatırlatma hatası: ' + e.message); }
                }

                async runYearlyCharge() {
                    if (!this.config.yearly_charge?.enabled) { alert('Yıllık Borçlandırma agent\'ı devre dışı!'); return; }
                    const year = prompt('Borçlandırma yılını girin:', new Date().getFullYear());
                    if (!year) return;

                    try {
                        showNotification('Yıllık borçlandırma başlatılıyor...', 'info');
                        const res = await fetch(`${this.apiBase}?action=run`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ agent: 'yearly_charge', year: parseInt(year) })
                        });
                        const data = await res.json();
                        showNotification(data.message || 'Borçlandırma tamamlandı', data.success ? 'success' : 'error');
                        if (data.success) { loadAllData(); this.loadStats(); this.loadLogs(); }
                    } catch (e) { alert('Borçlandırma hatası: ' + e.message); }
                }

                async runBirthdayAgent() {
                    if (!this.config.birthday?.enabled) { alert('Doğum Günü agent\'ı devre dışı!'); return; }
                    try {
                        showNotification('Doğum günleri kontrol ediliyor...', 'info');
                        const res = await fetch(`${this.apiBase}?action=run`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ agent: 'birthday' })
                        });
                        const data = await res.json();
                        showNotification(data.message || 'Doğum günü kontrolü tamamlandı', data.success ? 'success' : 'error');

                        // WhatsApp kuyruğunu tarayıcıdan gönder
                        if (data.data?.whatsapp_queue?.length > 0) {
                            await processWhatsAppQueue(data.data.whatsapp_queue, 'birthday');
                        }

                        this.loadLogs();
                    } catch (e) { alert('Doğum günü agent hatası: ' + e.message); }
                }

                async runSeniorityAgent() {
                    if (!this.config.seniority_promotion?.enabled) { alert('Kıdem Terfi agent\'ı devre dışı!'); return; }
                    try {
                        showNotification('🏅 Kıdem terfi adayları kontrol ediliyor...', 'info');

                        // 1. Terfi adaylarını kontrol et
                        const checkRes = await fetch(`${this.apiBase}?action=seniority_check`);
                        const checkData = await checkRes.json();

                        if (!checkData.success || !checkData.data?.candidates?.length) {
                            showNotification('Terfi edilecek üye bulunamadı (20+ yıl kıdem gerekli)', 'info');
                            return;
                        }

                        const candidates = checkData.data.candidates;
                        if (!confirm(`${candidates.length} üye terfi için uygun:\n\n${candidates.map(c => `• ${c.fullName} (${c.years} yıl)`).join('\n')}\n\nTerfi edilsin mi?`)) {
                            return;
                        }

                        // 2. Terfi işlemini çalıştır
                        const promoRes = await fetch(`${this.apiBase}?action=seniority_promote`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ candidates: candidates.map(c => c.id) })
                        });
                        const promoData = await promoRes.json();

                        if (promoData.success) {
                            const promoted = promoData.data?.promoted || [];
                            showNotification(`🏅 ${promoted.length} üye onursal üyeliğe terfi edildi!`, 'success');

                            // WhatsApp bildirimlerini gönder
                            if (promoData.data?.whatsapp_queue?.length > 0) {
                                await processWhatsAppQueue(promoData.data.whatsapp_queue, 'seniority_promotion');
                            }
                        } else {
                            showNotification('Terfi işlemi başarısız: ' + (promoData.message || 'Bilinmeyen hata'), 'error');
                        }

                        this.loadLogs();
                        this.loadStats();
                    } catch (e) { alert('Kıdem terfi agent hatası: ' + e.message); }
                }
            }

            const agentManager = new AgentManager();

            // ─── WhatsApp (Evolution API) Settings ─────────────────
            let whatsappSettings = { api_url: '', api_key: '', instance_name: 'tpjd' };

            // ═══════════════════════════════════════════════════════
            // WhatsApp Lokal Sunucu (localhost:3456) 
            // ═══════════════════════════════════════════════════════
            const WA_SERVER = 'http://localhost:3456';

            async function loadWhatsAppSettings() {
                // Lokal sunucu durumunu kontrol et (Evolution API ayarları artık gerekli değil)
                await checkWhatsAppStatus();
            }

            async function saveWhatsAppSettings() {
                // Lokal sunucu — kayıt gerektirmiyor
                showNotification('WhatsApp lokal sunucu kullanılıyor. Ayar kaydetmeye gerek yok.', 'info');
            }

            async function checkWhatsAppStatus() {
                const card = document.getElementById('waStatusCard');
                const badge = document.getElementById('waStatusBadge');
                const text = document.getElementById('waStatusText');
                if (!card || !badge || !text) return;

                try {
                    const res = await fetch(`${WA_SERVER}/status`, { signal: AbortSignal.timeout(3000) });
                    const data = await res.json();

                    if (data.status === 'connected' && data.ready) {
                        card.style.borderLeftColor = '#27ae60';
                        badge.style.background = 'rgba(39,174,96,0.15)';
                        badge.style.color = '#27ae60';
                        badge.textContent = '✅ Bağlı';
                        text.style.color = '#27ae60';
                        text.textContent = `WhatsApp bağlı — ${data.phone || 'hazır'}`;
                    } else if (data.status === 'qr_waiting') {
                        card.style.borderLeftColor = '#f39c12';
                        badge.style.background = 'rgba(243,156,18,0.15)';
                        badge.style.color = '#f39c12';
                        badge.textContent = '⏳ QR Bekleniyor';
                        text.style.color = '#f39c12';
                        text.textContent = 'QR kodu okutulması bekleniyor...';
                    } else {
                        card.style.borderLeftColor = '#e67e22';
                        badge.style.background = 'rgba(230,126,34,0.15)';
                        badge.style.color = '#e67e22';
                        badge.textContent = '⚠️ Bağlanıyor';
                        text.style.color = '#e67e22';
                        text.textContent = `Durum: ${data.status || 'bilinmiyor'}`;
                    }
                } catch (e) {
                    card.style.borderLeftColor = '#e74c3c';
                    badge.style.background = 'rgba(231,76,60,0.15)';
                    badge.style.color = '#e74c3c';
                    badge.textContent = '❌ Kapalı';
                    text.style.color = '#e74c3c';
                    text.textContent = 'Sunucu kapalı — TPJD_WHATSAPP.bat çalıştırın';
                }
            }

            async function showWhatsAppQR(retryCount = 0) {
                const modal = document.getElementById('waQRModal');
                const content = document.getElementById('waQRContent');
                modal.classList.add('active');

                if (retryCount === 0) {
                    content.innerHTML = '<div style="margin:20px auto;text-align:center;"><div style="width:40px;height:40px;border:3px solid #25D366;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div><p style="color:#555;">WhatsApp sunucusu kontrol ediliyor...</p></div>';
                }

                try {
                    // 1. Sunucu çalışıyor mu kontrol et
                    const statusRes = await fetch(`${WA_SERVER}/status`, { signal: AbortSignal.timeout(3000) }).catch(() => null);

                    if (!statusRes || !statusRes.ok) {
                        // Sunucu kapalı — PHP ile otomatik başlat
                        content.innerHTML = `<div style="text-align:center;margin:20px auto;">
                            <div style="width:40px;height:40px;border:3px solid #25D366;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                            <p style="color:#f39c12;font-weight:bold;">🚀 WhatsApp sunucusu başlatılıyor...</p>
                            <p style="color:#999;font-size:13px;">Deneme ${retryCount + 1}/5 — lütfen bekleyin</p>
                        </div>`;

                        // PHP ile sunucuyu başlat
                        try {
                            await fetch(`${API_BASE}/whatsapp_control.php?action=start`, { signal: AbortSignal.timeout(25000) });
                        } catch (phpErr) {
                            console.warn('PHP start call error:', phpErr);
                        }

                        if (retryCount < 5) {
                            setTimeout(() => showWhatsAppQR(retryCount + 1), 6000);
                            return;
                        } else {
                            // 5 deneme sonrası hala açılamadı
                            content.innerHTML = `
                                <div style="text-align:center;padding:20px;">
                                    <p style="color:#e74c3c;font-size:48px;margin:0;">🔌</p>
                                    <p style="color:#e74c3c;font-size:18px;font-weight:bold;margin:10px 0;">Sunucu Başlatılamadı</p>
                                    <p style="color:#555;font-size:13px;line-height:1.8;">Node.js veya WhatsApp sunucu dosyaları bulunamadı.<br>Lütfen Node.js'in yüklü olduğundan emin olun.</p>
                                    <button onclick="showWhatsAppQR(0)" style="margin-top:15px;padding:10px 24px;background:#25D366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">🔄 Tekrar Dene</button>
                                </div>`;
                            return;
                        }
                    }

                    // 2. Sunucu çalışıyor — durumu kontrol et
                    const statusData = await statusRes.json();

                    if (statusData.authenticated || statusData.status === 'connected') {
                        // Zaten bağlı
                        content.innerHTML = `
                            <div style="text-align:center;padding:20px;">
                                <p style="color:#25D366;font-size:48px;margin:0;">✅</p>
                                <p style="color:#27ae60;font-size:18px;font-weight:bold;margin:10px 0;">WhatsApp Bağlı!</p>
                                <p style="color:#555;">Oturum aktif, QR taratmaya gerek yok.</p>
                                ${statusData.info?.pushname ? '<p style="color:#999;font-size:13px;">👤 ' + statusData.info.pushname + '</p>' : ''}
                            </div>`;
                        checkWhatsAppStatus();
                        return;
                    }

                    // 3. Sunucu çalışıyor ama bağlı değil — QR al
                    const qrRes = await fetch(`${WA_SERVER}/qr`, { signal: AbortSignal.timeout(10000) });
                    const qrData = await qrRes.json();

                    if (qrData.qr) {
                        content.innerHTML = `
                            <div style="text-align:center;padding:10px;">
                                <img src="${qrData.qr}" style="max-width:280px;border-radius:12px;border:2px solid #eee;box-shadow:0 4px 20px rgba(0,0,0,0.1);" alt="WhatsApp QR">
                                <p style="color:#25D366;margin-top:15px;font-weight:700;font-size:15px;">📱 Telefonla bu QR'ı taratın</p>
                                <p style="color:#999;font-size:12px;">WhatsApp → Bağlı Cihazlar → Cihaz Bağla</p>
                            </div>`;
                        setTimeout(() => checkWhatsAppStatus(), 15000);

                    } else if (qrData.authenticated) {
                        content.innerHTML = `
                            <div style="text-align:center;padding:20px;">
                                <p style="color:#25D366;font-size:48px;margin:0;">✅</p>
                                <p style="color:#27ae60;font-size:18px;font-weight:bold;margin:10px 0;">WhatsApp Bağlı!</p>
                                <p style="color:#555;">Oturum aktif, QR taratmaya gerek yok.</p>
                            </div>`;
                        checkWhatsAppStatus();

                    } else {
                        // QR henüz üretilmedi — retry
                        if (retryCount < 5) {
                            content.innerHTML = `<div style="text-align:center;margin:20px auto;">
                                <div style="width:40px;height:40px;border:3px solid #25D366;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                                <p style="color:#f39c12;font-weight:bold;">⏳ QR kodu oluşturuluyor...</p>
                                <p style="color:#999;font-size:13px;">Deneme ${retryCount + 1}/5 — 6 saniye bekleniyor</p>
                            </div>`;
                            setTimeout(() => showWhatsAppQR(retryCount + 1), 6000);
                        } else {
                            content.innerHTML = `
                                <div style="text-align:center;padding:20px;">
                                    <p style="color:#e74c3c;font-size:16px;font-weight:bold;">⚠️ QR kodu üretilemedi</p>
                                    <p style="color:#555;font-size:13px;margin:10px 0;">Sunucu çalışıyor ama QR kodu oluşturulamadı.</p>
                                    <button onclick="showWhatsAppQR(0)" style="margin-top:12px;padding:10px 24px;background:#25D366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">🔄 Tekrar Dene</button>
                                </div>`;
                        }
                    }
                } catch (e) {
                    console.error('showWhatsAppQR error:', e);
                    // Beklenmeyen hata — PHP ile başlatmayı dene
                    if (retryCount < 5) {
                        content.innerHTML = `<div style="text-align:center;margin:20px auto;">
                            <div style="width:40px;height:40px;border:3px solid #25D366;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                            <p style="color:#f39c12;font-weight:bold;">🚀 Sunucu başlatılıyor...</p>
                            <p style="color:#999;font-size:13px;">Deneme ${retryCount + 1}/5</p>
                        </div>`;
                        fetch(`${API_BASE}/whatsapp_control.php?action=start`).catch(() => { });
                        setTimeout(() => showWhatsAppQR(retryCount + 1), 6000);
                    } else {
                        content.innerHTML = `
                            <div style="text-align:center;padding:20px;">
                                <p style="color:#e74c3c;font-size:48px;margin:0;">🔌</p>
                                <p style="color:#e74c3c;font-size:18px;font-weight:bold;margin:10px 0;">Sunucu Başlatılamadı</p>
                                <p style="color:#555;font-size:13px;">WhatsApp sunucusu başlatılamadı. Node.js yüklü olduğundan emin olun.</p>
                                <button onclick="showWhatsAppQR(0)" style="margin-top:15px;padding:10px 24px;background:#25D366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">🔄 Tekrar Dene</button>
                            </div>`;
                    }
                }
            }


            // ═══════════════════════════════════════════════════════
            // WhatsApp Kuyruk İşleyici — Agent response'tan gelen mesajları gönder
            // ═══════════════════════════════════════════════════════
            async function processWhatsAppQueue(queue, agentName) {
                if (!queue || queue.length === 0) return;

                let sent = 0, failed = 0;
                showNotification(`📱 ${queue.length} WhatsApp mesajı gönderiliyor...`, 'info');

                for (const item of queue) {
                    try {
                        const res = await fetch(`${WA_SERVER}/send`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ number: item.number, message: item.message }),
                            signal: AbortSignal.timeout(15000)
                        });
                        const data = await res.json();

                        if (data.success) {
                            sent++;
                            // Log'u PHP'ye kaydet
                            try {
                                await fetch(`${API_BASE}/agents.php?action=log_whatsapp`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        agent_name: agentName,
                                        recipient_id: item.recipient_id || '',
                                        recipient_name: item.recipient_name || '',
                                        detail: item.detail || 'WhatsApp mesajı gönderildi',
                                        status: 'success'
                                    })
                                });
                            } catch (logErr) { console.warn('WA log kayıt hatası:', logErr); }
                        } else {
                            failed++;
                        }
                    } catch (e) {
                        failed++;
                        console.warn('WA gönderim hatası:', e);
                    }

                    // Spam engeli: mesajlar arası 1sn bekle
                    if (queue.indexOf(item) < queue.length - 1) {
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                if (sent > 0) showNotification(`✅ ${sent} WhatsApp mesajı gönderildi!`, 'success');
                if (failed > 0) showNotification(`⚠️ ${failed} mesaj gönderilemedi (WhatsApp kapalı olabilir)`, 'warning');
            }

            // Eski Evolution API fonksiyonları (uyumluluk)
            function testEvolutionConnection() { checkWhatsAppStatus(); }
            function showEvolutionQR() { showWhatsAppQR(); }

            // ═══════════════════════════════════════════════════════
            // Auto-Run Agents — Sayfa açılışında günde 1 kez çalıştır
            // ═══════════════════════════════════════════════════════
            async function autoRunAgents() {
                try {
                    // 1. Backend'den hangi agent'ların bugün çalışması gerektiğini sor
                    const res = await fetch(`${API_BASE}/agents.php?action=cron_check`);
                    const data = await res.json();
                    if (!data.success || !data.data) return;

                    const status = data.data;
                    const agentLabels = {
                        birthday: '🎂 Doğum Günü',
                        debt_reminder: '🔔 Borç Hatırlatma',
                        monthly_report: '📊 Aylık Rapor',
                        seniority_promotion: '🏅 Kıdem Terfi'
                    };
                    let ranAgents = [];

                    // 2. Birthday Agent — her gün
                    if (status.birthday?.should_run && agentManager.config.birthday?.enabled !== false) {
                        try {
                            const bRes = await fetch(`${agentManager.apiBase}?action=run`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ agent: 'birthday' })
                            });
                            const bData = await bRes.json();
                            // WhatsApp kuyruğunu tarayıcıdan gönder
                            if (bData.data?.whatsapp_queue?.length > 0) {
                                await processWhatsAppQueue(bData.data.whatsapp_queue, 'birthday');
                            }
                            ranAgents.push(agentLabels.birthday);
                            console.log('🤖 Auto-run: Birthday agent çalıştırıldı');
                        } catch (e) { console.warn('Auto-run birthday error:', e); }
                    }

                    // 3. Debt Reminder — 3 Kademeli Otomatik Eskalasyon
                    if (status.debt_reminder?.should_run && agentManager.config.debt_reminder?.enabled !== false) {
                        try {
                            const escalation = status.debt_reminder.escalation || {};
                            const tierSubjects = {
                                1: 'Aidat Hatırlatması - TPJD',
                                2: 'Resmi Aidat Uyarısı - TPJD',
                                3: 'Son Uyarı: Aidat Borcunuz - TPJD'
                            };
                            const tierLabels = { 1: 'Nazik', 2: 'Resmi', 3: 'Son Uyarı' };
                            let totalSent = 0;
                            let tierDetails = [];

                            for (let tier = 1; tier <= 3; tier++) {
                                const tierKey = `tier_${tier}`;
                                const eligible = escalation[tierKey]?.eligible || 0;
                                if (eligible === 0) continue;

                                // Bu kademe için borçlu listesini al
                                const debtRes = await fetch(`${agentManager.apiBase}?action=debtors&tier=${tier}`);
                                const debtData = await debtRes.json();
                                const debtorsList = debtData.data?.data || [];

                                const waQueue = [];
                                // IBAN bilgisi varsa mesaja ekle
                                const iban = settings?.iban_settings || {};
                                let ibanBlock = '';
                                if (iban.iban) {
                                    ibanBlock = `\n\n🏦 Ödeme Bilgileri:\nBanka: ${iban.banka_adi || '-'}\nHesap Sahibi: ${iban.hesap_sahibi || '-'}\nIBAN: ${iban.iban}${iban.aciklama ? '\nAçıklama: ' + iban.aciklama : ''}`;
                                }
                                for (const debtor of debtorsList) {
                                    const messages = {
                                        1: `Sayın ${debtor.fullName},\n\n${debtor.debtYears} yıllarına ait toplam ₺${debtor.totalDebt} aidat borcunuz bulunmaktadır. En yakın zamanda ödemenizi yapmanızı rica ederiz.${ibanBlock}\n\nTPJD Yönetimi`,
                                        2: `Sayın ${debtor.fullName},\n\nDaha önce bildirilen ₺${debtor.totalDebt} tutarındaki ${debtor.debtYears} yıllarına ait aidat borcunuz hâlâ ödenmemiştir. En kısa sürede ödeme yapmanızı önemle rica ederiz.${ibanBlock}\n\nTPJD Yönetim Kurulu`,
                                        3: `Sayın ${debtor.fullName},\n\nÖdenmemiş ₺${debtor.totalDebt} aidat borcunuz (${debtor.debtYears}) için son uyarıdır. 30 gün içinde ödeme yapılmaması halinde üyelik durumunuz değerlendirmeye alınacaktır.${ibanBlock}\n\nTPJD Yönetim Kurulu`
                                    };

                                    // Email gönder
                                    await fetch(`${agentManager.apiBase}?action=send-notification`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            agent_name: 'debt_reminder',
                                            channel: 'email',
                                            recipient_id: debtor.memberId,
                                            subject: tierSubjects[tier],
                                            message: messages[tier]
                                        })
                                    });
                                    totalSent++;

                                    // WhatsApp kuyruğuna ekle
                                    if (debtor.phone) {
                                        let waPhone = debtor.phone.replace(/[^0-9]/g, '');
                                        if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                        else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                        waQueue.push({
                                            number: waPhone, message: messages[tier],
                                            recipient_id: debtor.memberId,
                                            recipient_name: debtor.fullName,
                                            detail: `🔔 Borç hatırlatma Kademe ${tier} — ₺${debtor.totalDebt}`
                                        });
                                    }
                                }

                                // WhatsApp kuyruğunu gönder
                                if (waQueue.length > 0) {
                                    await processWhatsAppQueue(waQueue, 'debt_reminder');
                                }

                                if (debtorsList.length > 0) {
                                    tierDetails.push(`K${tier}:${debtorsList.length}`);
                                }
                            }

                            if (totalSent > 0) {
                                ranAgents.push(`🔔 Borç Hatırlatma (${tierDetails.join(', ')} — ${totalSent} üye)`);
                            }
                            console.log('🤖 Auto-run: Debt reminder (3 kademe) çalıştırıldı');
                        } catch (e) { console.warn('Auto-run debt_reminder error:', e); }
                    }

                    // 4. Monthly Report — sadece ayın 1'inde
                    if (status.monthly_report?.should_run && agentManager.config.monthly_report?.enabled !== false) {
                        try {
                            await fetch(`${agentManager.apiBase}?action=run`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ agent: 'monthly_report' })
                            });
                            ranAgents.push(agentLabels.monthly_report);
                            console.log('🤖 Auto-run: Monthly report çalıştırıldı');
                        } catch (e) { console.warn('Auto-run monthly_report error:', e); }
                    }

                    // 5. Seniority Promotion — 20+ yıllık üyeleri otomatik terfi et
                    if (status.seniority_promotion?.should_run) {
                        try {
                            // Terfi adaylarını al
                            const spRes = await fetch(`${agentManager.apiBase}?action=seniority_check`);
                            const spData = await spRes.json();
                            const eligible = spData.data?.eligible || [];

                            if (eligible.length > 0) {
                                // Terfi işlemini çalıştır
                                const promoRes = await fetch(`${agentManager.apiBase}?action=seniority_promote`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ promotions: eligible })
                                });
                                const promoData = await promoRes.json();

                                if (promoData.success) {
                                    const promoted = promoData.data?.promoted || [];
                                    const waQueue = [];

                                    for (const member of promoted) {
                                        // Üyeye e-posta gönder
                                        const emailMsg = `Sayın ${member.fullName},\n\nTürkiye Petrol Jeologları Derneği'ne 20 yılı aşkın süre üyeliğiniz nedeniyle, üyelik tipiniz "${member.oldType}" → "${member.newType}" olarak güncellenmiştir.\n\nBundan sonra yıllık aidat ödemesinden muaf tutulacaksınız.\n\nDeğerli katkılarınız için teşekkür eder, iyi dileklerimizi sunarız.\n\nTPJD Yönetim Kurulu`;
                                        await fetch(`${agentManager.apiBase}?action=send-notification`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                agent_name: 'seniority_promotion',
                                                channel: 'email',
                                                recipient_id: member.id,
                                                subject: 'Tebrikler! Onursal Üyelik Terfiniz — TPJD',
                                                message: emailMsg
                                            })
                                        });

                                        // WhatsApp kuyruğuna ekle
                                        const origMember = eligible.find(e => e.id === member.id);
                                        if (origMember?.phone) {
                                            let waPhone = origMember.phone.replace(/[^0-9]/g, '');
                                            if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                            else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                            waQueue.push({
                                                number: waPhone,
                                                message: `🏅 Sayın ${member.fullName},\n\nTebrikler! TPJD'ye 20+ yıllık üyeliğiniz nedeniyle "${member.newType}" statüsüne terfi ettiniz. Artık yıllık aidattan muafsınız.\n\n🎉 TPJD Yönetimi`,
                                                recipient_id: member.id,
                                                recipient_name: member.fullName,
                                                detail: `🏅 Kıdem terfi: ${member.oldType} → ${member.newType}`
                                            });
                                        }
                                    }

                                    // WhatsApp gönder
                                    if (waQueue.length > 0) {
                                        await processWhatsAppQueue(waQueue, 'seniority_promotion');
                                    }

                                    ranAgents.push(`🏅 Kıdem Terfi (${promoted.length} üye terfi edildi)`);
                                }
                                console.log('🤖 Auto-run: Seniority promotion çalıştırıldı');
                            }
                        } catch (e) { console.warn('Auto-run seniority_promotion error:', e); }
                    }

                    // 6. Özel Gün Kutlama Agentı — Kadınlar G., Anneler G., Bayramlar vs.
                    if (agentManager.config.special_day_greeting?.enabled !== false) {
                        try {
                            const today = new Date();
                            const mm = today.getMonth(); // 0-indexed
                            const dd = today.getDate();
                            const yy = today.getFullYear();
                            const todayKey = `${yy}-${mm}-${dd}`;

                            // Bugün gönderilmiş mi kontrol
                            const sentKey = 'tpjd_special_day_sent';
                            const lastSent = localStorage.getItem(sentKey);
                            if (lastSent === todayKey) {
                                console.log('🎁 Özel gün kutlaması bugün zaten gönderilmiş');
                            } else {
                                // Sabit özel günler
                                const specialDays = [
                                    {
                                        month: 0, day: 1, name: 'Yılbaşı', filter: 'all', emoji: '🎉',
                                        message: (name) => `🎉 Sayın ${name},\n\nYeni yılınız kutlu olsun! Sağlık, mutluluk ve başarı dolu bir yıl diliyoruz.\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 2, day: 8, name: 'Dünya Kadınlar Günü', filter: 'female', emoji: '🌸',
                                        message: (name) => `🌸 Sayın ${name},\n\n8 Mart Dünya Kadınlar Gününüz kutlu olsun! Değerli katkılarınız için teşekkür ederiz.\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 3, day: 23, name: '23 Nisan', filter: 'all', emoji: '🇹🇷',
                                        message: (name) => `🇹🇷 Sayın ${name},\n\n23 Nisan Ulusal Egemenlik ve Çocuk Bayramınız kutlu olsun!\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 4, day: 1, name: '1 Mayıs', filter: 'all', emoji: '✊',
                                        message: (name) => `✊ Sayın ${name},\n\n1 Mayıs Emek ve Dayanışma Gününüz kutlu olsun!\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 4, day: 11, name: 'Anneler Günü', filter: 'female', emoji: '💐',
                                        message: (name) => `💐 Sayın ${name},\n\nAnneler Gününüz kutlu olsun! Sevgi ve saygılarımızla.\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 4, day: 19, name: '19 Mayıs', filter: 'all', emoji: '🇹🇷',
                                        message: (name) => `🇹🇷 Sayın ${name},\n\n19 Mayıs Atatürk'ü Anma, Gençlik ve Spor Bayramınız kutlu olsun!\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 5, day: 15, name: 'Babalar Günü', filter: 'male', emoji: '👔',
                                        message: (name) => `👔 Sayın ${name},\n\nBabalar Gününüz kutlu olsun! Sağlıklı ve mutlu yıllar diliyoruz.\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 6, day: 15, name: '15 Temmuz', filter: 'all', emoji: '🇹🇷',
                                        message: (name) => `🇹🇷 Sayın ${name},\n\n15 Temmuz Demokrasi ve Millî Birlik Günü. Şehitlerimizi saygıyla anıyoruz.\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 7, day: 30, name: 'Zafer Bayramı', filter: 'all', emoji: '🇹🇷',
                                        message: (name) => `🇹🇷 Sayın ${name},\n\n30 Ağustos Zafer Bayramınız kutlu olsun!\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 9, day: 29, name: 'Cumhuriyet Bayramı', filter: 'all', emoji: '🇹🇷',
                                        message: (name) => `🇹🇷 Sayın ${name},\n\n29 Ekim Cumhuriyet Bayramınız kutlu olsun! Yaşasın Cumhuriyet!\n\nTPJD Yönetimi`
                                    },
                                    {
                                        month: 10, day: 24, name: 'Öğretmenler Günü', filter: 'all', emoji: '🍎',
                                        message: (name) => `🍎 Sayın ${name},\n\n24 Kasım Öğretmenler Gününüz kutlu olsun!\n\nTPJD Yönetimi`
                                    },
                                ];

                                // Dini bayramlar
                                const religiousToday = {
                                    2025: [
                                        { m: 2, d: 30, name: 'Ramazan Bayramı' }, { m: 2, d: 31, name: 'Ramazan Bayramı' }, { m: 3, d: 1, name: 'Ramazan Bayramı' },
                                        { m: 5, d: 6, name: 'Kurban Bayramı' }, { m: 5, d: 7, name: 'Kurban Bayramı' }, { m: 5, d: 8, name: 'Kurban Bayramı' }, { m: 5, d: 9, name: 'Kurban Bayramı' }
                                    ],
                                    2026: [
                                        { m: 2, d: 20, name: 'Ramazan Bayramı' }, { m: 2, d: 21, name: 'Ramazan Bayramı' }, { m: 2, d: 22, name: 'Ramazan Bayramı' },
                                        { m: 4, d: 27, name: 'Kurban Bayramı' }, { m: 4, d: 28, name: 'Kurban Bayramı' }, { m: 4, d: 29, name: 'Kurban Bayramı' }, { m: 4, d: 30, name: 'Kurban Bayramı' }
                                    ],
                                    2027: [
                                        { m: 2, d: 10, name: 'Ramazan Bayramı' }, { m: 2, d: 11, name: 'Ramazan Bayramı' }, { m: 2, d: 12, name: 'Ramazan Bayramı' },
                                        { m: 4, d: 16, name: 'Kurban Bayramı' }, { m: 4, d: 17, name: 'Kurban Bayramı' }, { m: 4, d: 18, name: 'Kurban Bayramı' }, { m: 4, d: 19, name: 'Kurban Bayramı' }
                                    ]
                                };

                                // Bugün özel gün mü kontrol et
                                let todayHoliday = specialDays.find(s => s.month === mm && s.day === dd);

                                // Dini bayram kontrolü
                                if (!todayHoliday && religiousToday[yy]) {
                                    const rel = religiousToday[yy].find(r => r.m === mm && r.d === dd);
                                    if (rel) {
                                        const isRamazan = rel.name.includes('Ramazan');
                                        todayHoliday = {
                                            name: rel.name, filter: 'all',
                                            emoji: isRamazan ? '🌙' : '🕌',
                                            message: (name) => isRamazan
                                                ? `🌙 Sayın ${name},\n\nRamazan Bayramınız mübarek olsun! Sağlık ve huzur dolu nice bayramlar diliyoruz.\n\nTPJD Yönetimi`
                                                : `🕌 Sayın ${name},\n\nKurban Bayramınız mübarek olsun! Sağlık ve mutluluk dolu nice bayramlar diliyoruz.\n\nTPJD Yönetimi`
                                        };
                                    }
                                }

                                if (todayHoliday) {
                                    console.log(`🎁 Özel gün tespit edildi: ${todayHoliday.name}`);

                                    // Üyeleri filtrele
                                    let targetMembers = members.filter(m => m.membershipStatus === 'aktif');
                                    if (todayHoliday.filter === 'female') {
                                        targetMembers = targetMembers.filter(m => m.gender === 'Kadın');
                                    } else if (todayHoliday.filter === 'male') {
                                        targetMembers = targetMembers.filter(m => m.gender === 'Erkek');
                                    }

                                    if (targetMembers.length > 0) {
                                        const waQueue = [];

                                        for (const m of targetMembers) {
                                            const fullName = `${m.firstName} ${m.lastName}`;
                                            const msgText = todayHoliday.message(fullName);

                                            // Email gönder
                                            if (m.email) {
                                                try {
                                                    await fetch(`${agentManager.apiBase}?action=send-notification`, {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({
                                                            agent_name: 'special_day_greeting',
                                                            channel: 'email',
                                                            recipient_id: m.id,
                                                            subject: `${todayHoliday.emoji} ${todayHoliday.name} Kutlu Olsun! — TPJD`,
                                                            message: msgText
                                                        })
                                                    });
                                                } catch (emailErr) { console.warn('Special day email error:', emailErr); }
                                            }

                                            // WhatsApp kuyruğuna ekle
                                            if (m.phone) {
                                                let waPhone = m.phone.replace(/[^0-9]/g, '');
                                                if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                                else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                                waQueue.push({
                                                    number: waPhone,
                                                    message: msgText,
                                                    recipient_id: m.id,
                                                    recipient_name: fullName,
                                                    detail: `${todayHoliday.emoji} ${todayHoliday.name} kutlaması`
                                                });
                                            }
                                        }

                                        // WhatsApp gönder
                                        if (waQueue.length > 0) {
                                            await processWhatsAppQueue(waQueue, 'special_day_greeting');
                                        }

                                        // Bildirim kaydı oluştur
                                        try {
                                            await fetch(`${API_BASE}/notifications.php?action=create`, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                    title: `${todayHoliday.emoji} ${todayHoliday.name} Kutlaması`,
                                                    message: `${targetMembers.length} üyeye otomatik kutlama mesajı gönderildi`,
                                                    type: 'kutlama',
                                                    priority: 'normal',
                                                    memberId: 'system',
                                                    recipients: targetMembers.map(m => ({ id: m.id, name: `${m.firstName} ${m.lastName}` })),
                                                    recipientGroup: todayHoliday.filter === 'female' ? 'Kadın Üyeler' : todayHoliday.filter === 'male' ? 'Erkek Üyeler' : 'Tüm Aktif Üyeler',
                                                    sentAt: new Date().toISOString(),
                                                    channels: 'WhatsApp, Email'
                                                })
                                            });
                                        } catch (notifErr) { console.warn('Special day notification save error:', notifErr); }

                                        localStorage.setItem(sentKey, todayKey);
                                        ranAgents.push(`${todayHoliday.emoji} ${todayHoliday.name} (${targetMembers.length} üyeye gönderildi)`);
                                        console.log(`🤖 Auto-run: ${todayHoliday.name} kutlaması ${targetMembers.length} üyeye gönderildi`);
                                    }
                                }
                            }
                        } catch (e) { console.warn('Auto-run special_day_greeting error:', e); }
                    }

                    // 6. Sonuç bildirimi
                    // 6. Yearly Charge Agent - her yil 1 kez
                    if (status.yearly_charge?.should_run && agentManager.config.yearly_charge?.enabled !== false) {
                        try {
                            await fetch(`${agentManager.apiBase}?action=run`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ agent: 'yearly_charge', year: new Date().getFullYear(), internal: true })
                            });
                            ranAgents.push('💰 Yıllık Borçlandırma');
                        } catch (e) {
                            console.error('Yearly charge auto-run error:', e);
                        }
                    }\n\n                    if (ranAgents.length > 0) {
                        showNotification(`🤖 Otomatik çalıştırıldı: ${ranAgents.join(', ')}`, 'success');
                        // Agent stats & logs'u yenile
                        await agentManager.loadStats();
                        await agentManager.loadLogs();
                    } else {
                        console.log('🤖 Auto-run: Tüm agent\'lar bugün zaten çalışmış');
                    }
                } catch (e) {
                    console.warn('Auto-run agents check failed:', e);
                }
            }

            // ═══════════════════════════════════════════════════════
            // CANLI SAAT
            // ═══════════════════════════════════════════════════════
            const TR_MONTHS = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            const TR_DAYS = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];

            function startLiveClock() {
                function tick() {
                    const now = new Date();
                    const dateEl = document.getElementById('liveDate');
                    const clockEl = document.getElementById('liveClock');
                    if (dateEl) dateEl.textContent = `📅 ${now.getDate()} ${TR_MONTHS[now.getMonth()]} ${now.getFullYear()}, ${TR_DAYS[now.getDay()]}`;
                    if (clockEl) clockEl.textContent = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }
                tick();
                setInterval(tick, 1000);
            }

            // ═══════════════════════════════════════════════════════
            // İNTERAKTİF TAKVİM
            // ═══════════════════════════════════════════════════════
            let calendarYear = new Date().getFullYear();
            let calendarMonth = new Date().getMonth();

            function calendarPrevMonth() {
                calendarMonth--;
                if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
                renderCalendar();
            }
            function calendarNextMonth() {
                calendarMonth++;
                if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
                renderCalendar();
            }

            function getCalendarEvents(year, month) {
                // Agent loglarından ve ödemelerden etkinlikleri çek
                const events = {};
                const key = (d) => `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                // 1. Ödemeler
                payments.forEach(p => {
                    if (!p.date) return;
                    const d = new Date(p.date);
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        const day = d.getDate();
                        if (!events[day]) events[day] = [];
                        const m = members.find(x => x.id === p.memberId);
                        const name = m ? `${m.firstName} ${m.lastName}` : 'Bilinmeyen';
                        events[day].push({ icon: p.status === 'tamamlandı' ? '💰' : '⏳', text: `${name} — ₺${p.amount} ${p.type}`, type: 'payment' });
                    }
                });

                // 2. Bildirimler (zenginleştirilmiş)
                (notifications || []).forEach(n => {
                    if (!n.sentAt) return;
                    const d = new Date(n.sentAt);
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        const day = d.getDate();
                        if (!events[day]) events[day] = [];
                        let channel = '';
                        if (n.channels) {
                            channel = ` [${n.channels}]`;
                        }
                        let recipientInfo = '';
                        if (n.recipientGroup) {
                            recipientInfo = ` → ${n.recipientGroup}`;
                        } else if (n.memberName) {
                            recipientInfo = ` → ${n.memberName}`;
                        }
                        events[day].push({ icon: '📢', text: (n.title || 'Bildirim') + channel + recipientInfo, type: 'notification' });
                    }
                });

                // 3. Doğum günleri (bu ayda)
                members.forEach(m => {
                    if (!m.birthDate) return;
                    const bd = new Date(m.birthDate);
                    if (bd.getMonth() === month) {
                        const day = bd.getDate();
                        if (!events[day]) events[day] = [];
                        events[day].push({ icon: '🎂', text: `${m.firstName} ${m.lastName} doğum günü`, type: 'birthday' });
                    }
                });

                // 4. Agent logları (localStorage)
                try {
                    const logs = JSON.parse(localStorage.getItem('tpjd_agent_logs') || '[]');
                    logs.forEach(log => {
                        if (!log.timestamp) return;
                        const d = new Date(log.timestamp);
                        if (d.getFullYear() === year && d.getMonth() === month) {
                            const day = d.getDate();
                            if (!events[day]) events[day] = [];
                            events[day].push({ icon: '🤖', text: log.agent + ': ' + (log.result || 'çalıştı'), type: 'agent' });
                        }
                    });
                } catch (e) { }

                // 5. Kullanıcı notları ve etkinlikleri (localStorage)
                try {
                    const calItems = JSON.parse(localStorage.getItem('tpjd_calendar_items') || '[]');
                    let noteIdx = 0, eventIdx = 0;
                    calItems.forEach(item => {
                        if (!item.date) return;
                        const [y, m, d] = item.date.split('-').map(Number);
                        if (y === year && (m - 1) === month) {
                            if (!events[d]) events[d] = [];
                            if (item.type === 'note') {
                                events[d].push({ icon: '📝', text: item.text, type: 'note', itemIndex: noteIdx++ });
                            } else if (item.type === 'event') {
                                const timeStr = item.time ? `${item.time} ` : '';
                                const locStr = item.location ? ` 📍${item.location}` : '';
                                events[d].push({ icon: '📅', text: `${timeStr}${item.title}${locStr}`, type: 'event', itemIndex: eventIdx++ });
                            }
                        }
                    });
                } catch (e) { }

                // 6. Borç vade tarihleri (Ocak ayı için)
                if (month === 0) { // Ocak
                    const debtorCount = members.filter(m => m.aidatAktif !== false && m.membershipStatus === 'aktif').length;
                    if (debtorCount > 0) {
                        if (!events[1]) events[1] = [];
                        events[1].push({ icon: '💳', text: `Yıllık aidat vadesi başlangıcı (${debtorCount} üye)`, type: 'debt_due' });
                    }
                }

                // 7. Türk resmi tatilleri ve özel günler
                const turkishHolidays = [
                    { month: 0, day: 1, text: 'Yılbaşı 🎉' },
                    { month: 2, day: 8, text: 'Dünya Kadınlar Günü 🌸' },
                    { month: 2, day: 18, text: 'Çanakkale Zaferi 🇹🇷' },
                    { month: 3, day: 23, text: 'Ulusal Egemenlik ve Çocuk Bayramı 🇹🇷' },
                    { month: 4, day: 1, text: 'Emek ve Dayanışma Günü ✊' },
                    { month: 4, day: 11, text: 'Anneler Günü 💐', floating: true }, // 2. pazar — yaklaşık
                    { month: 4, day: 19, text: 'Atatürk’ü Anma, Gençlik ve Spor Bayramı 🇹🇷' },
                    { month: 5, day: 15, text: 'Babalar Günü 👔', floating: true }, // 3. pazar — yaklaşık
                    { month: 6, day: 15, text: 'Demokrasi ve Millî Birlik Günü 🇹🇷' },
                    { month: 7, day: 30, text: 'Zafer Bayramı 🇹🇷' },
                    { month: 9, day: 29, text: 'Cumhuriyet Bayramı 🇹🇷' },
                    { month: 10, day: 10, text: 'Atatürk’ü Anma Günü 🇹🇷' },
                    { month: 10, day: 24, text: 'Öğretmenler Günü 🍎' },
                ];

                // Dini bayramlar (çRAMAZAN + KURBAN) — Hicri takvime göre her yıl değişir
                const religiousHolidays = {
                    2025: [
                        { month: 2, day: 30, text: 'Ramazan Bayramı (1. gün) 🌙' },
                        { month: 2, day: 31, text: 'Ramazan Bayramı (2. gün) 🌙' },
                        { month: 3, day: 1, text: 'Ramazan Bayramı (3. gün) 🌙' },
                        { month: 5, day: 6, text: 'Kurban Bayramı (1. gün) 🕌' },
                        { month: 5, day: 7, text: 'Kurban Bayramı (2. gün) 🕌' },
                        { month: 5, day: 8, text: 'Kurban Bayramı (3. gün) 🕌' },
                        { month: 5, day: 9, text: 'Kurban Bayramı (4. gün) 🕌' },
                    ],
                    2026: [
                        { month: 2, day: 20, text: 'Ramazan Bayramı (1. gün) 🌙' },
                        { month: 2, day: 21, text: 'Ramazan Bayramı (2. gün) 🌙' },
                        { month: 2, day: 22, text: 'Ramazan Bayramı (3. gün) 🌙' },
                        { month: 4, day: 27, text: 'Kurban Bayramı (1. gün) 🕌' },
                        { month: 4, day: 28, text: 'Kurban Bayramı (2. gün) 🕌' },
                        { month: 4, day: 29, text: 'Kurban Bayramı (3. gün) 🕌' },
                        { month: 4, day: 30, text: 'Kurban Bayramı (4. gün) 🕌' },
                    ],
                    2027: [
                        { month: 2, day: 10, text: 'Ramazan Bayramı (1. gün) 🌙' },
                        { month: 2, day: 11, text: 'Ramazan Bayramı (2. gün) 🌙' },
                        { month: 2, day: 12, text: 'Ramazan Bayramı (3. gün) 🌙' },
                        { month: 4, day: 16, text: 'Kurban Bayramı (1. gün) 🕌' },
                        { month: 4, day: 17, text: 'Kurban Bayramı (2. gün) 🕌' },
                        { month: 4, day: 18, text: 'Kurban Bayramı (3. gün) 🕌' },
                        { month: 4, day: 19, text: 'Kurban Bayramı (4. gün) 🕌' },
                    ]
                };

                // Sabit tatilleri ekle
                turkishHolidays.forEach(h => {
                    if (h.month === month) {
                        if (!events[h.day]) events[h.day] = [];
                        events[h.day].push({ icon: '🇹🇷', text: h.text, type: 'holiday' });
                    }
                });

                // Dini bayramları ekle
                const yearHolidays = religiousHolidays[year];
                if (yearHolidays) {
                    yearHolidays.forEach(h => {
                        if (h.month === month) {
                            if (!events[h.day]) events[h.day] = [];
                            events[h.day].push({ icon: '🌙', text: h.text, type: 'holiday' });
                        }
                    });
                }

                return events;
            }

            function renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const titleEl = document.getElementById('calendarTitle');
                const detailEl = document.getElementById('calendarDayDetail');
                if (!grid) return;

                titleEl.innerHTML = `<i class="fas fa-calendar-alt"></i> ${TR_MONTHS[calendarMonth]} ${calendarYear}`;

                const events = getCalendarEvents(calendarYear, calendarMonth);
                const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
                const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === calendarYear && today.getMonth() === calendarMonth;
                const todayDate = today.getDate();

                // Pazartesi başlangıçlı
                const startOffset = (firstDay === 0 ? 6 : firstDay - 1);

                let html = '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;">';
                // Header
                ['Pt', 'Sa', 'Ça', 'Pe', 'Cu', 'Ct', 'Pa'].forEach(d => {
                    html += `<div style="font-size:11px;color:var(--calendar-header-text);font-weight:600;padding:4px 0;">${d}</div>`;
                });

                // Empty cells
                for (let i = 0; i < startOffset; i++) {
                    html += '<div></div>';
                }

                // Days
                const dotColorMap = {
                    'birthday': '#e74c3c',
                    'payment': '#27ae60',
                    'notification': '#3498db',
                    'event': '#9b59b6',
                    'agent': '#e67e22',
                    'note': '#f39c12',
                    'debt_due': '#c0392b',
                    'holiday': '#e91e63'
                };

                for (let d = 1; d <= daysInMonth; d++) {
                    const isToday = isCurrentMonth && d === todayDate;
                    const dayEvents = events[d] || [];
                    const hasEvents = dayEvents.length > 0;

                    // Benzersiz event türlerini bul (multi-dot için)
                    const uniqueTypes = [...new Set(dayEvents.map(e => e.type))];

                    let style = 'padding:6px 2px;border-radius:6px;cursor:pointer;position:relative;font-size:12px;';
                    if (isToday) style += 'background:var(--tpjd-gold);color:#fff;font-weight:700;';
                    else style += 'color:var(--calendar-text);';

                    html += `<div style="${style}" onclick="showCalendarDay(${d})" onmouseover="this.style.background='var(--calendar-day-hover)'" onmouseout="this.style.background='${isToday ? 'var(--tpjd-gold)' : 'transparent'}'">`;
                    html += d;
                    if (hasEvents) {
                        // Multi-dot: her event türü için bir renkli dot göster (maks 3)
                        const dots = uniqueTypes.slice(0, 3).map((type, i) => {
                            const color = dotColorMap[type] || '#3498db';
                            const offset = (i - Math.min(uniqueTypes.length, 3) / 2 + 0.5) * 6;
                            return `<div style="position:absolute;bottom:1px;left:calc(50% + ${offset}px);transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:${color};"></div>`;
                        }).join('');
                        html += dots;
                    }
                    html += '</div>';
                }

                html += '</div>';

                // Renk kodları legendı
                html += `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;padding:6px;font-size:10px;color:var(--text-muted);">`;
                const legendItems = [
                    { color: '#e74c3c', label: '🎂 Doğum Günü' },
                    { color: '#27ae60', label: '💰 Ödeme' },
                    { color: '#3498db', label: '📢 Bildirim' },
                    { color: '#9b59b6', label: '📅 Etkinlik' },
                    { color: '#e67e22', label: '🤖 Agent' },
                    { color: '#e91e63', label: '🇹🇷 Tatil/Özel Gün' }
                ];
                legendItems.forEach(item => {
                    html += `<span style="display:flex;align-items:center;gap:3px;"><span style="width:6px;height:6px;border-radius:50%;background:${item.color};display:inline-block;"></span>${item.label}</span>`;
                });
                html += `</div>`;

                grid.innerHTML = html;

                // Bugünün etkinliklerini göster
                if (isCurrentMonth && events[todayDate]) {
                    showCalendarDay(todayDate);
                } else if (detailEl) {
                    detailEl.innerHTML = '<span style="color:var(--text-muted);font-style:italic;">Bir güne tıklayarak detay görüntüleyin</span>';
                }
            }

            function showCalendarDay(day) {
                const detailEl = document.getElementById('calendarDayDetail');
                if (!detailEl) return;
                const events = getCalendarEvents(calendarYear, calendarMonth);
                const dayEvents = events[day] || [];
                const dateStr = `${day} ${TR_MONTHS[calendarMonth]} ${calendarYear}`;
                const dateKey = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                let html = `<div style="font-weight:600;color:var(--calendar-detail-text);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                    <span>${dateStr}${dayEvents.length ? ` — ${dayEvents.length} işlem` : ''}</span>
                </div>`;

                if (dayEvents.length > 0) {
                    // Event'ları türe göre grupla
                    const typeLabels = {
                        'birthday': { label: '🎂 Doğum Günleri', color: '#e74c3c' },
                        'payment': { label: '💰 Ödemeler', color: '#27ae60' },
                        'notification': { label: '📢 Bildirimler', color: '#3498db' },
                        'event': { label: '📅 Etkinlikler', color: '#9b59b6' },
                        'agent': { label: '🤖 Agent İşlemleri', color: '#e67e22' },
                        'note': { label: '📝 Notlar', color: '#f39c12' },
                        'debt_due': { label: '💳 Borç Vadeleri', color: '#c0392b' },
                        'holiday': { label: '🇹🇷 Tatil / Özel Gün', color: '#e91e63' }
                    };

                    const grouped = {};
                    dayEvents.forEach((e, idx) => {
                        const t = e.type || 'other';
                        if (!grouped[t]) grouped[t] = [];
                        grouped[t].push({ ...e, _idx: idx });
                    });

                    const groupOrder = ['holiday', 'birthday', 'payment', 'notification', 'event', 'agent', 'note', 'debt_due', 'other'];
                    const accId = `cal_acc_${day}`;

                    groupOrder.forEach((type, gi) => {
                        const items = grouped[type];
                        if (!items || items.length === 0) return;
                        const info = typeLabels[type] || { label: '📌 Diğer', color: '#95a5a6' };
                        const sectionId = `${accId}_${type}`;
                        const isFirst = gi === groupOrder.findIndex(t => grouped[t]?.length > 0);

                        html += `<div style="margin-bottom:4px;border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);">`;
                        // Header
                        html += `<div onclick="(function(){var b=document.getElementById('${sectionId}');var a=document.getElementById('${sectionId}_arrow');if(b.style.display==='none'){b.style.display='block';a.textContent='▼';}else{b.style.display='none';a.textContent='▶';}})()" 
                            style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.06));cursor:pointer;user-select:none;">
                            <span style="font-size:12px;font-weight:600;color:${info.color};">${info.label} <span style="font-size:10px;opacity:0.7;font-weight:400;">(${items.length})</span></span>
                            <span id="${sectionId}_arrow" style="font-size:10px;color:var(--text-muted);transition:transform .2s;">${isFirst ? '▼' : '▶'}</span>
                        </div>`;
                        // Body
                        html += `<div id="${sectionId}" style="display:${isFirst ? 'block' : 'none'};padding:2px 10px 6px;">`;
                        items.forEach(e => {
                            const isUserItem = e.type === 'note' || e.type === 'event';
                            html += `<div style="padding:3px 0;border-bottom:1px solid var(--calendar-detail-border);display:flex;justify-content:space-between;align-items:center;font-size:12px;">
                                <span>${e.icon} ${e.text}</span>
                                ${isUserItem ? `<button onclick="deleteCalendarItem('${dateKey}','${e.type}',${e.itemIndex})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:11px;padding:2px 4px;" title="Sil">✕</button>` : ''}
                            </div>`;
                        });
                        html += `</div></div>`;
                    });
                } else {
                    html += `<div style="padding:8px 0;color:var(--text-muted);font-style:italic;text-align:center;">Bu günde işlem yok</div>`;
                }

                // Aksiyon butonları
                html += `<div style="display:flex;gap:6px;margin-top:8px;">
                    <button onclick="showCalendarForm('${dateKey}','note')" style="flex:1;padding:5px 8px;background:linear-gradient(135deg,#2c3e50,#34495e);border:1px solid rgba(52,152,219,0.3);border-radius:6px;color:#3498db;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .2s;" onmouseover="this.style.borderColor='#3498db'" onmouseout="this.style.borderColor='rgba(52,152,219,0.3)'">
                        📝 Not Ekle
                    </button>
                    <button onclick="showCalendarForm('${dateKey}','event')" style="flex:1;padding:5px 8px;background:linear-gradient(135deg,#2c3e50,#34495e);border:1px solid rgba(46,204,113,0.3);border-radius:6px;color:#2ecc71;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .2s;" onmouseover="this.style.borderColor='#2ecc71'" onmouseout="this.style.borderColor='rgba(46,204,113,0.3)'">
                        📅 Etkinlik Ekle
                    </button>
                </div>`;

                // Form alanı
                html += `<div id="calendarFormArea"></div>`;

                detailEl.innerHTML = html;
            }

            // Takvim inline form göster
            function showCalendarForm(dateKey, type) {
                const area = document.getElementById('calendarFormArea');
                if (!area) return;

                if (type === 'note') {
                    area.innerHTML = `
                        <div style="margin-top:8px;padding:8px;background:rgba(52,152,219,0.1);border-radius:8px;border:1px solid rgba(52,152,219,0.2);">
                            <div style="font-size:11px;color:#3498db;font-weight:600;margin-bottom:4px;">📝 Not Ekle</div>
                            <textarea id="calNoteText" placeholder="Notunuzu yazın..." style="width:100%;padding:6px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#ecf0f1;font-size:12px;resize:vertical;min-height:40px;box-sizing:border-box;"></textarea>
                            <div style="display:flex;gap:4px;margin-top:4px;">
                                <button onclick="saveCalendarItem('${dateKey}','note')" style="flex:1;padding:4px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;">💾 Kaydet</button>
                                <button onclick="document.getElementById('calendarFormArea').innerHTML=''" style="padding:4px 8px;background:rgba(255,255,255,0.1);color:#bdc3c7;border:none;border-radius:4px;cursor:pointer;font-size:11px;">İptal</button>
                            </div>
                        </div>`;
                } else {
                    area.innerHTML = `
                        <div style="margin-top:8px;padding:8px;background:rgba(46,204,113,0.1);border-radius:8px;border:1px solid rgba(46,204,113,0.2);">
                            <div style="font-size:11px;color:#2ecc71;font-weight:600;margin-bottom:4px;">📅 Etkinlik Ekle</div>
                            <input id="calEventTitle" type="text" placeholder="Etkinlik adı (ör: Genel Kurul)" style="width:100%;padding:6px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#ecf0f1;font-size:12px;margin-bottom:4px;box-sizing:border-box;"/>
                            <div style="display:flex;gap:4px;margin-bottom:4px;">
                                <input id="calEventTime" type="time" value="10:00" style="flex:1;padding:5px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#ecf0f1;font-size:12px;"/>
                                <input id="calEventLocation" type="text" placeholder="Yer (opsiyonel)" style="flex:2;padding:5px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#ecf0f1;font-size:12px;"/>
                            </div>
                            <textarea id="calEventDesc" placeholder="Açıklama (opsiyonel)" style="width:100%;padding:6px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#ecf0f1;font-size:12px;resize:vertical;min-height:30px;box-sizing:border-box;"></textarea>
                            <div style="display:flex;gap:4px;margin-top:4px;">
                                <button onclick="saveCalendarItem('${dateKey}','event')" style="flex:1;padding:4px;background:#2ecc71;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;">💾 Kaydet</button>
                                <button onclick="document.getElementById('calendarFormArea').innerHTML=''" style="padding:4px 8px;background:rgba(255,255,255,0.1);color:#bdc3c7;border:none;border-radius:4px;cursor:pointer;font-size:11px;">İptal</button>
                            </div>
                        </div>`;
                }
                // İlk input'a focus
                setTimeout(() => {
                    const firstInput = area.querySelector('textarea, input[type="text"]');
                    if (firstInput) firstInput.focus();
                }, 50);
            }

            // Takvim öğesi kaydet (localStorage)
            function saveCalendarItem(dateKey, type) {
                const storageKey = 'tpjd_calendar_items';
                const items = JSON.parse(localStorage.getItem(storageKey) || '[]');

                if (type === 'note') {
                    const text = document.getElementById('calNoteText')?.value?.trim();
                    if (!text) { showNotification('Not metni boş olamaz!', 'warning'); return; }
                    items.push({ date: dateKey, type: 'note', text, createdAt: new Date().toISOString() });
                    showNotification('📝 Not kaydedildi!', 'success');
                } else {
                    const title = document.getElementById('calEventTitle')?.value?.trim();
                    if (!title) { showNotification('Etkinlik adı boş olamaz!', 'warning'); return; }
                    const time = document.getElementById('calEventTime')?.value || '';
                    const location = document.getElementById('calEventLocation')?.value?.trim() || '';
                    const desc = document.getElementById('calEventDesc')?.value?.trim() || '';
                    items.push({ date: dateKey, type: 'event', title, time, location, description: desc, createdAt: new Date().toISOString() });
                    showNotification('📅 Etkinlik kaydedildi!', 'success');
                }

                localStorage.setItem(storageKey, JSON.stringify(items));
                renderCalendar(); // Takvimi güncelle

                // Tıklanan günü tekrar göster
                const day = parseInt(dateKey.split('-')[2]);
                setTimeout(() => showCalendarDay(day), 50);
            }

            // Takvim öğesi sil
            function deleteCalendarItem(dateKey, type, itemIndex) {
                if (!confirm('Bu öğeyi silmek istediğinize emin misiniz?')) return;
                const storageKey = 'tpjd_calendar_items';
                const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const filtered = items.filter(i => i.date === dateKey && i.type === type);
                if (filtered[itemIndex]) {
                    const globalIdx = items.indexOf(filtered[itemIndex]);
                    if (globalIdx > -1) items.splice(globalIdx, 1);
                }
                localStorage.setItem(storageKey, JSON.stringify(items));
                renderCalendar();
                const day = parseInt(dateKey.split('-')[2]);
                setTimeout(() => showCalendarDay(day), 50);
                showNotification('🗑️ Öğe silindi!', 'info');
            }

            // ═══════════════════════════════════════════════════════
            // WHATSAPP SUNUCU DURUM KONTROLÜ
            // ═══════════════════════════════════════════════════════
            async function checkWPServerStatus() {
                const dot = document.getElementById('wpStatusDot');
                const text = document.getElementById('wpStatusText');
                if (!dot || !text) return;

                dot.style.background = '#f39c12';
                text.textContent = 'Kontrol ediliyor...';

                try {
                    const resp = await fetch(API_BASE + '/whatsapp_control.php?action=status');
                    const data = await resp.json();
                    if (data.success && data.data && data.data.running) {
                        if (data.data.authenticated) {
                            dot.style.background = '#27ae60';
                            const phone = data.data.info?.phone || '';
                            text.textContent = '✅ WhatsApp bağlı' + (phone ? ` (${phone})` : '');
                        } else {
                            dot.style.background = '#f39c12';
                            text.textContent = '⏳ Sunucu çalışıyor ama QR okutulmamış';
                        }
                    } else {
                        dot.style.background = '#e74c3c';
                        text.textContent = '❌ WhatsApp sunucusu kapalı — TPJD_WHATSAPP.bat dosyasını çalıştırın';
                    }
                } catch (e) {
                    dot.style.background = '#e74c3c';
                    text.textContent = '❌ Bağlantı hatası — sunucu çalışmıyor olabilir';
                }
            }

            // ═══════════════════════════════════════════════════════
            // SON İŞLEMLER FEED
            // ═══════════════════════════════════════════════════════
            function updateRecentFeed() {
                const feed = document.getElementById('recentActivityFeed');
                if (!feed) return;

                const activities = [];

                // Son ödemeler
                payments.slice().sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)).slice(0, 5).forEach(p => {
                    const m = members.find(x => x.id === p.memberId);
                    const name = m ? `${m.firstName} ${m.lastName}` : 'Bilinmeyen';
                    const d = p.date ? new Date(p.date) : null;
                    const timeStr = d ? d.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' }) : '';
                    activities.push({
                        time: d || new Date(0),
                        html: `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(39,174,96,0.05);border-radius:6px;border-left:3px solid ${p.status === 'tamamlandı' ? '#27ae60' : '#e67e22'};">
                            <span style="font-size:16px;">${p.status === 'tamamlandı' ? '💰' : '⏳'}</span>
                            <div style="flex:1;font-size:12px;color:#2c3e50;">
                                <strong>${name}</strong> — ₺${p.amount} ${p.type} (${p.year})
                            </div>
                            <span style="font-size:11px;color:#95a5a6;">${timeStr}</span>
                        </div>`
                    });
                });

                // Son bildirimler
                (notifications || []).slice().sort((a, b) => new Date(b.sentAt || 0) - new Date(a.sentAt || 0)).slice(0, 3).forEach(n => {
                    const d = n.sentAt ? new Date(n.sentAt) : null;
                    const timeStr = d ? d.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' }) : '';
                    activities.push({
                        time: d || new Date(0),
                        html: `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(52,152,219,0.05);border-radius:6px;border-left:3px solid #3498db;">
                            <span style="font-size:16px;">📢</span>
                            <div style="flex:1;font-size:12px;color:#2c3e50;">
                                <strong>${n.title || 'Bildirim'}</strong> — ${(n.recipients || []).length} kişiye gönderildi
                            </div>
                            <span style="font-size:11px;color:#95a5a6;">${timeStr}</span>
                        </div>`
                    });
                });

                // Zamana göre sırala
                activities.sort((a, b) => b.time - a.time);

                if (activities.length === 0) {
                    feed.innerHTML = '<div style="text-align:center;color:#95a5a6;padding:20px;font-size:13px;"><i class="fas fa-inbox" style="font-size:24px;margin-bottom:8px;display:block;"></i>Henüz işlem yok</div>';
                } else {
                    feed.innerHTML = activities.slice(0, 8).map(a => a.html).join('');
                }
            }

            // Haftalık otomatik sunucu yedeği
            async function checkAutoBackup() {
                try {
                    const lastBackupKey = 'tpjd_last_auto_backup';
                    const lastBackup = localStorage.getItem(lastBackupKey);
                    const now = Date.now();
                    const sevenDays = 7 * 24 * 60 * 60 * 1000;

                    if (!lastBackup || (now - parseInt(lastBackup)) > sevenDays) {
                        console.log('💾 Otomatik haftalık yedek başlatılıyor...');
                        const res = await fetch(API_BASE + '/backup.php?action=create', { method: 'POST' });
                        const data = await res.json();
                        if (data.success) {
                            localStorage.setItem(lastBackupKey, String(now));
                            console.log('✅ Otomatik yedek oluşturuldu');
                        }
                    }
                } catch (e) {
                    console.warn('Auto-backup check failed:', e);
                }
            }

            // Initialize app on page load
            async function initializeApp() {
                console.log('Uygulama başlatılıyor...');
                startLiveClock();

                // Önce auth kontrolü yap — login olmadan API çağrısı yapma
                checkAuth();

                // Eğer oturum varsa data yükle (checkAuth zaten loadAllData çağırıyor)
                // Eğer oturum yoksa login ekranı gösterilir, login sonrası loadAllData çağrılır
                if (isAuthenticated) {
                    await agentManager.init();
                    await loadWhatsAppSettings();
                    renderCalendar();
                    console.log('Uygulama başlatıldı. Üyeler:', members.length);
                    // Agent'ları arka planda otomatik çalıştır
                    setTimeout(() => autoRunAgents(), 3000);
                    // Haftalık otomatik yedek kontrolü
                    setTimeout(() => checkAutoBackup(), 5000);
                } else {
                    console.log('Oturum yok, login bekleniyor...');
                    renderCalendar(); // Boş takvim göster
                }
            }

            // Load app when DOM is ready
            document.addEventListener('DOMContentLoaded', initializeApp);
        </script>

</body>

</html>