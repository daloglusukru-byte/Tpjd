<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPJD Ãœyelik YÃ¶netim Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --tpjd-dark: #2c3e50;
            --tpjd-gray: #34495e;
            --tpjd-gold: #f39c12;
            --tpjd-light-gold: #f1c40f;
            --tpjd-light: #ecf0f1;
            --tpjd-border: #bdc3c7;
            --tpjd-success: #27ae60;
            --tpjd-danger: #e74c3c;
            --tpjd-warning: #e67e22;
            --tpjd-info: #3498db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--tpjd-dark) 0%, var(--tpjd-gray) 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 1px solid var(--tpjd-border);
        }

        .header {
            background: linear-gradient(135deg, var(--tpjd-dark) 0%, var(--tpjd-gray) 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
            border-bottom: 4px solid var(--tpjd-gold);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: var(--tpjd-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 24px;
        }

        .logo i {
            display: block;
        }

        .header-text h1 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header-text p {
            opacity: 0.9;
            font-size: 14px;
            color: var(--tpjd-light);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tabs {
            display: flex;
            background: var(--tpjd-light);
            border-bottom: 1px solid var(--tpjd-border);
            overflow-x: auto;
            padding: 0 10px;
        }

        .tab {
            padding: 18px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--tpjd-gray);
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab:hover {
            background: rgba(52, 73, 94, 0.05);
            color: var(--tpjd-dark);
        }

        .tab.active {
            color: var(--tpjd-dark);
            border-bottom: 3px solid var(--tpjd-gold);
            background: white;
        }

        .tab i {
            margin-right: 8px;
            opacity: 0.8;
        }

        .content {
            padding: 30px;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid var(--tpjd-gold);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--tpjd-light-gold) 0%, transparent 70%);
            opacity: 0.1;
            border-radius: 0 0 0 100%;
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--tpjd-gray);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--tpjd-dark);
        }

        .stat-card .subtitle {
            font-size: 13px;
            color: #7f8c8d;
            font-weight: 500;
        }

        .stat-card.success {
            border-left-color: var(--tpjd-success);
        }

        .stat-card.warning {
            border-left-color: var(--tpjd-warning);
        }

        .stat-card.info {
            border-left-color: var(--tpjd-info);
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 35px;
        }

        .chart-container h3 {
            font-size: 18px;
            color: var(--tpjd-dark);
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .chart-wrapper {
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }

        @media (max-width: 768px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 50px 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--tpjd-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 32px;
            margin: 0 auto 30px;
        }

        .login-logo i {
            display: block;
        }

        .login-box h1 {
            font-size: 28px;
            color: var(--tpjd-dark);
            margin-bottom: 10px;
        }

        .login-box p {
            color: #7f8c8d;
            margin-bottom: 35px;
            font-size: 15px;
        }

        .login-form .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--tpjd-dark);
            font-weight: 600;
            font-size: 14px;
        }

        .login-form input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .login-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--tpjd-danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .main-app {
            display: none;
        }

        .main-app.show {
            display: block;
        }

        .logout-btn {
            background: var(--tpjd-danger);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--tpjd-border);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn i {
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--tpjd-gray), var(--tpjd-dark));
        }

        .btn-success {
            background: var(--tpjd-success);
            color: white;
        }

        .btn-warning {
            background: var(--tpjd-warning);
            color: white;
        }

        .btn-danger {
            background: var(--tpjd-danger);
            color: white;
        }

        .btn-info {
            background: var(--tpjd-info);
            color: white;
        }

        .btn-secondary {
            background: var(--tpjd-border);
            color: var(--tpjd-dark);
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid var(--tpjd-border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
        }

        thead th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid var(--tpjd-border);
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: rgba(243, 156, 18, 0.05);
        }

        tbody td {
            padding: 14px 16px;
            font-size: 14px;
            color: #555;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge.success {
            background: rgba(39, 174, 96, 0.15);
            color: var(--tpjd-success);
        }

        .badge.warning {
            background: rgba(230, 126, 34, 0.15);
            color: var(--tpjd-warning);
        }

        .badge.danger {
            background: rgba(231, 76, 60, 0.15);
            color: var(--tpjd-danger);
        }

        .badge.info {
            background: rgba(52, 152, 219, 0.15);
            color: var(--tpjd-info);
        }

        .action-btn {
            padding: 8px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .action-btn.edit {
            background: var(--tpjd-info);
            color: white;
        }

        .action-btn.delete {
            background: var(--tpjd-danger);
            color: white;
        }

        .action-btn.view {
            background: var(--tpjd-warning);
            color: white;
        }

        .action-btn.download {
            background: var(--tpjd-success);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 0;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--tpjd-gold);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tpjd-dark);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .modal-footer {
            padding: 20px 25px;
            background: var(--tpjd-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--tpjd-border);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 2000;
            min-width: 300px;
            border-left: 5px solid var(--tpjd-success);
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left-color: var(--tpjd-success);
        }

        .notification.error {
            border-left-color: var(--tpjd-danger);
        }

        .notification.warning {
            border-left-color: var(--tpjd-warning);
        }

        .notification.info {
            border-left-color: var(--tpjd-info);
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid var(--tpjd-border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--tpjd-gold);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tpjd-gray);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--tpjd-gold);
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            thead th,
            tbody td {
                padding: 10px 8px;
            }
        }

        .spinner {
            border: 3px solid var(--tpjd-light);
            border-top: 3px solid var(--tpjd-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--tpjd-gray);
        }

        .empty-state p {
            font-size: 14px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .detail-item {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid var(--tpjd-gold);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .detail-item label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .detail-item .value {
            font-size: 16px;
            color: var(--tpjd-dark);
            font-weight: 500;
        }

        .accordion {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid var(--tpjd-border);
        }

        .accordion-header {
            background: linear-gradient(135deg, var(--tpjd-dark), var(--tpjd-gray));
            color: white;
            padding: 18px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg, var(--tpjd-gray), var(--tpjd-dark));
        }

        .accordion-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accordion-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .accordion-content.active {
            max-height: 2000px;
        }

        .accordion-body {
            padding: 0;
        }

        .accordion-body table {
            margin: 0;
        }

        .member-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .member-stat-badge {
            background: var(--tpjd-gold);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .form-group.checkbox-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group.checkbox-inline input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .form-group.checkbox-inline label {
            margin: 0;
            cursor: pointer;
        }

        .year-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: var(--tpjd-light);
            border-radius: 8px;
        }

        .year-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid var(--tpjd-border);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .year-checkbox-item:hover {
            border-color: var(--tpjd-gold);
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.2);
        }

        .year-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--tpjd-gold);
        }

        .year-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: var(--tpjd-dark);
        }

        .year-checkbox-item input[type="checkbox"]:checked+label {
            color: var(--tpjd-gold);
            font-weight: 600;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: 0.3s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
        }

        input:checked+.slider {
            background: #27ae60;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .slider.round {
            border-radius: 24px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-users"></i>
            </div>
            <h1>TPJD Ãœyelik YÃ¶netim Sistemi</h1>
            <p style="margin-bottom: 35px;">GiriÅŸ yaparak sisteme eriÅŸebilirsiniz</p>

            <div id="loginError" class="login-error">
                KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!
            </div>

            <form class="login-form" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginUsername">KullanÄ±cÄ± AdÄ±</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Åžifre</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> GiriÅŸ Yap
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="header-text">
                            <h1>TPJD</h1>
                            <p>TÃ¼rkiye Petrol JeologlarÄ± DerneÄŸi - Ãœyelik YÃ¶netim Sistemi</p>
                        </div>
                    </div>
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i> YÃ¶netici Paneli
                        <button class="logout-btn" onclick="logout()" style="margin-left: 15px;">
                            <i class="fas fa-sign-out-alt"></i> Ã‡Ä±kÄ±ÅŸ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard', event)">
                    <i class="fas fa-home"></i> Ana Sayfa
                </button>
                <button class="tab" onclick="switchTab('members', event)">
                    <i class="fas fa-users"></i> Ãœyeler
                </button>
                <button class="tab" onclick="switchTab('payments', event)">
                    <i class="fas fa-money-bill-wave"></i> Ã–demeler
                </button>
                <button class="tab" onclick="switchTab('notifications', event)">
                    <i class="fas fa-bell"></i> Bildirimler
                </button>
                <button class="tab" onclick="switchTab('settings', event)">
                    <i class="fas fa-cog"></i> Ayarlar
                </button>
                <button class="tab" onclick="switchTab('agents', event)">
                    <i class="fas fa-robot"></i> Ajanlar
                </button>
            </div>
            <!-- Content -->
            <div class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <!-- HoÅŸ Geldin + CanlÄ± Saat -->
                    <div id="dashboardHeader"
                        style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px 20px;background:linear-gradient(135deg,rgba(44,62,80,0.95),rgba(52,73,94,0.9));border-radius:12px;border-left:4px solid var(--tpjd-primary);">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span style="font-size:28px;">ðŸ‘‹</span>
                            <div>
                                <div style="color:#fff;font-size:18px;font-weight:700;">HoÅŸ Geldiniz!</div>
                                <div style="color:#bdc3c7;font-size:13px;">TPJD Ãœyelik YÃ¶netim Paneli</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div id="liveDate" style="color:#ecf0f1;font-size:15px;font-weight:600;"></div>
                            <div id="liveClock"
                                style="color:var(--tpjd-primary);font-size:22px;font-weight:700;font-family:'Courier New',monospace;">
                            </div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Toplam Ãœye</h3>
                            <div class="value" id="totalMembers">0</div>
                            <div class="subtitle">KayÄ±tlÄ± Ã¼ye sayÄ±sÄ±</div>
                        </div>
                        <div class="stat-card success">
                            <h3>Aktif Ãœye</h3>
                            <div class="value" id="activeMembers">0</div>
                            <div class="subtitle" id="activeSubtitle">YÄ±llÄ±k aidat Ã¶demesi yapan</div>
                        </div>
                        <div class="stat-card warning">
                            <h3>Bekleyen Ã–deme</h3>
                            <div class="value" id="pendingPayments">0</div>
                            <div class="subtitle">Aidat Ã¶demeyen Ã¼ye sayÄ±sÄ±</div>
                        </div>
                        <div class="stat-card info">
                            <h3>Toplam Gelir</h3>
                            <div class="value" id="totalIncome">â‚º0</div>
                            <div class="subtitle" id="incomeSubtitle">YÄ±llÄ±k toplam aidat geliri</div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="charts-row">
                        <!-- Ä°nteraktif Takvim -->
                        <div class="chart-container" style="padding:15px;">
                            <div
                                style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <button onclick="calendarPrevMonth()"
                                    style="background:none;border:1px solid rgba(255,255,255,0.15);color:var(--tpjd-primary);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:14px;">â—€</button>
                                <h3 id="calendarTitle" style="margin:0;font-size:16px;"><i
                                        class="fas fa-calendar-alt"></i> Åžubat 2026</h3>
                                <button onclick="calendarNextMonth()"
                                    style="background:none;border:1px solid rgba(255,255,255,0.15);color:var(--tpjd-primary);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:14px;">â–¶</button>
                            </div>
                            <div id="calendarGrid" style="font-size:13px;"></div>
                            <div id="calendarDayDetail"
                                style="margin-top:10px;max-height:120px;overflow-y:auto;font-size:12px;color:#bdc3c7;border-top:1px solid rgba(255,255,255,0.08);padding-top:8px;">
                            </div>
                        </div>

                        <!-- Ãœyelik Tipi DaÄŸÄ±lÄ±mÄ± Simit Grafik -->
                        <div class="chart-container">
                            <h3><i class="fas fa-chart-pie"></i> Ãœyelik Tipi DaÄŸÄ±lÄ±mÄ±</h3>
                            <div class="chart-wrapper">
                                <canvas id="membershipDonutChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('memberModal')">
                            <i class="fas fa-user-plus"></i> Yeni Ãœye Ekle
                        </button>
                        <button class="btn btn-success" onclick="openModal('paymentModal')">
                            <i class="fas fa-plus-circle"></i> Ã–deme Ekle
                        </button>
                        <button class="btn btn-warning" onclick="openBulkEmailModal()">
                            <i class="fas fa-envelope"></i> Toplu E-posta
                        </button>
                        <button class="btn" style="background:#ff5722;color:white;border-color:#ff5722;"
                            onclick="openModal('eventModal')">
                            <i class="fas fa-bullhorn"></i> Etkinlik Duyuru
                        </button>
                        <button class="btn btn-secondary" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Excel'e Aktar
                        </button>
                        <button class="btn btn-secondary" onclick="exportToJSON()">
                            <i class="fas fa-file-code"></i> JSON Ä°ndir
                        </button>
                    </div>

                    <!-- Son Ä°ÅŸlemler Feed -->
                    <div
                        style="background:white;padding:16px 20px;border-radius:12px;margin-top:20px;box-shadow:0 5px 20px rgba(0,0,0,0.08);">
                        <h3
                            style="margin:0 0 12px 0;color:var(--tpjd-dark);display:flex;align-items:center;gap:8px;font-size:15px;">
                            <i class="fas fa-stream" style="color:var(--tpjd-primary);"></i> Son Ä°ÅŸlemler
                        </h3>
                        <div id="recentActivityFeed"
                            style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow-y:auto;"></div>
                    </div>

                    <div
                        style="background: white; padding: 20px; border-radius: 12px; margin-top: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                        <h3
                            style="margin: 0 0 20px 0; color: var(--tpjd-dark); display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--tpjd-danger);"></i>
                            BorÃ§lu Ãœyeler Listesi
                            <span id="debtorCount"
                                style="margin-left: auto; font-size: 14px; color: var(--tpjd-warning); background: rgba(230, 126, 34, 0.1); padding: 5px 15px; border-radius: 20px;"></span>
                        </h3>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ãœye No</th>
                                        <th>Ad Soyad</th>
                                        <th>Ãœyelik Tipi</th>
                                        <th>E-posta</th>
                                        <th>Telefon</th>
                                        <th>Ã–deme Durumu</th>
                                        <th>BorÃ§ TutarÄ±</th>
                                        <th>Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboardMembersTable">
                                    <tr>
                                        <td colspan="8" class="empty-state">
                                            <i class="fas fa-users"></i>
                                            <h3>HenÃ¼z Ã¼ye kaydÄ± bulunmamaktadÄ±r</h3>
                                            <p>Yeni Ã¼ye eklemek iÃ§in "Yeni Ãœye Ekle" butonuna tÄ±klayÄ±n</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Members Tab -->
                <div id="members" class="tab-content">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('memberModal')">
                            <i class="fas fa-user-plus"></i> Yeni Ãœye Ekle
                        </button>
                        <div id="membersStatusLine"
                            style="margin-left: 15px; font-weight: bold; color: #4f46e5; display: flex; align-items: center;">
                            YÃ¼klenen Ã¼ye sayÄ±sÄ±: <span id="loadedMembersCount">0</span></div>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="memberSearch" placeholder="Ãœye ara..." onkeyup="searchMembers()">
                        </div>
                        <button class="btn btn-secondary" onclick="exportMembersToExcel()">
                            <i class="fas fa-file-excel"></i> Excel'e Aktar
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ãœye No</th>
                                    <th>Ad Soyad</th>
                                    <th>TC No</th>
                                    <th>E-posta</th>
                                    <th>Telefon</th>
                                    <th>Ãœyelik Tipi</th>
                                    <th>KayÄ±t Tarihi</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="membersTable">
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <h3>HenÃ¼z Ã¼ye kaydÄ± bulunmamaktadÄ±r</h3>
                                        <p>Yeni Ã¼ye eklemek iÃ§in "Yeni Ãœye Ekle" butonuna tÄ±klayÄ±n</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Tab with Accordion -->
                <div id="payments" class="tab-content">
                    <div class="toolbar">
                        <button class="btn btn-success" onclick="openModal('paymentModal')">
                            <i class="fas fa-plus-circle"></i> Ã–deme Ekle
                        </button>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="paymentSearch" placeholder="Ã–deme ara..." onkeyup="searchPayments()">
                        </div>
                        <button class="btn btn-secondary" onclick="exportPaymentsToExcel()">
                            <i class="fas fa-file-excel"></i> Excel'e Aktar
                        </button>
                    </div>

                    <div id="paymentsAccordion">
                        <!-- Accordion items will be dynamically generated here -->
                    </div>
                </div>

                <!-- Transactions Tab -->

                <!-- Notifications Tab -->
                <div id="notifications" class="tab-content">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('notificationModal')">
                            <i class="fas fa-bell"></i> Yeni Bildirim GÃ¶nder
                        </button>
                        <button class="btn btn-warning" onclick="openBulkEmailModal()">
                            <i class="fas fa-envelope"></i> Toplu E-posta GÃ¶nder
                        </button>
                        <button class="btn btn-success" onclick="openBulkSMSModal()"
                            style="background: #25D366; border-color: #25D366;">
                            <i class="fas fa-sms"></i> Toplu SMS GÃ¶nder
                        </button>
                        <button class="btn btn-success" onclick="openBulkWhatsAppModal()"
                            style="background: #25D366; border-color: #128C7E;">
                            <i class="fab fa-whatsapp"></i> Toplu WhatsApp
                        </button>
                    </div>

                    <div id="notificationsList">
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <h3>HenÃ¼z bildirim bulunmamaktadÄ±r</h3>
                            <p>Yeni bildirim gÃ¶ndermek iÃ§in "Yeni Bildirim GÃ¶nder" butonuna tÄ±klayÄ±n</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings" class="tab-content">
                    <div class="stats-grid" style="grid-template-columns: 1fr;">
                        <div class="stat-card">
                            <h3><i class="fas fa-key"></i> KullanÄ±cÄ± AdÄ± ve Åžifre DeÄŸiÅŸtir</h3>
                            <form id="passwordForm" style="margin-top: 20px;">
                                <div class="form-group">
                                    <label>Mevcut KullanÄ±cÄ± AdÄ±</label>
                                    <input type="text" id="currentUsername" readonly style="background: #f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>Mevcut Åžifre</label>
                                    <input type="password" id="currentPasswordCheck" required
                                        placeholder="Mevcut ÅŸifrenizi girin">
                                </div>
                                <div class="form-group">
                                    <label>Yeni KullanÄ±cÄ± AdÄ±</label>
                                    <input type="text" id="newUsername" required placeholder="Yeni kullanÄ±cÄ± adÄ±">
                                </div>
                                <div class="form-group">
                                    <label>Yeni Åžifre</label>
                                    <input type="password" id="newPassword" required
                                        placeholder="Yeni ÅŸifre (min. 6 karakter)">
                                </div>
                                <div class="form-group">
                                    <label>Yeni Åžifre Tekrar</label>
                                    <input type="password" id="newPasswordConfirm" required
                                        placeholder="Yeni ÅŸifre tekrar">
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveAllSettings()"
                                    style="width: 100%; margin-top: 10px;">
                                    <i class="fas fa-save"></i> DeÄŸiÅŸiklikleri Kaydet
                                </button>
                            </form>
                        </div>

                        <!-- Agent Mail AyarlarÄ± -->
                        <div class="stat-card" style="border-left:4px solid #9b59b6;">
                            <h3><i class="fas fa-envelope-open-text" style="color:#9b59b6;"></i> Agent Mail AyarlarÄ±
                            </h3>
                            <p style="margin:10px 0 20px;color:#7f8c8d;font-size:13px;">
                                AylÄ±k rapor ve bildirimler hangi email adreslerine gÃ¶nderilsin? VirgÃ¼lle ayÄ±rarak birden
                                fazla adres girebilirsiniz.
                            </p>

                            <div
                                style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
                                <!-- AylÄ±k Rapor AlÄ±cÄ±larÄ± -->
                                <div class="form-group">
                                    <label><i class="fas fa-chart-bar" style="color:#673ab7;"></i> AylÄ±k Rapor
                                        AlÄ±cÄ±larÄ±</label>
                                    <textarea id="settingMonthlyEmails" rows="3"
                                        placeholder="ornek@tpjd.org.tr, baskan@tpjd.org.tr"
                                        style="width:100%;padding:10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;resize:vertical;"></textarea>
                                    <small style="color:#7f8c8d;">Ay sonunda mali Ã¶zet raporu bu adreslere
                                        gÃ¶nderilir</small>
                                </div>

                                <!-- Genel Bildirim AlÄ±cÄ±larÄ± -->
                                <div class="form-group">
                                    <label><i class="fas fa-bell" style="color:#e67e22;"></i> Genel Bildirim
                                        AlÄ±cÄ±larÄ±</label>
                                    <textarea id="settingNotifyEmails" rows="3" placeholder="yonetim@tpjd.org.tr"
                                        style="width:100%;padding:10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;resize:vertical;"></textarea>
                                    <small style="color:#7f8c8d;">Sistem bildirimleri (hata, uyarÄ±) bu adreslere
                                        gÃ¶nderilir</small>
                                </div>
                            </div>

                            <div
                                style="margin-top:15px;padding:15px;background:rgba(155,89,182,0.05);border-radius:8px;">
                                <h4 style="margin:0 0 12px;font-size:14px;color:var(--tpjd-dark);"><i
                                        class="fas fa-users"></i> HÄ±zlÄ± KiÅŸi Ekleme</h4>
                                <div
                                    style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;">
                                    <div class="form-group" style="margin:0;">
                                        <label style="font-size:12px;">Dernek BaÅŸkanÄ±</label>
                                        <input type="email" id="settingPresidentEmail" placeholder="baskan@ornek.com"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <label style="font-size:12px;">Sayman</label>
                                        <input type="email" id="settingTreasurerEmail" placeholder="sayman@ornek.com"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <label style="font-size:12px;">Genel Sekreter</label>
                                        <input type="email" id="settingSecretaryEmail" placeholder="sekreter@ornek.com"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                    </div>
                                </div>
                                <button type="button" onclick="addQuickEmailsToMonthly()" class="btn"
                                    style="margin-top:10px;padding:6px 14px;background:#9b59b6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                                    <i class="fas fa-plus"></i> YukarÄ±daki kiÅŸileri AylÄ±k Rapor'a ekle
                                </button>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="saveAgentEmailSettings()"
                                style="width:100%;margin-top:15px;">
                                <i class="fas fa-save"></i> Agent Mail AyarlarÄ±nÄ± Kaydet
                            </button>
                        </div>

                        <div class="stat-card info">
                            <h3><i class="fas fa-info-circle"></i> Sistem Bilgileri</h3>
                            <div style="margin-top: 20px;">
                                <div class="detail-item" style="margin-bottom: 15px;">
                                    <label>Toplam Ãœye SayÄ±sÄ±</label>
                                    <div class="value" id="settingsTotalMembers">0</div>
                                </div>
                                <div class="detail-item" style="margin-bottom: 15px;">
                                    <label>Toplam Ã–deme SayÄ±sÄ±</label>
                                    <div class="value" id="settingsTotalPayments">0</div>
                                </div>
                                <div class="detail-item">
                                    <label>Versiyon</label>
                                    <div class="value">v1.0.0</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card warning">
                            <h3><i class="fas fa-money-bill-wave"></i> Aidat TutarlarÄ±</h3>
                            <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                                Her Ã¼yelik tipi iÃ§in yÄ±llÄ±k aidat tutarlarÄ±nÄ± belirleyin. Bu tutarlar otomatik
                                borÃ§landÄ±rma iÅŸleminde kullanÄ±lacaktÄ±r.
                            </p>
                            <form id="aidatSettingsForm" style="margin-top: 20px;">
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div class="form-group">
                                        <label>Asil Ãœye AidatÄ± (â‚º)</label>
                                        <input type="number" id="aidatAsilUye" min="0" step="0.01" value="100" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Asil Onursal AidatÄ± (â‚º)</label>
                                        <input type="number" id="aidatAsilOnursal" min="0" step="0.01" value="0"
                                            required>
                                        <small style="color: #7f8c8d;">0 ise borÃ§landÄ±rÄ±lmaz</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Ã–ÄŸrenci Ãœye AidatÄ± (â‚º)</label>
                                        <input type="number" id="aidatOgrenciUye" min="0" step="0.01" value="50"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label>Fahri Ãœye AidatÄ± (â‚º)</label>
                                        <input type="number" id="aidatFahriUye" min="0" step="0.01" value="100"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label>Fahri Onursal AidatÄ± (â‚º)</label>
                                        <input type="number" id="aidatFahriOnursal" min="0" step="0.01" value="0"
                                            required>
                                        <small style="color: #7f8c8d;">0 ise borÃ§landÄ±rÄ±lmaz</small>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveAllSettings()"
                                    style="width: 100%; margin-top: 15px;">
                                    <i class="fas fa-save"></i> Aidat TutarlarÄ±nÄ± Kaydet
                                </button>
                            </form>

                            <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid var(--tpjd-light);">
                                <h4 style="color: var(--tpjd-dark); margin-bottom: 15px;">
                                    <i class="fas fa-calendar-check"></i> Otomatik YÄ±llÄ±k BorÃ§landÄ±rma
                                </h4>
                                <p style="margin: 10px 0; color: #7f8c8d; font-size: 14px;">
                                    TÃ¼m Ã¼yeleri yukarÄ±daki tutarlar Ã¼zerinden seÃ§tiÄŸiniz yÄ±l iÃ§in otomatik borÃ§landÄ±rÄ±n.
                                </p>
                                <div style="display: flex; gap: 15px; align-items: flex-end; margin-top: 15px;">
                                    <div class="form-group" style="flex: 1;">
                                        <label>BorÃ§landÄ±rma YÄ±lÄ±</label>
                                        <input type="number" id="borclandirmaYili" min="2020" max="2050" required
                                            style="width: 100%;">
                                    </div>
                                </div>

                                <div class="stat-card" style="border-left: 4px solid #2980b9; margin-top: 25px;">
                                    <h3><i class="fas fa-university"></i> Banka / IBAN Bilgileri</h3>
                                    <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                                        BorÃ§ hatÄ±rlatma mesajlarÄ±na otomatik eklenir. Ãœyeler bu bilgilerle Ã¶deme
                                        yapabilir.
                                    </p>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                                        <div class="form-group">
                                            <label>Banka AdÄ±</label>
                                            <input type="text" id="ibanBankaAdi" placeholder="Ã–rn: Ziraat BankasÄ±"
                                                style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                        </div>
                                        <div class="form-group">
                                            <label>Hesap Sahibi</label>
                                            <input type="text" id="ibanHesapSahibi" placeholder="Ã–rn: TPJD DerneÄŸi"
                                                style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-top: 15px;">
                                        <label>IBAN NumarasÄ±</label>
                                        <input type="text" id="ibanNumarasi"
                                            placeholder="TR00 0000 0000 0000 0000 0000 00"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:14px;font-family:monospace;width:100%;letter-spacing:1px;">
                                    </div>
                                    <div class="form-group" style="margin-top: 15px;">
                                        <label>Ã–deme AÃ§Ä±klamasÄ± <small style="color:#95a5a6;">(opsiyonel â€” Ã¼yeye
                                                "aÃ§Ä±klamaya ÅŸunu yazÄ±n" diye gider)</small></label>
                                        <input type="text" id="ibanAciklama" placeholder="Ã–rn: TPJD Aidat - Ad Soyad"
                                            style="padding:8px 10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;width:100%;">
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="saveIbanSettings()"
                                        style="width: 100%; margin-top: 15px;">
                                        <i class="fas fa-save"></i> IBAN Bilgilerini Kaydet
                                    </button>
                                </div>


                                <div class="stat-card" style="border-left: 4px solid #25D366;">
                                    <h3><i class="fas fa-sms"></i> NETGSM SMS AyarlarÄ±</h3>
                                    <p style="margin: 15px 0; color: #7f8c8d; font-size: 14px;">
                                        Ãœyelere SMS gÃ¶nderimi iÃ§in NETGSM API entegrasyon ayarlarÄ±nÄ± yapÄ±landÄ±rÄ±n.
                                    </p>
                                    <form id="netgsmSettingsForm" style="margin-top: 20px;">
                                        <div
                                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                            <div class="form-group">
                                                <label>NETGSM Abone NumarasÄ± (KullanÄ±cÄ± AdÄ±)</label>
                                                <input type="text" id="netgsmUsername"
                                                    placeholder="850XXXXXXX veya 312XXXXXXX" required>
                                                <small style="color: #7f8c8d;">Abone numaranÄ±z (850xxxxxxx
                                                    formatÄ±nda)</small>
                                            </div>
                                            <div class="form-group">
                                                <label>NETGSM Åžifre (Alt KullanÄ±cÄ±)</label>
                                                <input type="password" id="netgsmPassword"
                                                    placeholder="Alt kullanÄ±cÄ± ÅŸifreniz" required>
                                                <small style="color: #7f8c8d;">API yetkili alt kullanÄ±cÄ± ÅŸifresi</small>
                                            </div>
                                            <div class="form-group">
                                                <label>GÃ¶nderici AdÄ± (Mesaj BaÅŸlÄ±ÄŸÄ±)</label>
                                                <input type="text" id="netgsmHeader" placeholder="SMS BASLIK"
                                                    maxlength="11" required>
                                                <small style="color: #7f8c8d;">3-11 karakter, sistemde tanÄ±mlÄ±
                                                    olmalÄ±</small>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                                            <button type="button" class="btn btn-primary" onclick="saveNetgsmSettings()"
                                                style="flex: 1;">
                                                <i class="fas fa-save"></i> SMS AyarlarÄ±nÄ± Kaydet
                                            </button>
                                            <button type="button" class="btn btn-secondary"
                                                onclick="testNetgsmConnection()" style="flex: 1;">
                                                <i class="fas fa-plug"></i> BaÄŸlantÄ±yÄ± Test Et
                                            </button>
                                        </div>
                                    </form>
                                </div>




                                <!-- Yedekleme Paneli (Akordiyon) -->
                                <details class="stat-card"
                                    style="border-left: 4px solid #27ae60; margin-top: 20px; cursor: pointer;">
                                    <summary
                                        style="list-style: none; display: flex; align-items: center; justify-content: space-between; padding: 5px 0;">
                                        <h3 style="margin: 0;"><i class="fas fa-shield-alt" style="color:#27ae60;"></i>
                                            Yedekleme</h3>
                                        <i class="fas fa-chevron-down"
                                            style="color: #7f8c8d; transition: transform 0.3s;"></i>
                                    </summary>

                                    <!-- JSON Yedekleme -->
                                    <div
                                        style="margin-top: 20px; padding: 15px; background: rgba(39,174,96,0.05); border-radius: 8px;">
                                        <h4 style="margin: 0 0 10px; font-size: 14px; color: var(--tpjd-dark);">
                                            <i class="fas fa-download" style="color:#27ae60;"></i> Bilgisayara Yedekle
                                            (JSON)
                                        </h4>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            <button class="btn btn-success" onclick="exportToJSON()"
                                                style="flex: 1; min-width: 180px;">
                                                <i class="fas fa-download"></i> JSON Ä°ndir
                                            </button>
                                            <button class="btn btn-info"
                                                onclick="document.getElementById('jsonFileInput').click()"
                                                style="flex: 1; min-width: 180px;">
                                                <i class="fas fa-upload"></i> JSON YÃ¼kle (Geri YÃ¼kle)
                                            </button>
                                            <input type="file" id="jsonFileInput" accept=".json" style="display: none;"
                                                onchange="importFromJSON(event)">
                                        </div>
                                    </div>

                                    <!-- Sunucu Yedekleme -->
                                    <div
                                        style="margin-top: 15px; padding: 15px; background: rgba(39,174,96,0.05); border-radius: 8px;">
                                        <h4 style="margin: 0 0 10px; font-size: 14px; color: var(--tpjd-dark);">
                                            <i class="fas fa-hdd" style="color:#27ae60;"></i> Sunucu Yedekleme
                                        </h4>
                                        <p style="margin: 0 0 10px; color: #7f8c8d; font-size: 13px;">
                                            VeritabanÄ±nÄ±n tamamÄ±nÄ± sunucu tarafÄ±nda JSON olarak yedekleyin. 30 gÃ¼nden
                                            eski
                                            yedekler otomatik temizlenir.
                                        </p>

                                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                            <button type="button" class="btn" onclick="createServerBackup()"
                                                style="background:#27ae60; color:white; border:none;">
                                                <i class="fas fa-plus-circle"></i> Yeni Yedek OluÅŸtur
                                            </button>
                                            <button type="button" class="btn btn-secondary"
                                                onclick="loadServerBackups()">
                                                <i class="fas fa-sync"></i> Listeyi Yenile
                                            </button>
                                        </div>

                                        <div id="serverBackupResult"
                                            style="display:none; margin-bottom:10px; padding:10px; border-radius:6px;">
                                        </div>

                                        <div id="serverBackupList"
                                            style="background: #f8f9fa; border-radius: 8px; padding: 10px;">
                                            <p style="color: #95a5a6; text-align: center;">YÃ¼kleniyor...</p>
                                        </div>
                                    </div>



                                </details>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent Dashboard Tab -->
                <div id="agents" class="tab-content">
                    <!-- WhatsApp BaÄŸlantÄ± Durumu -->
                    <div id="waStatusCard"
                        style="background:white;padding:20px 25px;border-radius:12px;margin-bottom:25px;box-shadow:0 5px 20px rgba(0,0,0,0.08);border-left:5px solid #95a5a6;display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:250px;">
                            <i class="fab fa-whatsapp" style="font-size:32px;color:#25D366;"></i>
                            <div>
                                <strong style="font-size:16px;color:var(--tpjd-dark);">WhatsApp Lokal
                                    Sunucu</strong>
                                <div id="waStatusText" style="font-size:13px;color:#95a5a6;margin-top:2px;">
                                    Kontrol
                                    ediliyor...</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <span id="waStatusBadge" class="badge"
                                style="background:rgba(149,165,166,0.15);color:#95a5a6;">Bilinmiyor</span>
                            <button class="btn" onclick="checkWhatsAppStatus()"
                                style="font-size:12px;padding:8px 14px;background:var(--tpjd-info);color:white;">
                                <i class="fas fa-sync-alt"></i> Kontrol Et
                            </button>
                            <button class="btn" onclick="showWhatsAppQR()"
                                style="font-size:12px;padding:8px 14px;background:#25D366;color:white;">
                                <i class="fas fa-qrcode"></i> QR Kod
                            </button>
                        </div>
                    </div>

                    <!-- WhatsApp QR Modal -->
                    <div id="waQRModal" class="modal">
                        <div class="modal-content" style="max-width:400px;">
                            <div class="modal-header" style="background:linear-gradient(135deg,#25D366,#128C7E);">
                                <h2><i class="fab fa-whatsapp"></i> WhatsApp BaÄŸla</h2>
                                <button class="close"
                                    onclick="document.getElementById('waQRModal').classList.remove('active')">&times;</button>
                            </div>
                            <div class="modal-body" style="text-align:center;padding:30px;">
                                <div id="waQRContent">
                                    <p style="color:#555;margin-bottom:20px;">QR kodu yÃ¼klemek iÃ§in
                                        <strong>TPJD_WHATSAPP.bat</strong>'Ä± Ã§alÄ±ÅŸtÄ±rÄ±n
                                    </p>
                                    <div id="waQRImage" style="margin:20px auto;"></div>
                                    <p style="font-size:12px;color:#999;margin-top:15px;">WhatsApp > BaÄŸlÄ±
                                        Cihazlar >
                                        Cihaz BaÄŸla</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Stats -->
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left: 4px solid #9b59b6;">
                            <h3><i class="fas fa-robot" style="color:#9b59b6"></i> Aktif Ajanlar</h3>
                            <div class="value" id="activeAgentsCount">0</div>
                            <div class="subtitle">Ã‡alÄ±ÅŸan otomasyon sayÄ±sÄ±</div>
                        </div>
                        <div class="stat-card success">
                            <h3><i class="fas fa-check-circle"></i> Bu Ay Ä°ÅŸlemler</h3>
                            <div class="value" id="monthlyAgentActions">0</div>
                            <div class="subtitle">BaÅŸarÄ±lÄ± agent iÅŸlemi</div>
                        </div>
                        <div class="stat-card info">
                            <h3><i class="fas fa-percentage"></i> Tahsilat OranÄ±</h3>
                            <div class="value" id="collectionRate">%0</div>
                            <div class="subtitle">Toplam aidat tahsilat oranÄ±</div>
                        </div>
                        <div class="stat-card warning">
                            <h3><i class="fas fa-exclamation-triangle"></i> BorÃ§lu Ãœye</h3>
                            <div class="value" id="debtorCountAgent">0</div>
                            <div class="subtitle" id="totalDebtAmount">â‚º0 toplam borÃ§</div>
                        </div>
                    </div>

                    <!-- Agent Controls -->
                    <div
                        style="background:white;padding:25px;border-radius:12px;margin-top:25px;box-shadow:0 5px 20px rgba(0,0,0,0.08);">
                        <h3 style="margin:0 0 20px;color:var(--tpjd-dark);display:flex;align-items:center;gap:10px;">
                            <i class="fas fa-sliders-h" style="color:#9b59b6;"></i>
                            Agent Kontrol Paneli
                            <button id="agentRunAllBtn" class="btn" onclick="agentManager.runAllAgents()"
                                style="margin-left:auto;font-size:13px;background:#8e44ad;border-color:#8e44ad;color:white;">
                                <i class="fas fa-play-circle"></i> TÃ¼mÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±r
                            </button>
                            <button id="agentRefreshBtn" class="btn" onclick="agentManager.refreshAll()"
                                style="font-size:13px;background:#e74c3c;border-color:#e74c3c;color:white;">
                                <i class="fas fa-sync-alt"></i> Yenile
                            </button>
                            <span id="agentLastRefresh"
                                style="font-size:11px;color:#95a5a6;margin-left:8px;white-space:nowrap;"></span>
                        </h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:15px;"
                            id="agentCards">
                            <!-- Payment Confirm Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #27ae60;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-check-double" style="color:#27ae60"></i>
                                            Ã–deme Onay</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_payment_confirm" checked
                                            onchange="agentManager.toggleAgent('payment_confirm',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Ã–deme
                                    kaydedildiÄŸinde otomatik Email+WA bildirimi</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_payment_confirm">â€”
                                </div>
                            </div>
                            <!-- Welcome Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #3498db;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-hand-sparkles" style="color:#3498db"></i>
                                            HoÅŸ Geldin</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_welcome" checked
                                            onchange="agentManager.toggleAgent('welcome',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Yeni Ã¼ye kaydÄ±nda
                                    karÅŸÄ±lama mesajÄ± gÃ¶nderir</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_welcome">
                                    â€”</div>
                            </div>
                            <!-- Debt Reminder Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #e67e22;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-bell" style="color:#e67e22"></i> BorÃ§
                                            HatÄ±rlatma</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_debt_reminder" checked
                                            onchange="agentManager.toggleAgent('debt_reminder',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">3 kademeli borÃ§
                                    hatÄ±rlatma (nazikâ†’resmiâ†’son uyarÄ±)</p>
                                <div style="display:flex;gap:8px;margin-top:8px;">
                                    <button class="btn btn-warning" onclick="agentManager.runDebtReminder(1)"
                                        style="font-size:11px;padding:4px 10px;">Kademe 1</button>
                                    <button class="btn btn-warning" onclick="agentManager.runDebtReminder(2)"
                                        style="font-size:11px;padding:4px 10px;">Kademe 2</button>
                                    <button class="btn btn-danger" onclick="agentManager.runDebtReminder(3)"
                                        style="font-size:11px;padding:4px 10px;">Kademe 3</button>
                                </div>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_debt_reminder">â€”
                                </div>
                            </div>
                            <!-- Yearly Charge Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #f39c12;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-calendar-alt" style="color:#f39c12"></i>
                                            YÄ±llÄ±k BorÃ§landÄ±rma</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_yearly_charge" checked
                                            onchange="agentManager.toggleAgent('yearly_charge',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">YÄ±lbaÅŸÄ±nda otomatik
                                    aidat borÃ§landÄ±rmasÄ±</p>
                                <button class="btn btn-primary" onclick="agentManager.runYearlyCharge()"
                                    style="font-size:12px;padding:5px 12px;margin-top:8px;">
                                    <i class="fas fa-play"></i> Åžimdi Ã‡alÄ±ÅŸtÄ±r
                                </button>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_yearly_charge">â€”
                                </div>
                            </div>
                            <!-- Birthday Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #e91e63;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-birthday-cake" style="color:#e91e63"></i>
                                            DoÄŸum GÃ¼nÃ¼</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_birthday" checked
                                            onchange="agentManager.toggleAgent('birthday',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">DoÄŸum gÃ¼nÃ¼ kutlama
                                    mesajÄ± gÃ¶nderir</p>
                                <button class="btn btn-primary" onclick="agentManager.runBirthdayAgent()"
                                    style="font-size:12px;padding:5px 12px;margin-top:8px;background:#e91e63;border-color:#e91e63;">
                                    <i class="fas fa-play"></i> BugÃ¼nÃ¼ Kontrol Et
                                </button>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_birthday">â€”
                                </div>
                            </div>
                            <!-- Accounting Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #00bcd4;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-calculator" style="color:#00bcd4"></i>
                                            Muhasebe</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_accounting" checked
                                            onchange="agentManager.toggleAgent('accounting',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Tahsilat oranÄ±,
                                    aylÄ±k gelir, toplam borÃ§ takibi</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_accounting">â€”
                                </div>
                            </div>
                            <!-- Monthly Report Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #673ab7;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-chart-bar" style="color:#673ab7"></i>
                                            AylÄ±k Rapor</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_monthly_report" checked
                                            onchange="agentManager.toggleAgent('monthly_report',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Ay sonunda mali Ã¶zet
                                    raporu
                                    gÃ¶nderilir (Ayarlarâ†’Agent Mail)</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_monthly_report">â€”
                                </div>
                            </div>
                            <!-- Event Announcement Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #ff5722;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-bullhorn" style="color:#ff5722"></i>
                                            Etkinlik Duyuru</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_event_announce" checked
                                            onchange="agentManager.toggleAgent('event_announce',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">Etkinlik detaylarÄ±nÄ±
                                    Ã¼yelere duyurur</p>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_event_announce">â€”
                                </div>
                            </div>
                            <!-- Seniority Promotion Agent -->
                            <div class="agent-card"
                                style="background:var(--tpjd-light);padding:18px;border-radius:10px;border-left:4px solid #ff9800;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div><strong><i class="fas fa-medal" style="color:#ff9800"></i>
                                            KÄ±dem Terfi</strong></div>
                                    <label class="switch"><input type="checkbox" id="toggle_seniority_promotion" checked
                                            onchange="agentManager.toggleAgent('seniority_promotion',this.checked)"><span
                                            class="slider round"></span></label>
                                </div>
                                <p style="font-size:12px;color:#7f8c8d;margin:8px 0 0;">20+ yÄ±llÄ±k Ã¼yeleri
                                    otomatik onursal Ã¼yeliÄŸe terfi eder</p>
                                <button class="btn btn-primary" onclick="agentManager.runSeniorityAgent()"
                                    style="font-size:12px;padding:5px 12px;margin-top:8px;background:#ff9800;border-color:#ff9800;">
                                    <i class="fas fa-play"></i> Åžimdi Kontrol Et
                                </button>
                                <div style="font-size:11px;color:#9b59b6;margin-top:5px;" id="stat_seniority_promotion">
                                    â€”
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Logs - Single Accordion -->
                    <div
                        style="background:white;border-radius:12px;margin-top:25px;box-shadow:0 5px 20px rgba(0,0,0,0.08);overflow:hidden;">
                        <!-- Accordion Header (clickable) -->
                        <div onclick="document.getElementById('agentLogsBody').style.display = document.getElementById('agentLogsBody').style.display === 'none' ? 'block' : 'none'; this.querySelector('.accordion-chevron').classList.toggle('fa-chevron-down'); this.querySelector('.accordion-chevron').classList.toggle('fa-chevron-up');"
                            style="padding:18px 25px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background 0.15s;"
                            onmouseover="this.style.background='rgba(155,89,182,0.05)'"
                            onmouseout="this.style.background='transparent'">
                            <i class="fas fa-history" style="color:#9b59b6;font-size:18px;"></i>
                            <span style="font-size:16px;font-weight:700;color:var(--tpjd-dark);">Agent Ä°ÅŸlem
                                GeÃ§miÅŸi</span>
                            <span id="agentLogCount"
                                style="background:#9b59b6;color:white;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">0</span>
                            <i class="fas fa-chevron-down accordion-chevron"
                                style="margin-left:auto;color:#95a5a6;transition:transform 0.2s;"></i>
                        </div>

                        <!-- Accordion Body (default hidden) -->
                        <div id="agentLogsBody" style="display:none;">
                            <!-- Filter + Bulk Toolbar -->
                            <div style="padding:0 25px 15px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                                <select id="agentLogFilter" onchange="agentManager.loadLogs()"
                                    style="padding:6px 12px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:13px;background:rgba(255,255,255,0.05);">
                                    <option value="">TÃ¼m Ajanlar</option>
                                    <option value="payment_confirm">Ã–deme Onay</option>
                                    <option value="welcome">HoÅŸ Geldin</option>
                                    <option value="debt_reminder">BorÃ§ HatÄ±rlatma</option>
                                    <option value="yearly_charge">YÄ±llÄ±k BorÃ§landÄ±rma</option>
                                    <option value="birthday">DoÄŸum GÃ¼nÃ¼</option>
                                    <option value="accounting">Muhasebe</option>
                                    <option value="monthly_report">AylÄ±k Rapor</option>
                                    <option value="event_announce">Etkinlik Duyuru</option>
                                </select>

                                <label
                                    style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:13px;color:inherit;">
                                    <input type="checkbox" id="logSelectAll"
                                        onchange="agentManager.toggleSelectAll(this.checked)"
                                        style="width:15px;height:15px;cursor:pointer;">
                                    TÃ¼mÃ¼nÃ¼ SeÃ§
                                </label>
                                <span id="logSelectedCount" style="font-size:12px;color:#95a5a6;">0
                                    seÃ§ili</span>
                                <button onclick="agentManager.deleteSelected()" id="logDeleteSelectedBtn"
                                    style="margin-left:auto;padding:6px 14px;background:#e74c3c;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;display:none;">
                                    <i class="fas fa-trash-alt"></i> SeÃ§ilenleri Sil
                                </button>
                            </div>

                            <!-- Log Table -->
                            <div style="padding:0 25px 20px;overflow-x:auto;">
                                <table style="width:100%;border-collapse:separate;border-spacing:0 4px;">
                                    <thead>
                                        <tr>
                                            <th style="width:30px;padding:8px 6px;"></th>
                                            <th
                                                style="text-align:left;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                                Agent</th>
                                            <th
                                                style="text-align:left;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                                AlÄ±cÄ±</th>
                                            <th
                                                style="text-align:left;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                                Detay</th>
                                            <th
                                                style="text-align:left;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;">
                                                Tarih</th>
                                            <th
                                                style="text-align:center;padding:8px 10px;font-size:12px;color:#95a5a6;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
                                                Durum</th>
                                            <th style="width:40px;padding:8px 6px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="agentLogsTable">
                                        <tr>
                                            <td colspan="7" style="text-align:center;padding:40px;">
                                                <i class="fas fa-robot" style="font-size:48px;color:#bdc3c7;"></i>
                                                <p style="color:#95a5a6;margin-top:10px;">HenÃ¼z agent iÅŸlemi yok
                                                </p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk SMS Modal -->
        <div id="bulkSMSModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2><i class="fas fa-sms"></i> Toplu SMS GÃ¶nder</h2>
                    <span class="close" onclick="closeBulkSMSModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Hedef Grup *</label>
                        <select id="bulkSMSTarget" onchange="updateSMSPreview()">
                            <option value="">-- SeÃ§iniz --</option>
                            <option value="all">TÃ¼m Ãœyeler</option>
                            <option value="debtors">BorÃ§lu Ãœyeler</option>
                            <option value="active">Aktif Ãœyeler (Aidat Ã–deyen)</option>
                            <option value="asil">Asil Ãœyeler</option>
                            <option value="ogrenci">Ã–ÄŸrenci Ãœyeler</option>
                            <option value="fahri">Fahri Ãœyeler</option>
                        </select>
                    </div>

                    <!-- Ã–nizleme AlanÄ± -->
                    <div id="smsPreviewSection"
                        style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #25D366;">
                        <h4 style="margin: 0 0 10px 0; color: var(--tpjd-dark); font-size: 14px;">
                            <i class="fas fa-users"></i> AlÄ±cÄ±lar
                        </h4>
                        <div id="smsRecipientCount"
                            style="font-size: 16px; font-weight: 600; color: #25D366; margin-bottom: 10px;">
                        </div>
                        <details style="cursor: pointer;">
                            <summary style="color: var(--tpjd-primary); font-weight: 600; font-size: 13px;">
                                Telefon numaralarÄ±nÄ± gÃ¶ster</summary>
                            <div id="smsRecipientList"
                                style="max-height: 120px; overflow-y: auto; margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 12px; color: #666;">
                            </div>
                        </details>
                    </div>

                    <div class="form-group">
                        <label>Mesaj Ä°Ã§eriÄŸi *</label>
                        <textarea id="bulkSMSMessage" placeholder="SMS mesajÄ±nÄ±zÄ± buraya yazÄ±n..." rows="6"
                            maxlength="917" oninput="updateSMSCharCount()"></textarea>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <small style="color: #7f8c8d;">
                                <i class="fas fa-info-circle"></i> Maksimum 917 karakter
                            </small>
                            <small id="smsCharCount" style="color: var(--tpjd-primary); font-weight: 600;">0 /
                                917</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ä°YS Filtresi (Ticari Ä°leti)</label>
                        <select id="smsIysFilter">
                            <option value="0">Bilgilendirme (Ä°YS kontrolÃ¼ yok)</option>
                            <option value="11">Ticari - Bireysel (Ä°YS kontrollÃ¼)</option>
                            <option value="12">Ticari - Tacir (Ä°YS kontrollÃ¼)</option>
                        </select>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            <i class="fas fa-exclamation-triangle"></i> Ticari iÃ§erikli mesajlar Ä°YS'den kontrol
                            edilir.
                        </small>
                    </div>
                </div>
                <div class="modal-footer" style="flex-direction: column; gap: 15px;">
                    <div
                        style="width: 100%; padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #25D366;">
                        <strong style="color: #2e7d32; font-size: 14px;">
                            <i class="fas fa-info-circle"></i> SMS GÃ¶nderim Bilgisi
                        </strong>
                        <p style="margin: 8px 0 0 0; font-size: 13px; color: #2e7d32;">
                            SMS gÃ¶nderimi NETGSM Ã¼zerinden gerÃ§ekleÅŸtirilir. GÃ¶nderim Ã¼cretleri NETGSM
                            paketinizden dÃ¼ÅŸÃ¼lÃ¼r.
                        </p>
                    </div>

                    <div style="display: flex; gap: 10px; width: 100%;">
                        <button type="button" class="btn btn-secondary" onclick="closeBulkSMSModal()" style="flex: 1;">
                            <i class="fas fa-times"></i> Ä°ptal
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendBulkSMS()"
                            style="flex: 2; background: #25D366; border-color: #25D366;">
                            <i class="fas fa-paper-plane"></i> SMS GÃ¶nder
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk WhatsApp Wizard Modal -->
        <div id="bulkWhatsAppModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white;">
                    <h2><i class="fab fa-whatsapp"></i> Toplu WhatsApp GÃ¶nder</h2>
                    <span class="close" onclick="closeBulkWhatsAppModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- Step 1: Setup -->
                    <div id="waStep1">
                        <div class="form-group">
                            <label>Hedef Grup *</label>
                            <select id="bulkWATarget" onchange="updateWAPreview()">
                                <option value="">-- SeÃ§iniz --</option>
                                <option value="all">TÃ¼m Ãœyeler</option>
                                <option value="debtors">BorÃ§lu Ãœyeler</option>
                                <option value="active">Aktif Ãœyeler (Aidat Ã–deyen)</option>
                                <option value="asil">Asil Ãœyeler</option>
                                <option value="ogrenci">Ã–ÄŸrenci Ãœyeler</option>
                                <option value="fahri">Fahri Ãœyeler</option>
                            </select>
                        </div>

                        <!-- Recipient Preview -->
                        <div id="waPreviewSection"
                            style="display:none;background:#f0faf4;padding:15px;border-radius:8px;margin:15px 0;border-left:4px solid #25D366;">
                            <h4 style="margin:0 0 10px;color:#2e7d32;font-size:14px;">
                                <i class="fas fa-users"></i> AlÄ±cÄ±lar
                            </h4>
                            <div id="waRecipientCount"
                                style="font-size:16px;font-weight:600;color:#25D366;margin-bottom:5px;"></div>
                            <small id="waNoPhoneWarning" style="color:#e67e22;"></small>
                        </div>

                        <div class="form-group">
                            <label>Mesaj Ä°Ã§eriÄŸi *</label>
                            <textarea id="bulkWAMessage" placeholder="WhatsApp mesajÄ±nÄ±zÄ± yazÄ±n..." rows="5"
                                style="width:100%;padding:10px;border:1px solid var(--tpjd-border);border-radius:6px;font-size:14px;"></textarea>
                            <small style="color:#7f8c8d;"><i class="fas fa-info-circle"></i> *kalÄ±n*, _italik_
                                formatÄ±
                                desteklenir</small>
                        </div>
                    </div>

                    <!-- Step 2: Sending Progress -->
                    <div id="waStep2" style="display:none;">
                        <div style="text-align:center;padding:20px 0;">
                            <div id="waProgressIcon" style="font-size:48px;color:#25D366;margin-bottom:15px;">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <h3 id="waProgressTitle" style="color:var(--tpjd-dark);margin:0 0 10px;">GÃ¶nderime
                                HazÄ±r
                            </h3>
                            <p id="waProgressSubtitle" style="color:#7f8c8d;font-size:14px;"></p>

                            <!-- Progress Bar -->
                            <div
                                style="background:#e9ecef;border-radius:10px;height:12px;margin:20px 0;overflow:hidden;">
                                <div id="waProgressBar"
                                    style="height:100%;background:linear-gradient(90deg,#25D366,#128C7E);border-radius:10px;transition:width 0.3s;width:0%;">
                                </div>
                            </div>
                            <div id="waProgressText" style="font-size:14px;color:var(--tpjd-dark);font-weight:600;">0 /
                                0</div>
                        </div>

                        <!-- Current Recipient Card -->
                        <div id="waCurrentRecipient"
                            style="display:none;background:#f8f9fa;padding:15px;border-radius:10px;margin:15px 0;border:1px solid #e9ecef;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="width:40px;height:40px;border-radius:50%;background:#25D366;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;"
                                    id="waRecipientAvatar"></div>
                                <div>
                                    <div id="waRecipientName"
                                        style="font-weight:600;color:var(--tpjd-dark);font-size:15px;"></div>
                                    <div id="waRecipientPhone" style="color:#7f8c8d;font-size:13px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Sent Log -->
                        <div id="waSentLog" style="max-height:150px;overflow-y:auto;margin-top:10px;"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div
                        style="width:100%;padding:10px 14px;background:#e8f5e9;border-radius:6px;border-left:4px solid #25D366;margin-bottom:12px;">
                        <p style="margin:0;font-size:12px;color:#2e7d32;">
                            <i class="fas fa-info-circle"></i> Mesajlar lokal WhatsApp sunucusu Ã¼zerinden
                            gÃ¶nderilir.
                            Ajanlar sekmesinden WhatsApp baÄŸlantÄ±nÄ±zÄ±n aktif olduÄŸundan emin olun.
                        </p>
                    </div>
                    <div style="display:flex;gap:10px;width:100%;">
                        <button type="button" class="btn btn-secondary" onclick="closeBulkWhatsAppModal()"
                            style="flex:1;">
                            <i class="fas fa-times"></i> <span id="waCancelText">Ä°ptal</span>
                        </button>
                        <button type="button" id="waStartBtn" class="btn btn-success" onclick="startBulkWhatsApp()"
                            style="flex:2;background:#25D366;border-color:#128C7E;">
                            <i class="fab fa-whatsapp"></i> GÃ¶nderime BaÅŸla
                        </button>
                        <button type="button" id="waStopBtn" class="btn btn-danger" onclick="stopBulkWhatsApp()"
                            style="display:none;flex:1;">
                            <i class="fas fa-stop"></i> Durdur
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div id="notificationToast" class="notification"></div>
        <!-- Member Modal -->
        <div id="memberModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-plus"></i> Ãœye Ä°ÅŸlemleri</h2>
                    <span class="close" onclick="closeModal('memberModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="memberForm">
                        <input type="hidden" id="memberId">

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ãœye No *</label>
                                <input type="text" id="memberNo" required placeholder="TPJD001">
                            </div>
                            <div class="form-group">
                                <label>Ãœyelik Tipi *</label>
                                <select id="membershipType" required onchange="updateMembershipType()">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="Asil Ãœye">Asil Ãœye</option>
                                    <option value="Asil Onursal">Asil Onursal</option>
                                    <option value="Ã–ÄŸrenci Ãœye">Ã–ÄŸrenci Ãœye</option>
                                    <option value="Fahri Ãœye">Fahri Ãœye</option>
                                    <option value="Fahri Onursal">Fahri Onursal</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ad *</label>
                                <input type="text" id="firstName" required placeholder="Ad">
                            </div>
                            <div class="form-group">
                                <label>Soyad *</label>
                                <input type="text" id="lastName" required placeholder="Soyad">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>TC Kimlik No *</label>
                                <input type="text" id="tcNo" required placeholder="12345678901" maxlength="11">
                            </div>
                            <div class="form-group">
                                <label>Cinsiyet *</label>
                                <select id="gender" required>
                                    <option value="">SeÃ§iniz</option>
                                    <option value="Erkek">Erkek</option>
                                    <option value="KadÄ±n">KadÄ±n</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>DoÄŸum Tarihi *</label>
                                <input type="date" id="birthDate" required>
                            </div>
                            <div class="form-group">
                                <label>Kan Grubu</label>
                                <select id="bloodType">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="A Rh+">A Rh+</option>
                                    <option value="A Rh-">A Rh-</option>
                                    <option value="B Rh+">B Rh+</option>
                                    <option value="B Rh-">B Rh-</option>
                                    <option value="AB Rh+">AB Rh+</option>
                                    <option value="AB Rh-">AB Rh-</option>
                                    <option value="0 Rh+">0 Rh+</option>
                                    <option value="0 Rh-">0 Rh-</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>E-posta *</label>
                                <input type="email" id="email" required placeholder="ornek@email.com">
                            </div>
                            <div class="form-group">
                                <label>Telefon *</label>
                                <input type="tel" id="phone" required placeholder="+905551234567">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ev Telefonu</label>
                                <input type="tel" id="phoneHome" placeholder="+902121234567">
                            </div>
                            <div class="form-group">
                                <label>Medeni Durum</label>
                                <select id="maritalStatus">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="Bekar">Bekar</option>
                                    <option value="Evli">Evli</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ä°l *</label>
                                <input type="text" id="city" required placeholder="Ä°l" list="cityList">
                                <datalist id="cityList">
                                    <option value="Adana">
                                    <option value="AdÄ±yaman">
                                    <option value="Afyonkarahisar">
                                    <option value="AÄŸrÄ±">
                                    <option value="Aksaray">
                                    <option value="Amasya">
                                    <option value="Ankara">
                                    <option value="Antalya">
                                    <option value="Ardahan">
                                    <option value="Artvin">
                                    <option value="AydÄ±n">
                                    <option value="BalÄ±kesir">
                                    <option value="BartÄ±n">
                                    <option value="Batman">
                                    <option value="Bayburt">
                                    <option value="Bilecik">
                                    <option value="BingÃ¶l">
                                    <option value="Bitlis">
                                    <option value="Bolu">
                                    <option value="Burdur">
                                    <option value="Bursa">
                                    <option value="Ã‡anakkale">
                                    <option value="Ã‡ankÄ±rÄ±">
                                    <option value="Ã‡orum">
                                    <option value="Denizli">
                                    <option value="DiyarbakÄ±r">
                                    <option value="DÃ¼zce">
                                    <option value="Edirne">
                                    <option value="ElazÄ±ÄŸ">
                                    <option value="Erzincan">
                                    <option value="Erzurum">
                                    <option value="EskiÅŸehir">
                                    <option value="Gaziantep">
                                    <option value="Giresun">
                                    <option value="GÃ¼mÃ¼ÅŸhane">
                                    <option value="Hakkari">
                                    <option value="Hatay">
                                    <option value="IÄŸdÄ±r">
                                    <option value="Isparta">
                                    <option value="Ä°stanbul">
                                    <option value="Ä°zmir">
                                    <option value="KahramanmaraÅŸ">
                                    <option value="KarabÃ¼k">
                                    <option value="Karaman">
                                    <option value="Kars">
                                    <option value="Kastamonu">
                                    <option value="Kayseri">
                                    <option value="KÄ±rÄ±kkale">
                                    <option value="KÄ±rklareli">
                                    <option value="KÄ±rÅŸehir">
                                    <option value="Kilis">
                                    <option value="Kocaeli">
                                    <option value="Konya">
                                    <option value="KÃ¼tahya">
                                    <option value="Malatya">
                                    <option value="Manisa">
                                    <option value="Mardin">
                                    <option value="Mersin">
                                    <option value="MuÄŸla">
                                    <option value="MuÅŸ">
                                    <option value="NevÅŸehir">
                                    <option value="NiÄŸde">
                                    <option value="Ordu">
                                    <option value="Osmaniye">
                                    <option value="Rize">
                                    <option value="Sakarya">
                                    <option value="Samsun">
                                    <option value="Siirt">
                                    <option value="Sinop">
                                    <option value="Sivas">
                                    <option value="ÅžanlÄ±urfa">
                                    <option value="ÅžÄ±rnak">
                                    <option value="TekirdaÄŸ">
                                    <option value="Tokat">
                                    <option value="Trabzon">
                                    <option value="Tunceli">
                                    <option value="UÅŸak">
                                    <option value="Van">
                                    <option value="Yalova">
                                    <option value="Yozgat">
                                    <option value="Zonguldak">
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label>Ä°lÃ§e</label>
                                <input type="text" id="district" placeholder="Ä°lÃ§e">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Mahalle</label>
                            <input type="text" id="neighborhood" placeholder="Mahalle">
                        </div>

                        <div class="form-group">
                            <label>Adres *</label>
                            <textarea id="address" required placeholder="Tam adres"></textarea>
                        </div>



                        <div class="form-row">
                            <div class="form-group">
                                <label>Mezuniyet</label>
                                <input type="text" id="graduation" placeholder="Ãœniversite adÄ±">
                            </div>
                            <div class="form-group">
                                <label>Mezuniyet YÄ±lÄ±</label>
                                <input type="text" id="graduationYear" placeholder="2020">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ä°ÅŸ Durumu</label>
                                <select id="employmentStatus">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="Ã‡alÄ±ÅŸÄ±yor">Ã‡alÄ±ÅŸÄ±yor</option>
                                    <option value="Ã–ÄŸrenci">Ã–ÄŸrenci</option>
                                    <option value="Emekli">Emekli</option>
                                    <option value="Ä°ÅŸsiz">Ä°ÅŸsiz</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ä°ÅŸ Yeri</label>
                                <input type="text" id="workplace" placeholder="Åžirket adÄ±">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Pozisyon</label>
                            <input type="text" id="position" placeholder="Ãœnvan">
                        </div>



                        <div class="form-group">
                            <label>KayÄ±t Tarihi</label>
                            <input type="date" id="registrationDate" required>
                        </div>



                        <div class="form-group">
                            <label>Notlar</label>
                            <textarea id="notes" placeholder="Ãœye ile ilgili notlar..." rows="3"></textarea>
                        </div>

                        <div class="form-group checkbox-inline">
                            <input type="checkbox" id="aidatAktif" checked onchange="toggleAidatBedelField()">
                            <label for="aidatAktif">Aidat Aktif (Her yÄ±l otomatik aidat borcu
                                oluÅŸturulacak)</label>
                        </div>

                        <div id="aidatBedelContainer" class="form-group"
                            style="display: none; margin-top: 10px; padding: 12px; background: rgba(241,196,15,0.1); border-radius: 8px; border-left: 4px solid #f1c40f;">
                            <label><i class="fas fa-coins" style="color: #f39c12;"></i> Cari YÄ±l Aidat Bedeli
                                (â‚º)</label>
                            <input type="number" id="manuelAidatBedel" min="0" step="1"
                                placeholder="Ayarlardan otomatik Ã§ekilir">
                            <small style="color: #7f8c8d;">BoÅŸ bÄ±rakÄ±rsanÄ±z ayarlardaki varsayÄ±lan tutar
                                kullanÄ±lÄ±r.
                                Manuel deÄŸiÅŸtirmek iÃ§in yazÄ±n.</small>
                        </div>

                        <div class="form-group checkbox-inline">
                            <input type="checkbox" id="gecmisYillarBorclandir" onchange="toggleYearSelection()">
                            <label for="gecmisYillarBorclandir">GeÃ§miÅŸ YÄ±llardan BorÃ§landÄ±r</label>
                        </div>

                        <div id="yearSelectionContainer" style="display: none;">
                            <div class="form-group">
                                <label>BorÃ§landÄ±rÄ±lacak YÄ±llarÄ± SeÃ§in:</label>
                                <div class="year-selection-grid" id="yearSelectionGrid">
                                    <!-- Years will be dynamically generated here -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('memberModal')">
                        <i class="fas fa-times"></i> Ä°ptal
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveMember()">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="paymentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-money-bill-wave"></i> Ã–deme Ä°ÅŸlemleri</h2>
                    <span class="close" onclick="closeModal('paymentModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId">

                        <div class="form-group">
                            <label>Ãœye SeÃ§in *</label>
                            <select id="paymentMemberId" required onchange="updatePaymentAmount()">
                                <option value="">Ãœye seÃ§iniz</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ã–deme Tipi *</label>
                                <select id="paymentType" required>
                                    <option value="aidat">Aidat</option>
                                    <option value="baÄŸÄ±ÅŸ">BaÄŸÄ±ÅŸ</option>
                                    <option value="diÄŸer">DiÄŸer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>YÄ±l *</label>
                                <input type="number" id="paymentYear" required min="2000" max="2100">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tutar (â‚º) *</label>
                                <input type="number" id="paymentAmount" required step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>Tarih *</label>
                                <input type="date" id="paymentDate" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>FiÅŸ No</label>
                            <input type="text" id="receiptNo" placeholder="FÄ°Åž001">
                        </div>

                        <div class="form-group">
                            <label>AÃ§Ä±klama *</label>
                            <textarea id="paymentDescription" required placeholder="Ã–deme aÃ§Ä±klamasÄ±"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Durum *</label>
                            <select id="paymentStatus" required>
                                <option value="tamamlandÄ±">Ã–dendi</option>
                                <option value="bekliyor">Ã–denmedi</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">
                        <i class="fas fa-times"></i> Ä°ptal
                    </button>
                    <button type="button" class="btn btn-success" onclick="savePayment()">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </div>
        </div>
        <!-- Notification Modal (UPDATED) -->
        <div id="notificationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-bell"></i> Bildirim GÃ¶nder</h2>
                    <span class="close" onclick="closeModal('notificationModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="notificationForm">
                        <div class="form-group">
                            <label>GÃ¶nderim TÃ¼rÃ¼ *</label>
                            <select id="notificationType" required onchange="toggleRecipientSelection()">
                                <option value="">SeÃ§iniz</option>
                                <option value="group">Hedef Grup</option>
                                <option value="individual">Bireysel</option>
                            </select>
                        </div>

                        <!-- Hedef Grup SeÃ§imi -->
                        <div id="groupSelectionContainer" style="display: none;">
                            <div class="form-group">
                                <label>Hedef Grup *</label>
                                <select id="targetGroup">
                                    <option value="all">TÃ¼m Ãœyeler</option>
                                    <option value="active">Aidat Aktif Ãœyeler</option>
                                    <option value="inactive">Aidat Pasif Ãœyeler</option>
                                    <option value="paid">Bu YÄ±l Ã–deme Yapan Ãœyeler</option>
                                    <option value="unpaid">Bu YÄ±l Ã–deme Yapmayan Ãœyeler</option>
                                    <option value="asil">Asil Ãœyeler</option>
                                    <option value="asil-onursal">Asil Onursal Ãœyeler</option>
                                    <option value="ogrenci">Ã–ÄŸrenci Ãœyeler</option>
                                    <option value="fahri">Fahri Ãœyeler</option>
                                    <option value="fahri-onursal">Fahri Onursal Ãœyeler</option>
                                </select>
                            </div>
                        </div>

                        <!-- Bireysel Ãœye SeÃ§imi -->
                        <div id="individualSelectionContainer" style="display: none;">
                            <!-- SeÃ§ili Ã¼ye gÃ¶sterimi -->
                            <div id="preSelectedMemberInfo" style="display: none;">
                                <div class="form-group"
                                    style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid var(--tpjd-success);">
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <i class="fas fa-user-check" style="color: var(--tpjd-success);"></i>
                                        <strong>SeÃ§ili Ãœye</strong>
                                    </label>
                                    <div id="preSelectedMemberName"
                                        style="font-size: 16px; color: var(--tpjd-dark); font-weight: 600;">
                                    </div>
                                    <button type="button" class="btn btn-secondary"
                                        onclick="changeNotificationRecipient()"
                                        style="margin-top: 10px; padding: 5px 15px; font-size: 13px;">
                                        <i class="fas fa-exchange-alt"></i> FarklÄ± Ãœye SeÃ§
                                    </button>
                                </div>
                            </div>

                            <!-- Normal Ã¼ye seÃ§im alanÄ± -->
                            <div id="normalMemberSelection">
                                <div class="form-group">
                                    <label>Ãœye Ara</label>
                                    <input type="text" id="memberSearchInput"
                                        placeholder="Ãœye adÄ±, soyadÄ± veya Ã¼ye no ile ara..."
                                        oninput="searchMemberForNotification()">
                                </div>

                                <div class="form-group">
                                    <label>Ãœye SeÃ§in *</label>
                                    <select id="individualMemberId" size="5" style="height: 150px;">
                                        <option value="">Ãœye seÃ§iniz</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Bildirim BaÅŸlÄ±ÄŸÄ± *</label>
                            <input type="text" id="notificationTitle" required placeholder="Bildirim baÅŸlÄ±ÄŸÄ±">
                        </div>

                        <div class="form-group">
                            <label>Bildirim MesajÄ± *</label>
                            <textarea id="notificationMessage" required placeholder="Bildirim mesajÄ±..."
                                rows="6"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Ã–ncelik</label>
                            <select id="notificationPriority">
                                <option value="normal">Normal</option>
                                <option value="high">YÃ¼ksek</option>
                                <option value="urgent">Acil</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="flex-direction: column; gap: 15px;">
                    <!-- Bireysel GÃ¶nderim Ä°Ã§in Ã–zel Butonlar -->
                    <div id="individualSendButtons" style="display: none; width: 100%;">
                        <div
                            style="width: 100%; padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196F3; margin-bottom: 15px;">
                            <strong style="color: #1565C0; font-size: 14px;">
                                <i class="fas fa-info-circle"></i> Bireysel Ä°letiÅŸim
                            </strong>
                            <p style="margin: 8px 0 0 0; font-size: 13px; color: #1565C0;">
                                MesajÄ±nÄ±z seÃ§tiÄŸiniz kanal Ã¼zerinden gÃ¶nderilecek.
                            </p>
                        </div>

                        <div style="display: flex; gap: 10px; width: 100%;">
                            <button type="button" class="btn" onclick="sendViaWhatsAppIndividual()"
                                style="flex:1; background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;">
                                <i class="fab fa-whatsapp" style="font-size: 18px;"></i>
                                <span>WhatsApp</span>
                            </button>
                            <button type="button" class="btn" onclick="sendViaEmailIndividual()"
                                style="flex:1; background: #EA4335; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;">
                                <i class="fas fa-envelope" style="font-size: 18px;"></i>
                                <span>E-posta</span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')"
                                style="padding: 10px 16px;">
                                <i class="fas fa-times"></i> Ä°ptal
                            </button>
                        </div>
                    </div>

                    <!-- Grup GÃ¶nderimi Ä°Ã§in Normal Butonlar -->
                    <div id="groupSendButtons" style="width: 100%;">
                        <!-- GÃ¶nderim KanallarÄ± -->
                        <div
                            style="margin-bottom:15px;padding:12px;background:rgba(52,152,219,0.08);border-radius:8px;border-left:4px solid #3498db;">
                            <label
                                style="display:block;font-weight:600;font-size:13px;color:var(--tpjd-dark);margin-bottom:10px;">
                                <i class="fas fa-share-alt" style="color:#3498db;"></i> GÃ¶nderim KanallarÄ±
                            </label>
                            <div style="display:flex;gap:15px;flex-wrap:wrap;">
                                <label
                                    style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;color:var(--tpjd-dark);">
                                    <input type="checkbox" id="channelEmail" checked
                                        style="width:18px;height:18px;accent-color:#EA4335;">
                                    ðŸ“§ E-posta
                                </label>
                                <label
                                    style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;color:var(--tpjd-dark);">
                                    <input type="checkbox" id="channelWhatsApp"
                                        style="width:18px;height:18px;accent-color:#25D366;">
                                    ðŸ’¬ WhatsApp
                                </label>
                                <label
                                    style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;color:var(--tpjd-dark);">
                                    <input type="checkbox" id="channelSMS"
                                        style="width:18px;height:18px;accent-color:#ff9800;">
                                    ðŸ“± SMS
                                </label>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')"
                                style="flex: 1;">
                                <i class="fas fa-times"></i> Ä°ptal
                            </button>
                            <button type="button" class="btn btn-primary" onclick="sendNotification()" style="flex: 2;">
                                <i class="fas fa-paper-plane"></i> Bildirim GÃ¶nder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Email Modal -->
        <div id="bulkEmailModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2><i class="fas fa-envelope"></i> Toplu E-posta GÃ¶nder</h2>
                    <span class="close" onclick="closeBulkEmailModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Hedef Grup *</label>
                        <select id="bulkEmailTarget" onchange="updateEmailPreview()">
                            <option value="">-- SeÃ§iniz --</option>
                            <option value="all">TÃ¼m Ãœyeler</option>
                            <option value="paid" id="bulkEmailPaidOption">Aidat Ã–deyenler</option>
                            <option value="unpaid">Aidat Ã–demeyenler (BorÃ§lular)</option>
                        </select>
                    </div>

                    <!-- Ã–nizleme AlanÄ± -->
                    <div id="emailPreviewSection"
                        style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--tpjd-info);">
                        <h4 style="margin: 0 0 10px 0; color: var(--tpjd-dark); font-size: 14px;">
                            <i class="fas fa-users"></i> AlÄ±cÄ±lar
                        </h4>
                        <div id="emailRecipientCount"
                            style="font-size: 16px; font-weight: 600; color: var(--tpjd-info); margin-bottom: 10px;">
                        </div>
                        <details style="cursor: pointer;">
                            <summary style="color: var(--tpjd-primary); font-weight: 600; font-size: 13px;">
                                E-posta adreslerini gÃ¶ster</summary>
                            <div id="emailRecipientList"
                                style="max-height: 120px; overflow-y: auto; margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 12px; color: #666;">
                            </div>
                        </details>
                    </div>

                    <div class="form-group">
                        <label>Konu *</label>
                        <input type="text" id="bulkEmailSubject" placeholder="E-posta konusu (Ã¶rn: Aidat HatÄ±rlatmasÄ±)"
                            maxlength="100">
                    </div>

                    <div class="form-group">
                        <label>Mesaj *</label>
                        <textarea id="bulkEmailMessage" placeholder="E-posta mesajÄ±nÄ±zÄ± buraya yazÄ±n..." rows="6"
                            maxlength="2000"></textarea>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Not: Ã‡ok uzun mesajlar mail programlarÄ±nda
                            kesilme yapabilir.
                        </small>
                    </div>
                </div>
                <div class="modal-footer" style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeBulkEmailModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> Ä°ptal
                    </button>
                    <button type="button" class="btn btn-success" onclick="sendBulkEmailDirect()"
                        style="flex: 2; background: #27ae60; border-color: #27ae60;">
                        <i class="fas fa-paper-plane"></i> GÃ¶nder
                    </button>
                </div>
            </div>
        </div>

        <!-- Event Announcement Modal -->
        <div id="eventModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #ff5722, #ff9800);">
                    <h2 style="color: white;"><i class="fas fa-bullhorn"></i> Etkinlik Duyurusu</h2>
                    <span class="close" onclick="closeModal('eventModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label><i class="fas fa-heading" style="color:#ff5722"></i> Etkinlik AdÄ± *</label>
                        <input type="text" id="eventTitle" placeholder="Ã–rn: TPJD 2026 YÄ±llÄ±k KonferansÄ±"
                            maxlength="150">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label><i class="fas fa-calendar-alt" style="color:#e67e22"></i> Tarih *</label>
                            <input type="date" id="eventDate">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-clock" style="color:#e67e22"></i> Saat</label>
                            <input type="time" id="eventTime" value="10:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt" style="color:#e74c3c"></i> Konum</label>
                        <input type="text" id="eventLocation" placeholder="Ã–rn: Ankara, TPJD Konferans Salonu">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-align-left" style="color:#3498db"></i> Etkinlik AÃ§Ä±klamasÄ±
                            *</label>
                        <textarea id="eventDescription" placeholder="Etkinlik hakkÄ±nda detaylÄ± bilgi yazÄ±n..." rows="5"
                            maxlength="3000"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-users" style="color:#9b59b6"></i> Hedef Kitle</label>
                        <select id="eventTarget">
                            <option value="all">TÃ¼m Aktif Ãœyeler</option>
                            <option value="paid">AidatÄ±nÄ± Ã–deyenler</option>
                        </select>
                    </div>
                    <!-- AlÄ±cÄ± Ã–nizleme -->
                    <div id="eventRecipientPreview"
                        style="background: #f0f9ff; padding: 12px 16px; border-radius: 8px; border-left: 4px solid #3498db; margin-top: 10px;">
                        <i class="fas fa-info-circle" style="color:#3498db"></i>
                        <span id="eventRecipientCount" style="font-weight:600; color:#2c3e50;">YÃ¼kleniyor...</span>
                    </div>
                    <!-- GÃ¶nderim KanalÄ± -->
                    <div class="form-group" style="margin-top:15px;">
                        <label><i class="fas fa-share-alt" style="color:#16a085"></i> GÃ¶nderim KanalÄ±</label>
                        <div style="display:flex;gap:20px;margin-top:8px;">
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                                <input type="radio" name="eventChannel" value="email" checked>
                                <i class="fas fa-envelope" style="color:#3498db"></i> E-posta
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                                <input type="radio" name="eventChannel" value="whatsapp">
                                <i class="fab fa-whatsapp" style="color:#25D366"></i> WhatsApp
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                                <input type="radio" name="eventChannel" value="both">
                                <i class="fas fa-layer-group" style="color:#9b59b6"></i> Her Ä°kisi
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('eventModal')" style="flex:1;">
                        <i class="fas fa-times"></i> Ä°ptal
                    </button>
                    <button type="button" class="btn" id="sendEventBtn" onclick="sendEventAnnouncement()"
                        style="flex:2; background:#ff5722; color:white; border-color:#ff5722;">
                        <i class="fas fa-paper-plane"></i> Duyuru GÃ¶nder
                    </button>
                </div>
            </div>
        </div>

        <!-- Member Detail Modal (UPDATED WITH NOTIFICATION BUTTON) -->
        <div id="memberDetailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user"></i> Ãœye DetaylarÄ±</h2>
                    <span class="close" onclick="closeModal('memberDetailModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="memberDetailContent">
                        <!-- Member details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('memberDetailModal')">
                        <i class="fas fa-times"></i> Kapat
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addPaymentForCurrentMember()"
                        title="Bu Ã¼ye iÃ§in Ã¶deme ekle">
                        <i class="fas fa-plus-circle"></i> Ã–deme Ekle
                    </button>
                    <button type="button" class="btn btn-warning" onclick="sendNotificationToCurrentMember()">
                        <i class="fas fa-bell"></i> Bildirim GÃ¶nder
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadMemberDetail()"
                        id="downloadDetailBtn">
                        <i class="fas fa-download"></i> HTML Ä°ndir
                    </button>
                </div>
            </div>
        </div>

        <!-- Direct Notify Modal (Ãœye Detay â†’ Bildirim GÃ¶nder) -->
        <div id="directNotifyModal" class="modal">
            <div class="modal-content" style="max-width: 560px;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white;">
                    <h2><i class="fas fa-paper-plane"></i> Bildirim GÃ¶nder</h2>
                    <span class="close" onclick="closeModal('directNotifyModal')" style="color: white;">&times;</span>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <!-- Ãœye Bilgisi -->
                    <div id="directNotifyMemberInfo"
                        style="background: linear-gradient(135deg, #1a2332, #2c3e50); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                        <div
                            style="background: var(--tpjd-primary); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div id="directNotifyMemberName" style="font-weight: 700; font-size: 16px;"></div>
                            <div id="directNotifyMemberDebt" style="font-size: 13px; opacity: 0.8; margin-top: 3px;">
                            </div>
                        </div>
                    </div>

                    <!-- Kanal SeÃ§imi -->
                    <label style="font-weight: 600; color: var(--tpjd-dark); margin-bottom: 10px; display: block;">
                        <i class="fas fa-broadcast-tower"></i> GÃ¶nderim KanallarÄ±
                    </label>
                    <div id="directNotifyChannels"
                        style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    </div>

                    <!-- Konu -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="font-weight: 600;"><i class="fas fa-tag"></i> Konu</label>
                        <input type="text" id="directNotifySubject" value="Aidat HatÄ±rlatma"
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 14px;">
                    </div>

                    <!-- Mesaj -->
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-weight: 600;"><i class="fas fa-comment-alt"></i> Mesaj</label>
                        <textarea id="directNotifyMessage" rows="8"
                            style="width: 100%; padding: 12px 14px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; line-height: 1.6;"></textarea>
                    </div>

                    <!-- GÃ¶nderim SonuÃ§larÄ± -->
                    <div id="directNotifyResults" style="display: none; margin-top: 15px;"></div>
                </div>
                <div class="modal-footer" style="padding: 15px 20px; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('directNotifyModal')">
                        <i class="fas fa-times"></i> Ä°ptal
                    </button>
                    <button type="button" id="directNotifySendBtn" class="btn btn-primary"
                        onclick="sendDirectNotification()"
                        style="flex: 2; background: linear-gradient(135deg, #e67e22, #d35400); border: none; font-weight: 600;">
                        <i class="fas fa-paper-plane"></i> GÃ¶nder
                    </button>
                </div>
            </div>
        </div>

        <script>
            // IMMEDIATE DEBUG MODE
            window.addEventListener('error', e => {
                console.error("Global JS Error:", e.error || e.message);
                alert("JS HatasÄ±: " + e.message);
            });
            window.addEventListener('unhandledrejection', e => {
                console.error("Unhandled Promise Rejection:", e.reason);
                alert("Promise HatasÄ±: " + (e.reason?.message || e.reason));
            });

            // API Configuration - dynamically determine based on current path
            const pathParts = window.location.pathname.split('/');
            const basePath = pathParts.slice(0, -1).join('/') || '';
            const API_BASE = basePath + "/api";
            console.log("API_BASE initialized as:", API_BASE);

            // â”€â”€â”€ Global Fetch Wrapper (Session Auth) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // TÃ¼m fetch Ã§aÄŸrÄ±larÄ±na credentials:'same-origin' ekler
            // 401 yanÄ±tlarÄ±nda otomatik login'e yÃ¶nlendirir
            const _origFetch = window.fetch;
            window.fetch = function (url, options = {}) {
                options.credentials = 'same-origin';
                return _origFetch.call(this, url, options).then(response => {
                    if (response.status === 401 && !url.includes('login.php')) {
                        console.warn('Session expired, redirecting to login');
                        isAuthenticated = false;
                        localStorage.removeItem('tpjd_isAuthenticated');
                        localStorage.removeItem('tpjd_adminUsername');
                        document.getElementById('loginContainer').style.display = 'flex';
                        document.getElementById('mainApp').classList.remove('show');
                        showNotification('Oturum sÃ¼resi doldu. LÃ¼tfen tekrar giriÅŸ yapÄ±n.', 'warning');
                    }
                    return response;
                });
            };

            // Global variables
            let members = [];
            let payments = [];
            let notifications = [];
            let debtors = [];
            let adminUsername = '';
            let aidatSettings = {};
            let historicalAidatSettings = {};
            let settings = {}; // Store all settings including NETGSM

            let currentMemberId = null;
            let membershipDonutChart = null;
            let isAuthenticated = false;
            let lastDebtYearMemory = null;

            // Aidat tutarlarÄ± (boÅŸ olarak baÅŸlatÄ±lÄ±yor, MySQL'den yÃ¼klenecek)


            // Login function
            async function login(event) {
                if (event) event.preventDefault();

                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const response = await fetch(`${API_BASE}/login.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const result = await response.json();

                    if (result.success) {
                        isAuthenticated = true;
                        localStorage.setItem('tpjd_isAuthenticated', 'true');
                        localStorage.setItem('tpjd_adminUsername', username);

                        document.getElementById('loginContainer').style.display = 'none';
                        document.getElementById('mainApp').classList.add('show');

                        initializeDonutCharts();
                        updateSettingsInfo();
                        loadAllData();
                    } else {
                        alert('HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!');
                        document.getElementById('loginError').classList.add('show');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('GiriÅŸ sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.');
                    document.getElementById('loginError').classList.add('show');
                }
            }

            // Logout function
            function logout() {
                if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
                    // Sunucu session'Ä±nÄ± da sonlandÄ±r
                    fetch(`${API_BASE}/login.php?action=logout`).catch(() => { });
                    isAuthenticated = false;
                    localStorage.removeItem('tpjd_isAuthenticated');
                    localStorage.removeItem('tpjd_adminUsername');
                    window.location.reload();
                }
            }

            // Update settings info
            function updateSettingsInfo() {
                const totalMembers = members ? members.length : 0;
                const totalPayments = payments ? payments.length : 0;

                document.getElementById('settingsTotalMembers').textContent = totalMembers;
                document.getElementById('settingsTotalPayments').textContent = totalPayments;

                // Load aidat settings
                loadAidatSettingsToForm();
            }

            // Backward-compatible helper (was missing); reuses existing populateSettingsForm
            function loadAidatSettingsToForm() {
                populateSettingsForm();
            }

            // Aidat AyarlarÄ± FonksiyonlarÄ±
            async function loadAllSettings() {
                try {
                    const response = await fetch(`${API_BASE}/settings.php?action=all`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        // Store all settings globally
                        settings = result.data;
                        // Load aidat settings
                        if (result.data.aidat_settings) {
                            aidatSettings = result.data.aidat_settings;
                        }
                        // Load historical settings if available
                        if (result.data.historical_aidat_settings) {
                            historicalAidatSettings = result.data.historical_aidat_settings;
                        }
                        // Load admin username to display in settings form
                        if (result.data.admin_username) {
                            adminUsername = result.data.admin_username;
                        }
                        populateSettingsForm();
                    } else {
                        console.error('Settings could not be loaded.');
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }

            // ===== Agent Mail AyarlarÄ± =====
            function saveAgentEmailSettings() {
                const monthlyEmails = document.getElementById('settingMonthlyEmails').value.trim();
                const notifyEmails = document.getElementById('settingNotifyEmails').value.trim();
                const presidentEmail = document.getElementById('settingPresidentEmail').value.trim();
                const treasurerEmail = document.getElementById('settingTreasurerEmail').value.trim();
                const secretaryEmail = document.getElementById('settingSecretaryEmail').value.trim();

                const settings = {
                    monthly_report_recipients: monthlyEmails.split(',').map(e => e.trim()).filter(e => e),
                    notify_recipients: notifyEmails.split(',').map(e => e.trim()).filter(e => e),
                    president_email: presidentEmail,
                    treasurer_email: treasurerEmail,
                    secretary_email: secretaryEmail
                };

                localStorage.setItem('agentEmailSettings', JSON.stringify(settings));

                // Also save to API
                fetch('api/agents.php?action=save_email_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                }).then(r => r.json()).then(res => {
                    showNotification('Agent mail ayarlarÄ± kaydedildi!', 'success');
                }).catch(e => {
                    // At least localStorage has it
                    showNotification('Ayarlar yerel olarak kaydedildi', 'success');
                });
            }

            function loadAgentEmailSettings() {
                const saved = localStorage.getItem('agentEmailSettings');
                if (!saved) return;
                try {
                    const s = JSON.parse(saved);
                    if (s.monthly_report_recipients) document.getElementById('settingMonthlyEmails').value = s.monthly_report_recipients.join(', ');
                    if (s.notify_recipients) document.getElementById('settingNotifyEmails').value = s.notify_recipients.join(', ');
                    if (s.president_email) document.getElementById('settingPresidentEmail').value = s.president_email;
                    if (s.treasurer_email) document.getElementById('settingTreasurerEmail').value = s.treasurer_email;
                    if (s.secretary_email) document.getElementById('settingSecretaryEmail').value = s.secretary_email;
                } catch (e) { console.warn('Agent email settings parse error', e); }
            }

            function addQuickEmailsToMonthly() {
                const fields = ['settingPresidentEmail', 'settingTreasurerEmail', 'settingSecretaryEmail'];
                const textarea = document.getElementById('settingMonthlyEmails');
                const existing = textarea.value.split(',').map(e => e.trim()).filter(e => e);

                let added = 0;
                fields.forEach(id => {
                    const email = document.getElementById(id).value.trim();
                    if (email && !existing.includes(email)) {
                        existing.push(email);
                        added++;
                    }
                });

                textarea.value = existing.join(', ');
                if (added > 0) {
                    showNotification(added + ' kiÅŸi eklendi!', 'success');
                } else {
                    showNotification('Eklenecek yeni adres bulunamadÄ±', 'warning');
                }
            }

            // Load on page ready
            document.addEventListener('DOMContentLoaded', loadAgentEmailSettings);



            // ===== Sunucu Yedekleme FonksiyonlarÄ± =====
            async function createServerBackup() {
                const resultDiv = document.getElementById('serverBackupResult');
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(52,152,219,0.1)';
                resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yedek oluÅŸturuluyor...';
                try {
                    const res = await fetch(API_BASE + '/backup.php?action=create', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        resultDiv.style.background = 'rgba(39,174,96,0.1)';
                        resultDiv.innerHTML = '<i class="fas fa-check-circle" style="color:#27ae60;"></i> ' + data.message;
                        showNotification('Yedek oluÅŸturuldu!', 'success');
                        loadServerBackups();
                    } else {
                        resultDiv.style.background = 'rgba(231,76,60,0.1)';
                        resultDiv.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> ' + data.message;
                    }
                } catch (e) {
                    resultDiv.style.background = 'rgba(231,76,60,0.1)';
                    resultDiv.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> Hata: ' + e.message;
                }
            }

            async function loadServerBackups() {
                const container = document.getElementById('serverBackupList');
                if (!container) return;
                try {
                    const res = await fetch(API_BASE + '/backup.php?action=list');
                    const data = await res.json();
                    if (data.success && data.data && data.data.length > 0) {
                        let html = '<table style="width:100%; font-size:12px; border-collapse:collapse;">';
                        html += '<tr style="background:#e8e8e8;"><th style="padding:6px;text-align:left;">Dosya</th><th style="padding:6px;">Boyut</th><th style="padding:6px;">Tarih</th><th style="padding:6px;">Ä°ÅŸlem</th></tr>';
                        data.data.forEach(b => {
                            html += '<tr style="border-bottom:1px solid #eee;">';
                            html += '<td style="padding:5px;"><i class="fas fa-file-archive" style="color:#27ae60;"></i> ' + b.filename + '</td>';
                            html += '<td style="padding:5px;text-align:center;">' + b.size_kb + ' KB</td>';
                            html += '<td style="padding:5px;text-align:center;">' + b.created_at + '</td>';
                            html += '<td style="padding:5px;text-align:center;">';
                            html += '<a href="' + API_BASE + '/backup.php?action=download&file=' + b.filename + '" style="color:#3498db;margin-right:10px;" title="Ä°ndir"><i class="fas fa-download"></i></a>';
                            html += '<a href="#" onclick="deleteServerBackup(\'' + b.filename + '\');return false;" style="color:#e74c3c;" title="Sil"><i class="fas fa-trash"></i></a>';
                            html += '</td></tr>';
                        });
                        html += '</table>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">HenÃ¼z yedek yok</p>';
                    }
                } catch (e) {
                    container.innerHTML = '<p style="color:#95a5a6;text-align:center;">Yedekler yÃ¼klenemedi</p>';
                }
            }

            async function deleteServerBackup(filename) {
                if (!confirm('Bu yedeÄŸi silmek istediÄŸinize emin misiniz?\n' + filename)) return;
                try {
                    const res = await fetch(API_BASE + '/backup.php?action=delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file: filename })
                    });
                    const data = await res.json();
                    if (data.success) {
                        showNotification('Yedek silindi', 'success');
                        loadServerBackups();
                    } else {
                        showNotification('Hata: ' + data.message, 'error');
                    }
                } catch (e) {
                    showNotification('Silme hatasÄ±: ' + e.message, 'error');
                }
            }

            // Settings sekmesinde Yedekleme verilerini yÃ¼kle
            const origShowTab = window.showTab;
            if (typeof origShowTab === 'function') {
                window.showTab = function (tabName) {
                    origShowTab(tabName);
                    if (tabName === 'settings') {
                        loadServerBackups();
                    }
                };
            }

            async function saveAllSettings() {
                const newUsername = document.getElementById('newUsername').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;

                if (!newUsername) {
                    showNotification('KullanÄ±cÄ± adÄ± boÅŸ olamaz!', 'warning');
                    return;
                }

                if (newPassword && newPassword.length < 6) {
                    showNotification('Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r!', 'warning');
                    return;
                }

                if (newPassword !== newPasswordConfirm) {
                    showNotification('Yeni ÅŸifreler eÅŸleÅŸmiyor!', 'warning');
                    return;
                }

                const settingsToSave = {
                    aidat_settings: {
                        'Asil Ãœye': parseFloat(document.getElementById('aidatAsilUye').value) || 0,
                        'Asil Onursal': parseFloat(document.getElementById('aidatAsilOnursal').value) || 0,
                        'Ã–ÄŸrenci Ãœye': parseFloat(document.getElementById('aidatOgrenciUye').value) || 0,
                        'Fahri Ãœye': parseFloat(document.getElementById('aidatFahriUye').value) || 0,
                        'Fahri Onursal': parseFloat(document.getElementById('aidatFahriOnursal').value) || 0
                    },
                    admin_username: newUsername,
                    admin_password: newPassword // Send empty string if not changed, server will ignore it
                };

                try {
                    const response = await fetch(`${API_BASE}/settings.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settingsToSave)
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Ayarlar baÅŸarÄ±yla kaydedildi!', 'success');
                        adminUsername = newUsername; // Update global variable
                        await loadAllSettings(); // Reload settings from DB
                    } else {
                        showNotification('Ayarlar kaydedilirken hata oluÅŸtu: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showNotification('Ayarlar kaydedilirken bir aÄŸ hatasÄ± oluÅŸtu.', 'error');
                }
            }

            async function saveIbanSettings() {
                const ibanData = {
                    iban_settings: {
                        banka_adi: document.getElementById('ibanBankaAdi').value.trim(),
                        hesap_sahibi: document.getElementById('ibanHesapSahibi').value.trim(),
                        iban: document.getElementById('ibanNumarasi').value.trim(),
                        aciklama: document.getElementById('ibanAciklama').value.trim()
                    }
                };
                try {
                    const response = await fetch(`${API_BASE}/settings.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ibanData)
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification('âœ… IBAN bilgileri kaydedildi!', 'success');
                        await loadAllSettings();
                    } else {
                        showNotification('âŒ IBAN kaydetme hatasÄ±: ' + result.message, 'error');
                    }
                } catch (error) {
                    showNotification('âŒ AÄŸ hatasÄ±', 'error');
                }
            }


            function populateSettingsForm() {
                // Populate aidat settings from MySQL data
                document.getElementById('aidatAsilUye').value = aidatSettings['Asil Ãœye'] || 0;
                document.getElementById('aidatAsilOnursal').value = aidatSettings['Asil Onursal'] || 0;
                document.getElementById('aidatOgrenciUye').value = aidatSettings['Ã–ÄŸrenci Ãœye'] || 0;
                document.getElementById('aidatFahriUye').value = aidatSettings['Fahri Ãœye'] || 0;
                document.getElementById('aidatFahriOnursal').value = aidatSettings['Fahri Onursal'] || 0;

                // Populate credentials
                document.getElementById('currentUsername').value = adminUsername;
                document.getElementById('newUsername').value = adminUsername;
                document.getElementById('newPassword').value = '';
                document.getElementById('newPasswordConfirm').value = '';

                // Set current year as default
                const currentYear = new Date().getFullYear();
                document.getElementById('borclandirmaYili').value = currentYear;

                // Populate NETGSM settings if available
                populateNetgsmSettings();

                // Populate IBAN settings
                const ibanSettings = settings && settings.iban_settings ? settings.iban_settings : {};
                document.getElementById('ibanBankaAdi').value = ibanSettings.banka_adi || '';
                document.getElementById('ibanHesapSahibi').value = ibanSettings.hesap_sahibi || '';
                document.getElementById('ibanNumarasi').value = ibanSettings.iban || '';
                document.getElementById('ibanAciklama').value = ibanSettings.aciklama || '';
            }

            // NETGSM Settings Functions
            function populateNetgsmSettings() {
                const netgsmSettings = settings && settings.netgsm_settings ? settings.netgsm_settings : {};
                document.getElementById('netgsmUsername').value = netgsmSettings.username || '';
                document.getElementById('netgsmPassword').value = netgsmSettings.password || '';
                document.getElementById('netgsmHeader').value = netgsmSettings.header || '';
            }

            async function saveNetgsmSettings() {
                const username = document.getElementById('netgsmUsername').value.trim();
                const password = document.getElementById('netgsmPassword').value;
                const header = document.getElementById('netgsmHeader').value.trim();

                if (!username || !password || !header) {
                    showNotification('TÃ¼m NETGSM alanlarÄ± zorunludur!', 'warning');
                    return;
                }

                if (header.length < 3 || header.length > 11) {
                    showNotification('GÃ¶nderici adÄ± 3-11 karakter arasÄ±nda olmalÄ±dÄ±r!', 'warning');
                    return;
                }

                const settingsToSave = {
                    netgsm_settings: {
                        username: username,
                        password: password,
                        header: header
                    }
                };

                try {
                    const response = await fetch(`${API_BASE}/settings.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settingsToSave)
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification('NETGSM ayarlarÄ± baÅŸarÄ±yla kaydedildi!', 'success');
                        await loadAllSettings(); // Reload settings from DB
                    } else {
                        showNotification('NETGSM ayarlarÄ± kaydedilirken hata oluÅŸtu: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error saving NETGSM settings:', error);
                    showNotification('NETGSM ayarlarÄ± kaydedilirken bir aÄŸ hatasÄ± oluÅŸtu.', 'error');
                }
            }

            async function testNetgsmConnection() {
                showNotification('BaÄŸlantÄ± testi yapÄ±lÄ±yor...', 'info');

                try {
                    const response = await fetch(`${API_BASE}/sms.php?action=test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification('âœ… NETGSM baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±! Kredi: ' + (result.data.balance || 'Bilinmiyor'), 'success');
                    } else {
                        showNotification('âŒ BaÄŸlantÄ± hatasÄ±: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('NETGSM test error:', error);
                    showNotification('BaÄŸlantÄ± testi sÄ±rasÄ±nda bir hata oluÅŸtu.', 'error');
                }
            }

            // Otomatik YÄ±llÄ±k BorÃ§landÄ±rma Fonksiyonu
            async function otomatikBorclandir() {
                const year = parseInt(document.getElementById('borclandirmaYili').value);

                if (!year || year < 2020 || year > 2050) {
                    showNotification('LÃ¼tfen geÃ§erli bir yÄ±l girin!', 'warning');
                    return;
                }

                if (!confirm(`TÃ¼m aktif Ã¼yeler ${year} yÄ±lÄ± iÃ§in borÃ§landÄ±rÄ±lacak. Bu iÅŸlem mevcut borÃ§ kayÄ±tlarÄ±nÄ± etkilemez. Devam etmek istiyor musunuz?`)) {
                    return;
                }

                try {
                    showNotification('Ä°ÅŸlem baÅŸlatÄ±ldÄ±, lÃ¼tfen bekleyin...', 'info');

                    const response = await fetch(`${API_BASE}/batch_debt.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ year: year })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const createdCount = result.data.created || 0;
                        const skippedCount = result.data.skipped || 0;
                        showNotification(`âœ… Otomatik borÃ§landÄ±rma tamamlandÄ±!\n${createdCount} yeni borÃ§ kaydÄ± oluÅŸturuldu, ${skippedCount} Ã¼ye atlandÄ±.`, 'success');
                        loadAllData(); // Refresh UI
                    } else {
                        showNotification(`Hata: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Batch debt creation error:', error);
                    showNotification('Otomatik borÃ§landÄ±rma sÄ±rasÄ±nda bir aÄŸ hatasÄ± oluÅŸtu.', 'error');
                }
            }

            // Check authentication
            function checkAuth() {
                const storedAuth = localStorage.getItem('tpjd_isAuthenticated');
                const storedUsername = localStorage.getItem('tpjd_adminUsername');

                if (storedAuth === 'true') {
                    isAuthenticated = true;
                    if (storedUsername) adminUsername = storedUsername;

                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainApp').classList.add('show');

                    // Load data if authenticated
                    initializeDonutCharts();
                    updateSettingsInfo();
                    loadAllData();
                } else {
                    isAuthenticated = false;
                    document.getElementById('loginContainer').style.display = 'flex';
                    document.getElementById('mainApp').classList.remove('show');
                }
            }

            // Initialize

            // Duplikat borÃ§ kayÄ±tlarÄ±nÄ± temizle (Tek seferlik temizlik)
            async function cleanDuplicateDebts() {
                try {
                    let duplicateIds = [];

                    const completedPayments = payments.filter(p =>
                        p.type === 'aidat' &&
                        p.status === 'tamamlandÄ±'
                    );

                    completedPayments.forEach(completedPayment => {
                        const duplicateDebts = payments.filter(p =>
                            p.id !== completedPayment.id &&
                            p.memberId === completedPayment.memberId &&
                            p.year === completedPayment.year &&
                            p.type === 'aidat' &&
                            p.status === 'bekliyor'
                        );
                        duplicateIds = duplicateIds.concat(duplicateDebts.map(d => d.id));
                    });

                    if (duplicateIds.length === 0) {
                        return;
                    }

                    await Promise.all(
                        duplicateIds.map(id => fetch(`${API_BASE}/payments.php?id=${id}`, { method: 'DELETE' }))
                    );

                    await Promise.all([loadPayments(), loadDebtors()]);
                    showNotification(`âœ… ${duplicateIds.length} adet duplikat borÃ§ kaydÄ± temizlendi!`, 'success');
                } catch (error) {
                    console.error('Duplikat borÃ§ temizleme hatasÄ±:', error);
                    showNotification('Duplikat borÃ§lar temizlenirken hata oluÅŸtu.', 'error');
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                checkAuth();
                setDefaultDate();
                generateYearSelection();

                // Fix tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function (e) {
                        const tabName = this.getAttribute('onclick').match(/switchTab\('([^']+)'/)[1];
                        switchTab(tabName, e);
                    });
                });
            });

            // Tab switching
            function switchTab(tabName, event) {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Show selected tab content
                document.getElementById(tabName).classList.add('active');

                // Add active class to clicked tab
                event.currentTarget.classList.add('active');

                // Reload data based on tab
                if (tabName === 'members') loadMembersTable();
                if (tabName === 'payments') loadPaymentsTable();
                if (tabName === 'notifications') loadNotifications();
                if (tabName === 'settings') populateSettingsForm();
                if (tabName === 'dashboard') {
                    updateDashboard();
                    updateDonutCharts();
                }
            }

            // Generate ID
            function generateId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            }

            // Set default date
            function setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                const dateInputs = ['paymentDate', 'transactionDate'];
                dateInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.value = today;
                });
            }

            // Generate year selection checkboxes
            function generateYearSelection() {
                const container = document.getElementById('yearSelectionGrid');
                const currentYear = new Date().getFullYear();
                const startYear = 2000;

                container.innerHTML = '';

                for (let year = startYear; year < currentYear; year++) {
                    const div = document.createElement('div');
                    div.className = 'year-checkbox-item';
                    div.innerHTML = `
                    <input type="checkbox" id="year${year}" value="${year}">
                    <label for="year${year}">${year}</label>
                `;
                    container.appendChild(div);
                }
            }

            // Toggle year selection
            function toggleYearSelection() {
                const checkbox = document.getElementById('gecmisYillarBorclandir');
                const container = document.getElementById('yearSelectionContainer');
                if (checkbox && container) {
                    container.style.display = checkbox.checked ? 'block' : 'none';
                }
            }

            // Update aidat amount based on membership type and selected year
            function updateAidatAmount() {
                const membershipType = document.getElementById('membershipType').value;
                const paymentAmountInput = document.getElementById('paymentAmount');
                const year = document.getElementById('paymentYear')?.value || new Date().getFullYear();

                if (paymentAmountInput) {
                    // Use historical settings if available for that year, otherwise current settings
                    const yearSettings = (historicalAidatSettings && historicalAidatSettings[year]) ? historicalAidatSettings[year] : aidatSettings;
                    paymentAmountInput.value = (yearSettings[membershipType] || 0).toFixed(2);
                }
            }

            // Update payment amount when member is selected
            function updatePaymentAmount() {
                const memberId = document.getElementById('paymentMemberId').value;
                const member = members.find(m => m.id === memberId);
                const year = document.getElementById('paymentYear')?.value || new Date().getFullYear();

                if (member) {
                    // Use historical settings if available for that year, otherwise current settings
                    const yearSettings = (historicalAidatSettings && historicalAidatSettings[year]) ? historicalAidatSettings[year] : aidatSettings;
                    document.getElementById('paymentAmount').value = (yearSettings[member.membershipType] || 0).toFixed(2);
                }
            }

            // â”€â”€â”€ Direct Notification System (Ãœye Detay â†’ Bildirim) â”€â”€â”€
            let directNotifyMember = null;

            function sendNotificationToCurrentMember() {
                if (!currentMemberId) {
                    showNotification('LÃ¼tfen bir Ã¼ye seÃ§in!', 'warning');
                    return;
                }

                const member = members.find(m => m.id === currentMemberId);
                if (!member) {
                    showNotification('Ãœye bulunamadÄ±!', 'error');
                    return;
                }

                directNotifyMember = member;

                // Ãœye bilgilerini doldur
                document.getElementById('directNotifyMemberName').textContent =
                    `${member.memberNo} â€” ${member.firstName} ${member.lastName}`;

                // BorÃ§ bilgisi
                const memberPayments = payments.filter(p => p.memberId === member.id);
                const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor' && p.type === 'aidat');
                const totalDebt = pendingPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                document.getElementById('directNotifyMemberDebt').textContent =
                    totalDebt > 0 ? `ðŸ’° BorÃ§: â‚º${totalDebt.toFixed(2)} (${pendingPayments.length} yÄ±l)` : 'âœ“ BorÃ§ yok';

                // KanallarÄ± render et
                renderDirectNotifyChannels(member);

                // MesajÄ± otomatik oluÅŸtur
                document.getElementById('directNotifySubject').value = 'Aidat HatÄ±rlatma';
                document.getElementById('directNotifyMessage').value = generateDebtMessage(member);

                // SonuÃ§larÄ± sÄ±fÄ±rla
                document.getElementById('directNotifyResults').style.display = 'none';
                document.getElementById('directNotifyResults').innerHTML = '';
                document.getElementById('directNotifySendBtn').disabled = false;
                document.getElementById('directNotifySendBtn').innerHTML = '<i class="fas fa-paper-plane"></i> GÃ¶nder';

                // Detay modalÄ±nÄ± KAPATMADAN Ã¼stÃ¼ne aÃ§
                openModal('directNotifyModal');
            }

            function renderDirectNotifyChannels(member) {
                const hasEmail = member.email && member.email.trim() !== '';
                const hasPhone = member.phone && member.phone.trim() !== '';

                const channels = [
                    {
                        id: 'email', label: 'E-posta', icon: 'fas fa-envelope',
                        color: '#EA4335', info: hasEmail ? member.email : 'E-posta yok',
                        enabled: hasEmail, checked: hasEmail
                    },
                    {
                        id: 'sms', label: 'SMS', icon: 'fas fa-comment-sms',
                        color: '#2196F3', info: hasPhone ? member.phone : 'Telefon yok',
                        enabled: hasPhone, checked: false
                    },
                    {
                        id: 'whatsapp', label: 'WhatsApp', icon: 'fab fa-whatsapp',
                        color: '#25D366', info: hasPhone ? member.phone : 'Telefon yok',
                        enabled: hasPhone, checked: hasPhone
                    }
                ];

                const container = document.getElementById('directNotifyChannels');
                container.innerHTML = channels.map(ch => `
                    <label style="display: flex; flex-direction: column; align-items: center; padding: 14px 10px;
                                  background: ${ch.enabled && ch.checked ? ch.color + '15' : '#f8f9fa'};
                                  border: 2px solid ${ch.enabled && ch.checked ? ch.color : '#e0e6ed'}; border-radius: 10px;
                                  cursor: ${ch.enabled ? 'pointer' : 'not-allowed'}; opacity: ${ch.enabled ? '1' : '0.5'};
                                  transition: all 0.2s; position: relative;" id="directCh_${ch.id}_card"
                           onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='none'">
                        <input type="checkbox" id="directCh_${ch.id}" ${ch.checked ? 'checked' : ''} ${ch.enabled ? '' : 'disabled'}
                               style="position: absolute; top: 8px; right: 8px; width: 16px; height: 16px; accent-color: ${ch.color};"
                               onchange="updateChannelCardStyle('${ch.id}', '${ch.color}')">
                        <i class="${ch.icon}" style="font-size: 24px; color: ${ch.color}; margin-bottom: 6px;"></i>
                        <span style="font-weight: 600; font-size: 13px; color: var(--tpjd-dark);">${ch.label}</span>
                        <span style="font-size: 10px; color: #7f8c8d; margin-top: 4px; text-align: center; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ch.info}</span>
                    </label>
                `).join('');
            }

            function updateChannelCardStyle(channelId, color) {
                const checkbox = document.getElementById(`directCh_${channelId}`);
                const card = document.getElementById(`directCh_${channelId}_card`);
                if (checkbox.checked) {
                    card.style.background = color + '15';
                    card.style.borderColor = color;
                } else {
                    card.style.background = '#f8f9fa';
                    card.style.borderColor = '#e0e6ed';
                }
            }

            function generateDebtMessage(member) {
                const memberPayments = payments.filter(p => p.memberId === member.id);
                const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor' && p.type === 'aidat');
                const debtYears = pendingPayments.map(p => p.year).sort((a, b) => a - b);
                const totalDebt = pendingPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                let msg = `SayÄ±n ${member.firstName} ${member.lastName},\n\n`;

                if (debtYears.length > 0) {
                    msg += `TPJD Ã¼yelik aidatlarÄ±nÄ±z ile ilgili bilgilendirme:\n\n`;
                    msg += `BorÃ§lu yÄ±llar: ${debtYears.join(', ')}\n`;
                    msg += `Toplam borÃ§: â‚º${totalDebt.toFixed(2)}\n\n`;
                    msg += `Aidat Ã¶demelerinizi dernek hesabÄ±na yapabilirsiniz.\n\n`;
                } else {
                    msg += `TPJD Ã¼yelik durumunuz ile ilgili bilgilendirme.\n\n`;
                }

                msg += `SaygÄ±larÄ±mÄ±zla,\nTPJD YÃ¶netim Kurulu`;
                return msg;
            }

            async function sendDirectNotification() {
                if (!directNotifyMember) return;

                const member = directNotifyMember;
                const subject = document.getElementById('directNotifySubject').value.trim();
                const message = document.getElementById('directNotifyMessage').value.trim();

                if (!subject || !message) {
                    showNotification('Konu ve mesaj alanlarÄ± zorunludur!', 'warning');
                    return;
                }

                const sendEmail = document.getElementById('directCh_email')?.checked;
                const sendSms = document.getElementById('directCh_sms')?.checked;
                const sendWhatsapp = document.getElementById('directCh_whatsapp')?.checked;

                if (!sendEmail && !sendSms && !sendWhatsapp) {
                    showNotification('En az bir kanal seÃ§melisiniz!', 'warning');
                    return;
                }

                // Disable button
                const btn = document.getElementById('directNotifySendBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GÃ¶nderiliyor...';

                const results = [];
                const resultsDiv = document.getElementById('directNotifyResults');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div style="color: #7f8c8d; text-align: center;"><i class="fas fa-spinner fa-spin"></i> GÃ¶nderiliyor...</div>';

                // â”€â”€ Email â”€â”€
                if (sendEmail && member.email) {
                    try {
                        const res = await fetch(`${API_BASE}/send_email.php`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                recipients: [{ email: member.email, name: `${member.firstName} ${member.lastName}` }],
                                subject: subject,
                                message: message
                            })
                        });
                        const data = await res.json();
                        results.push({ channel: 'E-posta', icon: 'fas fa-envelope', color: '#EA4335', success: data.success, msg: data.message });
                    } catch (e) {
                        results.push({ channel: 'E-posta', icon: 'fas fa-envelope', color: '#EA4335', success: false, msg: e.message });
                    }
                }

                // â”€â”€ SMS â”€â”€
                if (sendSms && member.phone) {
                    try {
                        const res = await fetch(`${API_BASE}/sms.php?action=send`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                recipients: [member.phone],
                                message: `${subject}\n\n${message}`
                            })
                        });
                        const data = await res.json();
                        results.push({ channel: 'SMS', icon: 'fas fa-comment-sms', color: '#2196F3', success: data.success, msg: data.message });
                    } catch (e) {
                        results.push({ channel: 'SMS', icon: 'fas fa-comment-sms', color: '#2196F3', success: false, msg: e.message });
                    }
                }

                // â”€â”€ WhatsApp (Evolution API via server) â”€â”€
                if (sendWhatsapp && member.phone) {
                    try {
                        const res = await fetch(`${API_BASE}/notifications.php?action=whatsapp_send`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                phone: member.phone,
                                message: `*${subject}*\n\n${message}`
                            })
                        });
                        const data = await res.json();
                        results.push({ channel: 'WhatsApp', icon: 'fab fa-whatsapp', color: '#25D366', success: data.success, msg: data.message });
                    } catch (e) {
                        results.push({ channel: 'WhatsApp', icon: 'fab fa-whatsapp', color: '#25D366', success: false, msg: e.message });
                    }
                }

                // SonuÃ§larÄ± gÃ¶ster
                resultsDiv.innerHTML = results.map(r => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; margin-bottom: 8px;
                                background: ${r.success ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;
                                border-left: 4px solid ${r.success ? '#4caf50' : '#ef5350'};">
                        <i class="${r.icon}" style="color: ${r.color}; font-size: 18px; width: 24px; text-align: center;"></i>
                        <span style="font-weight: 600; min-width: 70px;">${r.channel}</span>
                        <span style="font-size: 13px; color: ${r.success ? '#2e7d32' : '#c62828'};">
                            ${r.success ? 'âœ… ' : 'âŒ '}${r.msg}
                        </span>
                    </div>
                `).join('');

                // Save notification record
                const successChannels = results.filter(r => r.success).map(r => r.channel);
                if (successChannels.length > 0) {
                    try {
                        await fetch(`${API_BASE}/notifications.php`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: generateId(),
                                memberId: member.id,
                                memberName: `${member.firstName} ${member.lastName}`,
                                title: `${subject} (${successChannels.join('+')})`,
                                message: message,
                                priority: 'normal',
                                recipients: [member.id],
                                sentAt: new Date().toISOString()
                            })
                        });
                    } catch (e) { console.error('Notification log error:', e); }
                }

                // Update button
                btn.disabled = false;
                const allSuccess = results.every(r => r.success);
                btn.innerHTML = allSuccess
                    ? '<i class="fas fa-check"></i> TamamlandÄ±'
                    : '<i class="fas fa-paper-plane"></i> Tekrar GÃ¶nder';

                if (allSuccess) {
                    showNotification(`âœ… ${successChannels.join(', ')} ile bildirim gÃ¶nderildi!`, 'success');
                }
            }


            // Change notification recipient
            function changeNotificationRecipient() {
                document.getElementById('preSelectedMemberInfo').style.display = 'none';
                document.getElementById('normalMemberSelection').style.display = 'block';
                populateIndividualMemberSelect();
            }

            // Add payment for current member (BorÃ§lu detayÄ±ndan)
            function addPaymentForCurrentMember() {
                if (!currentMemberId) {
                    showNotification('LÃ¼tfen bir Ã¼ye seÃ§in!', 'warning');
                    return;
                }

                const member = members.find(m => m.id === currentMemberId);
                if (!member) {
                    showNotification('Ãœye bulunamadÄ±!', 'error');
                    return;
                }

                // Detay modalÄ±nÄ± kapat
                closeModal('memberDetailModal');

                // Ã–deme modalÄ±nÄ± aÃ§
                openModal('paymentModal');

                // Ãœyeyi seÃ§
                populateMemberSelect();
                document.getElementById('paymentMemberId').value = member.id;

                // VarsayÄ±lan deÄŸerler
                const currentYear = new Date().getFullYear();
                document.getElementById('paymentYear').value = currentYear;
                document.getElementById('paymentType').value = 'aidat';
                document.getElementById('paymentStatus').value = 'tamamlandÄ±';

                // Aidat tutarÄ±nÄ± otomatik doldur
                updatePaymentAmount();

                showNotification(`${member.firstName} ${member.lastName} iÃ§in Ã¶deme ekleniyor...`, 'info');
            }

            // Quick pay debt - Detay sayfasÄ±ndan hÄ±zlÄ± Ã¶deme
            function quickPayDebt(paymentId) {
                // Bekleyen Ã¶demeyi bul
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) {
                    showNotification('Ã–deme kaydÄ± bulunamadÄ±!', 'error');
                    return;
                }

                if (payment.status !== 'bekliyor') {
                    showNotification('Bu Ã¶deme zaten tamamlanmÄ±ÅŸ!', 'warning');
                    return;
                }

                // Ãœyeyi bul
                const member = members.find(m => m.id === payment.memberId);
                if (!member) {
                    showNotification('Ãœye bulunamadÄ±!', 'error');
                    return;
                }

                // Detay modalÄ±nÄ± kapat
                closeModal('memberDetailModal');

                // Ã–deme modalÄ±nÄ± aÃ§
                openModal('paymentModal');

                // Formu doldur - BEKLEYEN Ã–DEMEYÄ° DÃœZENLÄ°YORUZ
                document.getElementById('paymentId').value = payment.id; // â† Ã–nemli: Mevcut ID

                // Ãœye listesini doldur ve seÃ§
                populateMemberSelect();
                document.getElementById('paymentMemberId').value = payment.memberId;

                // DiÄŸer alanlarÄ± doldur
                document.getElementById('paymentAmount').value = payment.amount;
                document.getElementById('paymentType').value = payment.type;
                document.getElementById('paymentYear').value = payment.year;
                document.getElementById('paymentDescription').value = payment.description;
                document.getElementById('paymentStatus').value = 'tamamlandÄ±'; // Ã–deme yapÄ±lacak

                // BugÃ¼nÃ¼n tarihini set et
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('paymentDate').value = today;

                // FiÅŸ no alanÄ±na focus
                setTimeout(() => {
                    document.getElementById('receiptNo')?.focus();
                }, 300);

                showNotification(` ${member.firstName} ${member.lastName} - ${payment.year} yÄ±lÄ± Ã¶deme yapÄ±lÄ±yor...`, 'info');
            }

            // Initialize Donut Charts
            function initializeDonutCharts() {
                // Destroy existing charts if they exist to avoid "Canvas is already in use" error
                if (membershipDonutChart) {
                    membershipDonutChart.destroy();
                    membershipDonutChart = null;
                }

                // Check if Chart is available
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded');
                    return;
                }

                // Membership Type Donut Chart
                const membershipCtx = document.getElementById('membershipDonutChart');
                if (!membershipCtx) {
                    console.error('Membership chart canvas not found');
                    return;
                }

                membershipDonutChart = new Chart(membershipCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Asil Ãœye', 'Asil Onursal', 'Ã–ÄŸrenci Ãœye', 'Fahri Ãœye', 'Fahri Onursal'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: [
                                '#3498db',
                                '#9b59b6',
                                '#f39c12',
                                '#e67e22',
                                '#95a5a6'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });

                updateDonutCharts();
            }

            // Update Donut Charts
            function updateDonutCharts() {
                // Re-initialize charts if they don't exist
                if (!membershipDonutChart) {
                    console.log('Charts not initialized, re-initializing...');
                    initializeDonutCharts();
                }

                // Check again after initialization
                if (!membershipDonutChart) {
                    console.error('Charts still not available after initialization');
                    return;
                }

                const currentYear = new Date().getFullYear();

                // Dinamik yÄ±l â€” stat kartÄ± subtitle'larÄ± gÃ¼ncelle
                const activeSub = document.getElementById('activeSubtitle');
                const incomeSub = document.getElementById('incomeSubtitle');
                if (activeSub) activeSub.textContent = `${currentYear} yÄ±lÄ± aidat Ã¶demesi yapan`;
                if (incomeSub) incomeSub.textContent = `${currentYear} yÄ±lÄ± toplam aidat geliri`;

                // Update membership type chart (sadece aktif Ã¼yeler)
                const membershipCounts = {
                    'Asil Ãœye': 0,
                    'Asil Onursal': 0,
                    'Ã–ÄŸrenci Ãœye': 0,
                    'Fahri Ãœye': 0,
                    'Fahri Onursal': 0
                };

                const activeMembers = members.filter(m => m.membershipStatus !== 'ayrÄ±ldÄ±');
                activeMembers.forEach(member => {
                    if (membershipCounts.hasOwnProperty(member.membershipType)) {
                        membershipCounts[member.membershipType]++;
                    }
                });

                membershipDonutChart.data.datasets[0].data = [
                    membershipCounts['Asil Ãœye'],
                    membershipCounts['Asil Onursal'],
                    membershipCounts['Ã–ÄŸrenci Ãœye'],
                    membershipCounts['Fahri Ãœye'],
                    membershipCounts['Fahri Onursal']
                ];
                membershipDonutChart.update();
            }

            function populateIndividualMemberSelect(searchTerm = '') {
                const select = document.getElementById('individualMemberId');
                if (!select) return;
                select.innerHTML = '<option value="">Ãœye seÃ§iniz</option>';
                const term = searchTerm.toLowerCase();
                members.filter(m => !term || `${m.memberNo} ${m.firstName} ${m.lastName}`.toLowerCase().includes(term))
                    .forEach(m => select.add(new Option(`${m.memberNo} - ${m.firstName} ${m.lastName}`, m.id)));
            }

            function searchMemberForNotification() {
                populateIndividualMemberSelect(document.getElementById('memberSearchInput').value);
            }

            let currentNotificationId = null;
            function editNotification(id) {
                const n = notifications.find(notif => notif.id === id);
                if (!n) return;
                currentNotificationId = id;
                openModal('notificationModal');
                document.getElementById('notificationTitle').value = n.title || '';
                document.getElementById('notificationMessage').value = n.message || '';
                document.getElementById('notificationPriority').value = n.priority || 'normal';
                if (n.recipients?.length > 0) {
                    document.getElementById('notificationType').value = 'individual';
                    toggleRecipientSelection();
                    const select = document.getElementById('individualMemberId');
                    select.innerHTML = '';
                    n.recipients.forEach(rid => {
                        const m = members.find(mem => mem.id === rid);
                        if (m) select.add(new Option(`${m.firstName} ${m.lastName}`, m.id, true, true));
                    });
                } else {
                    document.getElementById('notificationType').value = 'group';
                    toggleRecipientSelection();
                }
            }

            function validateIndividualNotification() {
                const title = document.getElementById('notificationTitle').value.trim();
                const message = document.getElementById('notificationMessage').value.trim();
                const mid = document.getElementById('individualMemberId').value;
                if (!title || !message || !mid) {
                    showNotification('Eksik bilgi!', 'warning');
                    return null;
                }
                const member = members.find(m => m.id === mid);
                return member ? { title, message, member } : null;
            }

            async function saveIndividualNotification(member, title, message, method) {
                try {
                    const response = await fetch(`${API_BASE}/notifications.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: generateId(),
                            memberId: member.id,
                            memberName: `${member.firstName} ${member.lastName}`,
                            title: `${title} (${method})`,
                            message,
                            priority: 'normal',
                            recipients: [member.id],
                            sentAt: new Date().toISOString()
                        })
                    });
                    if ((await response.json()).success) await loadNotifications();
                } catch (e) { console.error(e); }
            }

            async function sendViaWhatsAppIndividual() {
                const d = validateIndividualNotification();
                if (!d || !d.member.phone) {
                    showNotification('Telefon numarasÄ± bulunamadÄ±!', 'warning');
                    return;
                }
                let phone = d.member.phone.replace(/\D/g, '');
                if (phone.startsWith('0')) phone = '90' + phone.substring(1);
                else if (!phone.startsWith('90')) phone = '90' + phone;

                const WA = 'http://localhost:3456';
                try {
                    // Ã–nce sunucu durumunu kontrol et
                    const statusRes = await fetch(`${WA}/status`, { signal: AbortSignal.timeout(3000) }).catch(() => null);
                    if (!statusRes || !statusRes.ok) {
                        showNotification('âš ï¸ WhatsApp sunucusu Ã§alÄ±ÅŸmÄ±yor! Ajanlar sekmesinden QR kod ile baÄŸlanÄ±n.', 'warning');
                        return;
                    }
                    const statusData = await statusRes.json();
                    if (!statusData.authenticated) {
                        showNotification('âš ï¸ WhatsApp baÄŸlÄ± deÄŸil! Ajanlar sekmesinden QR kod ile baÄŸlanÄ±n.', 'warning');
                        return;
                    }

                    // Mesaj gÃ¶nder
                    showNotification('ðŸ“¤ WhatsApp mesajÄ± gÃ¶nderiliyor...', 'info');
                    const res = await fetch(`${WA}/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ number: phone, message: `*${d.title}*\n\n${d.message}` })
                    });
                    const result = await res.json();
                    if (result.success) {
                        showNotification('âœ… WhatsApp mesajÄ± gÃ¶nderildi!', 'success');
                        saveIndividualNotification(d.member, d.title, d.message, 'WhatsApp');
                    } else {
                        showNotification('âŒ Mesaj gÃ¶nderilemedi: ' + (result.error || 'Bilinmeyen hata'), 'error');
                    }
                } catch (e) {
                    console.error('WA send error:', e);
                    showNotification('âŒ WhatsApp sunucusuna baÄŸlanÄ±lamadÄ±!', 'error');
                }
            }

            function sendViaTelegramIndividual() {
                const d = validateIndividualNotification();
                if (!d || !d.member.phone) return;
                let phone = d.member.phone.replace(/\D/g, '');
                if (!phone.startsWith('90')) phone = '90' + phone;
                window.open(`https://t.me/+${phone}`, '_blank');
                saveIndividualNotification(d.member, d.title, d.message, 'Telegram');
            }

            function sendViaEmailIndividual() {
                const d = validateIndividualNotification();
                if (!d || !d.member.email) return;

                // Send via server instead of opening mail client
                const emailData = {
                    recipients: [{ email: d.member.email, name: `${d.member.firstName} ${d.member.lastName}` }],
                    subject: d.title,
                    message: d.message
                };

                fetch(`${API_BASE}/send_email.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailData)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            saveIndividualNotification(d.member, d.title, d.message, 'E-posta');
                            closeModal('notificationModal');
                            showNotification(`âœ… E-posta baÅŸarÄ±yla gÃ¶nderildi: ${d.member.email}`, 'success');
                        } else {
                            showNotification(`âŒ E-posta gÃ¶nderilemedi: ${result.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Email sending error:', error);
                        showNotification('âŒ E-posta gÃ¶nderilirken bir hata oluÅŸtu.', 'error');
                    });
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Grup Bildirim GÃ¶nderimi â€” checkbox'lara gÃ¶re Ã§oklu kanal
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            async function sendNotification() {
                const title = document.getElementById('notificationTitle').value.trim();
                const message = document.getElementById('notificationMessage').value.trim();
                const priority = document.getElementById('notificationPriority').value;
                const targetGroup = document.getElementById('targetGroup').value;

                if (!title || !message) {
                    showNotification('LÃ¼tfen baÅŸlÄ±k ve mesaj girin!', 'warning');
                    return;
                }
                if (!targetGroup) {
                    showNotification('LÃ¼tfen hedef grup seÃ§in!', 'warning');
                    return;
                }

                // SeÃ§ili kanallarÄ± oku
                const useEmail = document.getElementById('channelEmail')?.checked;
                const useWhatsApp = document.getElementById('channelWhatsApp')?.checked;
                const useSMS = document.getElementById('channelSMS')?.checked;

                if (!useEmail && !useWhatsApp && !useSMS) {
                    showNotification('En az bir gÃ¶nderim kanalÄ± seÃ§in!', 'warning');
                    return;
                }

                // Hedef Ã¼yeleri belirle
                let targetMembers = [];
                const currentYear = new Date().getFullYear();
                const paidIds = new Set(
                    payments
                        .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandÄ±')
                        .map(p => p.memberId)
                );

                switch (targetGroup) {
                    case 'all':
                        targetMembers = members.filter(m => m.membershipStatus === 'aktif');
                        break;
                    case 'active':
                        targetMembers = members.filter(m => m.aidatAktif !== false && m.membershipStatus === 'aktif');
                        break;
                    case 'inactive':
                        targetMembers = members.filter(m => m.aidatAktif === false);
                        break;
                    case 'paid':
                        targetMembers = members.filter(m => m.membershipStatus === 'aktif' && paidIds.has(m.id));
                        break;
                    case 'unpaid':
                        targetMembers = members.filter(m => m.membershipStatus === 'aktif' && !paidIds.has(m.id));
                        break;
                    case 'asil':
                        targetMembers = members.filter(m => m.membershipType === 'Asil Ãœye');
                        break;
                    case 'asil-onursal':
                        targetMembers = members.filter(m => m.membershipType?.includes('Onursal'));
                        break;
                    case 'ogrenci':
                        targetMembers = members.filter(m => m.membershipType === 'Ã–ÄŸrenci Ãœye');
                        break;
                    case 'fahri':
                        targetMembers = members.filter(m => m.membershipType === 'Fahri Ãœye');
                        break;
                    default:
                        targetMembers = members.filter(m => m.membershipStatus === 'aktif');
                }

                if (targetMembers.length === 0) {
                    showNotification('SeÃ§ilen grupta Ã¼ye bulunamadÄ±!', 'error');
                    return;
                }

                const channels = [];
                if (useEmail) channels.push('ðŸ“§ E-posta');
                if (useWhatsApp) channels.push('ðŸ’¬ WhatsApp');
                if (useSMS) channels.push('ðŸ“± SMS');

                if (!confirm(`${targetMembers.length} Ã¼yeye ${channels.join(' + ')} ile bildirim gÃ¶nderilecek.\n\nDevam edilsin mi?`)) {
                    return;
                }

                let results = [];

                // 1. E-posta gÃ¶nderimi
                if (useEmail) {
                    const emailRecipients = targetMembers
                        .filter(m => m.email && m.email.trim())
                        .map(m => ({ email: m.email.trim(), name: `${m.firstName} ${m.lastName}` }));

                    if (emailRecipients.length > 0) {
                        showNotification(`ðŸ“§ ${emailRecipients.length} kiÅŸiye e-posta gÃ¶nderiliyor...`, 'info');
                        try {
                            const res = await fetch(`${API_BASE}/send_email.php`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ recipients: emailRecipients, subject: title, message })
                            });
                            const data = await res.json();
                            results.push(`ðŸ“§ E-posta: ${data.data?.success_count || 0} baÅŸarÄ±lÄ±`);
                        } catch (e) {
                            results.push('ðŸ“§ E-posta: Hata!');
                        }
                    } else {
                        results.push('ðŸ“§ E-posta: E-posta adresi olan Ã¼ye yok');
                    }
                }

                // 2. WhatsApp gÃ¶nderimi (lokal sunucu Ã¼zerinden)
                if (useWhatsApp) {
                    const waRecipients = targetMembers.filter(m => m.phone && m.phone.trim());
                    if (waRecipients.length > 0) {
                        showNotification(`ðŸ’¬ ${waRecipients.length} kiÅŸiye WhatsApp gÃ¶nderiliyor...`, 'info');
                        const waQueue = waRecipients.map(m => {
                            let phone = (m.phone || '').replace(/\D/g, '');
                            if (phone.startsWith('0')) phone = '90' + phone.substring(1);
                            else if (!phone.startsWith('90')) phone = '90' + phone;
                            return { number: phone, message: `*${title}*\n\n${message}`, recipient_id: m.id };
                        });
                        try {
                            await processWhatsAppQueue(waQueue, 'notification');
                            results.push(`ðŸ’¬ WhatsApp: ${waQueue.length} mesaj kuyruÄŸa alÄ±ndÄ±`);
                        } catch (e) {
                            results.push('ðŸ’¬ WhatsApp: Hata â€” sunucu Ã§alÄ±ÅŸÄ±yor mu?');
                        }
                    } else {
                        results.push('ðŸ’¬ WhatsApp: Telefon numarasÄ± olan Ã¼ye yok');
                    }
                }

                // 3. SMS (henÃ¼z aktif deÄŸil)
                if (useSMS) {
                    results.push('ðŸ“± SMS: HenÃ¼z aktif deÄŸil (NetGSM entegrasyonu gerekli)');
                }

                // Bildirimi DB'ye kaydet
                try {
                    await fetch(`${API_BASE}/notifications.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: generateId(),
                            title,
                            message,
                            priority,
                            recipients: targetMembers.map(m => m.id),
                            sentAt: new Date().toISOString(),
                            channels: channels.join(', ')
                        })
                    });
                    await loadNotifications();
                } catch (e) { console.error('Notification save error:', e); }

                closeModal('notificationModal');
                showNotification(`âœ… Bildirim gÃ¶nderildi! ${results.join(' | ')}`, 'success');
            }

            function openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
                if (modalId === 'memberModal') {
                    document.getElementById('memberForm').reset();
                    document.getElementById('memberId').value = '';
                    document.getElementById('aidatAktif').checked = true;
                    document.getElementById('gecmisYillarBorclandir').checked = false;
                    toggleYearSelection();
                } else if (modalId === 'paymentModal') {
                    document.getElementById('paymentForm').reset();
                    document.getElementById('paymentId').value = '';
                    populateMemberSelect();
                    setDefaultDate();
                } else if (modalId === 'notificationModal') {
                    document.getElementById('notificationForm').reset();
                    document.getElementById('notificationType').value = '';
                    // Reset pre-selected member info
                    document.getElementById('preSelectedMemberInfo').style.display = 'none';
                    document.getElementById('normalMemberSelection').style.display = 'block';
                    toggleRecipientSelection();
                } else if (modalId === 'eventModal') {
                    document.getElementById('eventTitle').value = '';
                    document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('eventTime').value = '10:00';
                    document.getElementById('eventLocation').value = '';
                    document.getElementById('eventDescription').value = '';
                    // Aktif Ã¼ye sayÄ±sÄ±nÄ± gÃ¶ster
                    try {
                        const activeCount = members.filter(m => m.membershipStatus === 'aktif' && m.email).length;
                        document.getElementById('eventRecipientCount').textContent = activeCount + ' aktif Ã¼yeye email gÃ¶nderilecek';
                    } catch (e) {
                        document.getElementById('eventRecipientCount').textContent = 'Ãœye verileri yÃ¼kleniyor...';
                    }
                }
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            // Toggle exit fields visibility
            function toggleExitFields() {
                const status = document.getElementById('membershipStatus').value;
                const container = document.getElementById('exitFieldsContainer');

                if (status === 'ayrÄ±ldÄ±') {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                    // AlanlarÄ± temizle
                    document.getElementById('exitDate').value = '';
                    document.getElementById('exitReasonType').value = '';
                    document.getElementById('exitReason').value = '';
                }
            }

            // Toggle edit exit fields visibility (Ãœye DÃ¼zenle iÃ§in)
            function toggleEditExitFields() {
                const status = document.getElementById('editMembershipStatus').value;
                const container = document.getElementById('editExitFieldsContainer');

                if (status === 'ayrÄ±ldÄ±') {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            }

            // Populate member select
            function populateMemberSelect() {
                const select = document.getElementById('paymentMemberId');
                select.innerHTML = '<option value="">Ãœye seÃ§iniz</option>';

                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.memberNo} - ${member.firstName} ${member.lastName}`;
                    select.appendChild(option);
                });
            }

            // Save member
            async function saveMember() {
                console.log("saveMember called");
                const saveBtn = document.querySelector('#memberModal .btn-primary');
                const originalBtnText = saveBtn ? saveBtn.innerHTML : 'Kaydet';

                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                }

                const memberIdInput = document.getElementById('memberId').value;
                const ensuredId = memberIdInput || generateId();

                const normalize = (val) => {
                    if (val === undefined || val === null) return '';
                    return val.toString().trim();
                };

                const normalizePhone = (val) => {
                    const digits = normalize(val).replace(/\D/g, '');
                    if (!digits) return '';
                    if (digits.startsWith('90')) return `+${digits}`;
                    if (digits.startsWith('0')) return `+9${digits.replace(/^0+/, '')}`;
                    return `+90${digits}`;
                };

                const member = {
                    id: ensuredId,
                    memberNo: normalize(document.getElementById('memberNo').value),
                    membershipType: normalize(document.getElementById('membershipType').value),
                    aidatAktif: document.getElementById('aidatAktif').checked,
                    firstName: normalize(document.getElementById('firstName').value),
                    lastName: normalize(document.getElementById('lastName').value),
                    tcNo: normalize(document.getElementById('tcNo').value),
                    gender: normalize(document.getElementById('gender').value),
                    birthDate: normalize(document.getElementById('birthDate').value),
                    phone: normalizePhone(document.getElementById('phone').value),
                    phoneHome: normalize(document.getElementById('phoneHome').value),
                    email: normalize(document.getElementById('email').value),
                    address: normalize(document.getElementById('address').value),
                    city: normalize(document.getElementById('city').value),
                    district: normalize(document.getElementById('district').value),
                    neighborhood: normalize(document.getElementById('neighborhood').value),
                    bloodType: normalize(document.getElementById('bloodType').value),
                    employmentStatus: normalize(document.getElementById('employmentStatus').value),

                    maritalStatus: normalize(document.getElementById('maritalStatus').value),
                    graduation: normalize(document.getElementById('graduation').value),
                    graduationYear: normalize(document.getElementById('graduationYear').value),
                    workplace: normalize(document.getElementById('workplace').value),
                    position: normalize(document.getElementById('position').value),

                    registrationDate: normalize(document.getElementById('registrationDate').value) || new Date().toISOString().split('T')[0],
                    lastPaymentDate: '',
                    notes: normalize(document.getElementById('notes').value),
                    membershipStatus: 'aktif',
                    exitDate: null,
                    exitReasonType: null,
                    exitReason: null
                };

                const requiredFields = [
                    { field: member.memberNo, name: 'Ãœye No', id: 'memberNo' },
                    { field: member.firstName, name: 'Ad', id: 'firstName' },
                    { field: member.lastName, name: 'Soyad', id: 'lastName' },
                    { field: member.tcNo, name: 'TC Kimlik No', id: 'tcNo' },
                    { field: member.gender, name: 'Cinsiyet', id: 'gender' },
                    { field: member.birthDate, name: 'DoÄŸum Tarihi', id: 'birthDate' },
                    { field: member.email, name: 'E-posta', id: 'email' },
                    { field: member.phone, name: 'Telefon', id: 'phone' },
                    { field: member.address, name: 'Adres', id: 'address' },
                    { field: member.city, name: 'Åžehir', id: 'city' },
                    { field: member.membershipType, name: 'Ãœyelik Tipi', id: 'membershipType' }
                ];

                for (let item of requiredFields) {
                    if (!item.field || item.field.trim() === '') {
                        alert(`âŒ ${item.name} alanÄ± zorunludur!`);
                        document.getElementById(item.id)?.focus();
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                        return;
                    }
                }

                // API'ye Ã¼yeyi kaydet
                const method = memberIdInput ? 'PUT' : 'POST';
                console.log(`Sending ${method} request to members.php with payload:`, member);

                // Capture past debt options before saving
                const isPastDebtRequested = document.getElementById('gecmisYillarBorclandir').checked;
                let selectedYears = [];
                if (isPastDebtRequested) {
                    const checkboxes = document.querySelectorAll('#yearSelectionGrid input[type="checkbox"]:checked');
                    checkboxes.forEach(cb => selectedYears.push(cb.value));
                }

                try {
                    const response = await fetch(`${API_BASE}/members.php`, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(member)
                    });

                    const text = await response.text();
                    console.log("Raw save response:", text);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        throw new Error("API non-JSON response: " + text);
                    }

                    if (result.success) {
                        // Determine the correct Member ID
                        // For POST, the API returns the new ID in result.data.id
                        // For PUT, we use the input ID
                        const savedMemberId = memberIdInput || (result.data && result.data.id) || ensuredId;

                        // Handle Past Debts if requested
                        if (isPastDebtRequested && selectedYears.length > 0 && savedMemberId) {
                            console.log(`Creating past debts for member ${savedMemberId} for years:`, selectedYears);
                            await createPastDebts(savedMemberId, selectedYears);
                        }

                        // â”€ Yeni Ã¼ye kaydÄ±nda otomatik cari yÄ±l borÃ§landÄ±rma â”€
                        if (!memberIdInput && member.aidatAktif) {
                            const currentYear = new Date().getFullYear();
                            const alreadyCharged = isPastDebtRequested && selectedYears.includes(String(currentYear));
                            if (!alreadyCharged) {
                                try {
                                    // Manuel bedel girilmiÅŸ mi kontrol et
                                    const manuelBedel = document.getElementById('manuelAidatBedel').value;
                                    let aidatAmount = 0;

                                    if (manuelBedel && parseFloat(manuelBedel) > 0) {
                                        aidatAmount = parseFloat(manuelBedel);
                                    } else {
                                        // Ayarlardan Ã§ek
                                        aidatAmount = parseFloat(aidatSettings[member.membershipType] || 0);
                                    }

                                    if (aidatAmount > 0) {
                                        const debtPayload = {
                                            memberId: savedMemberId,
                                            year: currentYear,
                                            type: 'aidat',
                                            amount: aidatAmount,
                                            status: 'bekliyor',
                                            date: new Date().toISOString().split('T')[0]
                                        };
                                        await fetch(`${API_BASE}/payments.php`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(debtPayload)
                                        });
                                        console.log(`ðŸ’° Otomatik ${currentYear} aidat borcu oluÅŸturuldu: â‚º${aidatAmount}`);
                                    }
                                } catch (e) { console.error('Otomatik borÃ§landÄ±rma hatasÄ±:', e); }
                            }
                        }

                        alert("BaÅŸarÄ±yla kaydedildi.");
                        // Agent Hook: Welcome new member
                        if (!memberIdInput && typeof agentManager !== 'undefined') {
                            agentManager.onNewMember(member);
                        }
                        closeModal('memberModal');

                        // Reload ALL data to ensure payments, debts, and dashboard are in sync
                        await loadAllData();
                    } else {
                        alert(`Hata: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Save member error:', error);
                    alert('Kaydetme sÄ±rasÄ±nda bir hata oluÅŸtu: ' + error.message);
                } finally {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalBtnText;
                    }
                }
            }

            // Create aidat debt
            function createAidatDebt(memberId, year) {
                const member = members.find(m => m.id === memberId);
                if (!member) return;

                // Aidat tutarÄ±nÄ± ayarlardan al
                const amount = aidatSettings[member.membershipType] || 0;

                // EÄŸer aidat tutarÄ± 0 ise borÃ§ oluÅŸturma
                if (amount === 0) return;

                const payment = {
                    id: generateId(),
                    memberId: memberId,
                    amount: amount,
                    type: 'aidat',
                    date: '',
                    year: year,
                    receiptNo: '',
                    description: `${year} yÄ±lÄ± ${member.membershipType} aidatÄ±`,
                    status: 'bekliyor',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // API'ye kaydet
                fetch(`${API_BASE}/payments.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payment)
                }).then(() => {
                    loadPayments();
                    loadDebtors(year);
                }).catch(err => console.error('Aidat borcu eklenemedi:', err));
            }

            // Delete member
            async function loadMemberForEdit(id) {
                try {
                    // API'den Ã‡Ã–ZÃœLMÃœÅž (decrypt) veri al â€” cache'deki maskelenmiÅŸ veri KULLANILMAMALI
                    const response = await fetch(`${API_BASE}/members.php?action=get&id=${id}`);
                    const result = await response.json();
                    if (!result.success || !result.data) {
                        showNotification('Ãœye verisi alÄ±namadÄ±: ' + (result.message || ''), 'error');
                        return;
                    }
                    const member = result.data;

                    openModal('memberModal');

                    // Formu doldur â€” decrypt edilmiÅŸ gerÃ§ek verilerle
                    document.getElementById('memberId').value = member.id;
                    document.getElementById('memberNo').value = member.memberNo;
                    document.getElementById('membershipType').value = member.membershipType;
                    document.getElementById('aidatAktif').checked = member.aidatAktif;
                    document.getElementById('firstName').value = member.firstName;
                    document.getElementById('lastName').value = member.lastName;
                    document.getElementById('tcNo').value = member.tcNo || '';
                    document.getElementById('gender').value = member.gender;
                    document.getElementById('birthDate').value = member.birthDate || '';
                    document.getElementById('phone').value = member.phone || '';
                    document.getElementById('phoneHome').value = member.phoneHome || '';
                    document.getElementById('email').value = member.email;
                    document.getElementById('address').value = member.address || '';
                    document.getElementById('city').value = member.city || '';
                    document.getElementById('district').value = member.district || '';
                    document.getElementById('neighborhood').value = member.neighborhood || '';
                    document.getElementById('bloodType').value = member.bloodType || '';
                    document.getElementById('employmentStatus').value = member.employmentStatus || '';

                    document.getElementById('maritalStatus').value = member.maritalStatus || '';
                    document.getElementById('graduation').value = member.graduation || '';
                    document.getElementById('graduationYear').value = member.graduationYear || '';
                    document.getElementById('workplace').value = member.workplace || '';
                    document.getElementById('position').value = member.position || '';

                    document.getElementById('registrationDate').value = member.registrationDate || '';
                    document.getElementById('notes').value = member.notes || '';

                    // Change modal title for editing
                    document.querySelector('#memberModal .modal-header h2').innerHTML = '<i class="fas fa-user-edit"></i> Ãœye DÃ¼zenle';
                } catch (error) {
                    console.error('Edit fetch error:', error);
                    showNotification('Ãœye dÃ¼zenleme verisi alÄ±namadÄ±: ' + error.message, 'error');
                }
            }

            async function createPastDebts(memberId, years) {
                try {
                    const response = await fetch(`${API_BASE}/batch_past_debt.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ memberId, years })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification(result.message, 'success');
                    } else {
                        showNotification(`GeÃ§miÅŸ borÃ§ oluÅŸturma hatasÄ±: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Error creating past debts:', error);
                    showNotification('GeÃ§miÅŸ borÃ§lar oluÅŸturulurken bir aÄŸ hatasÄ± oluÅŸtu.', 'error');
                }
            }

            function deleteMember(id) {
                if (!confirm('Bu Ã¼yeyi silmek istediÄŸinizden emin misiniz?')) return;

                fetch(`${API_BASE}/members.php?id=${id}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            showNotification('Ãœye baÅŸarÄ±yla silindi!', 'success');
                            loadAllData(); // Reload all data to ensure UI is in sync
                        } else {
                            showNotification(`Hata: ${result.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('API Error:', error);
                        showNotification('VeritabanÄ± baÄŸlantÄ± hatasÄ±!', 'error');
                    });
            }
            // View member details - TAM DETAYLI BORÃ‡ BÄ°LGÄ°SÄ°
            async function viewMemberDetail(id) {
                currentMemberId = id;

                // API'den Ã‡Ã–ZÃœLMÃœÅž (decrypt) veri al â€” cache'deki maskelenmiÅŸ veri KULLANILMAMALI
                let member;
                try {
                    const response = await fetch(`${API_BASE}/members.php?action=get&id=${id}`);
                    const result = await response.json();
                    if (!result.success || !result.data) {
                        showNotification('Ãœye detayÄ± alÄ±namadÄ±!', 'error');
                        return;
                    }
                    member = result.data;
                } catch (error) {
                    console.error('Member detail fetch error:', error);
                    showNotification('Ãœye detayÄ± alÄ±namadÄ±: ' + error.message, 'error');
                    return;
                }

                const memberPayments = payments.filter(p => p.memberId === id);

                // Ã–denen yÄ±llar
                const paidPayments = memberPayments.filter(p => p.status === 'tamamlandÄ±' && p.type === 'aidat');
                const paidYears = paidPayments.map(p => p.year).sort((a, b) => a - b);
                const totalPaid = paidPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                // Bekleyen Ã¶demeler (BORÃ‡LAR)
                const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor' && p.type === 'aidat');
                const debtYears = pendingPayments.map(p => p.year).sort((a, b) => a - b);
                const totalDebt = pendingPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                // Toplam
                const grandTotal = totalPaid + totalDebt;

                let detailHTML = `
                <!-- Ãœyelik Durumu Badge -->
                ${member.membershipStatus === 'ayrÄ±ldÄ±' ? `
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-user-times" style="font-size: 48px; opacity: 0.8;"></i>
                            <div>
                                <h3 style="margin: 0; font-size: 22px;">ÃœYELÄ°KTEN AYRILMIÅž</h3>
                                <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;">
                                    <strong>AyrÄ±lÄ±ÅŸ Tarihi:</strong> ${member.exitDate ? formatDate(member.exitDate) : '-'}<br>
                                    <strong>AyrÄ±lÄ±ÅŸ Nedeni:</strong> ${member.exitReasonType || '-'}
                                    ${member.exitReason ? `<br><strong>Detay:</strong> ${member.exitReason}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : member.membershipStatus === 'pasif' ? `
                    <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <i class="fas fa-pause-circle"></i> <strong>PASÄ°F ÃœYE</strong> - GeÃ§ici olarak aidat Ã¶demesi beklenmemektedir
                    </div>
                ` : ''}
                
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Ãœye No</label>
                        <div class="value">${member.memberNo}</div>
                    </div>
                    <div class="detail-item">
                        <label>Ad Soyad</label>
                        <div class="value">${member.firstName} ${member.lastName}</div>
                    </div>
                    <div class="detail-item">
                        <label>TC Kimlik No</label>
                        <div class="value">${member.tcNo}</div>
                    </div>
                    <div class="detail-item">
                        <label>Ãœyelik Tipi</label>
                        <div class="value">${member.membershipType}</div>
                    </div>
                    <div class="detail-item">
                        <label>DoÄŸum Tarihi</label>
                        <div class="value">${formatDate(member.birthDate)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Adres</label>
                        <div class="value">${member.city || '-'} / ${member.district || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>KayÄ±t Tarihi</label>
                        <div class="value">${formatDate(member.registrationDate)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Aidat Aktif</label>
                        <div class="value">${member.aidatAktif ? '<span class="badge success">Aktif</span>' : '<span class="badge warning">Pasif</span>'}</div>
                    </div>
                </div>
                
                <!-- Mali Durum Ã–zeti -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Ã–DENDÄ°</div>
                        <div style="font-size: 28px; font-weight: 700;">â‚º${totalPaid.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${paidPayments.length} Ã¶deme</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">BORÃ‡</div>
                        <div style="font-size: 28px; font-weight: 700;">â‚º${totalDebt.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${pendingPayments.length} bekleyen</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">TOPLAM</div>
                        <div style="font-size: 28px; font-weight: 700;">â‚º${grandTotal.toFixed(2)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${memberPayments.length} iÅŸlem</div>
                    </div>
                </div>
                
                <!-- YÄ±llara GÃ¶re Ã–deme Durumu -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid var(--tpjd-light);">
                    <h4 style="color: var(--tpjd-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-calendar-check"></i> Ã–denen YÄ±llar
                    </h4>
                    <div style="color: ${paidYears.length > 0 ? 'var(--tpjd-success)' : '#95a5a6'}; font-size: 16px; font-weight: 600;">
                        ${paidYears.length > 0 ? paidYears.join(', ') : 'HenÃ¼z Ã¶deme yapÄ±lmamÄ±ÅŸ'}
                    </div>
                </div>
                
                <div style="background: #fff5f5; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #ffcdd2;">
                    <h4 style="color: var(--tpjd-danger); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle"></i> BorÃ§lu YÄ±llar
                    </h4>
                    <div style="color: ${debtYears.length > 0 ? 'var(--tpjd-danger)' : 'var(--tpjd-success)'}; font-size: 16px; font-weight: 600;">
                        ${debtYears.length > 0 ? debtYears.join(', ') + ` (Toplam: â‚º${totalDebt.toFixed(2)})` : 'âœ“ BorÃ§ yok - TÃ¼m Ã¶demeler gÃ¼ncel'}
                    </div>
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: var(--tpjd-dark);">
                    <i class="fas fa-list"></i> DetaylÄ± Ã–deme DÃ¶kÃ¼mÃ¼
                </h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>YÄ±l</th>
                                <th>Tip</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>Tarih</th>
                                <th>FiÅŸ No</th>
                                <th>Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${memberPayments.length > 0 ? memberPayments.sort((a, b) => (b.year || 0) - (a.year || 0)).map(payment => `
                                <tr style="${payment.status === 'bekliyor' ? 'background: #fff5f5;' : ''}">
                                    <td><strong>${payment.year || '-'}</strong></td>
                                    <td>${payment.type === 'aidat' ? 'Aidat' : payment.type}</td>
                                    <td><strong style="color: ${payment.status === 'bekliyor' ? 'var(--tpjd-danger)' : 'var(--tpjd-success)'};">â‚º${parseFloat(payment.amount || 0).toFixed(2)}</strong></td>
                                    <td>
                                        ${payment.status === 'tamamlandÄ±' ?
                        '<span class="badge success"><i class="fas fa-check"></i> Ã–DENDÄ°</span>' :
                        '<span class="badge danger"><i class="fas fa-clock"></i> Ã–DENMEDÄ°</span>'}
                                    </td>
                                    <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                                    <td><small>${payment.receiptNo || '-'}</small></td>
                                    <td>
                                        ${payment.status === 'bekliyor' ?
                        `<button class="btn btn-primary" onclick="quickPayDebt('${payment.id}')" 
                                                    style="padding: 5px 12px; font-size: 12px;" title="HÄ±zlÄ± Ã–deme">
                                                <i class="fas fa-credit-card"></i> Ã–de
                                            </button>` :
                        '<span style="color: var(--tpjd-success); font-size: 12px;">âœ“ Ã–dendi</span>'}
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        <i class="fas fa-info-circle"></i>
                                        <p>HenÃ¼z Ã¶deme kaydÄ± bulunmamaktadÄ±r</p>
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;

                document.getElementById('memberDetailContent').innerHTML = detailHTML;
                openModal('memberDetailModal');
            }

            // Download member detail as HTML
            function downloadMemberDetail() {
                if (!currentMemberId) return;

                const member = members.find(m => m.id === currentMemberId);
                if (!member) return;

                const memberPayments = payments.filter(p => p.memberId === currentMemberId);
                const paidYears = memberPayments.filter(p => p.status === 'tamamlandÄ±' && p.type === 'aidat').map(p => p.year);
                const pendingPayments = memberPayments.filter(p => p.status === 'bekliyor');

                let html = `
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${member.firstName} ${member.lastName} - Ãœye DetayÄ±</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { margin: 0 0 10px 0; }
        .header p { margin: 0; opacity: 0.9; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-item { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .info-item label { display: block; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .info-item .value { font-size: 16px; color: #2c3e50; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        .footer { margin-top: 30px; text-align: center; color: #7f8c8d; font-size: 14px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>TPJD - Ãœye Detay Raporu</h1>
        <p>TÃ¼rkiye Petrol JeologlarÄ± DerneÄŸi</p>
    </div>
    
    <div class="info-grid">
        <div class="info-item"><label>Ãœye No</label><div class="value">${member.memberNo}</div></div>
        <div class="info-item"><label>Ad</label><div class="value">${member.firstName}</div></div>
        <div class="info-item"><label>Soyad</label><div class="value">${member.lastName}</div></div>
        <div class="info-item"><label>TC No</label><div class="value">${member.tcNo}</div></div>
        <div class="info-item"><label>Ãœyelik Tipi</label><div class="value">${member.membershipType}</div></div>
        <div class="info-item"><label>DoÄŸum Tarihi</label><div class="value">${formatDate(member.birthDate)}</div></div>
        <div class="info-item"><label>Nereli</label><div class="value">${member.birthCity || '-'} / ${member.birthDistrict || '-'}</div></div>
        <div class="info-item"><label>KayÄ±t Tarihi</label><div class="value">${formatDate(member.registrationDate)}</div></div>
        <div class="info-item"><label>Ã–denen YÄ±llar</label><div class="value">${paidYears.length > 0 ? paidYears.join(', ') : 'HenÃ¼z Ã¶deme yok'}</div></div>
        <div class="info-item"><label>Bekleyen Ã–deme</label><div class="value">${pendingPayments.length} adet</div></div>
    </div>
    
    <h3>BorÃ§ ve Ã–deme DÃ¶kÃ¼mÃ¼</h3>
    <table>
        <thead>
            <tr>
                <th>YÄ±l</th>
                <th>Tip</th>
                <th>Tutar</th>
                <th>Durum</th>
                <th>Tarih</th>
            </tr>
        </thead>
        <tbody>
            ${memberPayments.map(payment => `
                <tr>
                    <td>${payment.year}</td>
                    <td>${payment.type}</td>
                    <td>â‚º${payment.amount.toFixed(2)}</td>
                    <td>${payment.status === 'tamamlandÄ±' ? 'Ã–dendi' : 'Ã–denmedi'}</td>
                    <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    
    <div class="footer">
        <p>Bu rapor ${new Date().toLocaleDateString('tr-TR')} tarihinde oluÅŸturulmuÅŸtur.</p>
    </div>
</body>
</html>
            `;

                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${member.memberNo}_${member.firstName}_${member.lastName}_detay.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Ãœye detayÄ± HTML olarak indirildi!', 'success');
            }

            // Save payment
            function savePayment() {
                console.log("savePayment called");
                const saveBtn = document.querySelector('#paymentModal .btn-primary');
                const originalBtnText = saveBtn ? saveBtn.innerHTML : 'Kaydet';

                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                }

                const paymentId = document.getElementById('paymentId').value;
                const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

                const payment = {
                    id: paymentId || generateId(),
                    memberId: document.getElementById('paymentMemberId').value,
                    amount: parseFloat(document.getElementById('paymentAmount').value),
                    type: document.getElementById('paymentType').value,
                    date: document.getElementById('paymentDate').value,
                    year: parseInt(document.getElementById('paymentYear').value),
                    receiptNo: document.getElementById('receiptNo').value,
                    description: document.getElementById('paymentDescription').value,
                    status: document.getElementById('paymentStatus').value,
                    createdAt: now,
                    updatedAt: now
                };

                if (!payment.memberId) {
                    alert('âŒ Ãœye seÃ§imi zorunludur!');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
                    return;
                }
                if (!payment.amount || payment.amount <= 0) {
                    alert('âŒ GeÃ§erli bir tutar giriniz!');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
                    return;
                }
                if (!payment.date) {
                    alert('âŒ Tarih alanÄ± zorunludur!');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
                    return;
                }
                if (!payment.year || isNaN(payment.year)) {
                    alert('âŒ GeÃ§erli bir yÄ±l giriniz!');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
                    return;
                }

                // API'ye Ã¶deme kaydet
                const method = paymentId ? 'PUT' : 'POST';
                console.log(`Sending ${method} request to payments.php with payload:`, payment);

                fetch(`${API_BASE}/payments.php`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payment)
                })
                    .then(async response => {
                        const text = await response.text();
                        console.log("Raw payment save response:", text);
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            throw new Error("API non-JSON response: " + text);
                        }
                    })
                    .then(result => {
                        if (result.success) {
                            alert("Ã–deme baÅŸarÄ±yla kaydedildi.");
                            closeModal('paymentModal');
                            loadAllData();
                            // Agent Hook: Payment Confirmation
                            if (payment.status === 'tamamlandÄ±' && typeof agentManager !== 'undefined') {
                                agentManager.onPaymentConfirmed(payment);
                            }
                            // Direct updates for immediate UI refresh
                            setTimeout(() => {
                                updateDashboard();
                                updateDonutCharts();
                            }, 500);
                        } else {
                            alert('Hata: ' + result.message);
                        }
                    })
                    .catch(error => {
                        console.error('Save payment error:', error);
                        alert('Ã–deme kaydedilirken bir hata oluÅŸtu: ' + error.message);
                    })
                    .finally(() => {
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                    });
            }

            // Edit payment
            function editPayment(id) {
                const payment = payments.find(p => p.id === id);
                if (!payment) return;

                // Ã–NCE modalÄ± aÃ§ (bu form'u reset edecek)
                openModal('paymentModal');

                // SONRA deÄŸerleri doldur
                document.getElementById('paymentId').value = payment.id;
                document.getElementById('paymentAmount').value = payment.amount;
                document.getElementById('paymentType').value = payment.type;
                document.getElementById('paymentDate').value = payment.date;
                document.getElementById('paymentYear').value = payment.year;
                document.getElementById('receiptNo').value = payment.receiptNo || '';
                document.getElementById('paymentDescription').value = payment.description;
                document.getElementById('paymentStatus').value = payment.status;

                // Ãœye listesini doldur ve seÃ§
                populateMemberSelect();
                document.getElementById('paymentMemberId').value = payment.memberId;
            }

            // Delete payment
            function deletePayment(id) {
                if (!confirm('Bu Ã¶demeyi silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.')) return;

                fetch(`${API_BASE}/payments.php?id=${id}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            showNotification('Ã–deme baÅŸarÄ±yla silindi!', 'success');
                            loadAllData(); // Reload all data to ensure UI is in sync
                        } else {
                            showNotification(`Hata: ${result.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('API Error:', error);
                        showNotification('VeritabanÄ± baÄŸlantÄ± hatasÄ±!', 'error');
                    });
            }

            // Load members table
            function loadMembersTable() {
                const tbody = document.getElementById('membersTable');
                const searchTerm = document.getElementById('memberSearchInput').value.toLowerCase();
                const currentYear = new Date().getFullYear();

                const filteredMembers = members.filter(member => {
                    const fullName = `${member.firstName} ${member.lastName}`.toLowerCase();
                    const memberNo = member.memberNo.toLowerCase();
                    return fullName.includes(searchTerm) || memberNo.includes(searchTerm);
                });

                if (filteredMembers.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>HenÃ¼z Ã¼ye kaydÄ± bulunmamaktadÄ±r</h3>
                            <p>Yeni Ã¼ye eklemek iÃ§in "Yeni Ãœye Ekle" butonuna tÄ±klayÄ±n</p>
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = filteredMembers.map(member => {
                    const hasPaid = payments.some(p =>
                        p.memberId === member.id &&
                        p.type === 'aidat' &&
                        p.year == currentYear &&
                        p.status === 'tamamlandÄ±'
                    );

                    // Ãœyelik durumu badge'i
                    let statusBadge = '<span class="badge success">Aktif</span>';
                    if (member.membershipStatus === 'ayrÄ±ldÄ±') {
                        statusBadge = `<span class="badge danger" title="${member.exitReasonType || 'AyrÄ±ldÄ±'}">AyrÄ±ldÄ±</span>`;
                    } else if (member.membershipStatus === 'pasif') {
                        statusBadge = '<span class="badge warning">Pasif</span>';
                    }

                    return `
                    <tr style="${member.membershipStatus === 'ayrÄ±ldÄ±' ? 'opacity: 0.6;' : ''}">
                        <td>${member.memberNo}</td>
                        <td>${member.firstName} ${member.lastName} ${statusBadge}</td>
                        <td>${member.tcNo}</td>
                        <td>${member.email}</td>
                        <td>${member.phone}</td>
                        <td>${member.membershipType}</td>
                        <td>${formatDate(member.registrationDate)}</td>
                        <td>
                            <button class="action-btn view" onclick="viewMemberDetail('${member.id}')" title="DetaylarÄ± GÃ¶rÃ¼ntÃ¼le">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="loadMemberForEdit('${member.id}')" title="DÃ¼zenle">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteMember('${member.id}')" title="Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            }
            // Load payments table with accordion
            function loadPaymentsTable() {
                const container = document.getElementById('paymentsAccordion');

                if (payments.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3>HenÃ¼z Ã¶deme kaydÄ± bulunmamaktadÄ±r</h3>
                        <p>Yeni Ã¶deme eklemek iÃ§in "Ã–deme Ekle" butonuna tÄ±klayÄ±n</p>
                    </div>
                `;
                    return;
                }

                // Group payments by member
                const paymentsByMember = {};
                payments.forEach(payment => {
                    if (!paymentsByMember[payment.memberId]) {
                        paymentsByMember[payment.memberId] = [];
                    }
                    paymentsByMember[payment.memberId].push(payment);
                });

                container.innerHTML = '';

                Object.keys(paymentsByMember).forEach(memberId => {
                    const member = members.find(m => m.id === memberId);
                    if (!member) return;

                    const memberPayments = paymentsByMember[memberId];
                    const totalPaid = memberPayments.filter(p => p.status === 'tamamlandÄ±').reduce((sum, p) => sum + parseFloat(p.amount), 0);
                    const totalPending = memberPayments.filter(p => p.status === 'bekliyor').reduce((sum, p) => sum + parseFloat(p.amount), 0);

                    const accordion = document.createElement('div');
                    accordion.className = 'accordion';

                    const accordionHeader = document.createElement('div');
                    accordionHeader.className = 'accordion-header';
                    accordionHeader.innerHTML = `
                    <h3>
                        <i class="fas fa-user"></i>
                        ${member.memberNo} - ${member.firstName} ${member.lastName}
                        <span class="member-stats">
                            <span class="member-stat-badge" style="background: #27ae60;">â‚º${totalPaid.toFixed(2)} Ã–dendi</span>
                            <span class="member-stat-badge" style="background: #e67e22;">â‚º${totalPending.toFixed(2)} Ã–denmedi</span>
                        </span>
                    </h3>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                `;

                    const accordionContent = document.createElement('div');
                    accordionContent.className = 'accordion-content';

                    const accordionBody = document.createElement('div');
                    accordionBody.className = 'accordion-body';

                    const table = document.createElement('table');
                    table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>FiÅŸ No</th>
                            <th>Tip</th>
                            <th>YÄ±l</th>
                            <th>Tutar</th>
                            <th>AÃ§Ä±klama</th>
                            <th>Durum</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${memberPayments.map(payment => `
                            <tr>
                                <td>${payment.date ? formatDate(payment.date) : '-'}</td>
                                <td>${payment.receiptNo || '-'}</td>
                                <td>${payment.type}</td>
                                <td>${payment.year}</td>
                                <td>â‚º${parseFloat(payment.amount).toFixed(2)}</td>
                                <td>${payment.description}</td>
                                <td>
                                    ${payment.status === 'tamamlandÄ±' ?
                            '<span class="badge success">Ã–dendi</span>' :
                            '<span class="badge warning">Ã–denmedi</span>'}
                                </td>
                                <td>
                                    <button class="action-btn edit" onclick="editPayment('${payment.id}')" title="DÃ¼zenle">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="deletePayment('${payment.id}')" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;

                    accordionBody.appendChild(table);
                    accordionContent.appendChild(accordionBody);
                    accordion.appendChild(accordionHeader);
                    accordion.appendChild(accordionContent);
                    container.appendChild(accordion);

                    // Add click event to toggle accordion
                    accordionHeader.addEventListener('click', function () {
                        this.classList.toggle('active');
                        accordionContent.classList.toggle('active');
                    });
                });
            }

            // Save transaction

            // Display notifications
            function displayNotifications() {
                const container = document.getElementById('notificationsList');

                if (notifications.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>HenÃ¼z bildirim bulunmamaktadÄ±r</h3>
                        <p>Yeni bildirim gÃ¶ndermek iÃ§in "Yeni Bildirim GÃ¶nder" butonuna tÄ±klayÄ±n</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = notifications.map(notif => {
                    const dateText = notif.sentAt || notif.createdAt || notif.date || '';
                    let recipientLabel = 'AlÄ±cÄ± belirtilmedi';
                    if (Array.isArray(notif.recipients) && notif.recipients.length > 0) {
                        const names = notif.recipients.map(r => r.name || r.fullName || r.firstName || r.email || 'Bilinmeyen').filter(Boolean);
                        if (names.length <= 3) {
                            recipientLabel = names.join(', ');
                        } else {
                            recipientLabel = names.slice(0, 3).join(', ') + ` ve ${names.length - 3} kiÅŸi daha`;
                        }
                        recipientLabel += ` (${notif.recipients.length} kiÅŸi)`;
                    } else if (notif.recipientName) {
                        recipientLabel = notif.recipientName;
                    }
                    return `
                <div class="stat-card ${notif.read ? '' : 'info'}" style="margin-bottom: 15px;">
                    <h3>${notif.title || 'BaÅŸlÄ±ksÄ±z Bildirim'}</h3>
                    <p style="margin: 10px 0;">${notif.message || notif.content || 'Ä°Ã§erik yok'}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <small style="color: #7f8c8d;">
                            <i class="fas fa-calendar"></i> ${formatDateTime(dateText)} | 
                            <i class="fas fa-user"></i> ${recipientLabel}
                        </small>
                        <button class="action-btn delete" onclick="deleteNotification('${notif.id}')" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn edit" onclick="editNotification('${notif.id}')" title="DÃ¼zenle">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
                `;
                }).join('');
            }

            // Delete notification
            async function deleteNotification(id) {
                if (!confirm('Bu bildirimi silmek istediÄŸinizden emin misiniz?')) return;

                try {
                    const response = await fetch(`${API_BASE}/notifications.php?id=${id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) {
                        await loadNotifications();
                        showNotification('Bildirim baÅŸarÄ±yla silindi!', 'success');
                    } else {
                        showNotification(`Hata: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Bildirim silme hatasÄ±:', error);
                    showNotification('Bildirim silinemedi.', 'error');
                }
            }

            // Utility functions
            function formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('tr-TR');
            }

            function formatDateTime(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('tr-TR') + ' ' + date.toLocaleTimeString('tr-TR');
            }

            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notificationToast');
                notification.textContent = message;
                notification.className = `notification ${type} show`;

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }

            // Search functions
            function searchMembers() {
                const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
                const rows = document.querySelectorAll('#membersTable tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }

            function searchPayments() {
                const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
                const accordions = document.querySelectorAll('#paymentsAccordion .accordion');

                accordions.forEach(accordion => {
                    const text = accordion.textContent.toLowerCase();
                    accordion.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }


            // Export functions
            function exportToExcel() {
                const wb = XLSX.utils.book_new();

                // Members sheet
                const membersData = members.map(member => ({
                    'Ãœye No': member.memberNo,
                    'Ad': member.firstName,
                    'Soyad': member.lastName,
                    'TC No': member.tcNo,
                    'E-posta': member.email,
                    'Telefon': member.phone,
                    'Ãœyelik Tipi': member.membershipType,
                    'KayÄ±t Tarihi': member.registrationDate
                }));
                const wsMembers = XLSX.utils.json_to_sheet(membersData);
                XLSX.utils.book_append_sheet(wb, wsMembers, 'Ãœyeler');

                // Payments sheet
                const paymentsData = payments.map(payment => {
                    const member = members.find(m => m.id === payment.memberId);
                    return {
                        'Ãœye': member ? `${member.memberNo} - ${member.firstName} ${member.lastName}` : 'Bilinmeyen',
                        'Tutar': payment.amount,
                        'Tip': payment.type,
                        'YÄ±l': payment.year,
                        'Tarih': payment.date,
                        'FiÅŸ No': payment.receiptNo,
                        'AÃ§Ä±klama': payment.description,
                        'Durum': payment.status
                    };
                });
                const wsPayments = XLSX.utils.json_to_sheet(paymentsData);
                XLSX.utils.book_append_sheet(wb, wsPayments, 'Ã–demeler');

                XLSX.writeFile(wb, 'tpjd_veriler.xlsx');
                showNotification('Excel dosyasÄ± indirildi!', 'success');
            }

            function exportMembersToExcel() {
                const membersData = members.map(member => ({
                    'Ãœye No': member.memberNo,
                    'Ad': member.firstName,
                    'Soyad': member.lastName,
                    'TC No': member.tcNo,
                    'E-posta': member.email,
                    'Telefon': member.phone,
                    'Ãœyelik Tipi': member.membershipType,
                    'KayÄ±t Tarihi': member.registrationDate
                }));

                const ws = XLSX.utils.json_to_sheet(membersData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ãœyeler');
                XLSX.writeFile(wb, 'tpjd_uyeler.xlsx');
                showNotification('Ãœyeler Excel dosyasÄ± indirildi!', 'success');
            }

            function exportPaymentsToExcel() {
                const paymentsData = payments.map(payment => {
                    const member = members.find(m => m.id === payment.memberId);
                    return {
                        'Ãœye': member ? `${member.memberNo} - ${member.firstName} ${member.lastName}` : 'Bilinmeyen',
                        'Tutar': payment.amount,
                        'Tip': payment.type,
                        'YÄ±l': payment.year,
                        'Tarih': payment.date,
                        'FiÅŸ No': payment.receiptNo,
                        'AÃ§Ä±klama': payment.description,
                        'Durum': payment.status
                    };
                });

                const ws = XLSX.utils.json_to_sheet(paymentsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ã–demeler');
                XLSX.writeFile(wb, 'tpjd_odemeler.xlsx');
                showNotification('Ã–demeler Excel dosyasÄ± indirildi!', 'success');
            }


            function exportToJSON() {
                const data = {
                    members: members,
                    payments: payments,
                    notifications: notifications,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tpjd_yedek.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('JSON yedek dosyasÄ± indirildi!', 'success');
            }

            async function importFromJSON(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm('JSON dosyasÄ± yÃ¼klenecek. Mevcut veriler API Ã¼zerinden gÃ¼ncellenecek. Emin misiniz?')) {
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        if (Array.isArray(data.members)) {
                            for (const member of data.members) {
                                await fetch(`${API_BASE}/members.php`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(member)
                                });
                            }
                        }
                        if (Array.isArray(data.payments)) {
                            for (const payment of data.payments) {
                                await fetch(`${API_BASE}/payments.php`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payment)
                                });
                            }
                        }
                        if (Array.isArray(data.notifications)) {
                            for (const notif of data.notifications) {
                                await fetch(`${API_BASE}/notifications.php`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(notif)
                                });
                            }
                        }

                        await loadAllData();
                        showNotification('JSON dosyasÄ± baÅŸarÄ±yla yÃ¼klendi!', 'success');
                    } catch (error) {
                        showNotification('JSON dosyasÄ± okunamadÄ±!', 'error');
                        console.error('JSON import error:', error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            // Dashboard update function
            function updateDashboard() {
                const currentYear = new Date().getFullYear();
                const activeMembersList = members.filter(m => m.membershipStatus !== 'ayrÄ±ldÄ±');
                const totalMembers = activeMembersList.length;
                let paidMembers = 0;
                let totalIncome = 0;

                // All completed payments (for total income)
                const completedPayments = payments.filter(p => p.status === 'tamamlandÄ±');

                // Current year completed payments (for paid members count)
                const currentYearPayments = completedPayments.filter(p =>
                    String(p.year) === String(currentYear)
                );

                console.log('All completed payments:', completedPayments);
                console.log('Current year payments:', currentYearPayments);

                // Calculate total income from ALL completed payments
                completedPayments.forEach(payment => {
                    totalIncome += parseFloat(payment.amount || 0);
                });

                activeMembersList.forEach(member => {
                    const hasPaid = currentYearPayments.some(p => p.memberId === member.id);
                    if (hasPaid) {
                        paidMembers++;
                    }
                });

                console.log(`Dashboard Update: currentYear=${currentYear}, totalMembers=${totalMembers}, totalIncome=${totalIncome}, paidMembers=${paidMembers}`);

                document.getElementById('totalMembers').textContent = totalMembers;
                document.getElementById('activeMembers').textContent = paidMembers || totalMembers;
                document.getElementById('pendingPayments').textContent = debtors.length;
                document.getElementById('totalIncome').textContent = 'â‚º' + totalIncome.toFixed(2);

                updateDashboardTable();
            }

            // Dashboard tablosu gÃ¼ncelleme - SADECE BORÃ‡LU ÃœYELERÄ° GÃ–STER
            function updateDashboardTable() {
                const tbody = document.getElementById('dashboardMembersTable');
                if (!debtors || debtors.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-check-circle" style="color: var(--tpjd-success);"></i>
                            <h3>Harika! BorÃ§lu Ã¼ye bulunmamaktadÄ±r</h3>
                            <p>TÃ¼m Ã¼yelerin Ã¶demeleri gÃ¼ncel</p>
                        </td>
                    </tr>
                `;
                    document.getElementById('debtorCount').textContent = '0 BorÃ§lu Ãœye';
                    return;
                }

                document.getElementById('debtorCount').textContent = `${debtors.length} BorÃ§lu Ãœye`;

                tbody.innerHTML = debtors.map(debtor => {
                    // Ensure debtor.memberId is a string and properly escaped for HTML attributes
                    const mId = String(debtor.memberId).replace(/'/g, "\\'");
                    return `
                <tr>
                    <td><strong>${debtor.memberNo}</strong></td>
                    <td>${debtor.fullName}</td>
                    <td>${debtor.membershipType}</td>
                    <td><small>${debtor.email || '-'}</small></td>
                    <td><small>${debtor.phone || '-'}</small></td>
                    <td><span class="badge danger">BEKLÄ°YOR</span></td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <strong style="color: var(--tpjd-danger); font-size: 16px;">â‚º${Number(debtor.due).toFixed(2)}</strong>
                            <small style="color: #7f8c8d;">Ã–denen: â‚º${Number(debtor.paid).toFixed(2)}</small>
                        </div>
                    </td>
                    <td>
                        <button class="action-btn view" onclick="viewMemberDetail('${mId}')" title="DetaylarÄ± GÃ¶rÃ¼ntÃ¼le">
                            <i class="fas fa-eye"></i> Detay
                        </button>
                    </td>
                </tr>
            `}).join('');
            }

            // Sample data function (API-backed)
            async function loadSampleData() {
                if (!confirm('Ã–rnek veriler yÃ¼klenecek. Mevcut veriler korunur, yeni kayÄ±tlar eklenecek. Emin misiniz?')) return;

                const currentYear = new Date().getFullYear();
                const sampleMembers = [
                    {
                        id: generateId(),
                        memberNo: `TPJD${Math.floor(Math.random() * 900 + 100)}`,
                        membershipType: 'Asil Ãœye',
                        aidatAktif: true,
                        firstName: 'Ahmet',
                        lastName: 'YÄ±lmaz',
                        tcNo: `${Date.now().toString().slice(-11)}`,
                        gender: 'Erkek',
                        birthDate: '1975-05-15',
                        phone: '+905551234567',
                        email: `ahmet${Date.now()}@email.com`,
                        address: 'AtatÃ¼rk BulvarÄ± No:123 Daire:5',
                        city: 'Ä°stanbul',
                        registrationDate: '2010-01-15',
                        birthCity: 'Ankara'
                    },
                    {
                        id: generateId(),
                        memberNo: `TPJD${Math.floor(Math.random() * 900 + 100)}`,
                        membershipType: 'Ã–ÄŸrenci Ãœye',
                        aidatAktif: true,
                        firstName: 'AyÅŸe',
                        lastName: 'Demir',
                        tcNo: `${(Date.now() + 1).toString().slice(-11)}`,
                        gender: 'KadÄ±n',
                        birthDate: '2001-12-10',
                        phone: '+905551234569',
                        email: `ayse${Date.now()}@email.com`,
                        address: 'Ã–ÄŸrenci Yurdu KampÃ¼s Ä°Ã§i',
                        city: 'Ä°zmir',
                        registrationDate: '2022-09-10',
                        birthCity: 'Ä°zmir'
                    },
                    {
                        id: generateId(),
                        memberNo: `TPJD${Math.floor(Math.random() * 900 + 100)}`,
                        membershipType: 'Fahri Ãœye',
                        aidatAktif: true,
                        firstName: 'Zeynep',
                        lastName: 'Åžahin',
                        tcNo: `${(Date.now() + 2).toString().slice(-11)}`,
                        gender: 'KadÄ±n',
                        birthDate: '1988-03-25',
                        phone: '+905551234570',
                        email: `zeynep${Date.now()}@email.com`,
                        address: 'Ã‡amlÄ±ca Mahallesi Sokak No:45/7',
                        city: 'Ankara',
                        registrationDate: '2015-06-12',
                        birthCity: 'Bursa'
                    }
                ];

                try {
                    for (const m of sampleMembers) {
                        await fetch(`${API_BASE}/members.php`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(m)
                        });
                    }

                    const paymentsToInsert = [
                        {
                            id: generateId(),
                            memberId: sampleMembers[1].id,
                            amount: 50,
                            type: 'aidat',
                            date: `${currentYear}-01-05`,
                            year: currentYear,
                            receiptNo: 'FIS001',
                            description: `${currentYear} yÄ±lÄ± Ã¶ÄŸrenci aidat Ã¶demesi`,
                            status: 'tamamlandÄ±'
                        },
                        {
                            id: generateId(),
                            memberId: sampleMembers[2].id,
                            amount: 100,
                            type: 'aidat',
                            date: `${currentYear}-01-15`,
                            year: currentYear,
                            receiptNo: 'FIS002',
                            description: `${currentYear} yÄ±lÄ± aidat Ã¶demesi`,
                            status: 'tamamlandÄ±'
                        }
                    ];

                    for (const p of paymentsToInsert) {
                        await fetch(`${API_BASE}/payments.php`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(p)
                        });
                    }

                    await loadAllData();
                    showNotification('âœ… Ã–rnek veriler baÅŸarÄ±yla eklendi!', 'success');
                } catch (error) {
                    console.error('Ã–rnek veri yÃ¼kleme hatasÄ±:', error);
                    showNotification('Ã–rnek veriler eklenirken hata oluÅŸtu.', 'error');
                }
            }

        </script>

        <script>
            // Event Announcement Function
            async function sendEventAnnouncement() {
                const title = document.getElementById('eventTitle').value.trim();
                const date = document.getElementById('eventDate').value;
                const time = document.getElementById('eventTime').value || '10:00';
                const location = document.getElementById('eventLocation').value.trim();
                const description = document.getElementById('eventDescription').value.trim();
                const target = document.getElementById('eventTarget').value;
                const channel = document.querySelector('input[name="eventChannel"]:checked')?.value || 'email';

                if (!title || !date || !description) {
                    showNotification('Etkinlik adÄ±, tarih ve aÃ§Ä±klama zorunludur!', 'error');
                    return;
                }

                const sendEmail = (channel === 'email' || channel === 'both');
                const sendWhatsApp = (channel === 'whatsapp' || channel === 'both');

                const btn = document.getElementById('sendEventBtn');
                const origHTML = btn.innerHTML;

                // Build WhatsApp message for event
                const dateFormatted = new Date(date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                const waMessage = `ðŸ“¢ *${title}*\n\nðŸ“… Tarih: ${dateFormatted}\nðŸ• Saat: ${time}${location ? '\nðŸ“ Konum: ' + location : ''}\n\n${description}\n\n_TPJD_`;

                // Send Email if selected (always call PHP to get whatsapp_queue)
                let phpResult = null;
                if (sendEmail || sendWhatsApp) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GÃ¶nderiliyor...';
                    btn.style.opacity = '0.7';

                    try {
                        const response = await fetch('api/agents.php?action=event_announce', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, date, time, location, description, target, channel })
                        });
                        phpResult = await response.json();

                        if (sendEmail) {
                            if (phpResult.success) {
                                showNotification(`âœ… E-posta: ${phpResult.data?.sent || 0} Ã¼yeye gÃ¶nderildi!`, 'success');
                            } else {
                                showNotification('âŒ E-posta gÃ¶nderilemedi: ' + (phpResult.message || ''), 'error');
                            }
                        }
                    } catch (error) {
                        showNotification('âŒ Hata: ' + error.message, 'error');
                    }
                }

                // Send WhatsApp from PHP's whatsapp_queue (has decrypted phones)
                if (sendWhatsApp && phpResult?.data?.whatsapp_queue?.length > 0) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> WhatsApp gÃ¶nderiliyor...';
                    await processWhatsAppQueue(phpResult.data.whatsapp_queue, 'event_announce');
                } else if (sendWhatsApp) {
                    showNotification('âš ï¸ WhatsApp kuyruÄŸu oluÅŸturulamadÄ±', 'warning');
                }

                btn.innerHTML = origHTML;
                btn.style.opacity = '1';
                btn.disabled = false;

                // Close modal after all sends complete
                setTimeout(() => { closeModal('eventModal'); }, 1500);
            }
        </script>

        <script>
            // Bulk Email Modal Functions
            function openBulkEmailModal() {
                document.getElementById('bulkEmailModal').classList.add('active');
                document.getElementById('bulkEmailTarget').value = '';
                document.getElementById('emailPreviewSection').style.display = 'none';
            }

            function closeBulkEmailModal() {
                document.getElementById('bulkEmailModal').classList.remove('active');
            }

            // Bulk SMS Functions
            function openBulkSMSModal() {
                document.getElementById('bulkSMSModal').classList.add('active');
                document.getElementById('smsPreviewSection').style.display = 'none';
                document.getElementById('bulkSMSMessage').value = '';
                document.getElementById('bulkSMSTarget').value = '';
                updateSMSCharCount();
            }

            function closeBulkSMSModal() {
                document.getElementById('bulkSMSModal').classList.remove('active');
            }

            // â•â•â• Bulk WhatsApp Wizard â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let waRecipients = [];
            let waCurrentIndex = 0;
            let waSentCount = 0;
            let waSkippedCount = 0;
            let waSending = false;

            function openBulkWhatsAppModal() {
                document.getElementById('bulkWhatsAppModal').classList.add('active');
                document.getElementById('waStep1').style.display = 'block';
                document.getElementById('waStep2').style.display = 'none';
                document.getElementById('bulkWATarget').value = '';
                document.getElementById('bulkWAMessage').value = '';
                document.getElementById('waPreviewSection').style.display = 'none';
                document.getElementById('waStartBtn').style.display = '';
                document.getElementById('waStopBtn').style.display = 'none';
                document.getElementById('waCancelText').textContent = 'Ä°ptal';
                waRecipients = [];
                waCurrentIndex = 0;
                waSentCount = 0;
                waSkippedCount = 0;
                waSending = false;
            }

            function closeBulkWhatsAppModal() {
                waSending = false;
                document.getElementById('bulkWhatsAppModal').classList.remove('active');
            }

            function updateWAPreview() {
                const target = document.getElementById('bulkWATarget').value;
                const previewSection = document.getElementById('waPreviewSection');
                const countEl = document.getElementById('waRecipientCount');
                const warningEl = document.getElementById('waNoPhoneWarning');

                if (!target) { previewSection.style.display = 'none'; return; }

                const currentYear = new Date().getFullYear();
                let filtered = [];
                let totalInGroup = 0;

                switch (target) {
                    case 'all':
                        filtered = members.filter(m => m.membershipStatus !== 'ayrÄ±ldÄ±');
                        break;
                    case 'debtors':
                        const debtorIds = new Set(debtors.map(d => d.memberId));
                        filtered = members.filter(m => debtorIds.has(m.id));
                        break;
                    case 'active':
                        const activeIds = new Set(
                            payments.filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandÄ±').map(p => p.memberId)
                        );
                        filtered = members.filter(m => activeIds.has(m.id));
                        break;
                    case 'asil':
                        filtered = members.filter(m => m.membershipType === 'Asil Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±');
                        break;
                    case 'ogrenci':
                        filtered = members.filter(m => m.membershipType === 'Ã–ÄŸrenci Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±');
                        break;
                    case 'fahri':
                        filtered = members.filter(m => m.membershipType === 'Fahri Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±');
                        break;
                }

                totalInGroup = filtered.length;
                const withPhone = filtered.filter(m => m.phone);
                const noPhoneCount = totalInGroup - withPhone.length;

                countEl.textContent = `${withPhone.length} kiÅŸiye gÃ¶nderilecek`;
                warningEl.textContent = noPhoneCount > 0 ? `âš ï¸ ${noPhoneCount} Ã¼yenin telefon numarasÄ± yok, atlanacak` : '';
                previewSection.style.display = 'block';

                // Store for later
                waRecipients = withPhone.map(m => ({
                    id: m.id,
                    name: `${m.firstName} ${m.lastName}`,
                    phone: m.phone
                }));
            }

            async function startBulkWhatsApp() {
                const message = document.getElementById('bulkWAMessage').value.trim();
                if (!waRecipients.length) { showNotification('LÃ¼tfen hedef grup seÃ§in!', 'warning'); return; }
                if (!message) { showNotification('LÃ¼tfen mesaj yazÄ±n!', 'warning'); return; }

                // Check WhatsApp local server status
                try {
                    const statusCheck = await fetch('http://localhost:3456/status', { signal: AbortSignal.timeout(3000) });
                    const statusData = await statusCheck.json();
                    if (!statusData.authenticated) {
                        showNotification('âš ï¸ WhatsApp baÄŸlÄ± deÄŸil! Ajanlar sekmesinden QR kod ile baÄŸlanÄ±n.', 'warning');
                        return;
                    }
                } catch (e) {
                    showNotification('âš ï¸ WhatsApp sunucusu Ã§alÄ±ÅŸmÄ±yor! Ajanlar sekmesinden QR kod ile baÄŸlantÄ± kurun.', 'warning');
                    return;
                }

                // Switch to Step 2
                document.getElementById('waStep1').style.display = 'none';
                document.getElementById('waStep2').style.display = 'block';
                document.getElementById('waStartBtn').style.display = 'none';
                document.getElementById('waStopBtn').style.display = '';
                document.getElementById('waCancelText').textContent = 'Kapat';

                waCurrentIndex = 0;
                waSentCount = 0;
                waSkippedCount = 0;
                waSending = true;
                document.getElementById('waSentLog').innerHTML = '';

                updateWAProgress();

                // Auto-send loop
                for (let i = 0; i < waRecipients.length; i++) {
                    if (!waSending) break; // Stopped by user

                    waCurrentIndex = i;
                    showCurrentWARecipient();

                    try {
                        const r = waRecipients[i];
                        const response = await fetch(`${API_BASE}/agents.php?action=send_notification`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                channel: 'whatsapp',
                                memberId: r.id,
                                message: message,
                                subject: 'Toplu WhatsApp'
                            })
                        });
                        const result = await response.json();

                        if (result.success || result.data?.status === 'success') {
                            addWASentLog(r.name, 'sent');
                            waSentCount++;
                        } else {
                            addWASentLog(r.name + ' â€” ' + (result.data?.detail || result.message || 'Hata'), 'error');
                            waSkippedCount++;
                        }
                    } catch (err) {
                        addWASentLog(waRecipients[i].name + ' â€” BaÄŸlantÄ± hatasÄ±', 'error');
                        waSkippedCount++;
                    }

                    updateWAProgress();

                    // Small delay to avoid rate limiting
                    if (waSending && i < waRecipients.length - 1) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }

                waSending = false;
                document.getElementById('waStopBtn').style.display = 'none';
                updateWAProgress();
            }

            function stopBulkWhatsApp() {
                waSending = false;
                document.getElementById('waStopBtn').style.display = 'none';
                document.getElementById('waProgressTitle').textContent = 'â¹ï¸ GÃ¶nderim Durduruldu';
                document.getElementById('waProgressSubtitle').textContent = `${waSentCount} gÃ¶nderildi, ${waSkippedCount} hata, ${waRecipients.length - waSentCount - waSkippedCount} kalan`;
                document.getElementById('waCurrentRecipient').style.display = 'none';
                showNotification(`â¹ï¸ WhatsApp gÃ¶nderimi durduruldu. ${waSentCount} mesaj gÃ¶nderildi.`, 'info');
            }

            function updateWAProgress() {
                const total = waRecipients.length;
                const done = waSentCount + waSkippedCount;
                const pct = total > 0 ? Math.round((done / total) * 100) : 0;

                document.getElementById('waProgressBar').style.width = pct + '%';
                document.getElementById('waProgressText').textContent = `${done} / ${total}`;
                document.getElementById('waProgressTitle').textContent =
                    done >= total ? 'âœ… GÃ¶nderim TamamlandÄ±!' : 'GÃ¶nderim Devam Ediyor...';
                document.getElementById('waProgressSubtitle').textContent =
                    done >= total ? `${waSentCount} gÃ¶nderildi, ${waSkippedCount} hata` : `${waSentCount} gÃ¶nderildi...`;

                if (done >= total && total > 0) {
                    document.getElementById('waStopBtn').style.display = 'none';
                    document.getElementById('waCurrentRecipient').style.display = 'none';
                    document.getElementById('waCancelText').textContent = 'Kapat';
                    document.getElementById('waProgressIcon').innerHTML = '<i class="fas fa-check-circle" style="color:#27ae60;"></i>';

                    // Log to notifications
                    const target = document.getElementById('bulkWATarget').value;
                    saveNotification(null, 'Toplu WhatsApp', `${target} grubuna ${waSentCount} kiÅŸiye WhatsApp mesajÄ± gÃ¶nderildi`, 'WhatsApp');
                    showNotification(`âœ… ${waSentCount} kiÅŸiye WhatsApp gÃ¶nderildi!`, 'success');
                }
            }

            function showCurrentWARecipient() {
                if (waCurrentIndex >= waRecipients.length) return;

                const r = waRecipients[waCurrentIndex];
                document.getElementById('waCurrentRecipient').style.display = 'block';
                document.getElementById('waRecipientAvatar').textContent = r.name.charAt(0).toUpperCase();
                document.getElementById('waRecipientName').textContent = r.name;
                document.getElementById('waRecipientPhone').textContent = r.phone;
            }

            function addWASentLog(name, status) {
                const log = document.getElementById('waSentLog');
                const color = status === 'sent' ? '#27ae60' : '#e74c3c';
                const icon = status === 'sent' ? 'check' : 'exclamation-triangle';
                const label = status === 'sent' ? 'GÃ¶nderildi' : 'Hata';
                log.innerHTML = `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:13px;color:${color};">
                    <i class="fas fa-${icon}"></i> ${name} â€” ${label}
                </div>` + log.innerHTML;
            }

            async function saveNotification(memberId, title, message, channel) {
                try {
                    await fetch(API_BASE + '/notifications.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ memberId, title, message, channel, status: 'sent' })
                    });
                } catch (e) { console.warn('Notification save failed:', e); }
            }

            function updateSMSCharCount() {
                const message = document.getElementById('bulkSMSMessage').value;
                const count = message.length;
                document.getElementById('smsCharCount').textContent = `${count} / 917`;
            }

            function updateSMSPreview() {
                const target = document.getElementById('bulkSMSTarget').value;
                const previewSection = document.getElementById('smsPreviewSection');
                const recipientCountEl = document.getElementById('smsRecipientCount');
                const recipientListEl = document.getElementById('smsRecipientList');

                if (!target) {
                    previewSection.style.display = 'none';
                    return;
                }

                let recipients = [];
                const currentYear = new Date().getFullYear();

                switch (target) {
                    case 'all':
                        recipients = members
                            .filter(m => m.phone && m.membershipStatus !== 'ayrÄ±ldÄ±')
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'debtors':
                        const debtorIds = new Set(debtors.map(d => d.memberId));
                        recipients = members
                            .filter(m => debtorIds.has(m.id) && m.phone)
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'active':
                        const activeIds = new Set(
                            payments
                                .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandÄ±')
                                .map(p => p.memberId)
                        );
                        recipients = members
                            .filter(m => activeIds.has(m.id) && m.phone)
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'asil':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Asil Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±')
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'ogrenci':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Ã–ÄŸrenci Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±')
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'fahri':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Fahri Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±')
                            .map(m => ({ phone: m.phone, name: `${m.firstName} ${m.lastName}` }));
                        break;
                }

                if (recipients.length === 0) {
                    recipientCountEl.textContent = '0 kiÅŸi';
                    recipientListEl.innerHTML = '<p style="color: #999;">SeÃ§ilen grupta telefon numarasÄ± olan Ã¼ye bulunmamaktadÄ±r.</p>';
                } else {
                    recipientCountEl.textContent = `${recipients.length} kiÅŸi`;
                    recipientListEl.innerHTML = recipients
                        .map(r => `<div>${r.name} - ${r.phone}</div>`)
                        .join('');
                }

                previewSection.style.display = 'block';
            }

            async function sendBulkSMS() {
                const target = document.getElementById('bulkSMSTarget').value;
                const message = document.getElementById('bulkSMSMessage').value.trim();
                const iysFilter = document.getElementById('smsIysFilter').value;

                if (!target) {
                    showNotification('LÃ¼tfen bir hedef grup seÃ§in!', 'warning');
                    return;
                }

                if (!message) {
                    showNotification('LÃ¼tfen bir mesaj yazÄ±n!', 'warning');
                    return;
                }

                if (message.length > 917) {
                    showNotification('Mesaj 917 karakterden uzun olamaz!', 'warning');
                    return;
                }

                // Get recipients based on target
                let recipients = [];
                const currentYear = new Date().getFullYear();

                switch (target) {
                    case 'all':
                        recipients = members
                            .filter(m => m.phone && m.membershipStatus !== 'ayrÄ±ldÄ±')
                            .map(m => m.phone);
                        break;
                    case 'debtors':
                        const debtorIds = new Set(debtors.map(d => d.memberId));
                        recipients = members
                            .filter(m => debtorIds.has(m.id) && m.phone)
                            .map(m => m.phone);
                        break;
                    case 'active':
                        const activeIds = new Set(
                            payments
                                .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandÄ±')
                                .map(p => p.memberId)
                        );
                        recipients = members
                            .filter(m => activeIds.has(m.id) && m.phone)
                            .map(m => m.phone);
                        break;
                    case 'asil':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Asil Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±')
                            .map(m => m.phone);
                        break;
                    case 'ogrenci':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Ã–ÄŸrenci Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±')
                            .map(m => m.phone);
                        break;
                    case 'fahri':
                        recipients = members
                            .filter(m => m.phone && m.membershipType === 'Fahri Ãœye' && m.membershipStatus !== 'ayrÄ±ldÄ±')
                            .map(m => m.phone);
                        break;
                }

                if (recipients.length === 0) {
                    showNotification('SeÃ§ilen grupta telefon numarasÄ± olan Ã¼ye bulunmamaktadÄ±r.', 'warning');
                    return;
                }

                if (!confirm(`${recipients.length} kiÅŸiye SMS gÃ¶ndermek istediÄŸinize emin misiniz?`)) {
                    return;
                }

                showNotification('SMS gÃ¶nderiliyor...', 'info');

                try {
                    const response = await fetch(`${API_BASE}/sms.php?action=send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recipients: recipients,
                            message: message,
                            iysFilter: iysFilter
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification(`âœ… SMS baÅŸarÄ±yla kuyruÄŸa alÄ±ndÄ±! GÃ¶rev ID: ${result.data.jobId}`, 'success');
                        closeBulkSMSModal();
                    } else {
                        showNotification('âŒ SMS gÃ¶nderilemedi: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('SMS send error:', error);
                    showNotification('SMS gÃ¶nderilirken bir hata oluÅŸtu.', 'error');
                }
            }

            // AlÄ±cÄ±larÄ± Ã¶nizleme
            function updateEmailPreview() {
                const target = document.getElementById('bulkEmailTarget').value;
                const previewSection = document.getElementById('emailPreviewSection');
                const recipientCountEl = document.getElementById('emailRecipientCount');
                const recipientListEl = document.getElementById('emailRecipientList');

                if (!target) {
                    previewSection.style.display = 'none';
                    return;
                }

                let recipients = [];
                const currentYear = new Date().getFullYear();

                switch (target) {
                    case 'all':
                        recipients = members
                            .filter(m => m.email && m.membershipStatus === 'aktif')
                            .map(m => ({ email: m.email, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'paid':
                        const paidMemberIds = new Set(
                            payments
                                .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandÄ±')
                                .map(p => p.memberId)
                        );
                        recipients = members
                            .filter(m => m.email && m.membershipStatus === 'aktif' && paidMemberIds.has(m.id))
                            .map(m => ({ email: m.email, name: `${m.firstName} ${m.lastName}` }));
                        break;
                    case 'unpaid':
                        const paidMemberIdsForUnpaid = new Set(
                            payments
                                .filter(p => p.type === 'aidat' && p.year === currentYear && p.status === 'tamamlandÄ±')
                                .map(p => p.memberId)
                        );
                        recipients = members
                            .filter(m => m.email && m.membershipStatus === 'aktif' && !paidMemberIdsForUnpaid.has(m.id))
                            .map(m => ({ email: m.email, name: `${m.firstName} ${m.lastName}` }));
                        break;
                }

                recipientCountEl.textContent = `${recipients.length} alÄ±cÄ± bulundu.`;
                recipientListEl.innerHTML = recipients.map(r => `<div>${r.name} (${r.email})</div>`).join('');
                previewSection.style.display = 'block';
            }

            // Server-side email sending function
            async function sendBulkEmailDirect() {
                const target = document.getElementById('bulkEmailTarget').value;
                const subject = document.getElementById('bulkEmailSubject').value.trim();
                const message = document.getElementById('bulkEmailMessage').value.trim();

                if (!target) {
                    showNotification('LÃ¼tfen bir hedef grup seÃ§in!', 'warning');
                    return;
                }

                if (!subject) {
                    showNotification('LÃ¼tfen e-posta konusu girin!', 'warning');
                    return;
                }

                if (!message) {
                    showNotification('LÃ¼tfen e-posta mesajÄ± girin!', 'warning');
                    return;
                }

                const recipients = getEmailRecipients(target);

                if (recipients.length === 0) {
                    showNotification('SeÃ§ilen grupta e-posta adresi olan Ã¼ye bulunamadÄ±!', 'error');
                    return;
                }

                if (!confirm(`${recipients.length} kiÅŸiye e-posta gÃ¶ndermek istediÄŸinize emin misiniz?`)) {
                    return;
                }

                showNotification('E-posta gÃ¶nderiliyor...', 'info');

                try {
                    const response = await fetch(`${API_BASE}/send_email.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recipients: recipients,
                            subject: subject,
                            message: message
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const successCount = result.data.success_count || 0;
                        const failureCount = result.data.failure_count || 0;
                        showNotification(`âœ… E-posta gÃ¶nderildi! BaÅŸarÄ±lÄ±: ${successCount}, BaÅŸarÄ±sÄ±z: ${failureCount}`, 'success');
                        closeBulkEmailModal();
                    } else {
                        showNotification('âŒ E-posta gÃ¶nderilemedi: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Email send error:', error);
                    showNotification('E-posta gÃ¶nderilirken bir hata oluÅŸtu.', 'error');
                }
            }

            // AlÄ±cÄ±larÄ± al
            function getEmailRecipients(target) {
                let recipientMembers = [];
                const currentYear = new Date().getFullYear();

                if (target === 'all') {
                    recipientMembers = members;
                } else if (target === 'paid') {
                    recipientMembers = members.filter(member => {
                        const paid = payments.some(p => p.memberId === member.id && p.type === 'aidat' && p.year == currentYear && p.status === 'tamamlandÄ±');
                        return paid;
                    });
                } else if (target === 'unpaid') {
                    recipientMembers = members.filter(member => {
                        const hasDebt = payments.some(p => p.memberId === member.id && p.type === 'aidat' && p.status === 'bekliyor');
                        return hasDebt;
                    });
                }

                // Sadece email adresi olanlarÄ± al
                return recipientMembers
                    .filter(m => m.email && m.email.trim() !== '')
                    .map(m => ({
                        name: `${m.firstName} ${m.lastName}`,
                        email: m.email.trim()
                    }));
            }

            // Validasyon
            function validateEmailForm() {
                const target = document.getElementById('bulkEmailTarget').value;
                const subject = document.getElementById('bulkEmailSubject').value.trim();
                const message = document.getElementById('bulkEmailMessage').value.trim();

                if (!target) {
                    showNotification('LÃ¼tfen hedef grup seÃ§in!', 'warning');
                    return null;
                }

                if (!subject) {
                    showNotification('LÃ¼tfen e-posta konusu girin!', 'warning');
                    return null;
                }

                if (!message) {
                    showNotification('LÃ¼tfen e-posta mesajÄ± girin!', 'warning');
                    return null;
                }

                const recipients = getEmailRecipients(target);

                if (recipients.length === 0) {
                    showNotification('SeÃ§ilen grupta e-posta adresi olan Ã¼ye bulunamadÄ±!', 'error');
                    return null;
                }

                return { recipients, subject, message };
            }

            // Gmail'den gÃ¶nder
            function sendViaGmail() {
                const data = validateEmailForm();
                if (!data) return;

                const emails = data.recipients.map(r => r.email).join(',');
                const subject = encodeURIComponent(data.subject);
                const body = encodeURIComponent(data.message);

                // Gmail compose URL
                const gmailUrl = `https://mail.google.com/mail/?view=cm&bcc=${emails}&su=${subject}&body=${body}`;

                // Yeni sekmede aÃ§
                window.open(gmailUrl, '_blank');

                // Bildirim kaydet
                saveEmailNotification(data.recipients.length, 'Gmail');

                closeBulkEmailModal();
                showNotification(`âœ… Gmail aÃ§Ä±ldÄ±! ${data.recipients.length} alÄ±cÄ± BCC olarak eklendi.`, 'success');
            }

            // Outlook'tan gÃ¶nder
            function sendViaOutlook() {
                const data = validateEmailForm();
                if (!data) return;

                const emails = data.recipients.map(r => r.email).join(';'); // Outlook noktalÄ± virgÃ¼l kullanÄ±r
                const subject = encodeURIComponent(data.subject);
                const body = encodeURIComponent(data.message);

                // Outlook Web compose URL
                const outlookUrl = `https://outlook.live.com/mail/0/deeplink/compose?bcc=${emails}&subject=${subject}&body=${body}`;

                // Yeni sekmede aÃ§
                window.open(outlookUrl, '_blank');

                // Bildirim kaydet
                saveEmailNotification(data.recipients.length, 'Outlook');

                closeBulkEmailModal();
                showNotification(`âœ… Outlook aÃ§Ä±ldÄ±! ${data.recipients.length} alÄ±cÄ± BCC olarak eklendi.`, 'success');
            }

            // VarsayÄ±lan mail programÄ±ndan gÃ¶nder
            function sendViaDefaultMail() {
                const data = validateEmailForm();
                if (!data) return;

                const emails = data.recipients.map(r => r.email).join(',');
                const subject = encodeURIComponent(data.subject);
                const body = encodeURIComponent(data.message);

                // Mailto protokolÃ¼
                const mailtoUrl = `mailto:?bcc=${emails}&subject=${subject}&body=${body}`;

                // VarsayÄ±lan mail programÄ±nÄ± aÃ§
                window.location.href = mailtoUrl;

                // Bildirim kaydet
                saveEmailNotification(data.recipients.length, 'VarsayÄ±lan Mail');

                // KÄ±sa bir gecikme ile modal'Ä± kapat
                setTimeout(() => {
                    closeBulkEmailModal();
                    showNotification(`âœ… Mail programÄ±nÄ±z aÃ§Ä±ldÄ±! ${data.recipients.length} alÄ±cÄ± eklendi.`, 'success');
                }, 500);
            }

            // E-posta gÃ¶nderim bildirimini kaydet
            async function saveEmailNotification(recipientCount, method) {
                const notification = {
                    id: generateId(),
                    memberId: 'system',
                    memberName: 'Sistem',
                    title: `Toplu E-posta GÃ¶nderimi (${method})`,
                    message: `${recipientCount} kiÅŸiye e-posta gÃ¶nderilmek Ã¼zere ${method} aÃ§Ä±ldÄ±.`,
                    priority: 'normal',
                    recipients: ['bulk_email'],
                    sentAt: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };

                await persistNotification(notification);
            }

            // Load all data
            async function loadAllData() {
                // First load settings to ensure correct aidat values are available
                await loadAllSettings();

                // Then load other data in parallel
                await Promise.all([
                    loadMembers(),
                    loadPayments(),
                    loadNotifications()
                ]);

                // Load debtors for ALL years (not just current) to show complete debt list on dashboard
                await loadDebtors('all');

                // Refresh all UI components that depend on this data
                updateDashboard();
                updateDonutCharts();
                loadMembersTable();
                loadPaymentsTable();
                displayNotifications();
                updateSettingsInfo(); // Update settings statistics after data is loaded
                populateSettingsForm();
            }

            async function loadMembers() {
                console.log("loadMembers called");
                try {
                    const response = await fetch(`${API_BASE}/members.php?action=list`);
                    const text = await response.text();
                    console.log("Raw members response:", text);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        console.error("JSON Parse Error:", e);
                        alert("API JSON hatasÄ± (Ãœyeler): " + text);
                        return;
                    }

                    if (result.success) {
                        members = result.data || [];
                        console.log("Members loaded:", members.length);
                        // Add visible status line
                        const statusEl = document.getElementById('membersStatusLine');
                        if (statusEl) statusEl.textContent = `Sistemdeki Ãœye SayÄ±sÄ±: ${members.length}`;
                        loadMembersTable();
                    } else {
                        console.error('Failed to load members:', result.message);
                        members = [];
                        alert('Ãœyeler yÃ¼klenemedi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Load members error:', error);
                    members = [];
                    alert('Ãœyeleri yÃ¼klerken bir aÄŸ hatasÄ± oluÅŸtu: ' + error.message);
                }
            }

            async function loadPayments() {
                console.log("loadPayments called");
                try {
                    const response = await fetch(`${API_BASE}/payments.php?action=list`);
                    const text = await response.text();
                    console.log("Raw payments response:", text);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        console.error("JSON Parse Error (Payments):", e);
                        alert("API JSON hatasÄ± (Ã–demeler): " + text);
                        return;
                    }

                    if (result.success) {
                        payments = result.data || [];
                        console.log("Payments loaded:", payments.length);
                        loadPaymentsTable();
                    } else {
                        console.error('Failed to load payments:', result.message);
                        payments = [];
                        alert('Ã–demeler yÃ¼klenemedi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Load payments error:', error);
                    payments = [];
                    alert('Ã–demeleri yÃ¼klerken bir aÄŸ hatasÄ± oluÅŸtu: ' + error.message);
                }
            }

            async function loadNotifications() {
                try {
                    const response = await fetch(`${API_BASE}/notifications.php?action=list`);
                    const result = await response.json();
                    if (result.success) {
                        notifications = result.data || [];
                    } else {
                        console.error('Failed to load notifications:', result.message);
                        notifications = [];
                        showNotification('Bildirimler yÃ¼klenemedi: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('Load notifications error:', error);
                    notifications = [];
                    showNotification('Bildirimleri yÃ¼klerken bir aÄŸ hatasÄ± oluÅŸtu.', 'error');
                }
                displayNotifications();
            }

            async function loadDebtors(year = new Date().getFullYear()) {
                console.log(`loadDebtors called for year: ${year}`);
                console.log("Current Window Location:", window.location.href);
                console.log("Current Origin:", window.origin);
                try {
                    const url = `${API_BASE}/reports.php?action=debtors&year=${year}`;
                    console.log(`Fetching debtors from: ${url}`);

                    const startTime = performance.now();
                    const response = await fetch(url).catch(err => {
                        console.error("Fetch implementation caught error:", err);
                        throw err; // Re-throw for outer catch
                    });
                    const duration = performance.now() - startTime;
                    console.log(`Fetch completed in ${duration.toFixed(2)}ms`);

                    if (!response.ok) {
                        throw new Error(`HTTP Hata! Kod: ${response.status} - ${response.statusText}`);
                    }

                    const text = await response.text();
                    console.log("Raw debtors response length:", text.length);

                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        console.error("JSON Parse Error (Debtors):", e);
                        alert("API JSON hatasÄ± (BorÃ§lular): " + (text.substring(0, 500)));
                        return;
                    }

                    if (result.success && result.data) {
                        debtors = result.data.data || result.data || [];
                        console.log("Debtors loaded:", debtors.length);
                        updateDashboardTable();
                    } else {
                        console.error('Failed to load debtors:', result.message);
                        debtors = [];
                    }
                } catch (error) {
                    console.error('Detailed fetch error (Debtors):', error);
                    console.error('Error Name:', error.name);
                    console.error('Error Message:', error.message);
                    console.error('Error Stack:', error.stack);

                    let msg = error.message;
                    if (error.name === 'TypeError' && msg === 'Failed to fetch') {
                        msg = "Sunucuya baÄŸlanÄ±lamadÄ± (Network error). Laragon'un aÃ§Ä±k olduÄŸundan ve API_BASE yolunun doÄŸruluÄŸundan emin olun. TarayÄ±cÄ± konsolundaki (F12) Network sekmesini kontrol edin.";
                    }

                    alert('BorÃ§lu listesi yÃ¼klenirken bir hata oluÅŸtu: ' + msg);
                    debtors = [];
                }
            }

            function toggleRecipientSelection() {
                const type = document.getElementById('notificationType').value;
                document.getElementById('groupSelectionContainer').style.display = type === 'group' ? 'block' : 'none';
                document.getElementById('individualSelectionContainer').style.display = type === 'individual' ? 'block' : 'none';
                document.getElementById('individualSendButtons').style.display = type === 'individual' ? 'block' : 'none';
                document.getElementById('groupSendButtons').style.display = type === 'group' ? 'block' : 'none';
                if (type === 'individual') populateIndividualMemberSelect();
            }

            function updateMembershipType() {
                const type = document.getElementById('membershipType').value;
                const aidatAktifCheckbox = document.getElementById('aidatAktif');

                if (aidatAktifCheckbox) {
                    aidatAktifCheckbox.checked = !(type.includes('Onursal'));
                }
                toggleAidatBedelField();
            }

            function toggleAidatBedelField() {
                const isNewMember = !document.getElementById('memberId').value;
                const aidatAktif = document.getElementById('aidatAktif').checked;
                const container = document.getElementById('aidatBedelContainer');
                const bedelInput = document.getElementById('manuelAidatBedel');
                const membershipType = document.getElementById('membershipType').value;

                if (isNewMember && aidatAktif && container) {
                    container.style.display = 'block';
                    // Ayarlardan varsayÄ±lan tutarÄ± doldur
                    if (membershipType && typeof aidatSettings !== 'undefined') {
                        const defaultAmount = parseFloat(aidatSettings[membershipType] || 0);
                        bedelInput.placeholder = defaultAmount > 0
                            ? `VarsayÄ±lan: â‚º${defaultAmount} (ayarlardan)`
                            : 'Bu Ã¼yelik tipi borÃ§landÄ±rÄ±lmaz';
                    }
                } else if (container) {
                    container.style.display = 'none';
                }
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // AgentManager - TPJD Agent System v0.9
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            class AgentManager {
                constructor() {
                    this.config = {};
                    this.stats = {};
                    this.apiBase = API_BASE + '/agents.php';
                }

                async init() {
                    try {
                        await this.loadConfig();
                        await this.loadStats();
                        await this.loadLogs();
                        this.applyConfig();
                        console.log('ðŸ¤– AgentManager initialized');
                    } catch (e) {
                        console.warn('AgentManager init warning:', e.message);
                    }
                }

                async loadConfig() {
                    try {
                        const res = await fetch(`${this.apiBase}?action=config`);
                        const data = await res.json();
                        if (data.success) this.config = data.data || {};
                    } catch (e) { console.warn('Config load failed:', e); }
                }

                async loadStats() {
                    try {
                        const res = await fetch(`${this.apiBase}?action=stats`);
                        const data = await res.json();
                        if (data.success) {
                            this.stats = data.data;
                            this.updateStatsUI();
                        }
                    } catch (e) { console.warn('Stats load failed:', e); }
                }

                updateStatsUI() {
                    const s = this.stats;
                    // Active agents count
                    const activeCount = Object.keys(this.config).filter(k => this.config[k]?.enabled !== false).length;
                    const el = (id) => document.getElementById(id);
                    if (el('activeAgentsCount')) el('activeAgentsCount').textContent = activeCount;

                    // Monthly actions
                    if (s.agents && el('monthlyAgentActions')) {
                        const total = Object.values(s.agents).reduce((sum, a) => sum + parseInt(a.total_actions || 0), 0);
                        el('monthlyAgentActions').textContent = total;
                    }

                    // Collection rate
                    if (s.collection && el('collectionRate')) {
                        el('collectionRate').textContent = '%' + (s.collection.rate || 0);
                    }

                    // Debtor count
                    if (s.pending) {
                        if (el('debtorCountAgent')) el('debtorCountAgent').textContent = s.pending.debtor_count || 0;
                        if (el('totalDebtAmount')) el('totalDebtAmount').textContent = 'â‚º' + (s.pending.total_debt || 0).toLocaleString('tr-TR') + ' toplam borÃ§';
                    }

                    // Per-agent stats
                    if (s.agents) {
                        Object.entries(s.agents).forEach(([name, stat]) => {
                            const statEl = el('stat_' + name);
                            if (statEl) statEl.textContent = `${stat.success_count || 0} baÅŸarÄ±lÄ± / ${stat.error_count || 0} hata â€” Son: ${stat.last_run ? new Date(stat.last_run).toLocaleString('tr-TR') : 'â€”'}`;
                        });
                    }
                }

                applyConfig() {
                    Object.entries(this.config).forEach(([agent, cfg]) => {
                        const toggle = document.getElementById('toggle_' + agent);
                        if (toggle) toggle.checked = cfg.enabled !== false;
                    });
                }

                async toggleAgent(agent, enabled) {
                    this.config[agent] = this.config[agent] || {};
                    this.config[agent].enabled = enabled;
                    await this.saveConfig();
                    showNotification(enabled ? `${agent} agent'Ä± aktifleÅŸtirildi` : `${agent} agent'Ä± devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±`, enabled ? 'success' : 'warning');
                }

                async saveConfig() {
                    try {
                        await fetch(`${this.apiBase}?action=config`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.config)
                        });
                    } catch (e) { console.error('Config save error:', e); }
                }

                async loadLogs() {
                    try {
                        const filter = document.getElementById('agentLogFilter')?.value || '';
                        const url = filter ? `${this.apiBase}?action=logs&agent=${filter}&limit=50` : `${this.apiBase}?action=logs&limit=50`;
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.success) this.renderLogs(data.data || []);
                    } catch (e) { console.warn('Logs load failed:', e); }
                }

                renderLogs(logs) {
                    const tbody = document.getElementById('agentLogsTable');
                    if (!tbody) return;
                    this._logData = logs;

                    // Update count badge in header
                    const countBadge = document.getElementById('agentLogCount');
                    if (countBadge) countBadge.textContent = logs.length;

                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;"><i class="fas fa-robot" style="font-size:48px;color:#bdc3c7;"></i><p style="color:#95a5a6;margin-top:10px;">HenÃ¼z agent iÅŸlemi yok</p></td></tr>';
                        document.getElementById('logSelectAll').checked = false;
                        this.updateSelectionCount();
                        return;
                    }

                    const agentNames = {
                        payment_confirm: 'ðŸ’³ Ã–deme Onay', welcome: 'ðŸ‘‹ HoÅŸ Geldin', debt_reminder: 'ðŸ”” BorÃ§ HatÄ±rlatma',
                        yearly_charge: 'ðŸ“… YÄ±llÄ±k BorÃ§', birthday: 'ðŸŽ‚ DoÄŸum GÃ¼nÃ¼', accounting: 'ðŸ§® Muhasebe',
                        monthly_report: 'ðŸ“Š AylÄ±k Rapor', event_announce: 'ðŸ“¢ Etkinlik'
                    };
                    const agentColors = {
                        payment_confirm: '#3498db', welcome: '#2ecc71', debt_reminder: '#e67e22',
                        yearly_charge: '#9b59b6', birthday: '#e91e63', accounting: '#00bcd4',
                        monthly_report: '#ff9800', event_announce: '#ff5722'
                    };
                    const statusColors = { success: '#27ae60', error: '#e74c3c', pending: '#f39c12' };
                    const statusLabels = { success: 'BaÅŸarÄ±lÄ±', error: 'Hata', pending: 'Bekliyor' };

                    tbody.innerHTML = logs.map((log, i) => {
                        const agentColor = agentColors[log.agent_name] || '#95a5a6';
                        const sColor = statusColors[log.status] || '#95a5a6';
                        const dateStr = new Date(log.created_at).toLocaleString('tr-TR');
                        const agentLabel = agentNames[log.agent_name] || log.agent_name;
                        const sLabel = statusLabels[log.status] || log.status;
                        const detail = (log.details || 'â€”').replace(/"/g, '&quot;');
                        const shortDetail = detail.length > 40 ? detail.substring(0, 40) + 'â€¦' : detail;

                        return `<tr data-log-id="${log.id}" style="background:rgba(255,255,255,0.02);transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                            <td style="padding:10px 6px;text-align:center;"><input type="checkbox" class="log-checkbox" data-index="${i}" onchange="agentManager.updateSelectionCount()" style="width:15px;height:15px;cursor:pointer;"></td>
                            <td style="padding:10px;"><span style="background:${agentColor};color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;white-space:nowrap;">${agentLabel}</span></td>
                            <td style="padding:10px;font-size:13px;">${log.recipient_name || 'â€”'}</td>
                            <td style="padding:10px;font-size:12px;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#aaa;" title="${detail}">${shortDetail}</td>
                            <td style="padding:10px;font-size:12px;white-space:nowrap;color:#95a5a6;">${dateStr}</td>
                            <td style="padding:10px;text-align:center;"><span style="background:${sColor};color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;">${sLabel}</span></td>
                            <td style="padding:10px;text-align:center;"><button onclick="agentManager.deleteLog('${log.id}')" title="Sil" style="background:none;border:none;cursor:pointer;color:#e74c3c;font-size:14px;padding:4px;"><i class="fas fa-trash-alt"></i></button></td>
                        </tr>`;
                    }).join('');

                    document.getElementById('logSelectAll').checked = false;
                    this.updateSelectionCount();
                }

                toggleSelectAll(checked) {
                    document.querySelectorAll('.log-checkbox').forEach(cb => cb.checked = checked);
                    this.updateSelectionCount();
                }

                updateSelectionCount() {
                    const checked = document.querySelectorAll('.log-checkbox:checked').length;
                    const countEl = document.getElementById('logSelectedCount');
                    const deleteBtn = document.getElementById('logDeleteSelectedBtn');
                    if (countEl) countEl.textContent = checked + ' seÃ§ili';
                    if (deleteBtn) deleteBtn.style.display = checked > 0 ? 'inline-block' : 'none';
                }

                async deleteLog(logId) {
                    if (!confirm('Bu log kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?')) return;
                    try {
                        const res = await fetch(`${this.apiBase}?action=delete_log&id=${logId}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            showNotification('Log kaydÄ± silindi', 'success');
                            await this.loadLogs();
                        } else {
                            showNotification('Silme hatasÄ±: ' + (data.message || ''), 'error');
                        }
                    } catch (e) {
                        showNotification('Silme hatasÄ±', 'error');
                    }
                }

                async deleteSelected() {
                    const checkboxes = document.querySelectorAll('.log-checkbox:checked');
                    if (checkboxes.length === 0) return;
                    if (!confirm(`${checkboxes.length} log kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?`)) return;

                    const ids = [];
                    checkboxes.forEach(cb => {
                        const item = cb.closest('tr[data-log-id]');
                        if (item) ids.push(item.dataset.logId);
                    });

                    try {
                        const res = await fetch(`${this.apiBase}?action=delete_logs`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ids })
                        });
                        const data = await res.json();
                        if (data.success) {
                            showNotification(`${ids.length} log kaydÄ± silindi`, 'success');
                            await this.loadLogs();
                        } else {
                            showNotification('Toplu silme hatasÄ±: ' + (data.message || ''), 'error');
                        }
                    } catch (e) {
                        showNotification('Toplu silme hatasÄ±', 'error');
                    }
                }

                async refreshAll() {
                    const btn = document.getElementById('agentRefreshBtn');
                    if (btn) { btn.style.background = '#f39c12'; btn.style.borderColor = '#f39c12'; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yenileniyor...'; }
                    showNotification('Agent verileri yenileniyor...', 'info');
                    await this.loadConfig();
                    await this.loadStats();
                    await this.loadLogs();
                    this.applyConfig();
                    if (btn) { btn.style.background = '#27ae60'; btn.style.borderColor = '#27ae60'; btn.innerHTML = '<i class="fas fa-check"></i> GÃ¼ncel'; }
                    const now = new Date();
                    const timeStr = now.toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
                    const span = document.getElementById('agentLastRefresh');
                    if (span) span.textContent = `Son: ${timeStr}`;
                    showNotification('Agent verileri gÃ¼ncellendi', 'success');
                }

                async runAllAgents() {
                    const btn = document.getElementById('agentRunAllBtn');
                    if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ã‡alÄ±ÅŸÄ±yor...'; btn.style.background = '#f39c12'; btn.style.borderColor = '#f39c12'; }
                    showNotification('TÃ¼m agentlar sÄ±rayla Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...', 'info');
                    let ran = 0;

                    // BorÃ§ HatÄ±rlatma (Kademe 1 - nazik)
                    if (this.config.debt_reminder?.enabled) {
                        try { await this.runDebtReminder(1); ran++; } catch (e) { console.error('Debt reminder error:', e); }
                    }

                    // DoÄŸum GÃ¼nÃ¼
                    if (this.config.birthday?.enabled) {
                        try { await this.runBirthdayAgent(); ran++; } catch (e) { console.error('Birthday agent error:', e); }
                    }

                    // Verileri yenile
                    await this.loadStats();
                    await this.loadLogs();

                    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check-circle"></i> TamamlandÄ±!'; btn.style.background = '#27ae60'; btn.style.borderColor = '#27ae60'; }
                    setTimeout(() => { if (btn) { btn.innerHTML = '<i class="fas fa-play-circle"></i> TÃ¼mÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±r'; btn.style.background = '#8e44ad'; btn.style.borderColor = '#8e44ad'; } }, 3000);
                    showNotification(`âœ… ${ran} agent baÅŸarÄ±yla Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±!`, 'success');
                }

                // â”€â”€ Event Hooks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                async onPaymentConfirmed(payment) {
                    if (!this.config.payment_confirm?.enabled) return;
                    const member = members.find(m => m.id === payment.memberId);
                    if (!member) return;
                    const subject = 'Ã–deme OnayÄ± - TPJD';
                    const message = `SayÄ±n ${member.firstName} ${member.lastName},\n\n${payment.year} yÄ±lÄ± ${payment.type} Ã¶demeniz (â‚º${payment.amount}) baÅŸarÄ±yla alÄ±nmÄ±ÅŸtÄ±r.\n\nMakbuz No: ${payment.receiptNo || 'BelirtilmemiÅŸ'}\nTarih: ${payment.date}\n\nTeÅŸekkÃ¼r ederiz.\nTPJD YÃ¶netimi`;

                    const channels = this.config.payment_confirm?.channels || ['email'];
                    for (const channel of channels) {
                        if (channel === 'whatsapp') {
                            // WhatsApp mesajÄ±nÄ± tarayÄ±cÄ±dan gÃ¶nder
                            if (member.phone) {
                                let waPhone = (member.phone || '').replace(/[^0-9]/g, '');
                                if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                await processWhatsAppQueue([{
                                    number: waPhone, message, recipient_id: member.id,
                                    recipient_name: `${member.firstName} ${member.lastName}`,
                                    detail: `ðŸ’° Ã–deme onayÄ± â€” â‚º${payment.amount}`
                                }], 'payment_confirm');
                            }
                        } else {
                            try {
                                await fetch(`${this.apiBase}?action=send-notification`, {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ agent_name: 'payment_confirm', channel, recipient_id: member.id, subject, message })
                                });
                                console.log(`ðŸ¤– Payment confirm (${channel}) sent to`, member.firstName);
                            } catch (e) { console.error(`Payment confirm ${channel} error:`, e); }
                        }
                    }
                }

                async onNewMember(member) {
                    if (!this.config.welcome?.enabled) return;
                    const subject = 'TPJD\'ye HoÅŸ Geldiniz!';
                    const message = `SayÄ±n ${member.firstName} ${member.lastName},\n\nTÃ¼rkiye Petrol JeologlarÄ± DerneÄŸi ailesine hoÅŸ geldiniz!\n\nÃœye NumaranÄ±z: ${member.memberNo}\nÃœyelik Tipiniz: ${member.membershipType}\n\nSorularÄ±nÄ±z iÃ§in uye@tpjd.org.tr adresinden bize ulaÅŸabilirsiniz.\n\nSaygÄ±larÄ±mÄ±zla,\nTPJD YÃ¶netimi`;

                    const channels = this.config.welcome?.channels || ['email'];
                    for (const channel of channels) {
                        if (channel === 'whatsapp') {
                            if (member.phone) {
                                let waPhone = (member.phone || '').replace(/[^0-9]/g, '');
                                if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                await processWhatsAppQueue([{
                                    number: waPhone, message, recipient_id: member.id,
                                    recipient_name: `${member.firstName} ${member.lastName}`,
                                    detail: 'ðŸ‘‹ HoÅŸ geldin mesajÄ±'
                                }], 'welcome');
                            }
                        } else {
                            try {
                                await fetch(`${this.apiBase}?action=send-notification`, {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ agent_name: 'welcome', channel, recipient_id: member.id, subject, message })
                                });
                                console.log(`ðŸ¤– Welcome (${channel}) sent to`, member.firstName);
                            } catch (e) { console.error(`Welcome ${channel} error:`, e); }
                        }
                    }
                }

                async runDebtReminder(tier) {
                    if (!this.config.debt_reminder?.enabled) { alert('BorÃ§ HatÄ±rlatma agent\'Ä± devre dÄ±ÅŸÄ±!'); return; }
                    const tierNames = { 1: 'Nazik HatÄ±rlatma', 2: 'Resmi UyarÄ±', 3: 'Son UyarÄ±' };
                    if (!confirm(`Kademe ${tier} (${tierNames[tier]}) borÃ§ hatÄ±rlatmasÄ± gÃ¶nderilecek. Devam?`)) return;

                    try {
                        showNotification('BorÃ§lu Ã¼yeler taranÄ±yor...', 'info');
                        const res = await fetch(`${this.apiBase}?action=debtors&tier=${tier}`);
                        const data = await res.json();
                        if (!data.success) { alert('Hata: ' + data.message); return; }

                        const debtors = data.data?.data || [];
                        if (debtors.length === 0) { showNotification('Bu kademe iÃ§in borÃ§lu Ã¼ye bulunamadÄ±', 'warning'); return; }

                        let sent = 0;
                        const waQueue = [];
                        // IBAN bilgisi varsa mesaja ekle
                        const iban = settings?.iban_settings || {};
                        let ibanBlock = '';
                        if (iban.iban) {
                            ibanBlock = `\n\nðŸ¦ Ã–deme Bilgileri:\nBanka: ${iban.banka_adi || '-'}\nHesap Sahibi: ${iban.hesap_sahibi || '-'}\nIBAN: ${iban.iban}${iban.aciklama ? '\nAÃ§Ä±klama: ' + iban.aciklama : ''}`;
                        }
                        for (const debtor of debtors) {
                            const subjects = { 1: 'Aidat HatÄ±rlatmasÄ± - TPJD', 2: 'Resmi Aidat UyarÄ±sÄ± - TPJD', 3: 'Son UyarÄ±: Aidat Borcunuz - TPJD' };
                            const messages = {
                                1: `SayÄ±n ${debtor.fullName},\n\n${debtor.debtYears} yÄ±llarÄ±na ait toplam â‚º${debtor.totalDebt} aidat borcunuz bulunmaktadÄ±r. En yakÄ±n zamanda Ã¶demenizi yapmanÄ±zÄ± rica ederiz.${ibanBlock}\n\nTPJD YÃ¶netimi`,
                                2: `SayÄ±n ${debtor.fullName},\n\nDaha Ã¶nce bildirilen â‚º${debtor.totalDebt} tutarÄ±ndaki ${debtor.debtYears} yÄ±llarÄ±na ait aidat borcunuz hÃ¢lÃ¢ Ã¶denmemiÅŸtir. En kÄ±sa sÃ¼rede Ã¶deme yapmanÄ±zÄ± Ã¶nemle rica ederiz.${ibanBlock}\n\nTPJD YÃ¶netim Kurulu`,
                                3: `SayÄ±n ${debtor.fullName},\n\nÃ–denmemiÅŸ â‚º${debtor.totalDebt} aidat borcunuz (${debtor.debtYears}) iÃ§in son uyarÄ±dÄ±r. 30 gÃ¼n iÃ§inde Ã¶deme yapÄ±lmamasÄ± halinde Ã¼yelik durumunuz deÄŸerlendirmeye alÄ±nacaktÄ±r.${ibanBlock}\n\nTPJD YÃ¶netim Kurulu`
                            };

                            // Email gÃ¶nder
                            await fetch(`${this.apiBase}?action=send-notification`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ agent_name: 'debt_reminder', channel: 'email', recipient_id: debtor.memberId, subject: subjects[tier], message: messages[tier] })
                            });
                            sent++;

                            // WhatsApp kuyruÄŸuna ekle
                            if (debtor.phone) {
                                let waPhone = debtor.phone.replace(/[^0-9]/g, '');
                                if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;

                                waQueue.push({
                                    number: waPhone,
                                    message: messages[tier],
                                    recipient_id: debtor.memberId,
                                    recipient_name: debtor.fullName,
                                    detail: `ðŸ”” BorÃ§ hatÄ±rlatma Kademe ${tier} â€” â‚º${debtor.totalDebt}`
                                });
                            }
                        }
                        showNotification(`Kademe ${tier}: ${sent} Ã¼yeye email gÃ¶nderildi`, 'success');

                        // WhatsApp mesajlarÄ±nÄ± tarayÄ±cÄ±dan gÃ¶nder
                        if (waQueue.length > 0) {
                            await processWhatsAppQueue(waQueue, 'debt_reminder');
                        }

                        this.loadLogs();
                        this.loadStats();
                    } catch (e) { alert('BorÃ§ hatÄ±rlatma hatasÄ±: ' + e.message); }
                }

                async runYearlyCharge() {
                    if (!this.config.yearly_charge?.enabled) { alert('YÄ±llÄ±k BorÃ§landÄ±rma agent\'Ä± devre dÄ±ÅŸÄ±!'); return; }
                    const year = prompt('BorÃ§landÄ±rma yÄ±lÄ±nÄ± girin:', new Date().getFullYear());
                    if (!year) return;

                    try {
                        showNotification('YÄ±llÄ±k borÃ§landÄ±rma baÅŸlatÄ±lÄ±yor...', 'info');
                        const res = await fetch(`${this.apiBase}?action=run`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ agent: 'yearly_charge', year: parseInt(year) })
                        });
                        const data = await res.json();
                        showNotification(data.message || 'BorÃ§landÄ±rma tamamlandÄ±', data.success ? 'success' : 'error');
                        if (data.success) { loadAllData(); this.loadStats(); this.loadLogs(); }
                    } catch (e) { alert('BorÃ§landÄ±rma hatasÄ±: ' + e.message); }
                }

                async runBirthdayAgent() {
                    if (!this.config.birthday?.enabled) { alert('DoÄŸum GÃ¼nÃ¼ agent\'Ä± devre dÄ±ÅŸÄ±!'); return; }
                    try {
                        showNotification('DoÄŸum gÃ¼nleri kontrol ediliyor...', 'info');
                        const res = await fetch(`${this.apiBase}?action=run`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ agent: 'birthday' })
                        });
                        const data = await res.json();
                        showNotification(data.message || 'DoÄŸum gÃ¼nÃ¼ kontrolÃ¼ tamamlandÄ±', data.success ? 'success' : 'error');

                        // WhatsApp kuyruÄŸunu tarayÄ±cÄ±dan gÃ¶nder
                        if (data.data?.whatsapp_queue?.length > 0) {
                            await processWhatsAppQueue(data.data.whatsapp_queue, 'birthday');
                        }

                        this.loadLogs();
                    } catch (e) { alert('DoÄŸum gÃ¼nÃ¼ agent hatasÄ±: ' + e.message); }
                }

                async runSeniorityAgent() {
                    if (!this.config.seniority_promotion?.enabled) { alert('KÄ±dem Terfi agent\'Ä± devre dÄ±ÅŸÄ±!'); return; }
                    try {
                        showNotification('ðŸ… KÄ±dem terfi adaylarÄ± kontrol ediliyor...', 'info');

                        // 1. Terfi adaylarÄ±nÄ± kontrol et
                        const checkRes = await fetch(`${this.apiBase}?action=seniority_check`);
                        const checkData = await checkRes.json();

                        if (!checkData.success || !checkData.data?.candidates?.length) {
                            showNotification('Terfi edilecek Ã¼ye bulunamadÄ± (20+ yÄ±l kÄ±dem gerekli)', 'info');
                            return;
                        }

                        const candidates = checkData.data.candidates;
                        if (!confirm(`${candidates.length} Ã¼ye terfi iÃ§in uygun:\n\n${candidates.map(c => `â€¢ ${c.fullName} (${c.years} yÄ±l)`).join('\n')}\n\nTerfi edilsin mi?`)) {
                            return;
                        }

                        // 2. Terfi iÅŸlemini Ã§alÄ±ÅŸtÄ±r
                        const promoRes = await fetch(`${this.apiBase}?action=seniority_promote`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ candidates: candidates.map(c => c.id) })
                        });
                        const promoData = await promoRes.json();

                        if (promoData.success) {
                            const promoted = promoData.data?.promoted || [];
                            showNotification(`ðŸ… ${promoted.length} Ã¼ye onursal Ã¼yeliÄŸe terfi edildi!`, 'success');

                            // WhatsApp bildirimlerini gÃ¶nder
                            if (promoData.data?.whatsapp_queue?.length > 0) {
                                await processWhatsAppQueue(promoData.data.whatsapp_queue, 'seniority_promotion');
                            }
                        } else {
                            showNotification('Terfi iÅŸlemi baÅŸarÄ±sÄ±z: ' + (promoData.message || 'Bilinmeyen hata'), 'error');
                        }

                        this.loadLogs();
                        this.loadStats();
                    } catch (e) { alert('KÄ±dem terfi agent hatasÄ±: ' + e.message); }
                }
            }

            const agentManager = new AgentManager();

            // â”€â”€â”€ WhatsApp (Evolution API) Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let whatsappSettings = { api_url: '', api_key: '', instance_name: 'tpjd' };

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // WhatsApp Lokal Sunucu (localhost:3456) 
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const WA_SERVER = 'http://localhost:3456';

            async function loadWhatsAppSettings() {
                // Lokal sunucu durumunu kontrol et (Evolution API ayarlarÄ± artÄ±k gerekli deÄŸil)
                await checkWhatsAppStatus();
            }

            async function saveWhatsAppSettings() {
                // Lokal sunucu â€” kayÄ±t gerektirmiyor
                showNotification('WhatsApp lokal sunucu kullanÄ±lÄ±yor. Ayar kaydetmeye gerek yok.', 'info');
            }

            async function checkWhatsAppStatus() {
                const card = document.getElementById('waStatusCard');
                const badge = document.getElementById('waStatusBadge');
                const text = document.getElementById('waStatusText');
                if (!card || !badge || !text) return;

                try {
                    const res = await fetch(`${WA_SERVER}/status`, { signal: AbortSignal.timeout(3000) });
                    const data = await res.json();

                    if (data.status === 'connected' && data.ready) {
                        card.style.borderLeftColor = '#27ae60';
                        badge.style.background = 'rgba(39,174,96,0.15)';
                        badge.style.color = '#27ae60';
                        badge.textContent = 'âœ… BaÄŸlÄ±';
                        text.style.color = '#27ae60';
                        text.textContent = `WhatsApp baÄŸlÄ± â€” ${data.phone || 'hazÄ±r'}`;
                    } else if (data.status === 'qr_waiting') {
                        card.style.borderLeftColor = '#f39c12';
                        badge.style.background = 'rgba(243,156,18,0.15)';
                        badge.style.color = '#f39c12';
                        badge.textContent = 'â³ QR Bekleniyor';
                        text.style.color = '#f39c12';
                        text.textContent = 'QR kodu okutulmasÄ± bekleniyor...';
                    } else {
                        card.style.borderLeftColor = '#e67e22';
                        badge.style.background = 'rgba(230,126,34,0.15)';
                        badge.style.color = '#e67e22';
                        badge.textContent = 'âš ï¸ BaÄŸlanÄ±yor';
                        text.style.color = '#e67e22';
                        text.textContent = `Durum: ${data.status || 'bilinmiyor'}`;
                    }
                } catch (e) {
                    card.style.borderLeftColor = '#e74c3c';
                    badge.style.background = 'rgba(231,76,60,0.15)';
                    badge.style.color = '#e74c3c';
                    badge.textContent = 'âŒ KapalÄ±';
                    text.style.color = '#e74c3c';
                    text.textContent = 'Sunucu kapalÄ± â€” TPJD_WHATSAPP.bat Ã§alÄ±ÅŸtÄ±rÄ±n';
                }
            }

            async function showWhatsAppQR(retryCount = 0) {
                const modal = document.getElementById('waQRModal');
                const content = document.getElementById('waQRContent');
                modal.classList.add('active');

                if (retryCount === 0) {
                    content.innerHTML = '<div style="margin:20px auto;text-align:center;"><div style="width:40px;height:40px;border:3px solid #25D366;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div><p style="color:#555;">WhatsApp sunucusu kontrol ediliyor...</p></div>';
                }

                try {
                    // 1. Sunucu Ã§alÄ±ÅŸÄ±yor mu kontrol et
                    const statusRes = await fetch(`${WA_SERVER}/status`, { signal: AbortSignal.timeout(3000) }).catch(() => null);

                    if (!statusRes || !statusRes.ok) {
                        // Sunucu kapalÄ± â€” PHP ile otomatik baÅŸlat
                        content.innerHTML = `<div style="text-align:center;margin:20px auto;">
                            <div style="width:40px;height:40px;border:3px solid #25D366;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                            <p style="color:#f39c12;font-weight:bold;">ðŸš€ WhatsApp sunucusu baÅŸlatÄ±lÄ±yor...</p>
                            <p style="color:#999;font-size:13px;">Deneme ${retryCount + 1}/5 â€” lÃ¼tfen bekleyin</p>
                        </div>`;

                        // PHP ile sunucuyu baÅŸlat
                        try {
                            await fetch(`${API_BASE}/whatsapp_control.php?action=start`, { signal: AbortSignal.timeout(25000) });
                        } catch (phpErr) {
                            console.warn('PHP start call error:', phpErr);
                        }

                        if (retryCount < 5) {
                            setTimeout(() => showWhatsAppQR(retryCount + 1), 6000);
                            return;
                        } else {
                            // 5 deneme sonrasÄ± hala aÃ§Ä±lamadÄ±
                            content.innerHTML = `
                                <div style="text-align:center;padding:20px;">
                                    <p style="color:#e74c3c;font-size:48px;margin:0;">ðŸ”Œ</p>
                                    <p style="color:#e74c3c;font-size:18px;font-weight:bold;margin:10px 0;">Sunucu BaÅŸlatÄ±lamadÄ±</p>
                                    <p style="color:#555;font-size:13px;line-height:1.8;">Node.js veya WhatsApp sunucu dosyalarÄ± bulunamadÄ±.<br>LÃ¼tfen Node.js'in yÃ¼klÃ¼ olduÄŸundan emin olun.</p>
                                    <button onclick="showWhatsAppQR(0)" style="margin-top:15px;padding:10px 24px;background:#25D366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">ðŸ”„ Tekrar Dene</button>
                                </div>`;
                            return;
                        }
                    }

                    // 2. Sunucu Ã§alÄ±ÅŸÄ±yor â€” durumu kontrol et
                    const statusData = await statusRes.json();

                    if (statusData.authenticated || statusData.status === 'connected') {
                        // Zaten baÄŸlÄ±
                        content.innerHTML = `
                            <div style="text-align:center;padding:20px;">
                                <p style="color:#25D366;font-size:48px;margin:0;">âœ…</p>
                                <p style="color:#27ae60;font-size:18px;font-weight:bold;margin:10px 0;">WhatsApp BaÄŸlÄ±!</p>
                                <p style="color:#555;">Oturum aktif, QR taratmaya gerek yok.</p>
                                ${statusData.info?.pushname ? '<p style="color:#999;font-size:13px;">ðŸ‘¤ ' + statusData.info.pushname + '</p>' : ''}
                            </div>`;
                        checkWhatsAppStatus();
                        return;
                    }

                    // 3. Sunucu Ã§alÄ±ÅŸÄ±yor ama baÄŸlÄ± deÄŸil â€” QR al
                    const qrRes = await fetch(`${WA_SERVER}/qr`, { signal: AbortSignal.timeout(10000) });
                    const qrData = await qrRes.json();

                    if (qrData.qr) {
                        content.innerHTML = `
                            <div style="text-align:center;padding:10px;">
                                <img src="${qrData.qr}" style="max-width:280px;border-radius:12px;border:2px solid #eee;box-shadow:0 4px 20px rgba(0,0,0,0.1);" alt="WhatsApp QR">
                                <p style="color:#25D366;margin-top:15px;font-weight:700;font-size:15px;">ðŸ“± Telefonla bu QR'Ä± taratÄ±n</p>
                                <p style="color:#999;font-size:12px;">WhatsApp â†’ BaÄŸlÄ± Cihazlar â†’ Cihaz BaÄŸla</p>
                            </div>`;
                        setTimeout(() => checkWhatsAppStatus(), 15000);

                    } else if (qrData.authenticated) {
                        content.innerHTML = `
                            <div style="text-align:center;padding:20px;">
                                <p style="color:#25D366;font-size:48px;margin:0;">âœ…</p>
                                <p style="color:#27ae60;font-size:18px;font-weight:bold;margin:10px 0;">WhatsApp BaÄŸlÄ±!</p>
                                <p style="color:#555;">Oturum aktif, QR taratmaya gerek yok.</p>
                            </div>`;
                        checkWhatsAppStatus();

                    } else {
                        // QR henÃ¼z Ã¼retilmedi â€” retry
                        if (retryCount < 5) {
                            content.innerHTML = `<div style="text-align:center;margin:20px auto;">
                                <div style="width:40px;height:40px;border:3px solid #25D366;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                                <p style="color:#f39c12;font-weight:bold;">â³ QR kodu oluÅŸturuluyor...</p>
                                <p style="color:#999;font-size:13px;">Deneme ${retryCount + 1}/5 â€” 6 saniye bekleniyor</p>
                            </div>`;
                            setTimeout(() => showWhatsAppQR(retryCount + 1), 6000);
                        } else {
                            content.innerHTML = `
                                <div style="text-align:center;padding:20px;">
                                    <p style="color:#e74c3c;font-size:16px;font-weight:bold;">âš ï¸ QR kodu Ã¼retilemedi</p>
                                    <p style="color:#555;font-size:13px;margin:10px 0;">Sunucu Ã§alÄ±ÅŸÄ±yor ama QR kodu oluÅŸturulamadÄ±.</p>
                                    <button onclick="showWhatsAppQR(0)" style="margin-top:12px;padding:10px 24px;background:#25D366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">ðŸ”„ Tekrar Dene</button>
                                </div>`;
                        }
                    }
                } catch (e) {
                    console.error('showWhatsAppQR error:', e);
                    // Beklenmeyen hata â€” PHP ile baÅŸlatmayÄ± dene
                    if (retryCount < 5) {
                        content.innerHTML = `<div style="text-align:center;margin:20px auto;">
                            <div style="width:40px;height:40px;border:3px solid #25D366;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                            <p style="color:#f39c12;font-weight:bold;">ðŸš€ Sunucu baÅŸlatÄ±lÄ±yor...</p>
                            <p style="color:#999;font-size:13px;">Deneme ${retryCount + 1}/5</p>
                        </div>`;
                        fetch(`${API_BASE}/whatsapp_control.php?action=start`).catch(() => { });
                        setTimeout(() => showWhatsAppQR(retryCount + 1), 6000);
                    } else {
                        content.innerHTML = `
                            <div style="text-align:center;padding:20px;">
                                <p style="color:#e74c3c;font-size:48px;margin:0;">ðŸ”Œ</p>
                                <p style="color:#e74c3c;font-size:18px;font-weight:bold;margin:10px 0;">Sunucu BaÅŸlatÄ±lamadÄ±</p>
                                <p style="color:#555;font-size:13px;">WhatsApp sunucusu baÅŸlatÄ±lamadÄ±. Node.js yÃ¼klÃ¼ olduÄŸundan emin olun.</p>
                                <button onclick="showWhatsAppQR(0)" style="margin-top:15px;padding:10px 24px;background:#25D366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">ðŸ”„ Tekrar Dene</button>
                            </div>`;
                    }
                }
            }


            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // WhatsApp Kuyruk Ä°ÅŸleyici â€” Agent response'tan gelen mesajlarÄ± gÃ¶nder
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            async function processWhatsAppQueue(queue, agentName) {
                if (!queue || queue.length === 0) return;

                let sent = 0, failed = 0;
                showNotification(`ðŸ“± ${queue.length} WhatsApp mesajÄ± gÃ¶nderiliyor...`, 'info');

                for (const item of queue) {
                    try {
                        const res = await fetch(`${WA_SERVER}/send`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ number: item.number, message: item.message }),
                            signal: AbortSignal.timeout(15000)
                        });
                        const data = await res.json();

                        if (data.success) {
                            sent++;
                            // Log'u PHP'ye kaydet
                            try {
                                await fetch(`${API_BASE}/agents.php?action=log_whatsapp`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        agent_name: agentName,
                                        recipient_id: item.recipient_id || '',
                                        recipient_name: item.recipient_name || '',
                                        detail: item.detail || 'WhatsApp mesajÄ± gÃ¶nderildi',
                                        status: 'success'
                                    })
                                });
                            } catch (logErr) { console.warn('WA log kayÄ±t hatasÄ±:', logErr); }
                        } else {
                            failed++;
                        }
                    } catch (e) {
                        failed++;
                        console.warn('WA gÃ¶nderim hatasÄ±:', e);
                    }

                    // Spam engeli: mesajlar arasÄ± 1sn bekle
                    if (queue.indexOf(item) < queue.length - 1) {
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                if (sent > 0) showNotification(`âœ… ${sent} WhatsApp mesajÄ± gÃ¶nderildi!`, 'success');
                if (failed > 0) showNotification(`âš ï¸ ${failed} mesaj gÃ¶nderilemedi (WhatsApp kapalÄ± olabilir)`, 'warning');
            }

            // Eski Evolution API fonksiyonlarÄ± (uyumluluk)
            function testEvolutionConnection() { checkWhatsAppStatus(); }
            function showEvolutionQR() { showWhatsAppQR(); }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Auto-Run Agents â€” Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda gÃ¼nde 1 kez Ã§alÄ±ÅŸtÄ±r
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            async function autoRunAgents() {
                try {
                    // 1. Backend'den hangi agent'larÄ±n bugÃ¼n Ã§alÄ±ÅŸmasÄ± gerektiÄŸini sor
                    const res = await fetch(`${API_BASE}/agents.php?action=cron_check`);
                    const data = await res.json();
                    if (!data.success || !data.data) return;

                    const status = data.data;
                    const agentLabels = {
                        birthday: 'ðŸŽ‚ DoÄŸum GÃ¼nÃ¼',
                        debt_reminder: 'ðŸ”” BorÃ§ HatÄ±rlatma',
                        monthly_report: 'ðŸ“Š AylÄ±k Rapor',
                        seniority_promotion: 'ðŸ… KÄ±dem Terfi'
                    };
                    let ranAgents = [];

                    // 2. Birthday Agent â€” her gÃ¼n
                    if (status.birthday?.should_run && agentManager.config.birthday?.enabled !== false) {
                        try {
                            const bRes = await fetch(`${agentManager.apiBase}?action=run`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ agent: 'birthday' })
                            });
                            const bData = await bRes.json();
                            // WhatsApp kuyruÄŸunu tarayÄ±cÄ±dan gÃ¶nder
                            if (bData.data?.whatsapp_queue?.length > 0) {
                                await processWhatsAppQueue(bData.data.whatsapp_queue, 'birthday');
                            }
                            ranAgents.push(agentLabels.birthday);
                            console.log('ðŸ¤– Auto-run: Birthday agent Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±');
                        } catch (e) { console.warn('Auto-run birthday error:', e); }
                    }

                    // 3. Debt Reminder â€” 3 Kademeli Otomatik Eskalasyon
                    if (status.debt_reminder?.should_run && agentManager.config.debt_reminder?.enabled !== false) {
                        try {
                            const escalation = status.debt_reminder.escalation || {};
                            const tierSubjects = {
                                1: 'Aidat HatÄ±rlatmasÄ± - TPJD',
                                2: 'Resmi Aidat UyarÄ±sÄ± - TPJD',
                                3: 'Son UyarÄ±: Aidat Borcunuz - TPJD'
                            };
                            const tierLabels = { 1: 'Nazik', 2: 'Resmi', 3: 'Son UyarÄ±' };
                            let totalSent = 0;
                            let tierDetails = [];

                            for (let tier = 1; tier <= 3; tier++) {
                                const tierKey = `tier_${tier}`;
                                const eligible = escalation[tierKey]?.eligible || 0;
                                if (eligible === 0) continue;

                                // Bu kademe iÃ§in borÃ§lu listesini al
                                const debtRes = await fetch(`${agentManager.apiBase}?action=debtors&tier=${tier}`);
                                const debtData = await debtRes.json();
                                const debtorsList = debtData.data?.data || [];

                                const waQueue = [];
                                // IBAN bilgisi varsa mesaja ekle
                                const iban = settings?.iban_settings || {};
                                let ibanBlock = '';
                                if (iban.iban) {
                                    ibanBlock = `\n\nðŸ¦ Ã–deme Bilgileri:\nBanka: ${iban.banka_adi || '-'}\nHesap Sahibi: ${iban.hesap_sahibi || '-'}\nIBAN: ${iban.iban}${iban.aciklama ? '\nAÃ§Ä±klama: ' + iban.aciklama : ''}`;
                                }
                                for (const debtor of debtorsList) {
                                    const messages = {
                                        1: `SayÄ±n ${debtor.fullName},\n\n${debtor.debtYears} yÄ±llarÄ±na ait toplam â‚º${debtor.totalDebt} aidat borcunuz bulunmaktadÄ±r. En yakÄ±n zamanda Ã¶demenizi yapmanÄ±zÄ± rica ederiz.${ibanBlock}\n\nTPJD YÃ¶netimi`,
                                        2: `SayÄ±n ${debtor.fullName},\n\nDaha Ã¶nce bildirilen â‚º${debtor.totalDebt} tutarÄ±ndaki ${debtor.debtYears} yÄ±llarÄ±na ait aidat borcunuz hÃ¢lÃ¢ Ã¶denmemiÅŸtir. En kÄ±sa sÃ¼rede Ã¶deme yapmanÄ±zÄ± Ã¶nemle rica ederiz.${ibanBlock}\n\nTPJD YÃ¶netim Kurulu`,
                                        3: `SayÄ±n ${debtor.fullName},\n\nÃ–denmemiÅŸ â‚º${debtor.totalDebt} aidat borcunuz (${debtor.debtYears}) iÃ§in son uyarÄ±dÄ±r. 30 gÃ¼n iÃ§inde Ã¶deme yapÄ±lmamasÄ± halinde Ã¼yelik durumunuz deÄŸerlendirmeye alÄ±nacaktÄ±r.${ibanBlock}\n\nTPJD YÃ¶netim Kurulu`
                                    };

                                    // Email gÃ¶nder
                                    await fetch(`${agentManager.apiBase}?action=send-notification`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            agent_name: 'debt_reminder',
                                            channel: 'email',
                                            recipient_id: debtor.memberId,
                                            subject: tierSubjects[tier],
                                            message: messages[tier]
                                        })
                                    });
                                    totalSent++;

                                    // WhatsApp kuyruÄŸuna ekle
                                    if (debtor.phone) {
                                        let waPhone = debtor.phone.replace(/[^0-9]/g, '');
                                        if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                        else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                        waQueue.push({
                                            number: waPhone, message: messages[tier],
                                            recipient_id: debtor.memberId,
                                            recipient_name: debtor.fullName,
                                            detail: `ðŸ”” BorÃ§ hatÄ±rlatma Kademe ${tier} â€” â‚º${debtor.totalDebt}`
                                        });
                                    }
                                }

                                // WhatsApp kuyruÄŸunu gÃ¶nder
                                if (waQueue.length > 0) {
                                    await processWhatsAppQueue(waQueue, 'debt_reminder');
                                }

                                if (debtorsList.length > 0) {
                                    tierDetails.push(`K${tier}:${debtorsList.length}`);
                                }
                            }

                            if (totalSent > 0) {
                                ranAgents.push(`ðŸ”” BorÃ§ HatÄ±rlatma (${tierDetails.join(', ')} â€” ${totalSent} Ã¼ye)`);
                            }
                            console.log('ðŸ¤– Auto-run: Debt reminder (3 kademe) Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±');
                        } catch (e) { console.warn('Auto-run debt_reminder error:', e); }
                    }

                    // 4. Monthly Report â€” sadece ayÄ±n 1'inde
                    if (status.monthly_report?.should_run && agentManager.config.monthly_report?.enabled !== false) {
                        try {
                            await fetch(`${agentManager.apiBase}?action=run`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ agent: 'monthly_report' })
                            });
                            ranAgents.push(agentLabels.monthly_report);
                            console.log('ðŸ¤– Auto-run: Monthly report Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±');
                        } catch (e) { console.warn('Auto-run monthly_report error:', e); }
                    }

                    // 5. Seniority Promotion â€” 20+ yÄ±llÄ±k Ã¼yeleri otomatik terfi et
                    if (status.seniority_promotion?.should_run) {
                        try {
                            // Terfi adaylarÄ±nÄ± al
                            const spRes = await fetch(`${agentManager.apiBase}?action=seniority_check`);
                            const spData = await spRes.json();
                            const eligible = spData.data?.eligible || [];

                            if (eligible.length > 0) {
                                // Terfi iÅŸlemini Ã§alÄ±ÅŸtÄ±r
                                const promoRes = await fetch(`${agentManager.apiBase}?action=seniority_promote`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ promotions: eligible })
                                });
                                const promoData = await promoRes.json();

                                if (promoData.success) {
                                    const promoted = promoData.data?.promoted || [];
                                    const waQueue = [];

                                    for (const member of promoted) {
                                        // Ãœyeye e-posta gÃ¶nder
                                        const emailMsg = `SayÄ±n ${member.fullName},\n\nTÃ¼rkiye Petrol JeologlarÄ± DerneÄŸi'ne 20 yÄ±lÄ± aÅŸkÄ±n sÃ¼re Ã¼yeliÄŸiniz nedeniyle, Ã¼yelik tipiniz "${member.oldType}" â†’ "${member.newType}" olarak gÃ¼ncellenmiÅŸtir.\n\nBundan sonra yÄ±llÄ±k aidat Ã¶demesinden muaf tutulacaksÄ±nÄ±z.\n\nDeÄŸerli katkÄ±larÄ±nÄ±z iÃ§in teÅŸekkÃ¼r eder, iyi dileklerimizi sunarÄ±z.\n\nTPJD YÃ¶netim Kurulu`;
                                        await fetch(`${agentManager.apiBase}?action=send-notification`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                agent_name: 'seniority_promotion',
                                                channel: 'email',
                                                recipient_id: member.id,
                                                subject: 'Tebrikler! Onursal Ãœyelik Terfiniz â€” TPJD',
                                                message: emailMsg
                                            })
                                        });

                                        // WhatsApp kuyruÄŸuna ekle
                                        const origMember = eligible.find(e => e.id === member.id);
                                        if (origMember?.phone) {
                                            let waPhone = origMember.phone.replace(/[^0-9]/g, '');
                                            if (waPhone.startsWith('0')) waPhone = '90' + waPhone.substring(1);
                                            else if (!waPhone.startsWith('90')) waPhone = '90' + waPhone;
                                            waQueue.push({
                                                number: waPhone,
                                                message: `ðŸ… SayÄ±n ${member.fullName},\n\nTebrikler! TPJD'ye 20+ yÄ±llÄ±k Ã¼yeliÄŸiniz nedeniyle "${member.newType}" statÃ¼sÃ¼ne terfi ettiniz. ArtÄ±k yÄ±llÄ±k aidattan muafsÄ±nÄ±z.\n\nðŸŽ‰ TPJD YÃ¶netimi`,
                                                recipient_id: member.id,
                                                recipient_name: member.fullName,
                                                detail: `ðŸ… KÄ±dem terfi: ${member.oldType} â†’ ${member.newType}`
                                            });
                                        }
                                    }

                                    // WhatsApp gÃ¶nder
                                    if (waQueue.length > 0) {
                                        await processWhatsAppQueue(waQueue, 'seniority_promotion');
                                    }

                                    ranAgents.push(`ðŸ… KÄ±dem Terfi (${promoted.length} Ã¼ye terfi edildi)`);
                                }
                                console.log('ðŸ¤– Auto-run: Seniority promotion Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±');
                            }
                        } catch (e) { console.warn('Auto-run seniority_promotion error:', e); }
                    }

                    // 6. SonuÃ§ bildirimi
                    if (ranAgents.length > 0) {
                        showNotification(`ðŸ¤– Otomatik Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±: ${ranAgents.join(', ')}`, 'success');
                        // Agent stats & logs'u yenile
                        await agentManager.loadStats();
                        await agentManager.loadLogs();
                    } else {
                        console.log('ðŸ¤– Auto-run: TÃ¼m agent\'lar bugÃ¼n zaten Ã§alÄ±ÅŸmÄ±ÅŸ');
                    }
                } catch (e) {
                    console.warn('Auto-run agents check failed:', e);
                }
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CANLI SAAT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const TR_MONTHS = ['Ocak', 'Åžubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
            const TR_DAYS = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];

            function startLiveClock() {
                function tick() {
                    const now = new Date();
                    const dateEl = document.getElementById('liveDate');
                    const clockEl = document.getElementById('liveClock');
                    if (dateEl) dateEl.textContent = `ðŸ“… ${now.getDate()} ${TR_MONTHS[now.getMonth()]} ${now.getFullYear()}, ${TR_DAYS[now.getDay()]}`;
                    if (clockEl) clockEl.textContent = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }
                tick();
                setInterval(tick, 1000);
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Ä°NTERAKTÄ°F TAKVÄ°M
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let calendarYear = new Date().getFullYear();
            let calendarMonth = new Date().getMonth();

            function calendarPrevMonth() {
                calendarMonth--;
                if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
                renderCalendar();
            }
            function calendarNextMonth() {
                calendarMonth++;
                if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
                renderCalendar();
            }

            function getCalendarEvents(year, month) {
                // Agent loglarÄ±ndan ve Ã¶demelerden etkinlikleri Ã§ek
                const events = {};
                const key = (d) => `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                // 1. Ã–demeler
                payments.forEach(p => {
                    if (!p.date) return;
                    const d = new Date(p.date);
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        const day = d.getDate();
                        if (!events[day]) events[day] = [];
                        const m = members.find(x => x.id === p.memberId);
                        const name = m ? `${m.firstName} ${m.lastName}` : 'Bilinmeyen';
                        events[day].push({ icon: p.status === 'tamamlandÄ±' ? 'ðŸ’°' : 'â³', text: `${name} â€” â‚º${p.amount} ${p.type}`, type: 'payment' });
                    }
                });

                // 2. Bildirimler
                (notifications || []).forEach(n => {
                    if (!n.sentAt) return;
                    const d = new Date(n.sentAt);
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        const day = d.getDate();
                        if (!events[day]) events[day] = [];
                        events[day].push({ icon: 'ðŸ“¢', text: n.title || 'Bildirim', type: 'notification' });
                    }
                });

                // 3. DoÄŸum gÃ¼nleri (bu ayda)
                members.forEach(m => {
                    if (!m.birthDate) return;
                    const bd = new Date(m.birthDate);
                    if (bd.getMonth() === month) {
                        const day = bd.getDate();
                        if (!events[day]) events[day] = [];
                        events[day].push({ icon: 'ðŸŽ‚', text: `${m.firstName} ${m.lastName} doÄŸum gÃ¼nÃ¼`, type: 'birthday' });
                    }
                });

                // 4. Agent loglarÄ± (localStorage)
                try {
                    const logs = JSON.parse(localStorage.getItem('tpjd_agent_logs') || '[]');
                    logs.forEach(log => {
                        if (!log.timestamp) return;
                        const d = new Date(log.timestamp);
                        if (d.getFullYear() === year && d.getMonth() === month) {
                            const day = d.getDate();
                            if (!events[day]) events[day] = [];
                            events[day].push({ icon: 'ðŸ¤–', text: log.agent + ': ' + (log.result || 'Ã§alÄ±ÅŸtÄ±'), type: 'agent' });
                        }
                    });
                } catch (e) { }

                return events;
            }

            function renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const titleEl = document.getElementById('calendarTitle');
                const detailEl = document.getElementById('calendarDayDetail');
                if (!grid) return;

                titleEl.innerHTML = `<i class="fas fa-calendar-alt"></i> ${TR_MONTHS[calendarMonth]} ${calendarYear}`;

                const events = getCalendarEvents(calendarYear, calendarMonth);
                const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
                const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === calendarYear && today.getMonth() === calendarMonth;
                const todayDate = today.getDate();

                // Pazartesi baÅŸlangÄ±Ã§lÄ±
                const startOffset = (firstDay === 0 ? 6 : firstDay - 1);

                let html = '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;">';
                // Header
                ['Pt', 'Sa', 'Ã‡a', 'Pe', 'Cu', 'Ct', 'Pa'].forEach(d => {
                    html += `<div style="font-size:11px;color:#7f8c8d;font-weight:600;padding:4px 0;">${d}</div>`;
                });

                // Empty cells
                for (let i = 0; i < startOffset; i++) {
                    html += '<div></div>';
                }

                // Days
                for (let d = 1; d <= daysInMonth; d++) {
                    const isToday = isCurrentMonth && d === todayDate;
                    const hasEvents = events[d] && events[d].length > 0;
                    const dotColor = hasEvents ? (events[d].some(e => e.type === 'birthday') ? '#e74c3c' : events[d].some(e => e.type === 'payment') ? '#27ae60' : '#3498db') : '';

                    let style = 'padding:6px 2px;border-radius:6px;cursor:pointer;position:relative;font-size:12px;';
                    if (isToday) style += 'background:var(--tpjd-primary);color:#fff;font-weight:700;';
                    else style += 'color:#ecf0f1;';

                    html += `<div style="${style}" onclick="showCalendarDay(${d})" onmouseover="this.style.background='rgba(52,152,219,0.2)'" onmouseout="this.style.background='${isToday ? 'var(--tpjd-primary)' : 'transparent'}'">`;
                    html += d;
                    if (hasEvents) {
                        html += `<div style="position:absolute;bottom:1px;left:50%;transform:translateX(-50%);width:5px;height:5px;border-radius:50%;background:${dotColor};"></div>`;
                    }
                    html += '</div>';
                }

                html += '</div>';
                grid.innerHTML = html;

                // BugÃ¼nÃ¼n etkinliklerini gÃ¶ster
                if (isCurrentMonth && events[todayDate]) {
                    showCalendarDay(todayDate);
                } else if (detailEl) {
                    detailEl.innerHTML = '<span style="color:#7f8c8d;font-style:italic;">Bir gÃ¼ne tÄ±klayarak detay gÃ¶rÃ¼ntÃ¼leyin</span>';
                }
            }

            function showCalendarDay(day) {
                const detailEl = document.getElementById('calendarDayDetail');
                if (!detailEl) return;
                const events = getCalendarEvents(calendarYear, calendarMonth);
                const dayEvents = events[day] || [];

                if (dayEvents.length === 0) {
                    detailEl.innerHTML = `<span style="color:#7f8c8d;">${day} ${TR_MONTHS[calendarMonth]} â€” Ä°ÅŸlem yok</span>`;
                    return;
                }

                let html = `<div style="font-weight:600;color:#ecf0f1;margin-bottom:6px;">${day} ${TR_MONTHS[calendarMonth]} â€” ${dayEvents.length} iÅŸlem</div>`;
                dayEvents.forEach(e => {
                    html += `<div style="padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);">${e.icon} ${e.text}</div>`;
                });
                detailEl.innerHTML = html;
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SON Ä°ÅžLEMLER FEED
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            function updateRecentFeed() {
                const feed = document.getElementById('recentActivityFeed');
                if (!feed) return;

                const activities = [];

                // Son Ã¶demeler
                payments.slice().sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)).slice(0, 5).forEach(p => {
                    const m = members.find(x => x.id === p.memberId);
                    const name = m ? `${m.firstName} ${m.lastName}` : 'Bilinmeyen';
                    const d = p.date ? new Date(p.date) : null;
                    const timeStr = d ? d.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' }) : '';
                    activities.push({
                        time: d || new Date(0),
                        html: `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(39,174,96,0.05);border-radius:6px;border-left:3px solid ${p.status === 'tamamlandÄ±' ? '#27ae60' : '#e67e22'};">
                            <span style="font-size:16px;">${p.status === 'tamamlandÄ±' ? 'ðŸ’°' : 'â³'}</span>
                            <div style="flex:1;font-size:12px;color:#2c3e50;">
                                <strong>${name}</strong> â€” â‚º${p.amount} ${p.type} (${p.year})
                            </div>
                            <span style="font-size:11px;color:#95a5a6;">${timeStr}</span>
                        </div>`
                    });
                });

                // Son bildirimler
                (notifications || []).slice().sort((a, b) => new Date(b.sentAt || 0) - new Date(a.sentAt || 0)).slice(0, 3).forEach(n => {
                    const d = n.sentAt ? new Date(n.sentAt) : null;
                    const timeStr = d ? d.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' }) : '';
                    activities.push({
                        time: d || new Date(0),
                        html: `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(52,152,219,0.05);border-radius:6px;border-left:3px solid #3498db;">
                            <span style="font-size:16px;">ðŸ“¢</span>
                            <div style="flex:1;font-size:12px;color:#2c3e50;">
                                <strong>${n.title || 'Bildirim'}</strong> â€” ${(n.recipients || []).length} kiÅŸiye gÃ¶nderildi
                            </div>
                            <span style="font-size:11px;color:#95a5a6;">${timeStr}</span>
                        </div>`
                    });
                });

                // Zamana gÃ¶re sÄ±rala
                activities.sort((a, b) => b.time - a.time);

                if (activities.length === 0) {
                    feed.innerHTML = '<div style="text-align:center;color:#95a5a6;padding:20px;font-size:13px;"><i class="fas fa-inbox" style="font-size:24px;margin-bottom:8px;display:block;"></i>HenÃ¼z iÅŸlem yok</div>';
                } else {
                    feed.innerHTML = activities.slice(0, 8).map(a => a.html).join('');
                }
            }

            // Initialize app on page load
            async function initializeApp() {
                console.log('UygulamayÄ± baÅŸlatÄ±yor...');
                startLiveClock();
                await loadAllData();
                await agentManager.init();
                await loadWhatsAppSettings();
                renderCalendar();
                updateRecentFeed();
                console.log('Uygulama baÅŸlatÄ±ldÄ±. Ãœyeler:', members.length);

                // Agent'larÄ± arka planda otomatik Ã§alÄ±ÅŸtÄ±r (3sn gecikme ile UI'Ä±n yÃ¼klenmesini bekle)
                setTimeout(() => autoRunAgents(), 3000);
            }

            // Load app when DOM is ready
            document.addEventListener('DOMContentLoaded', initializeApp);
        </script>

</body>

</html>